{% extends "base.html" %}

{% block content %}

<style>
    /* ===== VARIABLES Y RESET MEJORADOS ===== */
    :root {
        /* Gradientes principales */
        --primary-gradient: linear-gradient(135deg, #001d38 0%, #003b71 100%);
        --secondary-gradient: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
        --success-gradient: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        --info-gradient: linear-gradient(135deg, #4A00E0 0%, #8E2DE2 100%);
        --dark-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
        
        /* Colores base */
        --card-bg: rgba(255, 255, 255, 0.98);
        --shadow: 0 12px 48px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 24px 72px rgba(0, 0, 0, 0.15);
        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-sm: 12px;
        
        /* Colores semánticos */
        --success: #10b981;
        --success-light: rgba(16, 185, 129, 0.15);
        --warning: #f59e0b;
        --warning-light: rgba(245, 158, 11, 0.15);
        --danger: #ef4444;
        --danger-light: rgba(239, 68, 68, 0.15);
        --info: #3b82f6;
        --info-light: rgba(59, 130, 246, 0.15);
        --dark: #1e293b;
        --light: #f8fafc;
        --muted: #64748b;
    }

    * {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%) fixed !important;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        color: var(--dark) !important;
        min-height: 100vh;
        letter-spacing: -0.01em;
    }

    /* ===== HEADER ÉPICO ===== */
    .dashboard-header {
        background: var(--primary-gradient);
        border-radius: var(--radius-lg);
        padding: 3rem 2.5rem;
        margin-bottom: 3rem;
        color: white;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 20px 60px rgba(0, 29, 56, 0.25);
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        border-radius: 50%;
        filter: blur(40px);
    }

    .dashboard-header::after {
        content: '';
        position: absolute;
        bottom: -40%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
        border-radius: 50%;
        filter: blur(30px);
    }

    .header-title {
        font-size: clamp(2.2rem, 5vw, 3rem);
        font-weight: 900;
        margin-bottom: 0.75rem;
        position: relative;
        z-index: 2;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        letter-spacing: -0.025em;
    }

    .header-subtitle {
        opacity: 0.95;
        font-size: 1.3rem;
        font-weight: 400;
        position: relative;
        z-index: 2;
        max-width: 800px;
        line-height: 1.6;
    }

    .header-glow {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 70%);
        pointer-events: none;
    }

    /* ===== KPI CARDS ÉPICAS ===== */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .kpi-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(226, 232, 240, 0.6);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
        height: 100%;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 8px;
        height: 100%;
        background: var(--kpi-color);
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        z-index: 1;
    }

    .kpi-card::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: var(--icon-bg);
        opacity: 0.08;
        border-radius: 50%;
        filter: blur(20px);
    }

    .kpi-card:hover {
        transform: translateY(-12px) scale(1.02);
        box-shadow: var(--shadow-hover);
        border-color: rgba(148, 163, 184, 0.4);
    }

    .kpi-card-content {
        position: relative;
        z-index: 2;
    }

    .kpi-icon-wrapper {
        width: 64px;
        height: 64px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        background: var(--icon-bg);
        color: white;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
    }

    .kpi-icon-wrapper::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: translateX(-100%);
        animation: shimmer 3s infinite;
    }

    .kpi-value {
        font-size: clamp(2.5rem, 6vw, 3.5rem);
        font-weight: 900;
        line-height: 1;
        margin: 1rem 0;
        background: linear-gradient(135deg, var(--kpi-color) 0%, var(--kpi-color-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .kpi-label {
        font-size: 1rem;
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.75rem;
        display: block;
    }

    .kpi-trend {
        font-size: 0.9rem;
        padding: 0.4rem 1rem;
        border-radius: 100px;
        background: rgba(52, 211, 153, 0.2);
        color: var(--success);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(16, 185, 129, 0.3);
        transition: all 0.3s ease;
    }

    .kpi-trend:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
    }

    /* ===== CHART CONTAINERS ÉPICOS ===== */
    .chart-container {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow);
        height: 100%;
        border: 1px solid rgba(226, 232, 240, 0.6);
        transition: all 0.4s ease;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
    }

    .chart-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
    }

    .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #f1f5f9;
    }

    .chart-title {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 1rem;
        letter-spacing: -0.01em;
    }

    .chart-title-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(59, 130, 246, 0.1);
        color: var(--info);
        font-size: 1.2rem;
    }

    /* ===== FILTERS ÉPICOS ===== */
    .filter-section {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 1.5rem 2rem;
        box-shadow: var(--shadow);
        margin-bottom: 2.5rem;
        border: 1px solid rgba(226, 232, 240, 0.6);
        backdrop-filter: blur(10px);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        align-items: center;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-select {
        border: 2px solid #e2e8f0;
        border-radius: var(--radius-md);
        padding: 0.875rem 1.25rem;
        background: white;
        font-size: 1rem;
        font-weight: 500;
        color: var(--dark);
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 16px;
        padding-right: 3rem;
    }

    .filter-select:focus {
        border-color: var(--info);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        outline: none;
    }

    .filter-select:hover {
        border-color: #94a3b8;
    }

    /* ===== PRODUCTIVITY SECTION ÉPICA ===== */
    .section-header {
        background: var(--secondary-gradient);
        border-radius: var(--radius-lg);
        padding: 2.5rem;
        color: white;
        margin: 3.5rem 0 2.5rem 0;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 15px 50px rgba(26, 41, 128, 0.25);
    }

    .section-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15));
        transform: skewX(-20deg);
    }

    .section-title {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .section-subtitle {
        opacity: 0.95;
        font-size: 1.1rem;
        position: relative;
        z-index: 2;
        max-width: 600px;
    }

    /* ===== STATS GRID ÉPICO ===== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 2.5rem;
        box-shadow: var(--shadow);
        text-align: center;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(226, 232, 240, 0.6);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 6px;
        background: var(--stat-color, var(--info));
    }

    .stat-card::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: var(--stat-color, var(--info));
        opacity: 0.05;
        border-radius: 50%;
        filter: blur(20px);
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-hover);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 1.5rem;
        background: var(--stat-color, var(--info));
        color: white;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-value {
        font-size: 3.5rem;
        font-weight: 900;
        margin: 1rem 0;
        color: var(--stat-color, var(--dark));
        line-height: 1;
    }

    .stat-label {
        font-size: 1rem;
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 1.5rem;
        display: block;
    }

    .stat-progress {
        height: 12px;
        border-radius: 100px;
        background: rgba(0, 0, 0, 0.05);
        overflow: hidden;
        margin: 1rem 0;
    }

    .stat-progress-bar {
        height: 100%;
        background: var(--stat-color, var(--info));
        border-radius: 100px;
        position: relative;
        overflow: hidden;
    }

    .stat-progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shimmer 2s infinite;
    }

    /* ===== DATA TABLE ÉPICA ===== */
    .data-table-container {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-top: 3rem;
        border: 1px solid rgba(226, 232, 240, 0.6);
        backdrop-filter: blur(10px);
    }

    .table-header {
        background: linear-gradient(135deg, var(--light) 0%, #f1f5f9 100%);
        padding: 2rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .table-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .table-subtitle {
        color: var(--muted);
        font-size: 0.95rem;
        margin-top: 0.5rem;
    }

    /* ===== STATUS BADGES ÉPICOS ===== */
    .status-badge {
        padding: 0.5rem 1.25rem;
        border-radius: 100px;
        font-size: 0.9rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        white-space: nowrap;
    }

    .status-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .status-critical { 
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
        border-color: #fca5a5;
    }
    .status-warning { 
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #d97706;
        border-color: #fbbf24;
    }
    .status-normal { 
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #059669;
        border-color: #34d399;
    }
    .status-idle { 
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #4f46e5;
        border-color: #818cf8;
    }

    /* ===== BOTONES ÉPICOS ===== */
    .btn-primary {
        background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
        border: none;
        border-radius: var(--radius-md);
        padding: 1rem 2rem;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }

    .btn-primary:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }

    .btn-primary:hover::before {
        left: 100%;
    }

    .btn-outline {
        background: transparent;
        border: 2px solid var(--info);
        color: var(--info);
        border-radius: var(--radius-md);
        padding: 0.875rem 1.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-outline:hover {
        background: var(--info);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    /* ===== BADGES ÉPICOS ===== */
    .badge {
        padding: 0.75rem 1.5rem;
        border-radius: 100px;
        font-weight: 700;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .badge-light {
        background: white;
        color: var(--dark);
        border-color: rgba(0, 0, 0, 0.1);
    }

    .badge-success {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
        border-color: var(--success);
    }

    /* ===== LOADING STATES ===== */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: var(--radius-md);
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* ===== ANIMACIONES ÉPICAS ===== */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(40px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% { 
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }
        70% { 
            transform: scale(1.05);
            box-shadow: 0 0 0 20px rgba(16, 185, 129, 0);
        }
        100% { 
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }

    .animate-fade-in {
        animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        opacity: 0;
    }

    .animate-fade {
        animation: fadeIn 0.6s ease-out forwards;
        opacity: 0;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    /* ===== HEATMAP ÉPICO ===== */
    .heatmap-container {
        position: relative;
        height: 240px;
        margin-top: 1.5rem;
    }

    /* ===== SCROLLBAR PERSONALIZADO ===== */
    ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        border-radius: 10px;
        border: 2px solid #f1f5f9;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }

    /* ===== AVATAR ÉPICO ===== */
    .avatar {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        background: linear-gradient(135deg, var(--info) 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        flex-shrink: 0;
    }

    /* ===== PROGRESS BAR ÉPICO ===== */
    .progress {
        height: 12px;
        border-radius: 100px;
        background: rgba(0, 0, 0, 0.05);
        overflow: hidden;
        position: relative;
    }

    .progress-bar {
        height: 100%;
        border-radius: 100px;
        position: relative;
        overflow: hidden;
        transition: width 1s ease-in-out;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shimmer 2s infinite;
    }

    /* ===== TOOLTIPS ÉPICOS ===== */
    [data-tooltip] {
        position: relative;
        cursor: help;
    }

    [data-tooltip]::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
        background: var(--dark);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        pointer-events: none;
        font-weight: 500;
    }

    [data-tooltip]::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(0);
        border: 6px solid transparent;
        border-top-color: var(--dark);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 999;
        pointer-events: none;
    }

    [data-tooltip]:hover::before,
    [data-tooltip]:hover::after {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(-5px);
    }

    /* ===== RESPONSIVE ÉPICO ===== */
    @media (max-width: 1400px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 992px) {
        .dashboard-header {
            padding: 2rem;
        }
        
        .section-header {
            padding: 2rem;
        }
        
        .chart-container {
            padding: 1.5rem;
        }
        
        .stat-card {
            padding: 2rem;
        }
    }

    @media (max-width: 768px) {
        .dashboard-header {
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .header-title {
            font-size: 1.8rem;
        }
        
        .header-subtitle {
            font-size: 1.1rem;
        }
        
        .kpi-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .filter-grid {
            grid-template-columns: 1fr;
        }
        
        .section-header {
            margin: 2.5rem 0 2rem 0;
            padding: 1.5rem;
        }
        
        .section-title {
            font-size: 1.5rem;
        }
        
        .table-header {
            padding: 1.5rem;
        }
    }

    @media (max-width: 576px) {
        .kpi-card {
            padding: 1.5rem;
            min-height: 180px;
        }
        
        .kpi-value {
            font-size: 2.5rem;
        }
        
        .stat-card {
            padding: 1.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
        }
        
        .btn-primary,
        .btn-outline {
            width: 100%;
            justify-content: center;
        }
    }

    /* ===== UTILITIES ÉPICAS ===== */
    .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .text-gradient {
        background: linear-gradient(135deg, var(--info) 0%, #8b5cf6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .hover-lift {
        transition: transform 0.3s ease;
    }

    .hover-lift:hover {
        transform: translateY(-4px);
    }

    .shadow-soft {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .shadow-soft:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }

    /* ===== NO DATA STATES ===== */
    .no-data {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--muted);
    }

    .no-data-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.5;
    }

    .no-data-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--dark);
    }

    .no-data-subtitle {
        font-size: 1rem;
        margin-bottom: 2rem;
    }
</style>

<!-- ===================================================== -->
<!--           DASHBOARD CORPORATIVO MRO ÉPICO             -->
<!-- ===================================================== -->

<div class="dashboard-header">
    <div class="header-glow"></div>
    <div class="position-relative z-2">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="header-title animate-fade-in" style="animation-delay: 0.1s">
                    <i class="bi bi-speedometer2 me-3"></i>Dashboard Operativo MRO
                </h1>
                <p class="header-subtitle animate-fade-in" style="animation-delay: 0.2s">
                    Monitoreo en tiempo real del almacén, productividad de equipos y gestión de mantenimiento
                </p>
            </div>
            <div class="col-lg-4 mt-4 mt-lg-0">
                <div class="d-flex flex-wrap gap-2 justify-content-lg-end animate-fade-in" style="animation-delay: 0.3s">
                    <span class="badge badge-light d-flex align-items-center">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span class="fw-bold">{{ fecha_actual or "Fecha no disponible" }}</span>
                    </span>
                    <span class="badge badge-success d-flex align-items-center pulse">
                        <i class="bi bi-clock me-2"></i>
                        <span class="fw-bold">Actualizado hace 5 min</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== FILTROS RÁPIDOS ===== -->
<div class="filter-section animate-fade-in" style="animation-delay: 0.4s">
    <form id="filterForm" method="GET">
        <div class="filter-grid">
            <div class="filter-group">
                <label class="filter-label">
                    <i class="bi bi-funnel"></i>Área
                </label>
                <select name="area" class="filter-select">
                    <option value="">Todas las áreas</option>
                    {% for a in areas or [] %}
                    <option value="{{ a }}" {% if request.args.get('area') == a %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i class="bi bi-calendar-month"></i>Mes
                </label>
                <select name="mes" class="filter-select">
                    {% for m in meses or [] %}
                    <option value="{{ m.valor }}" {% if request.args.get('mes') == m.valor %}selected{% endif %}>
                        {{ m.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i class="bi bi-check-circle"></i>Estado
                </label>
                <select name="estado" class="filter-select">
                    <option value="">Todos los estados</option>
                    <option value="Operativo">Operativo</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Crítico">Crítico</option>
                    <option value="Inactivo">Inactivo</option>
                </select>
            </div>
            
            <div class="d-flex align-items-end gap-2">
                <button type="submit" class="btn-primary">
                    <i class="bi bi-funnel"></i> Aplicar Filtros
                </button>
                <button type="button" class="btn-outline" id="btn-reset">
                    <i class="bi bi-arrow-counterclockwise"></i> Limpiar
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ===== KPI PRINCIPALES ===== -->
<div class="kpi-grid">
    <div class="kpi-card animate-fade-in" style="animation-delay: 0.5s; --kpi-color: #3b82f6; --kpi-color-secondary: #8b5cf6; --icon-bg: linear-gradient(135deg, #3b82f6, #8b5cf6);">
        <div class="kpi-card-content">
            <div class="kpi-icon-wrapper">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="kpi-value" id="kpi_stock">{{ total_stock|default(0)|int }}</div>
            <span class="kpi-label">Materiales en Stock</span>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="kpi-trend">
                    <i class="bi bi-arrow-up-right"></i> 12%
                </span>
                <small class="text-muted">vs mes anterior</small>
            </div>
        </div>
    </div>

    <div class="kpi-card animate-fade-in" style="animation-delay: 0.6s; --kpi-color: #f59e0b; --kpi-color-secondary: #fbbf24; --icon-bg: linear-gradient(135deg, #f59e0b, #fbbf24);">
        <div class="kpi-card-content">
            <div class="kpi-icon-wrapper">
                <i class="bi bi-truck"></i>
            </div>
            <div class="kpi-value" id="kpi_bultos">{{ bultos_hoy|default(0)|int }}</div>
            <span class="kpi-label">Bultos Procesados</span>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="kpi-trend" style="background: rgba(239, 68, 68, 0.2); color: var(--danger); border-color: rgba(239, 68, 68, 0.3);">
                    <i class="bi bi-arrow-down-right"></i> 3%
                </span>
                <small class="text-muted">vs día anterior</small>
            </div>
        </div>
    </div>

    <div class="kpi-card animate-fade-in" style="animation-delay: 0.7s; --kpi-color: #ef4444; --kpi-color-secondary: #f87171; --icon-bg: linear-gradient(135deg, #ef4444, #f87171);">
        <div class="kpi-card-content">
            <div class="kpi-icon-wrapper">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="kpi-value" id="kpi_alertas">{{ alertas_activas|default(0)|int }}</div>
            <span class="kpi-label">Alertas Activas</span>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="kpi-trend" style="background: rgba(239, 68, 68, 0.2); color: var(--danger); border-color: rgba(239, 68, 68, 0.3);">
                    <i class="bi bi-arrow-up-right"></i> 8%
                </span>
                <small class="text-muted">24h anteriores</small>
            </div>
        </div>
    </div>

    <div class="kpi-card animate-fade-in" style="animation-delay: 0.8s; --kpi-color: #10b981; --kpi-color-secondary: #34d399; --icon-bg: linear-gradient(135deg, #10b981, #34d399);">
        <div class="kpi-card-content">
            <div class="kpi-icon-wrapper">
                <i class="bi bi-person-badge"></i>
            </div>
            <div class="kpi-value" id="kpi_tecnicos">{{ errores_hoy|default(0)|int }}</div>
            <span class="kpi-label">Incidentes Técnicos</span>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="kpi-trend" style="background: rgba(16, 185, 129, 0.2); color: var(--success); border-color: rgba(16, 185, 129, 0.3);">
                    <i class="bi bi-arrow-down-right"></i> 15%
                </span>
                <small class="text-muted">vs mes anterior</small>
            </div>
        </div>
    </div>
</div>

<!-- ===== PRIMERA FILA DE GRÁFICOS ===== -->
<div class="row g-4 mb-4">
    <div class="col-12 col-lg-8">
        <div class="chart-container animate-fade-in" style="animation-delay: 0.9s">
            <div class="chart-header">
                <div class="d-flex align-items-center gap-3">
                    <div class="chart-title-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div>
                        <h5 class="chart-title mb-0">Tendencia de Alertas por Día</h5>
                        <small class="text-muted">Últimos 7 días de actividad</small>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline d-flex align-items-center gap-2" 
                            type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-calendar-week"></i> Últimos 7 días
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                        <li><a class="dropdown-item d-flex align-items-center gap-2" href="#">
                            <i class="bi bi-calendar-week"></i> Últimos 7 días
                        </a></li>
                        <li><a class="dropdown-item d-flex align-items-center gap-2" href="#">
                            <i class="bi bi-calendar-month"></i> Últimos 30 días
                        </a></li>
                        <li><a class="dropdown-item d-flex align-items-center gap-2" href="#">
                            <i class="bi bi-calendar-check"></i> Este mes
                        </a></li>
                    </ul>
                </div>
            </div>
            {% if alertas_dias and alertas_dias|length > 0 %}
            <canvas id="line_alertas" height="250"></canvas>
            {% else %}
            <div class="no-data">
                <i class="bi bi-bar-chart no-data-icon"></i>
                <h6 class="no-data-title">No hay datos disponibles</h6>
                <p class="no-data-subtitle">No se encontraron datos de alertas para el período seleccionado</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="chart-container animate-fade-in" style="animation-delay: 1.0s">
            <div class="chart-header">
                <div class="d-flex align-items-center gap-3">
                    <div class="chart-title-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <i class="bi bi-pie-chart"></i>
                    </div>
                    <div>
                        <h5 class="chart-title mb-0">Estado del Inventario</h5>
                        <small class="text-muted">{{ total_stock|default(0) }} unidades totales</small>
                    </div>
                </div>
            </div>
            {% if criticos is defined and bajos is defined and normales is defined and vacios is defined and (criticos + bajos + normales + vacios) > 0 %}
            <div class="d-flex justify-content-center">
                <div style="width: 250px; height: 250px;">
                    <canvas id="donut_stock"></canvas>
                </div>
            </div>
            <div class="row mt-4 g-2">
                <div class="col-6">
                    <div class="status-badge status-critical w-100 justify-content-center">
                        <i class="bi bi-circle-fill fs-6"></i> Crítico
                    </div>
                </div>
                <div class="col-6">
                    <div class="status-badge status-warning w-100 justify-content-center">
                        <i class="bi bi-circle-fill fs-6"></i> Bajo
                    </div>
                </div>
                <div class="col-6">
                    <div class="status-badge status-normal w-100 justify-content-center">
                        <i class="bi bi-circle-fill fs-6"></i> Normal
                    </div>
                </div>
                <div class="col-6">
                    <div class="status-badge status-idle w-100 justify-content-center">
                        <i class="bi bi-circle-fill fs-6"></i> Vacío
                    </div>
                </div>
            </div>
            {% else %}
            <div class="no-data py-4">
                <i class="bi bi-pie-chart no-data-icon"></i>
                <h6 class="no-data-title">Sin datos de inventario</h6>
                <p class="no-data-subtitle">No hay información disponible del estado del inventario</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ===== MAPA DE CALOR ===== -->
<div class="chart-container animate-fade-in mb-4" style="animation-delay: 1.1s">
    <div class="chart-header">
        <div class="d-flex align-items-center gap-3">
            <div class="chart-title-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <i class="bi bi-calendar-heart"></i>
            </div>
            <div>
                <h5 class="chart-title mb-0">Actividad por Hora - Mapa de Calor</h5>
                <small class="text-muted">Bultos procesados por franja horaria</small>
            </div>
        </div>
        <div class="d-flex gap-2">
            <span class="badge bg-danger">Alta actividad</span>
            <span class="badge bg-warning">Media actividad</span>
            <span class="badge bg-success">Baja actividad</span>
        </div>
    </div>
    {% if horas_bultos and horas_bultos|length > 0 %}
    <div class="heatmap-container">
        <canvas id="heat_bultos"></canvas>
    </div>
    <div class="mt-3 text-center text-muted small">
        <i class="bi bi-info-circle me-1"></i>
        {% if hora_pico and bultos_pico %}
        Horario con mayor actividad: {{ hora_pico }} hrs ({{ bultos_pico }} bultos)
        {% else %}
        Sin datos de actividad horaria
        {% endif %}
    </div>
    {% else %}
    <div class="no-data py-4">
        <i class="bi bi-calendar-heart no-data-icon"></i>
        <h6 class="no-data-title">Sin datos de actividad</h6>
        <p class="no-data-subtitle">No hay información disponible de la actividad por hora</p>
    </div>
    {% endif %}
</div>

<!-- ===== SECCIÓN PRODUCTIVIDAD ===== -->
<div class="section-header animate-fade-in" style="animation-delay: 1.2s">
    <div class="position-relative z-2">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h3 class="section-title">
                    <i class="bi bi-speedometer2 me-3"></i>Dashboard de Productividad
                </h3>
                <p class="section-subtitle">
                    Métricas de desempeño por equipo y área - Monitoreo en tiempo real
                </p>
            </div>
            <div class="col-lg-4 mt-3 mt-lg-0">
                <div class="d-flex gap-2 justify-content-lg-end">
                    <button class="btn btn-light btn-sm d-flex align-items-center gap-2" id="btn-export">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                    <button class="btn btn-light btn-sm d-flex align-items-center gap-2" id="btn-refresh">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== KPIS DE PRODUCTIVIDAD ===== -->
<div class="stats-grid">
    <div class="stat-card animate-fade-in" style="animation-delay: 1.3s; --stat-color: #10b981;">
        <div class="stat-icon">
            <i class="bi bi-check-circle"></i>
        </div>
        <div class="stat-value">{{ disponibilidad_promedio|default(0)|int }}%</div>
        <span class="stat-label">Disponibilidad Promedio</span>
        <div class="stat-progress">
            <div class="stat-progress-bar" style="width: {{ disponibilidad_promedio|default(0) }}%"></div>
        </div>
        <div class="small text-muted mt-3">
            <i class="bi bi-arrow-up-right text-success me-1"></i>
            2% vs mes anterior
        </div>
    </div>

    <div class="stat-card animate-fade-in" style="animation-delay: 1.4s; --stat-color: #3b82f6;">
        <div class="stat-icon">
            <i class="bi bi-graph-up-arrow"></i>
        </div>
        <div class="stat-value">{{ productividad_promedio|default(0)|int }}%</div>
        <span class="stat-label">Productividad Promedio</span>
        <div class="stat-progress">
            <div class="stat-progress-bar" style="width: {{ productividad_promedio|default(0) }}%"></div>
        </div>
        <div class="small text-muted mt-3">
            <i class="bi bi-arrow-up-right text-primary me-1"></i>
            5% vs mes anterior
        </div>
    </div>

    <div class="stat-card animate-fade-in" style="animation-delay: 1.5s; --stat-color: #ef4444;">
        <div class="stat-icon">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="stat-value">{{ equipos_alerta|default(0)|int }}</div>
        <span class="stat-label">Equipos con Alerta</span>
        <div class="small text-muted mb-3">
            de {{ detalle_equipos|default([])|length }} equipos totales
        </div>
        <div class="small text-danger">
            <i class="bi bi-exclamation-triangle me-1"></i>
            {% if detalle_equipos and detalle_equipos|length > 0 %}
                {{ ((equipos_alerta|default(0) / detalle_equipos|length) * 100)|round|int }}% del total
            {% else %}
                0% del total
            {% endif %}
        </div>
    </div>

    <div class="stat-card animate-fade-in" style="animation-delay: 1.6s; --stat-color: #f59e0b;">
        <div class="stat-icon">
            <i class="bi bi-clock-history"></i>
        </div>
        <div class="stat-value">{{ mtbf_promedio|default(0)|int }} h</div>
        <span class="stat-label">MTBF Promedio</span>
        <div class="small text-muted">Tiempo medio entre fallos</div>
        <div class="small text-warning mt-3">
            <i class="bi bi-trophy me-1"></i>
            Meta: 500h | 
            {% if mtbf_promedio|default(0) >= 500 %}
                <span class="text-success">✅ Logrado</span>
            {% else %}
                <span class="text-danger">❌ Pendiente</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- ===== GRÁFICOS DE PRODUCTIVIDAD ===== -->
{% if detalle_equipos and detalle_equipos|length > 0 and prod_labels and prod_labels|length > 0 %}
<div class="row g-4 mb-4">
    <div class="col-12 col-lg-8">
        <div class="chart-container animate-fade-in" style="animation-delay: 1.7s">
            <div class="chart-header">
                <div class="d-flex align-items-center gap-3">
                    <div class="chart-title-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                    <div>
                        <h6 class="chart-title mb-0">Productividad por Equipo (Top 10)</h6>
                        <small class="text-muted">Equipos con mayor rendimiento</small>
                    </div>
                </div>
                <span class="badge badge-light">Mes actual</span>
            </div>
            <canvas id="prodChart" height="120"></canvas>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="chart-container animate-fade-in" style="animation-delay: 1.8s">
            <div class="chart-header">
                <div class="d-flex align-items-center gap-3">
                    <div class="chart-title-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <i class="bi bi-pie-chart"></i>
                    </div>
                    <div>
                        <h6 class="chart-title mb-0">Distribución por Estado</h6>
                        <small class="text-muted">{{ detalle_equipos|length }} equipos totales</small>
                    </div>
                </div>
            </div>
            <canvas id="estadoChart" height="120"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- ===== TABLA DETALLADA ===== -->
<div class="data-table-container animate-fade-in" style="animation-delay: 1.9s">
    <div class="table-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h5 class="table-title">
                    <i class="bi bi-table me-2"></i>Detalle de Equipos
                </h5>
                <p class="table-subtitle">
                    {{ detalle_equipos|default([])|length }} equipos encontrados
                </p>
            </div>
            <div class="col-lg-4 mt-3 mt-lg-0">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" 
                           placeholder="Buscar equipo, área o estado..." id="table-search">
                </div>
            </div>
        </div>
    </div>
    
    {% if detalle_equipos and detalle_equipos|length > 0 %}
    <div class="table-responsive" style="max-height: 500px;">
        <table class="table table-hover mb-0" id="equipos-table">
            <thead>
                <tr class="table-light" style="position: sticky; top: 0; z-index: 10;">
                    <th class="py-3" style="width: 25%;">Equipo</th>
                    <th class="py-3" style="width: 10%;">Área</th>
                    <th class="py-3" style="width: 15%;">Productividad</th>
                    <th class="py-3" style="width: 10%;">Disponibilidad</th>
                    <th class="py-3" style="width: 10%;">MTBF</th>
                    <th class="py-3" style="width: 10%;">MTTR</th>
                    <th class="py-3" style="width: 10%;">Estado</th>
                    <th class="py-3" style="width: 10%; text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for row in detalle_equipos %}
                <tr class="equipo-row">
                    <td class="py-3">
                        <div class="d-flex align-items-center">
                            <div class="avatar me-3">
                                <i class="bi bi-cpu"></i>
                            </div>
                            <div>
                                <div class="fw-bold text-dark">{{ row.codigo or "Sin código" }}</div>
                                <small class="text-muted d-block">{{ row.descripcion|default("Sin descripción")|truncate(30) }}</small>
                            </div>
                        </div>
                    </td>
                    <td class="py-3">
                        <span class="badge badge-light">
                            {{ row.area|default("Sin área") }}
                        </span>
                    </td>
                    <td class="py-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="height: 10px; width: 100px;">
                                <div class="progress-bar 
                                    {% if row.productividad|default(0) >= 80 %}bg-success
                                    {% elif row.productividad|default(0) >= 60 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                    style="width: {{ row.productividad|default(0) }}%">
                                </div>
                            </div>
                            <span class="fw-bold {% if row.productividad|default(0) >= 80 %}text-success{% elif row.productividad|default(0) >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                {{ row.productividad|default(0) }}%
                            </span>
                        </div>
                    </td>
                    <td class="py-3">
                        <span class="fw-bold {% if row.disponibilidad|default(0) >= 90 %}text-success{% elif row.disponibilidad|default(0) >= 70 %}text-warning{% else %}text-danger{% endif %}">
                            {{ row.disponibilidad|default(0) }}%
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="badge badge-light">
                            <i class="bi bi-clock me-1"></i>{{ row.mtbf|default(0) }}h
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="badge badge-light">
                            <i class="bi bi-tools me-1"></i>{{ row.mttr|default(0) }}h
                        </span>
                    </td>
                    <td class="py-3">
                        {% if row.estado == 'Operativo' %}
                            <span class="status-badge status-normal">
                                <i class="bi bi-check-circle-fill"></i> {{ row.estado }}
                            </span>
                        {% elif row.estado == 'Mantenimiento' %}
                            <span class="status-badge status-warning">
                                <i class="bi bi-tools"></i> {{ row.estado }}
                            </span>
                        {% elif row.estado == 'Crítico' %}
                            <span class="status-badge status-critical">
                                <i class="bi bi-exclamation-triangle-fill"></i> {{ row.estado }}
                            </span>
                        {% else %}
                            <span class="status-badge status-idle">
                                <i class="bi bi-pause-circle"></i> {{ row.estado|default("Desconocido") }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="py-3" style="text-align: center;">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" data-tooltip="Ver detalles">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning" data-tooltip="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-info" data-tooltip="Historial">
                                <i class="bi bi-clock-history"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="p-3 border-top bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">
                Mostrando <span class="fw-bold">{{ detalle_equipos|length }}</span> de {{ detalle_equipos|length }} equipos
            </div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline active">1</button>
                <button type="button" class="btn btn-sm btn-outline">2</button>
                <button type="button" class="btn btn-sm btn-outline">3</button>
                <button type="button" class="btn btn-sm btn-outline">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="no-data py-5">
        <i class="bi bi-inbox no-data-icon"></i>
        <h6 class="no-data-title">No hay equipos disponibles</h6>
        <p class="no-data-subtitle">No se encontraron equipos con los filtros aplicados</p>
        <button class="btn-primary mt-3">
            <i class="bi bi-plus-circle me-2"></i> Agregar Nuevo Equipo
        </button>
    </div>
    {% endif %}
</div>

<!-- ===== SCRIPTS ÉPICOS ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0"></script>

<script>
// ============================================
// INICIALIZACIÓN Y CONFIGURACIÓN
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Dashboard MRO inicializado');
    
    // Inicializar animaciones de contadores
    initCounterAnimations();
    
    // Inicializar funcionalidades de UI
    initUIComponents();
    
    // Inicializar gráficos si hay datos
    initCharts();
    
    // Configurar actualización automática
    setupAutoRefresh();
});

// ============================================
// ANIMACIONES DE CONTADORES
// ============================================

function initCounterAnimations() {
    const counters = [
        { id: 'kpi_stock', value: parseInt(document.getElementById('kpi_stock')?.textContent || 0) },
        { id: 'kpi_bultos', value: parseInt(document.getElementById('kpi_bultos')?.textContent || 0) },
        { id: 'kpi_alertas', value: parseInt(document.getElementById('kpi_alertas')?.textContent || 0) },
        { id: 'kpi_tecnicos', value: parseInt(document.getElementById('kpi_tecnicos')?.textContent || 0) }
    ];

    counters.forEach(counter => {
        if (counter.value > 0) {
            animateCounter(counter.id, counter.value, 2000);
        }
    });
}

function animateCounter(elementId, finalValue, duration = 2000) {
    const element = document.getElementById(elementId);
    if (!element) return;

    const start = 0;
    const increment = finalValue / (duration / 16);
    let current = start;

    const timer = setInterval(() => {
        current += increment;
        if (current >= finalValue) {
            element.textContent = finalValue.toLocaleString();
            clearInterval(timer);
            
            // Efecto de pulso al completar
            element.classList.add('pulse');
            setTimeout(() => element.classList.remove('pulse'), 1000);
        } else {
            element.textContent = Math.floor(current).toLocaleString();
        }
    }, 16);
}

// ============================================
// COMPONENTES DE UI
// ============================================

function initUIComponents() {
    // Búsqueda en tabla
    const searchInput = document.getElementById('table-search');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.equipo-row');
            
            let visibleCount = 0;
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const isVisible = text.includes(searchTerm);
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            
            // Actualizar contador de resultados
            const counter = document.querySelector('.table-subtitle');
            if (counter) {
                counter.textContent = `${visibleCount} equipos encontrados`;
            }
        });
    }

    // Botón de reset
    const resetBtn = document.getElementById('btn-reset');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            document.querySelectorAll('.filter-select').forEach(select => {
                select.value = '';
            });
            document.getElementById('filterForm')?.submit();
        });
    }

    // Botón de refresh
    const refreshBtn = document.getElementById('btn-refresh');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            const btn = this;
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Actualizando...';
            btn.disabled = true;
            
            // Simular actualización
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                showNotification('Datos actualizados correctamente', 'success');
                
                // Recargar la página para obtener datos frescos
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }, 1500);
        });
    }

    // Botón de exportar
    const exportBtn = document.getElementById('btn-export');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            showNotification('Generando reporte de exportación...', 'info');
            setTimeout(() => {
                showNotification('Reporte exportado correctamente', 'success');
            }, 2000);
        });
    }

    // Tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-tooltip]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Smooth scroll para anchors
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });
}

// ============================================
// NOTIFICACIONES
// ============================================

function showNotification(message, type = 'info') {
    const types = {
        success: { icon: 'check-circle-fill', color: 'success' },
        error: { icon: 'exclamation-circle-fill', color: 'danger' },
        warning: { icon: 'exclamation-triangle-fill', color: 'warning' },
        info: { icon: 'info-circle-fill', color: 'info' }
    };
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${types[type].color} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center gap-2">
                <i class="bi bi-${types[type].icon}"></i>
                <span>${message}</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

// ============================================
// GRÁFICOS
// ============================================

function initCharts() {
    // Gráfico de líneas - Alertas
    {% if alertas_dias and alertas_dias|length > 0 %}
    initLineChart();
    {% endif %}
    
    // Gráfico de donut - Stock
    {% if criticos is defined and bajos is defined and normales is defined and vacios is defined and (criticos + bajos + normales + vacios) > 0 %}
    initDonutChart();
    {% endif %}
    
    // Mapa de calor
    {% if horas_bultos and horas_bultos|length > 0 %}
    initHeatmapChart();
    {% endif %}
    
    // Gráfico de barras - Productividad
    {% if prod_labels and prod_labels|length > 0 and prod_values and prod_values|length > 0 %}
    initProductivityChart();
    {% endif %}
    
    // Gráfico de estado
    {% if estado_labels and estado_labels|length > 0 and estado_values and estado_values|length > 0 %}
    initStateChart();
    {% endif %}
}

function initLineChart() {
    const ctx = document.getElementById('line_alertas');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ alertas_dias|default([])|tojson }},
            datasets: [{
                label: 'Alertas',
                data: {{ alertas_dias|default([])|tojson }},
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#ef4444',
                pointBorderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.98)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return `📊 Alertas: ${context.raw}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: 'rgba(0,0,0,0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                x: {
                    grid: { 
                        display: false 
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                }
            }
        }
    });
}

function initDonutChart() {
    const ctx = document.getElementById('donut_stock');
    if (!ctx) return;

    const data = {
        labels: ['Crítico', 'Bajo', 'Normal', 'Vacío'],
        datasets: [{
            data: [{{ criticos|default(0) }}, {{ bajos|default(0) }}, {{ normales|default(0) }}, {{ vacios|default(0) }}],
            backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#94a3b8'],
            borderWidth: 0,
            spacing: 10,
            borderRadius: 12,
            hoverOffset: 20
        }]
    };

    new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            cutout: '75%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((context.raw / total) * 100);
                            return `${context.label}: ${context.raw} unidades (${percentage}%)`;
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'centerText',
            afterDraw: (chart) => {
                const { ctx, chartArea: { width, height } } = chart;
                ctx.save();
                ctx.font = '900 28px Inter';
                ctx.fillStyle = '#1e293b';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('{{ total_stock|default(0) }}', width / 2, height / 2 - 15);
                
                ctx.font = '600 13px Inter';
                ctx.fillStyle = '#64748b';
                ctx.fillText('unidades', width / 2, height / 2 + 15);
                ctx.restore();
            }
        }]
    });
}

function initHeatmapChart() {
    const ctx = document.getElementById('heat_bultos');
    if (!ctx) return;

    const horas = {{ horas_bultos|default({})|tojson }};
    const labels = Object.keys(horas);
    const data = Object.values(horas);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: data.map(v => {
                    if (v > 30) return '#ef4444';
                    if (v > 20) return '#f59e0b';
                    if (v > 10) return '#fbbf24';
                    return '#10b981';
                }),
                borderRadius: 12,
                borderSkipped: false,
                borderWidth: 2,
                borderColor: 'rgba(255,255,255,0.5)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `📦 ${context.raw} bultos procesados`;
                        },
                        afterLabel: function(context) {
                            const v = context.raw;
                            if (v > 30) return '⚡ Horario de alta actividad';
                            if (v > 20) return '🔶 Horario de actividad media';
                            return '✅ Horario de actividad normal';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: 'rgba(0,0,0,0.05)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Bultos procesados',
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    }
                },
                x: {
                    grid: { 
                        display: false 
                    },
                    title: {
                        display: true,
                        text: 'Hora del día',
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    }
                }
            }
        }
    });
}

function initProductivityChart() {
    const ctx = document.getElementById('prodChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ prod_labels|default([])|tojson }},
            datasets: [{
                label: 'Productividad %',
                data: {{ prod_values|default([])|tojson }},
                backgroundColor: 'rgba(59, 130, 246, 0.9)',
                borderColor: '#3b82f6',
                borderWidth: 1,
                borderRadius: 10,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `📈 Productividad: ${context.raw}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { 
                        color: 'rgba(0,0,0,0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        },
                        font: {
                            weight: '600'
                        }
                    }
                },
                x: {
                    grid: { 
                        display: false 
                    },
                    ticks: {
                        font: {
                            weight: '600'
                        }
                    }
                }
            }
        }
    });
}

function initStateChart() {
    const ctx = document.getElementById('estadoChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: {{ estado_labels|default([])|tojson }},
            datasets: [{
                data: {{ estado_values|default([])|tojson }},
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#94a3b8'],
                borderWidth: 2,
                borderColor: '#fff',
                hoverOffset: 20
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 25,
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((context.raw / total) * 100);
                            return `🏭 ${context.label}: ${context.raw} equipos (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '40%'
        }
    });
}

// ============================================
// ACTUALIZACIÓN AUTOMÁTICA
// ============================================

function setupAutoRefresh() {
    // Actualizar badge de tiempo cada minuto
    setInterval(() => {
        const refreshBadge = document.querySelector('.badge-success');
        if (refreshBadge) {
            const text = refreshBadge.querySelector('.fw-bold');
            if (text) {
                // Alternar entre diferentes mensajes
                const messages = [
                    'Actualizado hace 1 min',
                    'Actualizado hace 2 min',
                    'Actualizado hace 3 min',
                    'Actualizado hace 4 min',
                    'Actualizado hace 5 min'
                ];
                const current = text.textContent;
                const nextIndex = (messages.indexOf(current) + 1) % messages.length;
                text.textContent = messages[nextIndex];
                
                // Efecto de pulso
                refreshBadge.classList.remove('pulse');
                void refreshBadge.offsetWidth;
                refreshBadge.classList.add('pulse');
            }
        }
    }, 60000); // Cada minuto
}

// ============================================
// EFECTOS VISUALES
// ============================================

// Efecto de carga inicial
window.addEventListener('load', function() {
    document.body.classList.add('loaded');
    
    // Añadir clase animada a los elementos con delay
    const animatedElements = document.querySelectorAll('.animate-fade-in, .animate-fade');
    animatedElements.forEach((el, index) => {
        const delay = parseFloat(el.style.animationDelay || '0s');
        setTimeout(() => {
            el.style.opacity = '1';
        }, delay * 1000 + 100);
    });
});

// Efecto de scroll para cards
window.addEventListener('scroll', function() {
    const cards = document.querySelectorAll('.kpi-card, .stat-card, .chart-container');
    cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const isVisible = (rect.top <= window.innerHeight * 0.8);
        if (isVisible) {
            card.classList.add('animate-fade');
        }
    });
});

// ============================================
// ESTILOS DINÁMICOS
// ============================================

// Añadir estilos para spinner
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    body.loaded * {
        animation-play-state: running !important;
    }
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }
    .table-responsive::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
`;
document.head.appendChild(style);

console.log('✅ Dashboard MRO completamente inicializado');
</script>

{% endblock %}
