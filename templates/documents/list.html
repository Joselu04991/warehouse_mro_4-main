<!-- templates/documents/list.html -->
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>üìã Extracci√≥n de Datos para Excel</h2>
    
    <div class="card">
        <div class="card-body">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle me-2"></i>¬øC√≥mo funciona?</h5>
                <p>Sube documentos (PDF/im√°genes) y el sistema extraer√° autom√°ticamente estos 9 campos:</p>
                
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Col</th>
                                <th>Nombre exacto</th>
                                <th>Ejemplo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>A</td><td>N¬∞ de Gu√≠a</td><td>852752</td></tr>
                            <tr><td>B</td><td>Fecha</td><td>14/01/2026</td></tr>
                            <tr><td>C</td><td>CANTIDAD DE PRESENTACION</td><td>31880</td></tr>
                            <tr><td>D</td><td>Unidad (kg)</td><td>KG</td></tr>
                            <tr><td>E</td><td>Material</td><td>OXIDO DE CALCIO</td></tr>
                            <tr><td>F</td><td>N√∫mero de RUC del PROVEEDOR</td><td>2040288554B</td></tr>
                            <tr><td>G</td><td>N√∫mero de RUC del transportista</td><td>-</td></tr>
                            <tr><td>H</td><td>Placa del veh√≠culo</td><td>CDL-733</td></tr>
                            <tr><td>I</td><td>N√∫mero de licencia de conducir del conductor</td><td>46695131</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Formulario de subida -->
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Subir Documentos</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar archivos:</label>
                            <input type="file" class="form-control" id="documentFiles" 
                                   name="files" multiple 
                                   accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
                                   required>
                            <div class="form-text">Puedes seleccionar m√∫ltiples archivos (PDF, JPG, PNG, etc.)</div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg" onclick="uploadDocuments()" id="uploadButton">
                                <i class="fas fa-upload me-2"></i>Subir y Extraer Datos
                            </button>
                        </div>
                    </form>
                    
                    <!-- Resultados -->
                    <div id="resultsContainer" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Resultados de Extracci√≥n</h5>
                            </div>
                            <div class="card-body">
                                <div id="resultsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Instrucciones -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Instrucciones</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li>Sube tus documentos (tickets, gu√≠as, facturas)</li>
                        <li>El sistema extraer√° autom√°ticamente los 9 campos</li>
                        <li>Copia el texto generado</li>
                        <li>Pega en tu Excel en la fila correspondiente</li>
                        <li>Los datos se pegar√°n cada uno en su columna correcta</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Nota importante:</h6>
                        <p class="mb-0">El sistema muestra los datos en formato <strong>tabulado</strong> para que al pegarlo en Excel, cada valor vaya a su columna correspondiente (A, B, C, etc.).</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function uploadDocuments() {
    const files = document.getElementById('documentFiles').files;
    if (files.length === 0) {
        alert('Por favor, selecciona al menos un archivo');
        return;
    }
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    
    // Mostrar carga
    const button = document.getElementById('uploadButton');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    button.disabled = true;
    
    // Mostrar contenedor
    document.getElementById('resultsContainer').style.display = 'block';
    document.getElementById('resultsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Procesando...</span>
            </div>
            <p class="mt-2">Extrayendo datos de ${files.length} documento(s)...</p>
        </div>
    `;
    
    fetch('{{ url_for("warehouse_documents.upload_documents") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Respuesta:', data);
        
        let html = '';
        if (data.success) {
            html += `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Extracci√≥n Completada</h5>
                    <p>Se procesaron ${data.total_files} archivos. 
                       <strong>Exitosos:</strong> ${data.successful} | 
                       <strong>Fallidos:</strong> ${data.failed}</p>
                </div>
            `;
            
            // Mostrar resultados por archivo
            data.resultados.forEach((resultado, index) => {
                html += `<div class="card mb-3 ${resultado.success ? 'border-success' : 'border-danger'}">`;
                html += `<div class="card-header ${resultado.success ? 'bg-success text-white' : 'bg-danger text-white'}">`;
                html += `<strong>${resultado.filename}</strong>`;
                html += `<span class="badge ${resultado.success ? 'bg-light text-success' : 'bg-warning text-dark'} float-end">`;
                html += resultado.success ? '‚úÖ √âXITO' : '‚ùå ERROR';
                html += `</span></div>`;
                html += `<div class="card-body">`;
                
                if (resultado.success) {
                    // Mostrar campos extra√≠dos
                    html += `<h6>Campos extra√≠dos (${resultado.porcentaje_exito}):</h6>`;
                    html += `<div class="table-responsive">`;
                    html += `<table class="table table-sm">`;
                    html += `<thead><tr><th>Campo</th><th>Valor</th></tr></thead>`;
                    html += `<tbody>`;
                    
                    const campos = [
                        'N¬∞ de Gu√≠a', 'Fecha', 'CANTIDAD DE PRESENTACION', 
                        'Unidad (kg)', 'Material', 'N√∫mero de RUC del PROVEEDOR',
                        'N√∫mero de RUC del transportista', 'Placa del veh√≠culo',
                        'N√∫mero de licencia de conducir del conductor'
                    ];
                    
                    campos.forEach(campo => {
                        const valor = resultado.campos_extraidos[campo] || 
                                     (resultado.campos_faltantes.includes(campo) ? 
                                      '<span class="text-danger">No encontrado</span>' : 
                                      '<span class="text-muted">-</span>');
                        html += `<tr><td><strong>${campo}</strong></td><td>${valor}</td></tr>`;
                    });
                    
                    html += `</tbody></table></div>`;
                    
                    // √Årea para copiar
                    html += `<h6 class="mt-3">üìã Para copiar y pegar en Excel:</h6>`;
                    html += `<div class="input-group mb-2">`;
                    html += `<textarea class="form-control font-monospace" rows="2" id="texto_${index}" readonly>${resultado.texto_copiable || ''}</textarea>`;
                    html += `<button class="btn btn-outline-primary" type="button" onclick="copiarTexto(${index})">`;
                    html += `<i class="fas fa-copy"></i> Copiar</button>`;
                    html += `</div>`;
                    html += `<small class="text-muted">Copia este texto y p√©guelo en la fila correspondiente de su Excel</small>`;
                    
                } else {
                    html += `<div class="alert alert-danger mb-0">`;
                    html += `<p><strong>Error:</strong> ${resultado.error || 'Error desconocido'}</p>`;
                    html += `</div>`;
                }
                
                html += `</div></div>`;
            });
            
        } else {
            html += `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Error en la Extracci√≥n</h5>
                    <p>${data.error || 'No se pudo extraer datos de ning√∫n documento'}</p>
                </div>
            `;
        }
        
        document.getElementById('resultsContent').innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('resultsContent').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error de Conexi√≥n</h5>
                <p>No se pudo conectar con el servidor.</p>
                <p>Verifica tu conexi√≥n a internet.</p>
            </div>
        `;
    })
    .finally(() => {
        // Restaurar bot√≥n
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function copiarTexto(index) {
    const textarea = document.getElementById(`texto_${index}`);
    textarea.select();
    textarea.setSelectionRange(0, 99999); // Para m√≥viles
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            // Mostrar notificaci√≥n
            const originalText = textarea.nextElementSibling.innerHTML;
            textarea.nextElementSibling.innerHTML = '<i class="fas fa-check"></i> ¬°Copiado!';
            setTimeout(() => {
                textarea.nextElementSibling.innerHTML = originalText;
            }, 2000);
        }
    } catch (err) {
        console.error('Error al copiar:', err);
    }
}

// Probar con ejemplo
function probarEjemplo() {
    fetch('{{ url_for("warehouse_documents.test_parser") }}')
        .then(response => response.json())
        .then(data => {
            alert('‚úÖ Parser funcionando\n\nTexto copiable:\n' + data.texto_copiable);
        })
        .catch(error => {
            alert('‚ùå Error: ' + error.message);
        });
}
</script>
{% endblock %}
