<!-- templates/documents/list.html - ACTUALIZADO CON PROCESAMIENTO REAL -->
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>üìÑ Documentos de Almac√©n</h2>
    
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h4>Procesamiento Autom√°tico de Documentos</h4>
                    <p class="lead">Sube tickets, facturas o gu√≠as y obt√©n un Excel organizado autom√°ticamente</p>
                    
                    <div class="alert alert-success">
                        <h5>‚úÖ Informaci√≥n que extraemos:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li>N√∫mero de proceso</li>
                                    <li>Proveedor</li>
                                    <li>Conductor</li>
                                    <li>Placa del veh√≠culo</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li>Pesos (tara, bruto, neto)</li>
                                    <li>Producto/material</li>
                                    <li>Fechas</li>
                                    <li>RUC/DNI</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5>üìä Formatos Soportados</h5>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <span class="badge bg-primary">PDF</span>
                                <span class="badge bg-primary">JPG</span>
                                <span class="badge bg-primary">PNG</span>
                                <span class="badge bg-primary">BMP</span>
                                <span class="badge bg-primary">TIFF</span>
                            </div>
                            <p class="small text-muted">Tama√±o m√°ximo: 16MB por archivo</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Formulario de subida -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Subir Documentos</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar archivos:</label>
                            <input type="file" class="form-control" id="documentFiles" 
                                   name="files" multiple 
                                   accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff"
                                   required>
                            <div class="form-text">Puedes seleccionar m√∫ltiples archivos a la vez</div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Tipos de documentos aceptados:</h6>
                            <ul class="mb-0">
                                <li>Tickets de pesaje/b√°scula</li>
                                <li>Gu√≠as de remisi√≥n/traslado</li>
                                <li>Facturas de proveedores</li>
                                <li>Bauchers de recepci√≥n</li>
                            </ul>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button type="button" class="btn btn-primary btn-lg px-4" onclick="uploadDocuments()" id="uploadButton">
                                <i class="fas fa-upload me-2"></i>Subir y Procesar
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="testAPI()">
                                <i class="fas fa-vial me-2"></i>Probar API
                            </button>
                        </div>
                    </form>
                    
                    <!-- Resultados -->
                    <div id="resultsContainer" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Resultados del Procesamiento</h5>
                            </div>
                            <div class="card-body">
                                <div id="resultsContent"></div>
                                <div id="downloadSection" style="display: none;" class="mt-3">
                                    <hr>
                                    <h6><i class="fas fa-file-excel text-success me-2"></i>Excel Generado</h6>
                                    <p>Tu archivo Excel est√° listo para descargar con todos los datos organizados.</p>
                                    <a href="#" id="downloadLink" class="btn btn-success">
                                        <i class="fas fa-download me-2"></i>Descargar Excel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ejemplos -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-images me-2"></i>Ejemplos de Documentos</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-weight fa-3x text-primary mb-3"></i>
                                    <h6>Ticket de Pesaje</h6>
                                    <p class="small">Extrae: Pesos, placa, conductor, fechas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-truck fa-3x text-warning mb-3"></i>
                                    <h6>Gu√≠a de Remisi√≥n</h6>
                                    <p class="small">Extrae: Proveedor, producto, direcciones</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-invoice-dollar fa-3x text-success mb-3"></i>
                                    <h6>Factura</h6>
                                    <p class="small">Extrae: RUC, montos, productos, fechas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentExcelUrl = null;

function uploadDocuments() {
    const files = document.getElementById('documentFiles').files;
    if (files.length === 0) {
        alert('Por favor, selecciona al menos un archivo');
        return;
    }
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    
    // Mostrar indicador de carga
    const button = document.getElementById('uploadButton');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    button.disabled = true;
    
    // Mostrar contenedor de resultados
    document.getElementById('resultsContainer').style.display = 'block';
    document.getElementById('resultsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Procesando...</span>
            </div>
            <p class="mt-2">Procesando ${files.length} documento(s)...</p>
        </div>
    `;
    
    fetch('{{ url_for("warehouse_documents.upload_documents") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Respuesta:', data);
        
        let html = '';
        if (data.success) {
            html += `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Procesamiento Completado</h5>
                    <p>${data.message}</p>
                    <p><strong>Total:</strong> ${data.total_files} archivos | 
                       <strong>Exitosos:</strong> ${data.successful} | 
                       <strong>Fallidos:</strong> ${data.failed}</p>
                </div>
            `;
            
            // Mostrar detalles de cada archivo
            if (data.results && data.results.length > 0) {
                html += `<h6>Detalles por archivo:</h6><div class="list-group">`;
                data.results.forEach((result, index) => {
                    if (result.success) {
                        html += `
                            <div class="list-group-item list-group-item-success">
                                <div class="d-flex w-100 justify-content-between">
                                    <strong>${result.filename}</strong>
                                    <span class="badge bg-success">√âXITO</span>
                                </div>
                                <small>P√°ginas: ${result.pages} | Texto extra√≠do: ${result.text_length} caracteres</small>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="list-group-item list-group-item-danger">
                                <div class="d-flex w-100 justify-content-between">
                                    <strong>${result.filename}</strong>
                                    <span class="badge bg-danger">ERROR</span>
                                </div>
                                <small>Error: ${result.error}</small>
                            </div>
                        `;
                    }
                });
                html += `</div>`;
            }
            
            // Mostrar bot√≥n de descarga si hay Excel
            if (data.excel_generated) {
                currentExcelUrl = data.excel_url;
                document.getElementById('downloadSection').style.display = 'block';
                document.getElementById('downloadLink').href = data.excel_url;
                document.getElementById('downloadLink').download = data.excel_filename;
            }
            
        } else {
            html += `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Error en el Procesamiento</h5>
                    <p>${data.error || 'Error desconocido'}</p>
                </div>
            `;
        }
        
        document.getElementById('resultsContent').innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('resultsContent').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error de Conexi√≥n</h5>
                <p>No se pudo conectar con el servidor. Error: ${error.message}</p>
                <p>Verifica tu conexi√≥n a internet o intenta nuevamente.</p>
            </div>
        `;
    })
    .finally(() => {
        // Restaurar bot√≥n
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function testAPI() {
    fetch('{{ url_for("warehouse_documents.test_endpoint") }}')
        .then(response => response.json())
        .then(data => {
            alert('‚úÖ API funcionando correctamente\n\n' + JSON.stringify(data, null, 2));
        })
        .catch(error => {
            alert('‚ùå Error probando API: ' + error.message);
        });
}

// Descargar Excel cuando se hace clic
document.getElementById('downloadLink')?.addEventListener('click', function(e) {
    if (currentExcelUrl) {
        // Forzar descarga
        const link = document.createElement('a');
        link.href = currentExcelUrl;
        link.download = 'documentos_procesados.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
});
</script>
{% endblock %}
