{% extends "base.html" %}
{% block title %}Crear Nueva Tarea{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">‚ûï Crear Nueva Tarea</h4>
                </div>
                
                <div class="card-body">
                    <form method="POST" action="{{ url_for('tasks.create_task') }}">
                        
                        <!-- T√≠tulo -->
                        <div class="mb-3">
                            <label for="titulo" class="form-label fw-bold">üìù T√≠tulo de la Tarea</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="titulo" 
                                   name="titulo" 
                                   placeholder="Ej: Revisar inventario del almac√©n A"
                                   required
                                   minlength="3">
                            <div class="form-text">M√≠nimo 3 caracteres. Sea claro y descriptivo.</div>
                        </div>
                        
                        <!-- Descripci√≥n -->
                        <div class="mb-3">
                            <label for="descripcion" class="form-label fw-bold">üìã Descripci√≥n</label>
                            <textarea class="form-control" 
                                      id="descripcion" 
                                      name="descripcion" 
                                      rows="4"
                                      placeholder="Describa los detalles de la tarea..."></textarea>
                            <div class="form-text">Opcional. Puede incluir instrucciones espec√≠ficas.</div>
                        </div>
                        
                        <!-- Asignar a -->
                        <div class="mb-3">
                            <label for="assigned_to" class="form-label fw-bold">üë§ Asignar a</label>
                            <select class="form-select" id="assigned_to" name="assigned_to" required>
                                <option value="">Seleccione un usuario...</option>
                                
                                <!-- Grupo: Administradores -->
                                <optgroup label="üëë Administradores">
                                    {% for usuario in usuarios if usuario.role in ['owner', 'admin'] %}
                                    <option value="{{ usuario.id }}" 
                                            {% if usuario.id == current_user.id %}selected{% endif %}>
                                        {{ usuario.username }} 
                                        {% if usuario.role == 'owner' %}(Owner){% endif %}
                                        {% if usuario.role == 'admin' %}(Admin){% endif %}
                                        {% if usuario.id == current_user.id %}‚Üê T√∫{% endif %}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                                
                                <!-- Grupo: T√©cnicos -->
                                <optgroup label="üîß T√©cnicos">
                                    {% for usuario in usuarios if usuario.role == 'tecnico' %}
                                    <option value="{{ usuario.id }}">
                                        {{ usuario.username }} (T√©cnico)
                                    </option>
                                    {% endfor %}
                                </optgroup>
                                
                                <!-- Grupo: Otros -->
                                <optgroup label="üë• Otros">
                                    {% for usuario in usuarios if usuario.role not in ['owner', 'admin', 'tecnico'] %}
                                    <option value="{{ usuario.id }}">
                                        {{ usuario.username }} ({{ usuario.role }})
                                    </option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                            <div class="form-text">Seleccione al responsable de la tarea.</div>
                        </div>
                        
                        <!-- Fecha l√≠mite -->
                        <div class="mb-4">
                            <label for="fecha_limite" class="form-label fw-bold">üìÖ Fecha L√≠mite</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="fecha_limite" 
                                   name="fecha_limite" 
                                   min="{{ fecha_minima }}"
                                   required>
                            <div class="form-text">La fecha no puede ser anterior a hoy.</div>
                        </div>
                        
                        <!-- Botones -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('tasks.my_tasks') }}" class="btn btn-secondary">
                                ‚Ü©Ô∏è Volver a mis tareas
                            </a>
                            <button type="submit" class="btn btn-primary">
                                ‚úÖ Crear Tarea
                            </button>
                        </div>
                        
                    </form>
                </div>
            </div>
            
            <!-- Informaci√≥n adicional -->
            <div class="card mt-3 border-info">
                <div class="card-body">
                    <h6 class="text-info">üí° Informaci√≥n importante:</h6>
                    <ul class="mb-0 small">
                        <li>Puedes asignar tareas a cualquier usuario activo del sistema.</li>
                        <li>Los usuarios recibir√°n notificaciones de nuevas tareas asignadas.</li>
                        <li>El sistema asignar√° puntaje autom√°ticamente al completar tareas.</li>
                        <li>Las tareas vencidas afectan negativamente el puntaje.</li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script>
// Script para mejorar la experiencia del usuario
document.addEventListener('DOMContentLoaded', function() {
    // Establecer fecha m√≠nima como hoy
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_limite').min = today;
    
    // Auto-seleccionar al usuario actual si no hay selecci√≥n
    const selectUsuario = document.getElementById('assigned_to');
    if (selectUsuario.value === '') {
        // Buscar opci√≥n que contenga "‚Üê T√∫"
        for (let option of selectUsuario.options) {
            if (option.text.includes('‚Üê T√∫')) {
                selectUsuario.value = option.value;
                break;
            }
        }
    }
    
    // Validaci√≥n en tiempo real del t√≠tulo
    const inputTitulo = document.getElementById('titulo');
    inputTitulo.addEventListener('input', function() {
        if (this.value.length < 3) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
});
</script>

<style>
.optgroup {
    font-weight: bold;
    font-size: 0.9em;
    color: #495057;
    padding: 5px 0;
}
.optgroup option {
    font-weight: normal;
    padding-left: 20px;
}
</style>
{% endblock %}
