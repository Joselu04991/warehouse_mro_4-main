{% extends "base.html" %}
{% block content %}

<style>
    /* ================= VARIABLES Y ESTILOS GENERALES ================= */
    :root {
        --primary: #1a5f7a;
        --primary-light: rgba(26, 95, 122, 0.1);
        --secondary: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #343a40;
        
        --primary-gradient: linear-gradient(135deg, #1a5f7a 0%, #0d4c6e 100%);
        --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --warning-gradient: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        --danger-gradient: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        --info-gradient: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        --dark-gradient: linear-gradient(135deg, #343a40 0%, #212529 100%);
        
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 8px;
    }

    .dashboard-container {
        padding: 20px;
        background: #f8fafc;
        min-height: calc(100vh - 80px);
    }

    /* ================= HEADER COMPACTO ================= */
    .dashboard-header {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .header-title h1 {
        font-weight: 700;
        color: var(--primary);
        margin: 0;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .header-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        padding-top: 15px;
        border-top: 1px solid #f1f5f9;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }

    .stat-info h4 {
        margin: 0;
        font-weight: 700;
        font-size: 1.5rem;
        line-height: 1.2;
    }

    .stat-info span {
        font-size: 0.85rem;
        color: #6c757d;
        display: block;
    }

    /* ================= LAYOUT PRINCIPAL ================= */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        margin-bottom: 20px;
    }

    .main-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* ================= KPI CARDS COMPACTAS ================= */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .kpi-card {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        min-height: auto;
    }

    .kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    .kpi-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
    }

    .kpi-content {
        flex: 1;
    }

    .kpi-value {
        font-size: 1.8rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 5px;
        color: var(--dark);
    }

    .kpi-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    /* ================= CHART SECTION COMPACTA ================= */
    .chart-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .chart-card {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        height: 100%;
    }

    .chart-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-title {
        font-weight: 600;
        color: var(--dark);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-title i {
        color: var(--primary);
    }

    .chart-body {
        padding: 15px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-body canvas {
        width: 100% !important;
        height: 100% !important;
    }

    /* ================= SIDEBAR WIDGETS ================= */
    .widget {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        overflow: hidden;
    }

    .widget-header {
        padding: 15px 20px;
        background: var(--primary-gradient);
        color: white;
    }

    .widget-header h5 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .widget-body {
        padding: 15px;
    }

    /* Stock Status Widget */
    .status-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .status-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        background: #f8f9fa;
        transition: all 0.2s;
    }

    .status-item:hover {
        background: #e9ecef;
    }

    .status-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
    }

    /* Quick Actions Widget */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .action-btn {
        padding: 12px;
        border: 1px solid #dee2e6;
        border-radius: var(--radius-sm);
        background: white;
        color: var(--dark);
        text-align: center;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        text-decoration: none;
        cursor: pointer;
    }

    .action-btn:hover {
        background: var(--primary-light);
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    .action-btn i {
        font-size: 1.2rem;
        color: var(--primary);
    }

    .action-btn span {
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* ================= TABLA COMPACTA ================= */
    .table-card {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        margin-top: 0;
    }

    .table-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .table-title {
        font-weight: 600;
        color: var(--dark);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-container {
        position: relative;
        min-width: 250px;
    }

    .search-input {
        width: 100%;
        padding: 8px 16px 8px 36px;
        border: 1px solid #e2e8f0;
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        transition: all 0.2s;
        background: #f8fafc;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        background: white;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
    }

    /* Tabla */
    .dashboard-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
    }

    .dashboard-table thead {
        background: #f1f5f9;
        position: sticky;
        top: 0;
    }

    .dashboard-table th {
        color: #4a5568;
        font-weight: 600;
        padding: 12px 15px;
        border-bottom: 2px solid #e2e8f0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.8rem;
    }

    .dashboard-table td {
        padding: 12px 15px;
        color: #2d3748;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
    }

    .dashboard-table tbody tr:hover {
        background-color: #f8fafc;
    }

    /* Badges en tabla */
    .stock-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        min-width: 70px;
    }

    .badge-critical { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
    .badge-low { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #212529; }
    .badge-ok { background: linear-gradient(135deg, #28a745, #20c997); color: white; }

    /* ================= MODALES ================= */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-md);
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        margin-bottom: 20px;
    }

    .modal-header h3 {
        margin: 0;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-body {
        margin-bottom: 25px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    /* ================= REPORT MODAL ================= */
    .report-options {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .option-group {
        border: 1px solid #dee2e6;
        border-radius: var(--radius-sm);
        padding: 15px;
    }

    .option-group h5 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--primary);
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }

    .checkbox-item label {
        margin: 0;
        font-weight: 500;
    }

    /* ================= SETTINGS MODAL ================= */
    .settings-options {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: var(--radius-sm);
    }

    .setting-info h5 {
        margin: 0 0 5px 0;
    }

    .setting-info p {
        margin: 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 1200px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }
        
        .chart-row {
            grid-template-columns: 1fr;
        }
        
        .header-top {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .header-actions {
            width: 100%;
            justify-content: flex-start;
        }
        
        .search-container {
            width: 100%;
        }
        
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .modal-content {
            width: 95%;
            padding: 20px;
        }
    }

    @media (max-width: 576px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-body {
            height: 180px;
        }
        
        .header-stats {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            grid-template-columns: 1fr;
        }
        
        .quick-actions {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .modal-content {
            width: 100%;
            height: 100vh;
            max-height: 100vh;
            border-radius: 0;
        }
    }

    /* ================= ANIMACIONES ================= */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    /* ================= LOADING SPINNER ================= */
    .spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ================= TOAST NOTIFICATIONS ================= */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast {
        min-width: 300px;
        background: white;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
</style>

<!-- MODALES -->
<div id="reportModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="bi bi-file-earmark-text"></i> Generar Reporte</h3>
        </div>
        <div class="modal-body">
            <div class="report-options">
                <div class="option-group">
                    <h5>Seleccionar Tipo de Reporte</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" id="report-summary" name="report-type" value="summary" checked>
                            <label for="report-summary">Resumen General</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="report-detailed" name="report-type" value="detailed">
                            <label for="report-detailed">Detallado Completo</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="report-critical" name="report-type" value="critical">
                            <label for="report-critical">Stock Cr칤tico</label>
                        </div>
                    </div>
                </div>
                
                <div class="option-group">
                    <h5>Incluir Secciones</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="section-kpis" checked>
                            <label for="section-kpis">KPIs y Estad칤sticas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="section-charts" checked>
                            <label for="section-charts">Gr치ficos y Visualizaciones</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="section-table" checked>
                            <label for="section-table">Tabla de Inventario</label>
                        </div>
                    </div>
                </div>
                
                <div class="option-group">
                    <h5>Formato de Salida</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" id="format-pdf" name="output-format" value="pdf" checked>
                            <label for="format-pdf">PDF</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="format-excel" name="output-format" value="excel">
                            <label for="format-excel">Excel</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="format-csv" name="output-format" value="csv">
                            <label for="format-csv">CSV</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('reportModal')">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="generateReport()">
                <i class="bi bi-download"></i> Generar Reporte
            </button>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="bi bi-gear"></i> Configuraci칩n del Dashboard</h3>
        </div>
        <div class="modal-body">
            <div class="settings-options">
                <div class="setting-item">
                    <div class="setting-info">
                        <h5>Actualizaci칩n Autom치tica</h5>
                        <p>Actualizar datos cada 30 segundos</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked 
                               onchange="toggleAutoRefresh(this.checked)">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h5>Mostrar Notificaciones</h5>
                        <p>Mostrar alertas de cambios importantes</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showNotifications" checked
                               onchange="toggleNotifications(this.checked)">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h5>Modo Oscuro</h5>
                        <p>Cambiar tema a modo oscuro</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="darkMode"
                               onchange="toggleDarkMode(this.checked)">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h5>Ordenar Tabla</h5>
                        <p>Ordenar items por stock (descendente)</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="sortTable" checked
                               onchange="toggleTableSort(this.checked)">
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('settingsModal')">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="saveSettings()">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- MAIN DASHBOARD -->
<div class="dashboard-container">
    <!-- ================= HEADER COMPACTO ================= -->
    <div class="dashboard-header fade-in">
        <div class="header-top">
            <div class="header-title">
                <h1>
                    <i class="bi bi-speedometer2"></i>
                    Dashboard de Inventario
                </h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="updateDashboard()">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
                <button class="btn btn-sm btn-primary" onclick="showExportModal()">
                    <i class="bi bi-download"></i> Exportar
                </button>
            </div>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--primary-gradient);">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="stat-info">
                    <h4 id="totalItems">{{ items|length if items else 0 }}</h4>
                    <span>Total Materiales</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--danger-gradient);">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    {% set criticos = items|selectattr('libre_utilizacion', 'defined')|selectattr('libre_utilizacion', '<=', 0)|list|length if items else 0 %}
                    <h4 id="criticalItems">{{ criticos }}</h4>
                    <span>Stock Cr칤tico</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--warning-gradient);">
                    <i class="bi bi-exclamation-circle"></i>
                </div>
                <div class="stat-info">
                    {% set bajos = items|selectattr('libre_utilizacion', 'defined')|selectattr('libre_utilizacion', '>', 0)|selectattr('libre_utilizacion', '<', 10)|list|length if items else 0 %}
                    <h4 id="lowItems">{{ bajos }}</h4>
                    <span>Stock Bajo</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--success-gradient);">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-info">
                    {% set normales = items|selectattr('libre_utilizacion', 'defined')|selectattr('libre_utilizacion', '>=', 10)|list|length if items else 0 %}
                    <h4 id="okItems">{{ normales }}</h4>
                    <span>Stock Normal</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= LAYOUT PRINCIPAL ================= -->
    <div class="dashboard-layout fade-in">
        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-content">
            <!-- KPI CARDS -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--primary-gradient);">
                        <i class="bi bi-geo-alt"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalLocations">0</div>
                        <div class="kpi-label">Ubicaciones 칔nicas</div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--info-gradient);">
                        <i class="bi bi-calculator"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalStock">0</div>
                        <div class="kpi-label">Stock Total</div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--dark-gradient);">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="avgStock">0</div>
                        <div class="kpi-label">Promedio por Item</div>
                    </div>
                </div>
            </div>

            <!-- GR츼FICOS -->
            <div class="chart-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-pie-chart"></i>
                            Distribuci칩n por Estado
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                    onclick="toggleChartType('pie')">
                                <i class="bi bi-arrows-angle-expand" id="pieChartIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="estadoChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-bar-chart"></i>
                            Stock por Ubicaci칩n
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                    onclick="toggleChartType('bar')">
                                <i class="bi bi-arrows-angle-expand" id="barChartIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="ubicacionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TABLA DE INVENTARIO -->
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">
                        <i class="bi bi-table"></i>
                        Inventario Detallado
                        <span id="filteredCount" class="badge bg-secondary">{{ items|length if items else 0 }}</span>
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        <div class="search-container">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="searchInv" class="search-input" 
                                   placeholder="Buscar material, ubicaci칩n...">
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()" title="Limpiar filtros">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="toggleTableView()" title="Cambiar vista">
                            <i class="bi bi-list-ul"></i>
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="dashboard-table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)" style="cursor: pointer;">
                                    C칩digo <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th onclick="sortTable(1)" style="cursor: pointer;">
                                    Descripci칩n <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th onclick="sortTable(2)" style="cursor: pointer;">
                                    Ubicaci칩n <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th onclick="sortTable(3)" style="cursor: pointer;">
                                    Stock <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            {% if items and items|length > 0 %}
                                {% for item in items %}
                                {% set stock = item.libre_utilizacion if item.libre_utilizacion is defined else 0 %}
                                <tr class="inventory-row" 
                                    data-code="{{ item.material_code|default('', true) }}"
                                    data-desc="{{ item.material_text|default('', true) }}"
                                    data-location="{{ item.location|default('Sin ubicaci칩n', true) }}"
                                    data-stock="{{ stock }}">
                                    <td class="fw-semibold">{{ item.material_code|default('N/A', true) }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" 
                                             title="{{ item.material_text|default('', true) }}">
                                            {{ item.material_text|default('Sin descripci칩n', true) }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-dark">{{ item.location|default('Sin ubicaci칩n', true) }}</span>
                                    </td>
                                    <td class="fw-bold {% if stock <= 0 %}text-danger{% elif stock < 10 %}text-warning{% else %}text-success{% endif %}">
                                        {{ stock }}
                                    </td>
                                    <td>
                                        {% if stock <= 0 %}
                                            <span class="stock-badge badge-critical">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Cr칤tico
                                            </span>
                                        {% elif stock < 10 %}
                                            <span class="stock-badge badge-low">
                                                <i class="bi bi-exclamation-circle me-1"></i>Bajo
                                            </span>
                                        {% else %}
                                            <span class="stock-badge badge-ok">
                                                <i class="bi bi-check-circle me-1"></i>OK
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="editItem('{{ item.material_code|default('', true) }}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="bi bi-inbox display-6"></i>
                                            <p class="mt-2 mb-3">No hay items de inventario</p>
                                            <a href="{{ url_for('inventory.upload_inventory') }}" class="btn btn-sm btn-primary">
                                                <i class="bi bi-upload me-1"></i>Cargar Inventario
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 d-flex justify-content-between align-items-center px-3">
                    <small class="text-muted" id="filterInfo">
                        Mostrando {{ items|length if items else 0 }} de {{ items|length if items else 0 }} items
                    </small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="exportTable('csv')">CSV</button>
                        <button class="btn btn-outline-secondary" onclick="exportTable('excel')">Excel</button>
                        <button class="btn btn-outline-secondary" onclick="printTable()">Imprimir</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- WIDGET: ESTADO DE STOCK -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-clipboard-data"></i> Resumen por Estado</h5>
                </div>
                <div class="widget-body">
                    <div class="status-list">
                        <div class="status-item">
                            <div class="status-label">
                                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                <span>Stock Cr칤tico</span>
                            </div>
                            <span class="status-badge" style="background: var(--danger-gradient);">
                                {{ criticos }}
                            </span>
                        </div>
                        <div class="status-item">
                            <div class="status-label">
                                <i class="bi bi-exclamation-circle-fill text-warning"></i>
                                <span>Stock Bajo</span>
                            </div>
                            <span class="status-badge" style="background: var(--warning-gradient);">
                                {{ bajos }}
                            </span>
                        </div>
                        <div class="status-item">
                            <div class="status-label">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <span>Stock Normal</span>
                            </div>
                            <span class="status-badge" style="background: var(--success-gradient);">
                                {{ normales }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDGET: ACCIONES R츼PIDAS -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-lightning-charge"></i> Acciones R치pidas</h5>
                </div>
                <div class="widget-body">
                    <div class="quick-actions">
                        <a href="{{ url_for('inventory.upload_inventory') }}" class="action-btn">
                            <i class="bi bi-upload"></i>
                            <span>Cargar Inventario</span>
                        </a>
                        <button class="action-btn" onclick="showExportOptions()">
                            <i class="bi bi-download"></i>
                            <span>Exportar Datos</span>
                        </button>
                        <button class="action-btn" onclick="openReportModal()">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>Generar Reporte</span>
                        </button>
                        <button class="action-btn" onclick="openSettingsModal()">
                            <i class="bi bi-gear"></i>
                            <span>Ajustes</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- WIDGET: TOP UBICACIONES -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-trophy"></i> Top Ubicaciones</h5>
                </div>
                <div class="widget-body">
                    <div id="topLocations">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                            <span class="ms-2">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- WIDGET: FILTROS R츼PIDOS -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-funnel"></i> Filtros R치pidos</h5>
                </div>
                <div class="widget-body">
                    <div class="d-flex flex-column gap-2">
                        <button class="btn btn-sm btn-outline-danger w-100" onclick="filterByStatus('critical')">
                            <i class="bi bi-exclamation-triangle me-1"></i>Stock Cr칤tico
                        </button>
                        <button class="btn btn-sm btn-outline-warning w-100" onclick="filterByStatus('low')">
                            <i class="bi bi-exclamation-circle me-1"></i>Stock Bajo
                        </button>
                        <button class="btn btn-sm btn-outline-success w-100" onclick="filterByStatus('ok')">
                            <i class="bi bi-check-circle me-1"></i>Stock Normal
                        </button>
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearStatusFilter()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar Filtro
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= JAVASCRIPT COMPLETO ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// ================= CONFIGURACI칍N GLOBAL =================
const config = {
    autoRefresh: true,
    refreshInterval: 30000,
    notifications: true,
    darkMode: false,
    tableSort: true,
    currentSort: { column: 3, direction: 'desc' }
};

let charts = {};
let inventoryData = [];
let filteredData = [];
let autoRefreshInterval = null;

// ================= INICIALIZACI칍N =================
document.addEventListener('DOMContentLoaded', function() {
    console.log('游 Inicializando dashboard completo...');
    
    // Inicializar componentes
    initDashboard();
    initModals();
    initSettings();
    
    // Configurar eventos
    setupEventListeners();
});

// ================= DASHBOARD FUNCTIONS =================
function initDashboard() {
    collectInventoryData();
    calculateMetrics();
    renderCharts();
    updateTopLocations();
    setupSearch();
    
    // Iniciar actualizaci칩n autom치tica si est치 habilitada
    if (config.autoRefresh) {
        startAutoRefresh();
    }
}

function collectInventoryData() {
    inventoryData = [];
    const rows = document.querySelectorAll('.inventory-row');
    rows.forEach(row => {
        const data = {
            code: row.dataset.code || '',
            desc: row.dataset.desc || '',
            location: row.dataset.location || 'Sin ubicaci칩n',
            stock: parseInt(row.dataset.stock) || 0,
            status: getStockStatus(parseInt(row.dataset.stock)),
            element: row
        };
        inventoryData.push(data);
    });
    filteredData = [...inventoryData];
    console.log(`游닍 ${inventoryData.length} items cargados`);
}

function getStockStatus(stock) {
    if (stock <= 0) return 'critical';
    if (stock < 10) return 'low';
    return 'ok';
}

function calculateMetrics() {
    if (inventoryData.length === 0) return;
    
    // Ubicaciones 칰nicas
    const locations = new Set(inventoryData.map(item => item.location));
    document.getElementById('totalLocations').textContent = locations.size;
    
    // Stock total
    const totalStock = inventoryData.reduce((sum, item) => sum + item.stock, 0);
    document.getElementById('totalStock').textContent = totalStock.toLocaleString();
    
    // Promedio por item
    const avgStock = totalStock / inventoryData.length;
    document.getElementById('avgStock').textContent = avgStock.toFixed(1);
}

function updateTopLocations() {
    if (inventoryData.length === 0) {
        document.getElementById('topLocations').innerHTML = '<p class="text-muted text-center">No hay datos</p>';
        return;
    }
    
    const locationMap = new Map();
    inventoryData.forEach(item => {
        if (!locationMap.has(item.location)) {
            locationMap.set(item.location, 0);
        }
        locationMap.set(item.location, locationMap.get(item.location) + item.stock);
    });
    
    const topLocations = Array.from(locationMap.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    const html = topLocations.map(([location, stock], index) => `
        <div class="d-flex align-items-center justify-content-between mb-2 pb-2 ${index < topLocations.length - 1 ? 'border-bottom' : ''}">
            <div class="d-flex align-items-center">
                <span class="badge bg-secondary me-2">${index + 1}</span>
                <span class="text-truncate" style="max-width: 150px;" title="${location}">
                    ${location}
                </span>
            </div>
            <span class="fw-bold text-primary">${stock}</span>
        </div>
    `).join('');
    
    document.getElementById('topLocations').innerHTML = html || '<p class="text-muted">No hay datos</p>';
}

// ================= CHART FUNCTIONS =================
function renderCharts() {
    renderEstadoChart();
    renderUbicacionChart();
}

function renderEstadoChart() {
    const ctx = document.getElementById('estadoChart');
    if (!ctx) return;
    
    const criticos = inventoryData.filter(item => item.stock <= 0).length;
    const bajos = inventoryData.filter(item => item.stock > 0 && item.stock < 10).length;
    const normales = inventoryData.filter(item => item.stock >= 10).length;
    
    if (charts.estado) {
        charts.estado.destroy();
    }
    
    charts.estado = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Cr칤tico', 'Bajo', 'Normal'],
            datasets: [{
                data: [criticos, bajos, normales],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.9)',
                    'rgba(255, 193, 7, 0.9)',
                    'rgba(40, 167, 69, 0.9)'
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(40, 167, 69, 1)'
                ],
                borderWidth: 1,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 11 }
                    }
                }
            },
            cutout: '65%'
        }
    });
}

function renderUbicacionChart() {
    const ctx = document.getElementById('ubicacionChart');
    if (!ctx) return;
    
    const locationMap = new Map();
    inventoryData.forEach(item => {
        if (!locationMap.has(item.location)) {
            locationMap.set(item.location, 0);
        }
        locationMap.set(item.location, locationMap.get(item.location) + item.stock);
    });
    
    const topLocations = Array.from(locationMap.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 7);
    
    if (charts.ubicacion) {
        charts.ubicacion.destroy();
    }
    
    charts.ubicacion = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topLocations.map(([location]) => location),
            datasets: [{
                label: 'Stock Total',
                data: topLocations.map(([, stock]) => stock),
                backgroundColor: 'rgba(23, 162, 184, 0.7)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { font: { size: 10 } }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 10 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

// ================= SEARCH AND FILTER FUNCTIONS =================
function setupSearch() {
    const searchInput = document.getElementById('searchInv');
    if (!searchInput) return;
    
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterInventory(this.value.toLowerCase().trim());
        }, 300);
    });
}

function filterInventory(searchTerm) {
    if (!searchTerm) {
        filteredData = [...inventoryData];
        inventoryData.forEach(item => item.element.style.display = '');
        updateFilteredCount();
        return;
    }
    
    filteredData = inventoryData.filter(item => {
        return item.code.toLowerCase().includes(searchTerm) ||
               item.desc.toLowerCase().includes(searchTerm) ||
               item.location.toLowerCase().includes(searchTerm) ||
               item.stock.toString().includes(searchTerm);
    });
    
    let visibleCount = 0;
    inventoryData.forEach(item => {
        const isVisible = filteredData.includes(item);
        item.element.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
    });
    
    updateFilteredCount();
}

function filterByStatus(status) {
    const searchInput = document.getElementById('searchInv');
    if (searchInput) searchInput.value = '';
    
    filteredData = inventoryData.filter(item => item.status === status);
    
    let visibleCount = 0;
    inventoryData.forEach(item => {
        const isVisible = item.status === status;
        item.element.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
    });
    
    updateFilteredCount();
    showToast(`Filtrado por: ${status === 'critical' ? 'Stock Cr칤tico' : status === 'low' ? 'Stock Bajo' : 'Stock Normal'}`);
}

function clearStatusFilter() {
    const searchInput = document.getElementById('searchInv');
    if (searchInput) searchInput.value = '';
    filterInventory('');
}

function clearFilters() {
    const searchInput = document.getElementById('searchInv');
    if (searchInput) {
        searchInput.value = '';
    }
    filterInventory('');
    showToast('Filtros limpiados');
}

function updateFilteredCount() {
    const visibleCount = filteredData.length;
    document.getElementById('filteredCount').textContent = visibleCount;
    document.getElementById('filterInfo').textContent = 
        `Mostrando ${visibleCount} de ${inventoryData.length} items`;
}

// ================= TABLE FUNCTIONS =================
function sortTable(columnIndex) {
    if (!config.tableSort) return;
    
    const table = document.getElementById('inventoryTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
    
    if (rows.length <= 1) return;
    
    const direction = config.currentSort.column === columnIndex ? 
                     config.currentSort.direction === 'asc' ? 'desc' : 'asc' : 'asc';
    
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Para columna de stock, convertir a n칰mero
        if (columnIndex === 3) {
            aValue = parseFloat(aValue) || 0;
            bValue = parseFloat(bValue) || 0;
        }
        
        if (direction === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Reordenar filas
    rows.forEach(row => tbody.appendChild(row));
    
    // Actualizar estado de ordenamiento
    config.currentSort = { column: columnIndex, direction };
    
    showToast(`Tabla ordenada por columna ${columnIndex + 1} (${direction})`);
}

function toggleTableView() {
    const table = document.getElementById('inventoryTable');
    const isCondensed = table.classList.contains('table-sm');
    
    if (isCondensed) {
        table.classList.remove('table-sm');
        showToast('Vista normal activada');
    } else {
        table.classList.add('table-sm');
        showToast('Vista compacta activada');
    }
}

// ================= EXPORT FUNCTIONS =================
function exportTable(format) {
    if (filteredData.length === 0) {
        showToast('No hay datos para exportar', 'warning');
        return;
    }
    
    try {
        let content, filename, mimeType;
        
        if (format === 'csv') {
            content = convertToCSV();
            filename = `inventario_${getFormattedDate()}.csv`;
            mimeType = 'text/csv';
        } else if (format === 'excel') {
            content = convertToExcel();
            filename = `inventario_${getFormattedDate()}.xlsx`;
            mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        }
        
        downloadFile(content, filename, mimeType);
        showToast(`Exportado como ${format.toUpperCase()}`, 'success');
        
    } catch (error) {
        console.error('Error al exportar:', error);
        showToast('Error al exportar los datos', 'danger');
    }
}

function convertToCSV() {
    const headers = ['C칩digo', 'Descripci칩n', 'Ubicaci칩n', 'Stock', 'Estado'];
    const rows = filteredData.map(item => [
        item.code,
        item.desc,
        item.location,
        item.stock,
        item.status === 'critical' ? 'Cr칤tico' : item.status === 'low' ? 'Bajo' : 'Normal'
    ]);
    
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    return csvContent;
}

function convertToExcel() {
    const wsData = [
        ['C칩digo', 'Descripci칩n', 'Ubicaci칩n', 'Stock', 'Estado'],
        ...filteredData.map(item => [
            item.code,
            item.desc,
            item.location,
            item.stock,
            item.status === 'critical' ? 'Cr칤tico' : item.status === 'low' ? 'Bajo' : 'Normal'
        ])
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
    
    return XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function getFormattedDate() {
    const now = new Date();
    return now.toISOString().slice(0, 10).replace(/-/g, '');
}

function printTable() {
    const printContent = document.getElementById('inventoryTable').outerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Inventario - ${new Date().toLocaleDateString()}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    @media print {
                        body { margin: 0; }
                    }
                </style>
            </head>
            <body>
                <h2>Reporte de Inventario</h2>
                <p>Generado: ${new Date().toLocaleString()}</p>
                ${printContent}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
    showToast('Preparando para imprimir...');
}

// ================= MODAL FUNCTIONS =================
function initModals() {
    // Cerrar modales al hacer clic fuera
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(this.id);
            }
        });
    });
    
    // Cerrar con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
}

function openReportModal() {
    document.getElementById('reportModal').style.display = 'flex';
}

function openSettingsModal() {
    document.getElementById('settingsModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
    });
}

function generateReport() {
    const reportType = document.querySelector('input[name="report-type"]:checked').value;
    const includeKPIs = document.getElementById('section-kpis').checked;
    const includeCharts = document.getElementById('section-charts').checked;
    const includeTable = document.getElementById('section-table').checked;
    const outputFormat = document.querySelector('input[name="output-format"]:checked').value;
    
    // Mostrar loading
    const generateBtn = document.querySelector('#reportModal .btn-primary');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<span class="spinner"></span> Generando...';
    generateBtn.disabled = true;
    
    // Simular generaci칩n de reporte
    setTimeout(() => {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
        
        closeModal('reportModal');
        
        showToast(`Reporte ${reportType} generado exitosamente`, 'success');
        
        // Simular descarga
        const reportData = {
            type: reportType,
            format: outputFormat,
            timestamp: new Date().toISOString(),
            includes: {
                kpis: includeKPIs,
                charts: includeCharts,
                table: includeTable
            }
        };
        
        const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_inventario_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
    }, 2000);
}

function showExportOptions() {
    const exportData = {
        totalItems: inventoryData.length,
        totalStock: inventoryData.reduce((sum, item) => sum + item.stock, 0),
        criticalItems: inventoryData.filter(item => item.status === 'critical').length,
        lowItems: inventoryData.filter(item => item.status === 'low').length,
        okItems: inventoryData.filter(item => item.status === 'ok').length,
        data: filteredData.map(item => ({
            codigo: item.code,
            descripcion: item.desc,
            ubicacion: item.location,
            stock: item.stock,
            estado: item.status
        }))
    };
    
    const jsonStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `inventario_export_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('Datos exportados en formato JSON', 'success');
}

function showExportModal() {
    Swal.fire({
        title: 'Exportar Dashboard',
        text: 'Selecciona el formato de exportaci칩n',
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Exportar Todo',
        cancelButtonText: 'Cancelar',
        showDenyButton: true,
        denyButtonText: 'Solo Datos',
        customClass: {
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-secondary',
            denyButton: 'btn btn-info'
        },
        buttonsStyling: false
    }).then((result) => {
        if (result.isConfirmed) {
            exportDashboard();
        } else if (result.isDenied) {
            showExportOptions();
        }
    });
}

function exportDashboard() {
    const dashboardData = {
        metadata: {
            exportedAt: new Date().toISOString(),
            totalItems: inventoryData.length,
            version: '1.0'
        },
        summary: {
            totalItems: inventoryData.length,
            totalStock: inventoryData.reduce((sum, item) => sum + item.stock, 0),
            averageStock: inventoryData.length > 0 ? 
                inventoryData.reduce((sum, item) => sum + item.stock, 0) / inventoryData.length : 0,
            uniqueLocations: new Set(inventoryData.map(item => item.location)).size
        },
        statusBreakdown: {
            critical: inventoryData.filter(item => item.status === 'critical').length,
            low: inventoryData.filter(item => item.status === 'low').length,
            ok: inventoryData.filter(item => item.status === 'ok').length
        },
        topLocations: Array.from(
            new Map(inventoryData.reduce((acc, item) => {
                if (!acc.has(item.location)) acc.set(item.location, 0);
                acc.set(item.location, acc.get(item.location) + item.stock);
                return acc;
            }, new Map()))
            .entries()
        ).sort((a, b) => b[1] - a[1]).slice(0, 10),
        inventoryData: filteredData.map(item => ({
            code: item.code,
            description: item.desc,
            location: item.location,
            stock: item.stock,
            status: item.status
        }))
    };
    
    const jsonStr = JSON.stringify(dashboardData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dashboard_completo_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Dashboard completo exportado', 'success');
}

// ================= SETTINGS FUNCTIONS =================
function initSettings() {
    // Cargar configuraci칩n desde localStorage
    const savedConfig = localStorage.getItem('dashboardConfig');
    if (savedConfig) {
        Object.assign(config, JSON.parse(savedConfig));
    }
    
    // Aplicar configuraci칩n
    document.getElementById('autoRefresh').checked = config.autoRefresh;
    document.getElementById('showNotifications').checked = config.notifications;
    document.getElementById('darkMode').checked = config.darkMode;
    document.getElementById('sortTable').checked = config.tableSort;
    
    // Aplicar modo oscuro si est치 activado
    if (config.darkMode) {
        enableDarkMode();
    }
}

function toggleAutoRefresh(enabled) {
    config.autoRefresh = enabled;
    if (enabled) {
        startAutoRefresh();
        showToast('Actualizaci칩n autom치tica activada');
    } else {
        stopAutoRefresh();
        showToast('Actualizaci칩n autom치tica desactivada');
    }
}

function toggleNotifications(enabled) {
    config.notifications = enabled;
    showToast(enabled ? 'Notificaciones activadas' : 'Notificaciones desactivadas');
}

function toggleDarkMode(enabled) {
    config.darkMode = enabled;
    if (enabled) {
        enableDarkMode();
    } else {
        disableDarkMode();
    }
}

function toggleTableSort(enabled) {
    config.tableSort = enabled;
    showToast(enabled ? 'Ordenamiento de tabla activado' : 'Ordenamiento de tabla desactivado');
}

function enableDarkMode() {
    document.documentElement.setAttribute('data-bs-theme', 'dark');
    document.body.classList.add('dark-mode');
}

function disableDarkMode() {
    document.documentElement.setAttribute('data-bs-theme', 'light');
    document.body.classList.remove('dark-mode');
}

function saveSettings() {
    localStorage.setItem('dashboardConfig', JSON.stringify(config));
    closeModal('settingsModal');
    showToast('Configuraci칩n guardada', 'success');
}

// ================= AUTO REFRESH FUNCTIONS =================
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    autoRefreshInterval = setInterval(updateDashboard, config.refreshInterval);
    console.log(`游댃 Auto-refresh iniciado (cada ${config.refreshInterval/1000}s)`);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('낓勇 Auto-refresh detenido');
    }
}

function updateDashboard() {
    console.log('游댃 Actualizando dashboard...');
    
    // Simular actualizaci칩n de datos
    const loadingToast = showToast('Actualizando datos...', 'info', 1000);
    
    setTimeout(() => {
        // En un sistema real, aqu칤 har칤as una petici칩n al servidor
        collectInventoryData();
        calculateMetrics();
        renderCharts();
        updateTopLocations();
        
        if (config.notifications) {
            showToast('Dashboard actualizado', 'success');
        }
    }, 1000);
}

// ================= CHART INTERACTION FUNCTIONS =================
function toggleChartType(type) {
    if (type === 'pie' && charts.estado) {
        const currentType = charts.estado.config.type;
        const newType = currentType === 'doughnut' ? 'pie' : 'doughnut';
        charts.estado.config.type = newType;
        charts.estado.update();
        
        const icon = document.getElementById('pieChartIcon');
        icon.className = newType === 'pie' ? 'bi bi-circle' : 'bi bi-arrows-angle-expand';
        
        showToast(`Gr치fico cambiado a ${newType}`);
    }
}

// ================= UTILITY FUNCTIONS =================
function showToast(message, type = 'info', duration = 3000) {
    if (!config.notifications && type !== 'danger') return;
    
    // Crear contenedor si no existe
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast border-${type}`;
    
    const typeIcons = {
        'success': 'check-circle-fill',
        'danger': 'exclamation-triangle-fill',
        'warning': 'exclamation-circle-fill',
        'info': 'info-circle-fill'
    };
    
    toast.innerHTML = `
        <div class="toast-header bg-${type} text-white">
            <i class="bi bi-${typeIcons[type] || 'info-circle'} me-2"></i>
            <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
            <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('${toastId}').remove()"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    container.appendChild(toast);
    
    // Auto-remover
    setTimeout(() => {
        const toastEl = document.getElementById(toastId);
        if (toastEl) {
            toastEl.style.animation = 'slideOutRight 0.3s ease-in forwards';
            setTimeout(() => toastEl.remove(), 300);
        }
    }, duration);
    
    return toastId;
}

function editItem(itemCode) {
    showToast(`Editando item: ${itemCode}`, 'info');
    // Aqu칤 ir칤a la l칩gica para abrir un formulario de edici칩n
    // Por ahora solo mostramos un mensaje
}

function setupEventListeners() {
    // Eventos de clic en filas
    document.querySelectorAll('.inventory-row').forEach(row => {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('button')) {
                const code = this.dataset.code;
                const desc = this.dataset.desc;
                showToast(`Seleccionado: ${code} - ${desc}`, 'info');
            }
        });
    });
    
    // Prevenir cierre de modales al hacer clic dentro
    document.querySelectorAll('.modal-content').forEach(modal => {
        modal.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
}

// ================= EXPORTAR FUNCIONES GLOBALES =================
// Hacer funciones disponibles globalmente
window.updateDashboard = updateDashboard;
window.clearFilters = clearFilters;
window.filterByStatus = filterByStatus;
window.clearStatusFilter = clearStatusFilter;
window.toggleTableView = toggleTableView;
window.sortTable = sortTable;
window.exportTable = exportTable;
window.printTable = printTable;
window.toggleChartType = toggleChartType;
window.openReportModal = openReportModal;
window.openSettingsModal = openSettingsModal;
window.closeModal = closeModal;
window.generateReport = generateReport;
window.showExportOptions = showExportOptions;
window.showExportModal = showExportModal;
window.exportDashboard = exportDashboard;
window.toggleAutoRefresh = toggleAutoRefresh;
window.toggleNotifications = toggleNotifications;
window.toggleDarkMode = toggleDarkMode;
window.toggleTableSort = toggleTableSort;
window.saveSettings = saveSettings;
window.editItem = editItem;
</script>

<!-- SweetAlert2 para mejores di치logos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.dark-mode {
    background-color: #212529;
    color: #f8f9fa;
}

.dark-mode .dashboard-header,
.dark-mode .kpi-card,
.dark-mode .chart-card,
.dark-mode .widget,
.dark-mode .table-card {
    background-color: #343a40;
    border-color: #495057;
    color: #f8f9fa;
}

.dark-mode .search-input {
    background-color: #495057;
    border-color: #6c757d;
    color: #f8f9fa;
}

.dark-mode .search-input:focus {
    background-color: #495057;
    border-color: #0d6efd;
}

.dark-mode .dashboard-table thead {
    background-color: #495057;
}

.dark-mode .dashboard-table th {
    color: #dee2e6;
    border-color: #6c757d;
}

.dark-mode .dashboard-table td {
    color: #e9ecef;
    border-color: #495057;
}

.dark-mode .dashboard-table tbody tr:hover {
    background-color: #495057;
}
</style>

{% endblock %}
