{% extends "base.html" %}
{% block content %}

<style>
    /* Estilos anteriores se mantienen igual */
    :root {
        --primary: #1a5f7a;
        --primary-light: rgba(26, 95, 122, 0.1);
        --primary-dark: #0d4c6e;
        --secondary: #6c757d;
        --success: #28a745;
        --success-light: rgba(40, 167, 69, 0.1);
        --warning: #ffc107;
        --warning-light: rgba(255, 193, 7, 0.1);
        --danger: #dc3545;
        --danger-light: rgba(220, 53, 69, 0.1);
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #343a40;
        --gray-100: #f8f9fa;
        --gray-200: #e9ecef;
        --gray-300: #dee2e6;
        --gray-400: #ced4da;
        --gray-500: #adb5bd;
        --gray-600: #6c757d;
        --gray-700: #495057;
        --gray-800: #343a40;
        --gray-900: #212529;
        
        --primary-gradient: linear-gradient(135deg, #1a5f7a 0%, #0d4c6e 100%);
        --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --warning-gradient: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        --danger-gradient: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        --info-gradient: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        --dark-gradient: linear-gradient(135deg, #343a40 0%, #212529 100%);
        --purple-gradient: linear-gradient(135deg, #6f42c1 0%, #6610f2 100%);
        
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
        --shadow-lg: 0 8px 16px rgba(0,0,0,0.15);
        --shadow-xl: 0 12px 24px rgba(0,0,0,0.2);
        
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 14px;
        --radius-xl: 18px;
        
        --transition-fast: 0.2s ease;
        --transition-normal: 0.3s ease;
        --transition-slow: 0.5s ease;
    }

    .dashboard-container {
        padding: 24px;
        background: linear-gradient(135deg, #f8fafc 0%, #e9ecef 100%);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .dashboard-header {
        background: white;
        border-radius: var(--radius-lg);
        padding: 28px 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .header-left h1 {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-subtitle {
        color: var(--gray-600);
        font-size: 1rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all var(--transition-normal);
        border: 2px solid transparent;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-primary-action {
        background: var(--primary-gradient);
        color: white;
        border: none;
    }

    .btn-primary-action:hover {
        background: linear-gradient(135deg, #0d4c6e 0%, #1a5f7a 100%);
        color: white;
    }

    .btn-outline-action {
        background: white;
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-outline-action:hover {
        background: var(--primary);
        color: white;
    }

    .btn-success-action {
        background: var(--success-gradient);
        color: white;
        border: none;
    }

    .btn-success-action:hover {
        background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        padding-top: 24px;
        border-top: 2px solid var(--gray-200);
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform var(--transition-normal);
    }

    .stat-card:hover::before {
        transform: scaleX(1);
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
        box-shadow: var(--shadow-md);
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 800;
        line-height: 1;
        margin: 0 0 6px 0;
        color: var(--gray-900);
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--gray-600);
        font-weight: 600;
        margin-bottom: 4px;
    }

    .stat-trend {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
    }

    .trend-up {
        background: rgba(40, 167, 69, 0.15);
        color: var(--success);
    }

    .trend-down {
        background: rgba(220, 53, 69, 0.15);
        color: var(--danger);
    }

    .trend-neutral {
        background: rgba(108, 117, 125, 0.15);
        color: var(--gray-600);
    }

    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 24px;
        margin-bottom: 24px;
    }

    .main-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .kpi-section {
        background: white;
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
    }

    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .kpi-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--gray-900);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
    }

    .kpi-card {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: var(--radius-md);
        padding: 24px;
        border: 1px solid var(--gray-200);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
    }

    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }

    .kpi-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .kpi-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        color: white;
        flex-shrink: 0;
        box-shadow: var(--shadow-md);
    }

    .kpi-details {
        flex: 1;
    }

    .kpi-value {
        font-size: 2.4rem;
        font-weight: 800;
        line-height: 1;
        margin: 0 0 6px 0;
        color: var(--gray-900);
    }

    .kpi-label {
        font-size: 0.95rem;
        color: var(--gray-600);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .kpi-progress {
        margin-top: 12px;
    }

    .kpi-progress-bar {
        height: 6px;
        border-radius: 3px;
        background: var(--gray-200);
        overflow: hidden;
    }

    .kpi-progress-fill {
        height: 100%;
        background: var(--primary-gradient);
        border-radius: 3px;
        transition: width 1s ease-in-out;
    }

    .chart-section {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .chart-container {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        transition: all var(--transition-normal);
    }

    .chart-container:hover {
        box-shadow: var(--shadow-lg);
    }

    .chart-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to right, rgba(248, 249, 250, 0.5), rgba(241, 245, 249, 0.8));
    }

    .chart-title {
        font-weight: 700;
        color: var(--gray-900);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-body {
        padding: 20px;
        height: 280px;
        position: relative;
    }

    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 16px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    .table-section {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        transition: all var(--transition-normal);
    }

    .table-section:hover {
        box-shadow: var(--shadow-lg);
    }

    .table-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        background: linear-gradient(to right, rgba(248, 249, 250, 0.5), rgba(241, 245, 249, 0.8));
    }

    .table-title-area {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .table-title {
        font-weight: 700;
        color: var(--gray-900);
        font-size: 1rem;
        margin: 0;
    }

    .table-badges {
        display: flex;
        gap: 8px;
    }

    .table-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .table-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .search-container {
        position: relative;
        min-width: 280px;
    }

    .search-input {
        width: 100%;
        padding: 10px 16px 10px 42px;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
        transition: all var(--transition-normal);
        background: white;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-500);
        pointer-events: none;
    }

    .filter-group {
        display: flex;
        gap: 8px;
    }

    .filter-select {
        padding: 8px 12px;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-md);
        background: white;
        font-size: 0.9rem;
        color: var(--gray-700);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .table-actions {
        display: flex;
        gap: 8px;
    }

    .table-btn {
        padding: 8px 16px;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-md);
        background: white;
        color: var(--gray-700);
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .table-btn:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }

    .table-btn-primary {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .table-btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    .table-wrapper {
        position: relative;
        max-height: 500px;
        overflow-y: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.9rem;
    }

    .data-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--gray-100);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .data-table th {
        padding: 16px;
        text-align: left;
        font-weight: 700;
        color: var(--gray-800);
        border-bottom: 2px solid var(--gray-300);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.85rem;
        white-space: nowrap;
        position: relative;
        user-select: none;
    }

    .data-table th.sortable {
        cursor: pointer;
        transition: background var(--transition-fast);
        padding-right: 30px;
    }

    .data-table th.sortable:hover {
        background: rgba(26, 95, 122, 0.05);
    }

    .data-table th.sortable::after {
        content: '↕';
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.8em;
        opacity: 0.5;
        transition: opacity var(--transition-fast);
    }

    .data-table th.sortable:hover::after {
        opacity: 1;
    }

    .data-table th.sort-asc::after {
        content: '↑';
        opacity: 1;
    }

    .data-table th.sort-desc::after {
        content: '↓';
        opacity: 1;
    }

    .data-table td {
        padding: 14px 16px;
        color: var(--gray-800);
        vertical-align: middle;
        border-bottom: 1px solid var(--gray-200);
        transition: background var(--transition-fast);
    }

    .data-table tbody tr {
        transition: all var(--transition-fast);
    }

    .data-table tbody tr:hover {
        background: rgba(26, 95, 122, 0.03);
    }

    .data-table tbody tr.selected {
        background: rgba(26, 95, 122, 0.08);
    }

    .data-table tbody tr.critical {
        background: rgba(220, 53, 69, 0.05);
    }

    .data-table tbody tr.critical:hover {
        background: rgba(220, 53, 69, 0.08);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        min-width: 100px;
        justify-content: center;
        transition: all var(--transition-fast);
    }

    .status-badge:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-sm);
    }

    .badge-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }

    .badge-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: var(--gray-900);
        font-weight: 800;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
    }

    .badge-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
    }

    .badge-secondary {
        background: linear-gradient(135deg, #6c757d, #868e96);
        color: white;
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
    }

    .widget {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        transition: all var(--transition-normal);
    }

    .widget:hover {
        box-shadow: var(--shadow-lg);
    }

    .widget-header {
        padding: 20px;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .widget-title {
        font-weight: 700;
        font-size: 1rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .widget-actions {
        display: flex;
        gap: 8px;
    }

    .widget-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .widget-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .widget-body {
        padding: 20px;
    }

    .status-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .status-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px;
        border-radius: var(--radius-md);
        background: linear-gradient(to right, #f8f9fa, #f1f5f9);
        border-left: 4px solid transparent;
        transition: all var(--transition-fast);
    }

    .status-item:hover {
        transform: translateX(4px);
        background: linear-gradient(to right, #e9ecef, #dee2e6);
    }

    .status-item.ok {
        border-left-color: var(--success);
    }

    .status-item.diff {
        border-left-color: var(--warning);
    }

    .status-item.pend {
        border-left-color: var(--secondary);
    }

    .status-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .status-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: white;
    }

    .status-text {
        display: flex;
        flex-direction: column;
    }

    .status-label {
        font-weight: 600;
        color: var(--gray-800);
        font-size: 0.95rem;
    }

    .status-desc {
        font-size: 0.85rem;
        color: var(--gray-600);
    }

    .status-count {
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 1.1rem;
        font-weight: 800;
        color: white;
        min-width: 60px;
        text-align: center;
        box-shadow: var(--shadow-sm);
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .action-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-md);
        padding: 20px;
        text-align: center;
        transition: all var(--transition-normal);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        text-decoration: none;
        color: inherit;
    }

    .action-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }

    .action-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all var(--transition-normal);
    }

    .action-card:hover .action-icon {
        transform: scale(1.1) rotate(5deg);
    }

    .action-title {
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--gray-800);
        margin: 0;
    }

    .action-desc {
        font-size: 0.85rem;
        color: var(--gray-600);
        margin: 0;
    }

    .notification-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        width: 350px;
    }

    .notification-toast {
        background: white;
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: var(--shadow-lg);
        border-left: 4px solid var(--primary);
        animation: slideInRight 0.3s ease-out;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .notification-content {
        flex: 1;
    }

    .notification-title {
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 4px;
    }

    .notification-message {
        color: var(--gray-600);
        font-size: 0.9rem;
    }

    .notification-close {
        background: none;
        border: none;
        color: var(--gray-500);
        cursor: pointer;
        padding: 4px;
        margin-left: 8px;
    }

    .notification-success {
        border-left-color: var(--success);
    }

    .notification-warning {
        border-left-color: var(--warning);
    }

    .notification-error {
        border-left-color: var(--danger);
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        backdrop-filter: blur(4px);
    }

    .loading-spinner {
        width: 80px;
        height: 80px;
        border: 6px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-content {
        text-align: center;
        color: white;
        margin-top: 20px;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    @media (max-width: 1200px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            grid-template-columns: repeat(2, 1fr);
            display: grid;
        }
    }

    @media (max-width: 768px) {
        .chart-section {
            grid-template-columns: 1fr;
        }
        
        .header-content {
            flex-direction: column;
        }
        
        .table-header {
            flex-direction: column;
        }
        
        .sidebar {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- ================= DASHBOARD HTML ================= -->
<div class="dashboard-container fade-in">
    <!-- NOTIFICATIONS PANEL -->
    <div id="notificationPanel" class="notification-panel"></div>
    
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-content">
                <h4 id="loadingMessage">Cargando...</h4>
                <p id="loadingDetail"></p>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1>
                    <i class="bi bi-clipboard-data"></i>
                    Dashboard de Conteo Físico
                </h1>
                <p class="header-subtitle">
                    <i class="bi bi-info-circle"></i>
                    Sistema de gestión de inventario
                </p>
            </div>
            <div class="header-actions">
                <button class="btn-action btn-primary-action" onclick="loadLatestData()" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
                <button class="btn-action btn-outline-action" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                    <i class="bi bi-clock"></i> Auto-Refresh
                </button>
                {% if url_for('inventory.count_inventory') %}
                <a href="{{ url_for('inventory.count_inventory') }}" class="btn-action btn-success-action">
                    <i class="bi bi-clipboard-check"></i> Nuevo Conteo
                </a>
                {% endif %}
                <button class="btn-action" style="background: var(--danger-gradient); color: white;" onclick="showHelp()">
                    <i class="bi bi-question-circle"></i> Ayuda
                </button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-gradient);">
                    <i class="bi bi-boxes"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalItems">{{ items|length }}</div>
                    <div class="stat-label">Total Materiales</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--success-gradient);">
                    <i class="bi bi-check-all"></i>
                </div>
                <div class="stat-content">
                    {% set ok_count = items|selectattr('estado', 'equalto', 'OK')|list|length %}
                    <div class="stat-value" id="okItems">{{ ok_count }}</div>
                    <div class="stat-label">Coinciden</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--warning-gradient);">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    {% set diff_count = items|selectattr('estado', 'equalto', 'Diferencia')|list|length %}
                    <div class="stat-value" id="diffItems">{{ diff_count }}</div>
                    <div class="stat-label">Diferencias</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--dark-gradient);">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-content">
                    {% set pend_count = items|length - ok_count - diff_count %}
                    <div class="stat-value" id="pendItems">{{ pend_count }}</div>
                    <div class="stat-label">Pendientes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="dashboard-layout">
        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-content">
            <!-- KPI SECTION -->
            <div class="kpi-section">
                <div class="kpi-header">
                    <h2 class="kpi-title">
                        <i class="bi bi-speedometer2"></i>
                        Indicadores Clave
                    </h2>
                </div>
                
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-icon" style="background: var(--primary-gradient);">
                                <i class="bi bi-geo-alt-fill"></i>
                            </div>
                            <div class="kpi-details">
                                {% set locations = [] %}
                                {% for item in items %}
                                    {% if item.location and item.location not in locations %}
                                        {% set _ = locations.append(item.location) %}
                                    {% endif %}
                                {% endfor %}
                                <div class="kpi-value">{{ locations|length }}</div>
                                <div class="kpi-label">Ubicaciones</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-icon" style="background: var(--info-gradient);">
                                <i class="bi bi-calculator-fill"></i>
                            </div>
                            <div class="kpi-details">
                                {% set total_stock = items|sum(attribute='stock') %}
                                <div class="kpi-value">{{ total_stock }}</div>
                                <div class="kpi-label">Stock Sistema</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-icon" style="background: var(--success-gradient);">
                                <i class="bi bi-check-all"></i>
                            </div>
                            <div class="kpi-details">
                                {% set counted_items = items|selectattr('real_count', '>', 0)|list|length %}
                                <div class="kpi-value">{{ counted_items }}</div>
                                <div class="kpi-label">Contados</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-icon" style="background: var(--purple-gradient);">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <div class="kpi-details">
                                {% if items|length > 0 %}
                                    {% set progress = ((ok_count + diff_count) / items|length * 100)|round|int %}
                                {% else %}
                                    {% set progress = 0 %}
                                {% endif %}
                                <div class="kpi-value">{{ progress }}%</div>
                                <div class="kpi-label">Progreso Total</div>
                                <div class="kpi-progress">
                                    <div class="kpi-progress-bar">
                                        <div class="kpi-progress-fill" style="width: {{ progress }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHART SECTION -->
            <div class="chart-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-pie-chart-fill"></i>
                            Distribución del Conteo
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="estadoChart"></canvas>
                        <div class="chart-legend" id="estadoLegend"></div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-bar-chart-fill"></i>
                            Conteos por Hora
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TABLE SECTION -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title-area">
                        <h3 class="table-title">
                            <i class="bi bi-table"></i>
                            Resultados Detallados
                        </h3>
                        <div class="table-badges">
                            <span class="table-badge bg-primary">{{ items|length }}</span>
                        </div>
                    </div>
                    
                    <div class="table-controls">
                        <div class="search-container">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="searchInput" class="search-input" 
                                   placeholder="Buscar código, descripción...">
                        </div>
                        
                        <div class="filter-group">
                            <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                                <option value="all">Todos los estados</option>
                                <option value="OK">Solo OK</option>
                                <option value="Diferencia">Solo Diferencias</option>
                                <option value="Pendiente">Solo Pendientes</option>
                            </select>
                            
                            <select class="filter-select" id="locationFilter" onchange="applyFilters()">
                                <option value="all">Todas las ubicaciones</option>
                                {% set unique_locations = [] %}
                                {% for item in items %}
                                    {% if item.location and item.location not in unique_locations %}
                                        {% set _ = unique_locations.append(item.location) %}
                                        <option value="{{ item.location }}">{{ item.location }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="table-actions">
                            <button class="table-btn" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                            <button class="table-btn table-btn-primary" onclick="exportToExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Excel
                            </button>
                            <button class="table-btn table-btn-primary" onclick="exportToPDF()">
                                <i class="bi bi-file-earmark-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('code')">Código</th>
                                <th>Descripción</th>
                                <th>Ubicación</th>
                                <th class="sortable" onclick="sortTable('stock')">Stock Sistema</th>
                                <th class="sortable" onclick="sortTable('count')">Conteo Físico</th>
                                <th class="sortable" onclick="sortTable('diff')">Diferencia</th>
                                <th>Estado</th>
                                <th>Usuario</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            {% for item in items %}
                            {% set diferencia = (item.real_count|default(0) - item.stock|default(0)) %}
                            {% set diferencia_abs = diferencia|abs %}
                            {% set is_critical = diferencia_abs > (item.stock|default(0) * 0.5) and diferencia_abs > 10 %}
                            <tr data-id="{{ item.id }}" 
                                data-code="{{ item.material_code }}"
                                data-desc="{{ item.material_text }}"
                                data-location="{{ item.location }}"
                                data-stock="{{ item.stock }}"
                                data-count="{{ item.real_count }}"
                                data-diferencia="{{ diferencia }}"
                                data-estado="{{ item.estado }}"
                                data-user="{{ item.usuario }}"
                                data-timestamp="{{ item.timestamp.strftime('%Y-%m-%d %H:%M:%S') if item.timestamp else '' }}">
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-bold">{{ item.material_code }}</span>
                                        {% if is_critical %}
                                        <i class="bi bi-fire text-danger" title="Diferencia crítica"></i>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 200px;" 
                                         title="{{ item.material_text }}">
                                        {{ item.material_text }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-dark">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        {{ item.location }}
                                    </span>
                                </td>
                                <td class="fw-bold">{{ item.stock }}</td>
                                <td class="fw-bold {% if item.estado == 'OK' %}text-success{% elif item.estado == 'Diferencia' %}text-danger{% else %}text-muted{% endif %}">
                                    {{ item.real_count if item.real_count else '-' }}
                                </td>
                                <td class="fw-bold {% if diferencia > 0 %}text-success{% elif diferencia < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if item.estado == 'OK' %}
                                        <span class="text-muted">0</span>
                                    {% elif item.estado == 'Diferencia' %}
                                        {% if diferencia > 0 %}
                                            <i class="bi bi-arrow-up-circle text-success me-1"></i>+{{ diferencia_abs }}
                                        {% elif diferencia < 0 %}
                                            <i class="bi bi-arrow-down-circle text-danger me-1"></i>-{{ diferencia_abs }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.estado == 'OK' %}
                                        <span class="status-badge badge-success">
                                            <i class="bi bi-check-circle me-1"></i>OK
                                        </span>
                                    {% elif item.estado == 'Diferencia' %}
                                        <span class="status-badge badge-warning">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Diferencia
                                        </span>
                                    {% else %}
                                        <span class="status-badge badge-secondary">
                                            <i class="bi bi-clock me-1"></i>Pendiente
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ item.usuario or 'N/A' }}</td>
                                <td>
                                    {% if item.timestamp %}
                                    <span class="small">{{ item.timestamp.strftime('%H:%M') }}</span>
                                    <br>
                                    <span class="text-muted extra-small">{{ item.timestamp.strftime('%d/%m/%Y') }}</span>
                                    {% else %}
                                    <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editItem({{ item.id }})" 
                                                title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteItem({{ item.id }})" 
                                                title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- RESUMEN WIDGET -->
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-clipboard-data"></i>
                        Resumen de Conteo
                    </h3>
                </div>
                <div class="widget-body">
                    <div class="status-list">
                        <div class="status-item ok">
                            <div class="status-content">
                                <div class="status-icon" style="background: var(--success-gradient);">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="status-text">
                                    <div class="status-label">Coinciden (OK)</div>
                                    <div class="status-desc">Stock exacto</div>
                                </div>
                            </div>
                            <span class="status-count" style="background: var(--success-gradient);">
                                {{ ok_count }}
                            </span>
                        </div>
                        <div class="status-item diff">
                            <div class="status-content">
                                <div class="status-icon" style="background: var(--warning-gradient);">
                                    <i class="bi bi-exclamation-triangle"></i>
                                </div>
                                <div class="status-text">
                                    <div class="status-label">Diferencias</div>
                                    <div class="status-desc">Faltantes/Sobrantes</div>
                                </div>
                            </div>
                            <span class="status-count" style="background: var(--warning-gradient);">
                                {{ diff_count }}
                            </span>
                        </div>
                        <div class="status-item pend">
                            <div class="status-content">
                                <div class="status-icon" style="background: var(--dark-gradient);">
                                    <i class="bi bi-hourglass-split"></i>
                                </div>
                                <div class="status-text">
                                    <div class="status-label">Pendientes</div>
                                    <div class="status-desc">Sin contar</div>
                                </div>
                            </div>
                            <span class="status-count" style="background: var(--dark-gradient);">
                                {{ pend_count }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCIONES RÁPIDAS -->
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-lightning-charge-fill"></i>
                        Acciones Rápidas
                    </h3>
                </div>
                <div class="widget-body">
                    <div class="quick-actions-grid">
                        {% if url_for('inventory.count_inventory') %}
                        <a href="{{ url_for('inventory.count_inventory') }}" class="action-card">
                            <div class="action-icon">
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <h4 class="action-title">Nuevo Conteo</h4>
                            <p class="action-desc">Agregar más items</p>
                        </a>
                        {% endif %}
                        
                        <div class="action-card" onclick="exportDifferences()">
                            <div class="action-icon" style="background: var(--success-gradient);">
                                <i class="bi bi-file-earmark-excel"></i>
                            </div>
                            <h4 class="action-title">Exportar Diferencias</h4>
                            <p class="action-desc">Reporte Excel</p>
                        </div>
                        
                        <div class="action-card" onclick="showReconciliation()">
                            <div class="action-icon" style="background: var(--info-gradient);">
                                <i class="bi bi-arrow-repeat"></i>
                            </div>
                            <h4 class="action-title">Conciliar Stock</h4>
                            <p class="action-desc">Ajustar sistema</p>
                        </div>
                        
                        <div class="action-card" onclick="exportDashboard()">
                            <div class="action-icon" style="background: var(--danger-gradient);">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </div>
                            <h4 class="action-title">Reporte PDF</h4>
                            <p class="action-desc">Dashboard completo</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MAYORES DIFERENCIAS -->
            <div class="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Mayores Diferencias
                    </h3>
                </div>
                <div class="widget-body">
                    <div id="topDifferences">
                        {% set differences = [] %}
                        {% for item in items if item.estado == 'Diferencia' %}
                            {% set diff = (item.real_count|default(0) - item.stock|default(0)) %}
                            {% set percent = (diff|abs / item.stock * 100)|round|int if item.stock > 0 else 100 %}
                            {% set _ = differences.append({
                                'code': item.material_code,
                                'desc': item.material_text,
                                'location': item.location,
                                'stock': item.stock,
                                'count': item.real_count,
                                'diff': diff,
                                'percent': percent
                            }) %}
                        {% endfor %}
                        
                        {% if differences %}
                            {% set top_differences = differences|sort(attribute='diff', reverse=true)|slice(0, 5) %}
                            {% for diff in top_differences %}
                                <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="badge {% if diff.percent > 50 %}bg-danger{% else %}bg-warning{% endif %}">
                                                {{ diff.percent }}%
                                            </span>
                                        </div>
                                        <div>
                                            <div class="fw-bold small">{{ diff.code }}</div>
                                            <div class="text-muted extra-small">{{ diff.location }}</div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold {% if diff.diff > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if diff.diff > 0 %}+{% endif %}{{ diff.diff }}
                                        </div>
                                        <div class="text-muted extra-small">{{ diff.stock }} → {{ diff.count }}</div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-3">
                                <i class="bi bi-check-circle-fill text-success fs-4 mb-2"></i>
                                <p class="text-muted mb-0">No hay diferencias</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE EDICIÓN -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>
                    Editar Conteo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editItemId">
                    <div class="mb-3">
                        <label class="form-label">Código Material</label>
                        <input type="text" class="form-control" id="editMaterialCode" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="editDescription" rows="2" readonly></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ubicación</label>
                            <input type="text" class="form-control" id="editLocation" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Stock Sistema</label>
                            <input type="number" class="form-control" id="editStock" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conteo Físico *</label>
                        <input type="number" class="form-control" id="editCount" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" id="editNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// ================= CONFIGURACIÓN =================
const CONFIG = {
    API: {
        base: '{{ url_for("inventory.index") }}',
        update: '{{ url_for("inventory.update_count") }}',
        delete: '{{ url_for("inventory.delete_item") }}',
        export_all: '{{ url_for("inventory.export_inventory") }}',
        export_diff: '{{ url_for("inventory.export_differences") }}'
    }
};

// ================= DATOS REALES =================
let dashboardData = {
    items: [],
    filteredItems: [],
    currentSort: { field: null, direction: 'asc' },
    currentPage: 1,
    itemsPerPage: 25,
    searchTerm: '',
    filters: {
        status: 'all',
        location: 'all'
    }
};

// ================= INICIALIZACIÓN =================
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    initCharts();
    setupEventListeners();
});

function loadData() {
    // Cargar datos desde la tabla HTML
    const rows = document.querySelectorAll('#tableBody tr');
    dashboardData.items = [];
    
    rows.forEach(row => {
        const data = {
            id: row.dataset.id,
            code: row.dataset.code,
            desc: row.dataset.desc,
            location: row.dataset.location,
            stock: parseInt(row.dataset.stock) || 0,
            count: parseInt(row.dataset.count) || 0,
            diferencia: parseInt(row.dataset.diferencia) || 0,
            estado: row.dataset.estado,
            user: row.dataset.user,
            timestamp: row.dataset.timestamp,
            element: row
        };
        dashboardData.items.push(data);
    });
    
    dashboardData.filteredItems = [...dashboardData.items];
    updateTableInfo();
}

// ================= GRÁFICOS CON DATOS REALES =================
function initCharts() {
    // Gráfico de distribución por estado
    const estadoData = {
        OK: 0,
        Diferencia: 0,
        Pendiente: 0
    };
    
    dashboardData.items.forEach(item => {
        estadoData[item.estado] = (estadoData[item.estado] || 0) + 1;
    });
    
    const estadoCtx = document.getElementById('estadoChart');
    if (estadoCtx) {
        new Chart(estadoCtx, {
            type: 'doughnut',
            data: {
                labels: ['Coinciden', 'Diferencias', 'Pendientes'],
                datasets: [{
                    data: [estadoData.OK, estadoData.Diferencia, estadoData.Pendiente],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.9)',
                        'rgba(255, 193, 7, 0.9)',
                        'rgba(108, 117, 125, 0.9)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(108, 117, 125, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico de conteos por hora
    const hourlyData = {};
    dashboardData.items.forEach(item => {
        if (item.timestamp) {
            const hour = new Date(item.timestamp).getHours();
            hourlyData[hour] = (hourlyData[hour] || 0) + 1;
        }
    });
    
    const hours = Array.from({length: 24}, (_, i) => i);
    const counts = hours.map(hour => hourlyData[hour] || 0);
    
    const hourlyCtx = document.getElementById('hourlyChart');
    if (hourlyCtx) {
        new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: hours.map(h => `${h}:00`),
                datasets: [{
                    label: 'Conteos por Hora',
                    data: counts,
                    backgroundColor: 'rgba(26, 95, 122, 0.7)',
                    borderColor: 'rgba(26, 95, 122, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
}

// ================= FILTROS Y BÚSQUEDA =================
function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const location = document.getElementById('locationFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    dashboardData.filters.status = status;
    dashboardData.filters.location = location;
    dashboardData.searchTerm = search;
    
    filterItems();
}

function filterItems() {
    dashboardData.filteredItems = dashboardData.items.filter(item => {
        // Filtro por estado
        if (dashboardData.filters.status !== 'all' && item.estado !== dashboardData.filters.status) {
            return false;
        }
        
        // Filtro por ubicación
        if (dashboardData.filters.location !== 'all' && item.location !== dashboardData.filters.location) {
            return false;
        }
        
        // Búsqueda
        if (dashboardData.searchTerm) {
            const searchTerm = dashboardData.searchTerm.toLowerCase();
            return item.code.toLowerCase().includes(searchTerm) ||
                   item.desc.toLowerCase().includes(searchTerm) ||
                   item.location.toLowerCase().includes(searchTerm);
        }
        
        return true;
    });
    
    updateTable();
    updateTableInfo();
}

function clearFilters() {
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('locationFilter').value = 'all';
    document.getElementById('searchInput').value = '';
    
    dashboardData.filters = { status: 'all', location: 'all' };
    dashboardData.searchTerm = '';
    dashboardData.filteredItems = [...dashboardData.items];
    
    updateTable();
    updateTableInfo();
    
    showNotification('Filtros limpiados', 'Se han eliminado todos los filtros', 'info');
}

function sortTable(field) {
    const isAsc = dashboardData.currentSort.field === field && 
                  dashboardData.currentSort.direction === 'asc';
    
    dashboardData.currentSort = {
        field: field,
        direction: isAsc ? 'desc' : 'asc'
    };
    
    dashboardData.filteredItems.sort((a, b) => {
        let aVal, bVal;
        
        switch(field) {
            case 'code':
                aVal = a.code;
                bVal = b.code;
                break;
            case 'stock':
                aVal = a.stock;
                bVal = b.stock;
                break;
            case 'count':
                aVal = a.count;
                bVal = b.count;
                break;
            case 'diff':
                aVal = a.diferencia;
                bVal = b.diferencia;
                break;
            default:
                return 0;
        }
        
        if (typeof aVal === 'string') {
            return dashboardData.currentSort.direction === 'asc' 
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        } else {
            return dashboardData.currentSort.direction === 'asc'
                ? aVal - bVal
                : bVal - aVal;
        }
    });
    
    updateTable();
}

function updateTable() {
    // Mostrar/ocultar filas según filtros
    dashboardData.items.forEach(item => {
        const isVisible = dashboardData.filteredItems.some(filtered => filtered.id === item.id);
        item.element.style.display = isVisible ? '' : 'none';
    });
}

function updateTableInfo() {
    const filteredCount = dashboardData.filteredItems.length;
    const totalCount = dashboardData.items.length;
    
    document.getElementById('filteredCount').textContent = filteredCount;
    document.querySelector('.table-badge').textContent = filteredCount;
}

// ================= GESTIÓN DE ITEMS =================
async function editItem(itemId) {
    const item = dashboardData.items.find(item => item.id == itemId);
    if (!item) return;
    
    document.getElementById('editItemId').value = item.id;
    document.getElementById('editMaterialCode').value = item.code;
    document.getElementById('editDescription').value = item.desc;
    document.getElementById('editLocation').value = item.location;
    document.getElementById('editStock').value = item.stock;
    document.getElementById('editCount').value = item.count || '';
    document.getElementById('editNotes').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

async function saveEdit() {
    const itemId = document.getElementById('editItemId').value;
    const count = parseInt(document.getElementById('editCount').value);
    const notes = document.getElementById('editNotes').value;
    
    if (isNaN(count) || count < 0) {
        showNotification('Error', 'El conteo debe ser un número positivo', 'error');
        return;
    }
    
    showLoading('Guardando cambios...');
    
    try {
        const response = await fetch(CONFIG.API.update, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: itemId,
                real_count: count,
                notes: notes
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Actualizar datos locales
            const item = dashboardData.items.find(item => item.id == itemId);
            if (item) {
                item.count = count;
                item.diferencia = count - item.stock;
                item.estado = count === item.stock ? 'OK' : 'Diferencia';
                
                // Actualizar fila en tabla
                updateTableRow(item);
                
                // Recargar datos
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
                showNotification('Actualizado', 'El conteo ha sido actualizado', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            }
        } else {
            showNotification('Error', result.message || 'Error al actualizar', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión', 'error');
    } finally {
        hideLoading();
    }
}

function updateTableRow(item) {
    const row = item.element;
    const diferencia_abs = Math.abs(item.diferencia);
    
    // Actualizar conteo físico
    row.cells[4].innerHTML = `<span class="fw-bold ${item.estado === 'OK' ? 'text-success' : item.estado === 'Diferencia' ? 'text-danger' : 'text-muted'}">
        ${item.count > 0 ? item.count : '-'}
    </span>`;
    
    // Actualizar diferencia
    row.cells[5].innerHTML = item.estado === 'OK' 
        ? '<span class="text-muted">0</span>'
        : `<span class="fw-bold ${item.diferencia > 0 ? 'text-success' : 'text-danger'}">
              ${item.diferencia > 0 ? '<i class="bi bi-arrow-up-circle me-1"></i>+' : '<i class="bi bi-arrow-down-circle me-1"></i>'}${diferencia_abs}
           </span>`;
    
    // Actualizar estado
    row.cells[6].innerHTML = item.estado === 'OK'
        ? '<span class="status-badge badge-success"><i class="bi bi-check-circle me-1"></i>OK</span>'
        : item.estado === 'Diferencia'
        ? '<span class="status-badge badge-warning"><i class="bi bi-exclamation-triangle me-1"></i>Diferencia</span>'
        : '<span class="status-badge badge-secondary"><i class="bi bi-clock me-1"></i>Pendiente</span>';
    
    // Actualizar dataset
    row.dataset.count = item.count;
    row.dataset.diferencia = item.diferencia;
    row.dataset.estado = item.estado;
}

async function deleteItem(itemId) {
    const result = await Swal.fire({
        title: '¿Eliminar item?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#dc3545'
    });
    
    if (!result.isConfirmed) return;
    
    showLoading('Eliminando item...');
    
    try {
        const response = await fetch(CONFIG.API.delete, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: itemId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Eliminar de los arrays
            dashboardData.items = dashboardData.items.filter(item => item.id != itemId);
            dashboardData.filteredItems = dashboardData.filteredItems.filter(item => item.id != itemId);
            
            // Eliminar del DOM
            const item = dashboardData.items.find(item => item.id == itemId);
            if (item && item.element) {
                item.element.remove();
            }
            
            updateTableInfo();
            showNotification('Eliminado', 'El item ha sido eliminado', 'success');
            
            // Recargar para actualizar estadísticas
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('Error', data.message || 'Error al eliminar', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión', 'error');
    } finally {
        hideLoading();
    }
}

// ================= EXPORTACIÓN =================
function exportToExcel() {
    showLoading('Generando Excel...');
    
    const data = dashboardData.filteredItems;
    if (data.length === 0) {
        hideLoading();
        showNotification('Sin datos', 'No hay datos para exportar', 'warning');
        return;
    }
    
    // Crear datos para Excel
    const excelData = [
        ['REPORTE DE CONTEO FÍSICO'],
        ['Fecha:', new Date().toLocaleDateString()],
        ['Hora:', new Date().toLocaleTimeString()],
        ['Total items:', data.length],
        [''],
        ['Código', 'Descripción', 'Ubicación', 'Stock Sistema', 'Conteo Físico', 'Diferencia', 'Estado', 'Usuario', 'Fecha']
    ];
    
    data.forEach(item => {
        excelData.push([
            item.code,
            item.desc,
            item.location,
            item.stock,
            item.count || '-',
            item.diferencia > 0 ? `+${item.diferencia}` : item.diferencia,
            item.estado,
            item.user || '-',
            item.timestamp ? new Date(item.timestamp).toLocaleDateString() : '-'
        ]);
    });
    
    // Crear libro de trabajo
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Conteo Físico');
    
    // Generar nombre de archivo
    const date = new Date().toISOString().split('T')[0];
    const fileName = `conteo_fisico_${date}.xlsx`;
    
    // Descargar archivo
    XLSX.writeFile(wb, fileName);
    
    hideLoading();
    showNotification('Excel generado', `Se ha generado: ${fileName}`, 'success');
}

function exportDifferences() {
    const differences = dashboardData.items.filter(item => item.estado === 'Diferencia');
    if (differences.length === 0) {
        showNotification('Sin diferencias', 'No hay diferencias para exportar', 'info');
        return;
    }
    
    showLoading('Generando Excel de diferencias...');
    
    // Crear datos para Excel
    const excelData = [
        ['REPORTE DE DIFERENCIAS'],
        ['Fecha:', new Date().toLocaleDateString()],
        ['Total diferencias:', differences.length],
        [''],
        ['Código', 'Descripción', 'Ubicación', 'Stock Sistema', 'Conteo Físico', 'Diferencia', 'Usuario', 'Fecha']
    ];
    
    differences.forEach(item => {
        excelData.push([
            item.code,
            item.desc,
            item.location,
            item.stock,
            item.count,
            item.diferencia > 0 ? `+${item.diferencia}` : item.diferencia,
            item.user || '-',
            item.timestamp ? new Date(item.timestamp).toLocaleDateString() : '-'
        ]);
    });
    
    // Crear libro de trabajo
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Diferencias');
    
    // Generar nombre de archivo
    const date = new Date().toISOString().split('T')[0];
    const fileName = `diferencias_conteo_${date}.xlsx`;
    
    // Descargar archivo
    XLSX.writeFile(wb, fileName);
    
    hideLoading();
    showNotification('Diferencias exportadas', `Se ha generado: ${fileName}`, 'success');
}

function exportToPDF() {
    showLoading('Generando PDF...');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    let yPos = margin;
    
    // Título
    doc.setFontSize(18);
    doc.setTextColor(26, 95, 122);
    doc.setFont('helvetica', 'bold');
    doc.text('REPORTE DE CONTEO FÍSICO', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    // Información
    doc.setFontSize(10);
    doc.setTextColor(108, 117, 125);
    doc.setFont('helvetica', 'normal');
    doc.text(`Fecha: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, yPos);
    doc.text(`Total items: ${dashboardData.items.length}`, pageWidth - margin, yPos, { align: 'right' });
    yPos += 15;
    
    // Estadísticas
    const okItems = dashboardData.items.filter(item => item.estado === 'OK').length;
    const diffItems = dashboardData.items.filter(item => item.estado === 'Diferencia').length;
    const pendItems = dashboardData.items.length - okItems - diffItems;
    
    doc.setFontSize(12);
    doc.setTextColor(33, 37, 41);
    doc.setFont('helvetica', 'bold');
    doc.text('ESTADÍSTICAS', margin, yPos);
    yPos += 10;
    
    const stats = [
        `• Coincidencias (OK): ${okItems} (${Math.round((okItems / dashboardData.items.length) * 100)}%)`,
        `• Diferencias: ${diffItems} (${Math.round((diffItems / dashboardData.items.length) * 100)}%)`,
        `• Pendientes: ${pendItems} (${Math.round((pendItems / dashboardData.items.length) * 100)}%)`
    ];
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    stats.forEach(stat => {
        doc.text(stat, margin + 5, yPos);
        yPos += 7;
    });
    
    yPos += 10;
    
    // Tabla de datos
    const tableData = dashboardData.items.map(item => [
        item.code,
        item.desc.substring(0, 30) + (item.desc.length > 30 ? '...' : ''),
        item.location,
        item.stock.toString(),
        item.count.toString() || '-',
        item.diferencia > 0 ? `+${item.diferencia}` : item.diferencia.toString(),
        item.estado,
        item.user || '-'
    ]);
    
    doc.autoTable({
        startY: yPos,
        head: [['Código', 'Descripción', 'Ubicación', 'Stock', 'Conteo', 'Diferencia', 'Estado', 'Usuario']],
        body: tableData,
        margin: { left: margin, right: margin },
        styles: { fontSize: 8 },
        headStyles: { 
            fillColor: [26, 95, 122],
            textColor: 255,
            fontStyle: 'bold'
        }
    });
    
    // Guardar PDF
    const date = new Date().toISOString().split('T')[0];
    const filename = `reporte_conteo_${date}.pdf`;
    doc.save(filename);
    
    hideLoading();
    showNotification('PDF generado', `Se ha generado: ${filename}`, 'success');
}

function exportDashboard() {
    exportToPDF();
}

// ================= FUNCIONALIDADES ADICIONALES =================
function loadLatestData() {
    showLoading('Actualizando datos...');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    const isActive = btn.classList.contains('btn-info');
    
    if (isActive) {
        btn.classList.remove('btn-info');
        btn.classList.add('btn-outline-action');
        showNotification('Auto-refresh desactivado', 'Actualización automática desactivada', 'info');
    } else {
        btn.classList.remove('btn-outline-action');
        btn.classList.add('btn-info');
        showNotification('Auto-refresh activado', 'Los datos se actualizarán cada 5 minutos', 'info');
        // Aquí podrías agregar setInterval para actualización automática
    }
}

function showReconciliation() {
    const differences = dashboardData.items.filter(item => item.estado === 'Diferencia');
    
    if (differences.length === 0) {
        showNotification('Sin diferencias', 'No hay diferencias para conciliar', 'info');
        return;
    }
    
    Swal.fire({
        title: 'Conciliar Inventario',
        html: `
            <div class="text-start">
                <p>Se encontraron <strong>${differences.length}</strong> diferencias.</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Esta acción actualizará el stock del sistema.
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmReconciliation">
                    <label class="form-check-label" for="confirmReconciliation">
                        Confirmo la conciliación del inventario
                    </label>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Conciliar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading(`Conciliando ${differences.length} diferencias...`);
            
            // Simular conciliación
            setTimeout(() => {
                showNotification('Conciliación completada', `Se han conciliado ${differences.length} diferencias`, 'success');
                hideLoading();
                
                // Recargar para ver cambios
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }, 2000);
        }
    });
}

function showHelp() {
    Swal.fire({
        title: 'Ayuda del Dashboard',
        html: `
            <div class="text-start">
                <h5>Funcionalidades:</h5>
                <ul>
                    <li><strong>Filtros:</strong> Filtra por estado y ubicación</li>
                    <li><strong>Búsqueda:</strong> Busca por código o descripción</li>
                    <li><strong>Edición:</strong> Click en el ícono de lápiz para editar</li>
                    <li><strong>Exportación:</strong> Exporta a Excel o PDF</li>
                    <li><strong>Gráficos:</strong> Visualiza distribución y tendencias</li>
                </ul>
                <h5>Atajos:</h5>
                <ul>
                    <li><kbd>Ctrl</kbd> + <kbd>F</kbd> - Buscar</li>
                    <li><kbd>Ctrl</kbd> + <kbd>E</kbd> - Exportar Excel</li>
                    <li><kbd>Ctrl</kbd> + <kbd>P</kbd> - Exportar PDF</li>
                </ul>
            </div>
        `,
        width: 600,
        confirmButtonText: 'Entendido'
    });
}

// ================= UTILIDADES =================
function showLoading(message = 'Cargando...') {
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').classList.remove('d-none');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('d-none');
}

function showNotification(title, message, type = 'info') {
    const panel = document.getElementById('notificationPanel');
    const notificationId = 'notification-' + Date.now();
    
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.className = `notification-toast notification-${type}`;
    
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="document.getElementById('${notificationId}').remove()">
            <i class="bi bi-x"></i>
        </button>
    `;
    
    panel.appendChild(notification);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        const notif = document.getElementById(notificationId);
        if (notif) {
            notif.remove();
        }
    }, 5000);
}

function setupEventListeners() {
    // Búsqueda en tiempo real
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        });
    }
    
    // Teclas rápidas
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            searchInput?.focus();
            searchInput?.select();
        }
        
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            exportToExcel();
        }
        
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            exportToPDF();
        }
        
        if (e.key === 'Escape') {
            clearFilters();
        }
    });
}

// Exportar funciones al scope global
window.loadLatestData = loadLatestData;
window.toggleAutoRefresh = toggleAutoRefresh;
window.showHelp = showHelp;
window.clearFilters = clearFilters;
window.applyFilters = applyFilters;
window.sortTable = sortTable;
window.editItem = editItem;
window.deleteItem = deleteItem;
window.exportToExcel = exportToExcel;
window.exportDifferences = exportDifferences;
window.exportToPDF = exportToPDF;
window.exportDashboard = exportDashboard;
window.showReconciliation = showReconciliation;
</script>

{% endblock %}
