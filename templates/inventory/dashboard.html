{% extends "base.html" %}
{% block content %}

<style>
    /* ================= VARIABLES Y ESTILOS GENERALES ================= */
    :root {
        --primary: #1a5f7a;
        --primary-light: rgba(26, 95, 122, 0.1);
        --secondary: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #343a40;
        
        --primary-gradient: linear-gradient(135deg, #1a5f7a 0%, #0d4c6e 100%);
        --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --warning-gradient: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        --danger-gradient: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        --info-gradient: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        --dark-gradient: linear-gradient(135deg, #343a40 0%, #212529 100%);
        
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 8px;
    }

    .dashboard-container {
        padding: 20px;
        background: #f8fafc;
        min-height: calc(100vh - 80px);
    }

    /* ================= HEADER COMPACTO ================= */
    .dashboard-header {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .header-title h1 {
        font-weight: 700;
        color: var(--primary);
        margin: 0;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .header-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        padding-top: 15px;
        border-top: 1px solid #f1f5f9;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }

    .stat-info h4 {
        margin: 0;
        font-weight: 700;
        font-size: 1.5rem;
        line-height: 1.2;
    }

    .stat-info span {
        font-size: 0.85rem;
        color: #6c757d;
        display: block;
    }

    /* ================= LAYOUT PRINCIPAL ================= */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        margin-bottom: 20px;
    }

    .main-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* ================= KPI CARDS COMPACTAS ================= */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .kpi-card {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        min-height: auto;
    }

    .kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    .kpi-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
    }

    .kpi-content {
        flex: 1;
    }

    .kpi-value {
        font-size: 1.8rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 5px;
        color: var(--dark);
    }

    .kpi-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    /* ================= CHART SECTION COMPACTA ================= */
    .chart-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .chart-card {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        height: 100%;
    }

    .chart-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-title {
        font-weight: 600;
        color: var(--dark);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-title i {
        color: var(--primary);
    }

    .chart-body {
        padding: 15px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-body canvas {
        width: 100% !important;
        height: 100% !important;
    }

    /* ================= SIDEBAR WIDGETS ================= */
    .widget {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        overflow: hidden;
    }

    .widget-header {
        padding: 15px 20px;
        background: var(--primary-gradient);
        color: white;
    }

    .widget-header h5 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .widget-body {
        padding: 15px;
    }

    /* Stock Status Widget */
    .status-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .status-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        background: #f8f9fa;
        transition: all 0.2s;
    }

    .status-item:hover {
        background: #e9ecef;
    }

    .status-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
    }

    /* Quick Actions Widget */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .action-btn {
        padding: 12px;
        border: 1px solid #dee2e6;
        border-radius: var(--radius-sm);
        background: white;
        color: var(--dark);
        text-align: center;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        text-decoration: none;
        cursor: pointer;
    }

    .action-btn:hover {
        background: var(--primary-light);
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    .action-btn i {
        font-size: 1.2rem;
        color: var(--primary);
    }

    .action-btn span {
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* ================= TABLA COMPACTA ================= */
    .table-card {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        margin-top: 0;
    }

    .table-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .table-title {
        font-weight: 600;
        color: var(--dark);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-container {
        position: relative;
        min-width: 250px;
    }

    .search-input {
        width: 100%;
        padding: 8px 16px 8px 36px;
        border: 1px solid #e2e8f0;
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        transition: all 0.2s;
        background: #f8fafc;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        background: white;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
    }

    /* Tabla */
    .dashboard-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
    }

    .dashboard-table thead {
        background: #f1f5f9;
        position: sticky;
        top: 0;
    }

    .dashboard-table th {
        color: #4a5568;
        font-weight: 600;
        padding: 12px 15px;
        border-bottom: 2px solid #e2e8f0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.8rem;
    }

    .dashboard-table td {
        padding: 12px 15px;
        color: #2d3748;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
    }

    .dashboard-table tbody tr:hover {
        background-color: #f8fafc;
    }

    /* Badges en tabla */
    .stock-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        min-width: 70px;
    }

    .badge-critical { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
    .badge-low { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #212529; }
    .badge-ok { background: linear-gradient(135deg, #28a745, #20c997); color: white; }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 1200px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }
        
        .chart-row {
            grid-template-columns: 1fr;
        }
        
        .header-top {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .header-actions {
            width: 100%;
            justify-content: flex-start;
        }
        
        .search-container {
            width: 100%;
        }
        
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 576px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-body {
            height: 180px;
        }
        
        .header-stats {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            grid-template-columns: 1fr;
        }
        
        .quick-actions {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* ================= ANIMACIONES ================= */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    /* ================= SCROLLBAR PERSONALIZADA ================= */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
</style>

<div class="dashboard-container">
    <!-- ================= HEADER COMPACTO ================= -->
    <div class="dashboard-header fade-in">
        <div class="header-top">
            <div class="header-title">
                <h1>
                    <i class="bi bi-speedometer2"></i>
                    Dashboard de Inventario
                </h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="updateDashboard()">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
                <button class="btn btn-sm btn-primary" onclick="exportDashboard()">
                    <i class="bi bi-download"></i> Exportar
                </button>
            </div>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--primary-gradient);">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="stat-info">
                    <h4 id="totalItems">{{ items|length if items else 0 }}</h4>
                    <span>Total Materiales</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--danger-gradient);">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    {% set criticos = items|selectattr('libre_utilizacion', 'defined')|selectattr('libre_utilizacion', '<=', 0)|list|length if items else 0 %}
                    <h4 id="criticalItems">{{ criticos }}</h4>
                    <span>Stock Cr칤tico</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--warning-gradient);">
                    <i class="bi bi-exclamation-circle"></i>
                </div>
                <div class="stat-info">
                    {% set bajos = items|selectattr('libre_utilizacion', 'defined')|selectattr('libre_utilizacion', '>', 0)|selectattr('libre_utilizacion', '<', 10)|list|length if items else 0 %}
                    <h4 id="lowItems">{{ bajos }}</h4>
                    <span>Stock Bajo</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--success-gradient);">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-info">
                    {% set normales = items|selectattr('libre_utilizacion', 'defined')|selectattr('libre_utilizacion', '>=', 10)|list|length if items else 0 %}
                    <h4 id="okItems">{{ normales }}</h4>
                    <span>Stock Normal</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= LAYOUT PRINCIPAL ================= -->
    <div class="dashboard-layout fade-in">
        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-content">
            <!-- KPI CARDS -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--primary-gradient);">
                        <i class="bi bi-geo-alt"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalLocations">0</div>
                        <div class="kpi-label">Ubicaciones 칔nicas</div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--info-gradient);">
                        <i class="bi bi-calculator"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalStock">0</div>
                        <div class="kpi-label">Stock Total</div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--dark-gradient);">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="avgStock">0</div>
                        <div class="kpi-label">Promedio por Item</div>
                    </div>
                </div>
            </div>

            <!-- GR츼FICOS -->
            <div class="chart-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-pie-chart"></i>
                            Distribuci칩n por Estado
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                    onclick="toggleChartType('pie')">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="estadoChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-bar-chart"></i>
                            Stock por Ubicaci칩n
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                    onclick="toggleChartType('bar')">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="ubicacionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TABLA DE INVENTARIO -->
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">
                        <i class="bi bi-table"></i>
                        Inventario Detallado
                        <span id="filteredCount" class="badge bg-secondary">{{ items|length if items else 0 }}</span>
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        <div class="search-container">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="searchInv" class="search-input" 
                                   placeholder="Buscar material, ubicaci칩n...">
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()" title="Limpiar filtros">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="dashboard-table">
                        <thead>
                            <tr>
                                <th>C칩digo</th>
                                <th>Descripci칩n</th>
                                <th>Ubicaci칩n</th>
                                <th>Stock</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            {% if items and items|length > 0 %}
                                {% for item in items %}
                                {% set stock = item.libre_utilizacion if item.libre_utilizacion is defined else 0 %}
                                <tr class="inventory-row" 
                                    data-code="{{ item.material_code|default('', true) }}"
                                    data-desc="{{ item.material_text|default('', true) }}"
                                    data-location="{{ item.location|default('Sin ubicaci칩n', true) }}"
                                    data-stock="{{ stock }}">
                                    <td class="fw-semibold">{{ item.material_code|default('N/A', true) }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" 
                                             title="{{ item.material_text|default('', true) }}">
                                            {{ item.material_text|default('Sin descripci칩n', true) }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-dark">{{ item.location|default('Sin ubicaci칩n', true) }}</span>
                                    </td>
                                    <td class="fw-bold {% if stock <= 0 %}text-danger{% elif stock < 10 %}text-warning{% else %}text-success{% endif %}">
                                        {{ stock }}
                                    </td>
                                    <td>
                                        {% if stock <= 0 %}
                                            <span class="stock-badge badge-critical">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Cr칤tico
                                            </span>
                                        {% elif stock < 10 %}
                                            <span class="stock-badge badge-low">
                                                <i class="bi bi-exclamation-circle me-1"></i>Bajo
                                            </span>
                                        {% else %}
                                            <span class="stock-badge badge-ok">
                                                <i class="bi bi-check-circle me-1"></i>OK
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="bi bi-inbox display-6"></i>
                                            <p class="mt-2 mb-3">No hay items de inventario</p>
                                            <a href="{{ url_for('inventory.upload_inventory') }}" class="btn btn-sm btn-primary">
                                                <i class="bi bi-upload me-1"></i>Cargar Inventario
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- WIDGET: ESTADO DE STOCK -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-clipboard-data"></i> Resumen por Estado</h5>
                </div>
                <div class="widget-body">
                    <div class="status-list">
                        <div class="status-item">
                            <div class="status-label">
                                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                <span>Stock Cr칤tico</span>
                            </div>
                            <span class="status-badge" style="background: var(--danger-gradient);">
                                {{ criticos }}
                            </span>
                        </div>
                        <div class="status-item">
                            <div class="status-label">
                                <i class="bi bi-exclamation-circle-fill text-warning"></i>
                                <span>Stock Bajo</span>
                            </div>
                            <span class="status-badge" style="background: var(--warning-gradient);">
                                {{ bajos }}
                            </span>
                        </div>
                        <div class="status-item">
                            <div class="status-label">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <span>Stock Normal</span>
                            </div>
                            <span class="status-badge" style="background: var(--success-gradient);">
                                {{ normales }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDGET: ACCIONES R츼PIDAS -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-lightning-charge"></i> Acciones R치pidas</h5>
                </div>
                <div class="widget-body">
                    <div class="quick-actions">
                        <a href="{{ url_for('inventory.upload_inventory') }}" class="action-btn">
                            <i class="bi bi-upload"></i>
                            <span>Cargar Inventario</span>
                        </a>
                        <button class="action-btn" onclick="exportData()">
                            <i class="bi bi-download"></i>
                            <span>Exportar Datos</span>
                        </button>
                        <button class="action-btn" onclick="showReport()">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>Generar Reporte</span>
                        </button>
                        <button class="action-btn" onclick="showSettings()">
                            <i class="bi bi-gear"></i>
                            <span>Ajustes</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- WIDGET: TOP UBICACIONES -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-trophy"></i> Top Ubicaciones</h5>
                </div>
                <div class="widget-body">
                    <div id="topLocations">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                            <span class="ms-2">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= JAVASCRIPT OPTIMIZADO ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ================= CONFIGURACI칍N INICIAL =================
let charts = {};
let inventoryData = [];
let filteredData = [];

// ================= INICIALIZAR DATOS =================
function initDashboard() {
    console.log('游 Inicializando dashboard...');
    
    // Recopilar datos de la tabla
    collectInventoryData();
    
    // Calcular m칠tricas
    calculateMetrics();
    
    // Renderizar gr치ficos
    renderCharts();
    
    // Inicializar widgets
    initWidgets();
    
    // Configurar b칰squeda
    setupSearch();
    
    // Configurar eventos
    setupEvents();
}

// ================= RECOPILAR DATOS DEL INVENTARIO =================
function collectInventoryData() {
    inventoryData = [];
    document.querySelectorAll('.inventory-row').forEach(row => {
        const data = {
            code: row.dataset.code || '',
            desc: row.dataset.desc || '',
            location: row.dataset.location || 'Sin ubicaci칩n',
            stock: parseInt(row.dataset.stock) || 0,
            element: row
        };
        inventoryData.push(data);
    });
    filteredData = [...inventoryData];
    console.log(`游닍 ${inventoryData.length} items cargados`);
}

// ================= CALCULAR M칄TRICAS =================
function calculateMetrics() {
    if (inventoryData.length === 0) return;
    
    // Ubicaciones 칰nicas
    const locations = new Set(inventoryData.map(item => item.location));
    document.getElementById('totalLocations').textContent = locations.size;
    
    // Stock total
    const totalStock = inventoryData.reduce((sum, item) => sum + item.stock, 0);
    document.getElementById('totalStock').textContent = totalStock.toLocaleString();
    
    // Promedio por item
    const avgStock = totalStock / inventoryData.length;
    document.getElementById('avgStock').textContent = avgStock.toFixed(1);
    
    // Top ubicaciones
    updateTopLocations();
}

// ================= ACTUALIZAR TOP UBICACIONES =================
function updateTopLocations() {
    if (inventoryData.length === 0) {
        document.getElementById('topLocations').innerHTML = '<p class="text-muted">No hay datos</p>';
        return;
    }
    
    // Agrupar por ubicaci칩n
    const locationMap = new Map();
    inventoryData.forEach(item => {
        if (!locationMap.has(item.location)) {
            locationMap.set(item.location, 0);
        }
        locationMap.set(item.location, locationMap.get(item.location) + item.stock);
    });
    
    // Ordenar y tomar top 5
    const topLocations = Array.from(locationMap.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    // Renderizar
    const html = topLocations.map(([location, stock], index) => `
        <div class="d-flex align-items-center justify-content-between mb-2 pb-2 ${index < topLocations.length - 1 ? 'border-bottom' : ''}">
            <div class="d-flex align-items-center">
                <span class="badge bg-secondary me-2">${index + 1}</span>
                <span class="text-truncate" style="max-width: 150px;" title="${location}">
                    ${location}
                </span>
            </div>
            <span class="fw-bold text-primary">${stock}</span>
        </div>
    `).join('');
    
    document.getElementById('topLocations').innerHTML = html || '<p class="text-muted">No hay datos</p>';
}

// ================= RENDERIZAR GR츼FICOS =================
function renderCharts() {
    renderEstadoChart();
    renderUbicacionChart();
}

// Gr치fico de distribuci칩n por estado
function renderEstadoChart() {
    const ctx = document.getElementById('estadoChart');
    if (!ctx) return;
    
    // Calcular estad칤sticas
    const criticos = inventoryData.filter(item => item.stock <= 0).length;
    const bajos = inventoryData.filter(item => item.stock > 0 && item.stock < 10).length;
    const normales = inventoryData.filter(item => item.stock >= 10).length;
    
    // Destruir gr치fico anterior si existe
    if (charts.estado) {
        charts.estado.destroy();
    }
    
    // Crear nuevo gr치fico
    charts.estado = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Cr칤tico', 'Bajo', 'Normal'],
            datasets: [{
                data: [criticos, bajos, normales],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.9)',
                    'rgba(255, 193, 7, 0.9)',
                    'rgba(40, 167, 69, 0.9)'
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(40, 167, 69, 1)'
                ],
                borderWidth: 1,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                }
            },
            cutout: '65%',
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

// Gr치fico de stock por ubicaci칩n
function renderUbicacionChart() {
    const ctx = document.getElementById('ubicacionChart');
    if (!ctx) return;
    
    // Agrupar por ubicaci칩n
    const locationMap = new Map();
    inventoryData.forEach(item => {
        if (!locationMap.has(item.location)) {
            locationMap.set(item.location, 0);
        }
        locationMap.set(item.location, locationMap.get(item.location) + item.stock);
    });
    
    // Ordenar y tomar top 7
    const topLocations = Array.from(locationMap.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 7);
    
    // Destruir gr치fico anterior si existe
    if (charts.ubicacion) {
        charts.ubicacion.destroy();
    }
    
    // Crear nuevo gr치fico
    charts.ubicacion = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topLocations.map(([location]) => location),
            datasets: [{
                label: 'Stock Total',
                data: topLocations.map(([, stock]) => stock),
                backgroundColor: 'rgba(23, 162, 184, 0.7)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1,
                borderRadius: 4,
                hoverBackgroundColor: 'rgba(23, 162, 184, 0.9)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 10
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

// ================= CONFIGURAR B칔SQUEDA =================
function setupSearch() {
    const searchInput = document.getElementById('searchInv');
    if (!searchInput) return;
    
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterInventory(this.value.toLowerCase().trim());
        }, 300);
    });
}

function filterInventory(searchTerm) {
    if (!searchTerm) {
        // Mostrar todos los items
        filteredData = [...inventoryData];
        inventoryData.forEach(item => {
            item.element.style.display = '';
        });
        document.getElementById('filteredCount').textContent = inventoryData.length;
        return;
    }
    
    // Filtrar datos
    filteredData = inventoryData.filter(item => {
        return item.code.toLowerCase().includes(searchTerm) ||
               item.desc.toLowerCase().includes(searchTerm) ||
               item.location.toLowerCase().includes(searchTerm) ||
               item.stock.toString().includes(searchTerm);
    });
    
    // Mostrar/ocultar filas
    let visibleCount = 0;
    inventoryData.forEach(item => {
        const isVisible = filteredData.includes(item);
        item.element.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
    });
    
    // Actualizar contador
    document.getElementById('filteredCount').textContent = visibleCount;
}

// ================= CONFIGURAR EVENTOS =================
function setupEvents() {
    // Eventos de clic en filas
    document.querySelectorAll('.inventory-row').forEach(row => {
        row.addEventListener('click', function() {
            const code = this.dataset.code;
            const desc = this.dataset.desc;
            showToast(`Seleccionado: ${code}`, 'info');
        });
    });
    
    // Actualizaci칩n peri칩dica
    setInterval(() => {
        updateDashboard();
    }, 30000); // Cada 30 segundos
}

// ================= FUNCIONES UTILITARIAS =================
function updateDashboard() {
    console.log('游댃 Actualizando dashboard...');
    collectInventoryData();
    calculateMetrics();
    renderCharts();
    updateTopLocations();
    showToast('Dashboard actualizado', 'success');
}

function clearFilters() {
    document.getElementById('searchInv').value = '';
    filterInventory('');
    showToast('Filtros limpiados', 'info');
}

function toggleChartType(type) {
    if (charts.estado && type === 'pie') {
        charts.estado.config.type = charts.estado.config.type === 'doughnut' ? 'pie' : 'doughnut';
        charts.estado.update();
    }
}

function exportDashboard() {
    const dataStr = JSON.stringify({
        timestamp: new Date().toISOString(),
        totalItems: inventoryData.length,
        metrics: {
            criticos: inventoryData.filter(item => item.stock <= 0).length,
            bajos: inventoryData.filter(item => item.stock > 0 && item.stock < 10).length,
            normales: inventoryData.filter(item => item.stock >= 10).length,
            totalStock: inventoryData.reduce((sum, item) => sum + item.stock, 0)
        }
    }, null, 2);
    
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dashboard-export-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Dashboard exportado', 'success');
}

function exportData() {
    // Aqu칤 implementar칤as la exportaci칩n de datos
    showToast('Funcionalidad de exportaci칩n en desarrollo', 'info');
}

function showReport() {
    // Aqu칤 implementar칤as la generaci칩n de reportes
    showToast('Generando reporte...', 'info');
}

function showSettings() {
    // Aqu칤 implementar칤as la configuraci칩n
    showToast('Ajustes del sistema', 'info');
}

function showToast(message, type = 'info') {
    // Crear toast si no existe
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        `;
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast show`;
    toast.style.cssText = `
        min-width: 250px;
        margin-bottom: 10px;
        animation: slideInRight 0.3s ease-out;
    `;
    
    const typeIcons = {
        'success': 'check-circle-fill',
        'danger': 'exclamation-triangle-fill',
        'warning': 'exclamation-circle-fill',
        'info': 'info-circle'
    };
    
    toast.innerHTML = `
        <div class="toast-header bg-${type} text-white">
            <i class="bi bi-${typeIcons[type] || 'info-circle'} me-2"></i>
            <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remover despu칠s de 3 segundos
    setTimeout(() => {
        const toastEl = document.getElementById(toastId);
        if (toastEl) {
            toastEl.style.animation = 'slideOutRight 0.3s ease-in forwards';
            setTimeout(() => toastEl.remove(), 300);
        }
    }, 3000);
}

// ================= INICIALIZACI칍N =================
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que el DOM est칠 completamente cargado
    setTimeout(() => {
        initDashboard();
        
        // Agregar estilos CSS para las animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }, 100);
});

// ================= MANEJAR EVENTOS DE VISIBILIDAD =================
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        updateDashboard();
    }
});
</script>

{% endblock %}
