{% extends "base.html" %}
{% block content %}

<style>
    /* ================= VARIABLES Y ESTILOS GENERALES ================= */
    :root {
        --primary: #1a5f7a;
        --primary-light: rgba(26, 95, 122, 0.1);
        --secondary: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
        --light: #f8f9fa;
        --dark: #343a40;
        
        --primary-gradient: linear-gradient(135deg, #1a5f7a 0%, #0d4c6e 100%);
        --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --warning-gradient: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        --danger-gradient: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        --info-gradient: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        --dark-gradient: linear-gradient(135deg, #343a40 0%, #212529 100%);
        --purple-gradient: linear-gradient(135deg, #6f42c1 0%, #6610f2 100%);
        
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 8px;
    }

    .dashboard-container {
        padding: 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #e9ecef 100%);
        min-height: calc(100vh - 80px);
        position: relative;
    }

    /* ================= HEADER COMPACTO MEJORADO ================= */
    .dashboard-header {
        background: linear-gradient(135deg, #ffffff 0%, #fdfdfd 100%);
        border-radius: var(--radius-md);
        padding: 20px 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-lg);
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .header-title h1 {
        font-weight: 800;
        color: var(--primary);
        margin: 0;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        gap: 10px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .header-title .badge {
        font-size: 0.7rem;
        padding: 4px 8px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .header-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        padding-top: 15px;
        border-top: 2px solid rgba(0,0,0,0.05);
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        border-radius: var(--radius-sm);
        background: rgba(255,255,255,0.7);
        transition: all 0.3s ease;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
        background: white;
    }

    .stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.3rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-info h4 {
        margin: 0;
        font-weight: 800;
        font-size: 1.6rem;
        line-height: 1.2;
        background: linear-gradient(45deg, var(--dark), #495057);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-info span {
        font-size: 0.85rem;
        color: #6c757d;
        display: block;
        font-weight: 500;
    }

    .progress-ring {
        margin-top: 5px;
    }

    /* ================= LAYOUT PRINCIPAL ================= */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        margin-bottom: 20px;
    }

    .main-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* ================= KPI CARDS MEJORADAS ================= */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
    }

    .kpi-card {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        min-height: auto;
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .kpi-card:hover::before {
        opacity: 1;
    }

    .kpi-icon {
        width: 55px;
        height: 55px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
    }

    .kpi-icon::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
    }

    .kpi-content {
        flex: 1;
    }

    .kpi-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 5px;
        background: linear-gradient(45deg, #212529, #495057);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .kpi-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .kpi-trend {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        margin-left: 8px;
    }

    .trend-up { background: rgba(40, 167, 69, 0.15); color: #28a745; }
    .trend-down { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
    .trend-neutral { background: rgba(108, 117, 125, 0.15); color: #6c757d; }

    /* ================= CHART SECTION MEJORADA ================= */
    .chart-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .chart-card {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        height: 100%;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .chart-card:hover {
        box-shadow: var(--shadow-md);
    }

    .chart-header {
        padding: 15px 20px;
        border-bottom: 2px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to right, rgba(248, 249, 250, 0.5), rgba(241, 245, 249, 0.8));
    }

    .chart-title {
        font-weight: 700;
        color: var(--dark);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-title i {
        color: var(--primary);
        font-size: 1.1rem;
    }

    .chart-body {
        padding: 15px;
        height: 220px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .chart-body canvas {
        width: 100% !important;
        height: 100% !important;
    }

    .chart-legend {
        position: absolute;
        bottom: 10px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.75rem;
    }

    .legend-color {
        width: 10px;
        height: 10px;
        border-radius: 2px;
    }

    /* ================= SIDEBAR WIDGETS MEJORADOS ================= */
    .widget {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .widget:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .widget-header {
        padding: 15px 20px;
        background: var(--primary-gradient);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .widget-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: translateX(-100%);
        animation: shimmer 3s infinite;
    }

    .widget-header h5 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
    }

    .widget-body {
        padding: 20px;
    }

    /* Stock Status Widget Mejorado */
    .status-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .status-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        background: linear-gradient(to right, #f8f9fa, #f1f5f9);
        transition: all 0.2s;
        border-left: 4px solid transparent;
    }

    .status-item:hover {
        background: linear-gradient(to right, #e9ecef, #dee2e6);
        transform: translateX(3px);
    }

    .status-item.ok { border-left-color: #28a745; }
    .status-item.diff { border-left-color: #ffc107; }
    .status-item.pend { border-left-color: #6c757d; }

    .status-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        color: white;
        min-width: 50px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Quick Actions Widget Mejorado */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .action-btn {
        padding: 14px;
        border: 2px solid #e9ecef;
        border-radius: var(--radius-sm);
        background: linear-gradient(to bottom, white, #f8f9fa);
        color: var(--dark);
        text-align: center;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .action-btn:hover {
        background: linear-gradient(to bottom, var(--primary-light), rgba(26, 95, 122, 0.2));
        border-color: var(--primary);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 6px 12px rgba(26, 95, 122, 0.15);
    }

    .action-btn i {
        font-size: 1.4rem;
        color: var(--primary);
        transition: all 0.3s ease;
    }

    .action-btn:hover i {
        transform: scale(1.1);
    }

    .action-btn span {
        font-size: 0.85rem;
        font-weight: 600;
    }

    .action-btn small {
        font-size: 0.7rem;
        color: #6c757d;
        opacity: 0.8;
    }

    /* ================= TABLA MEJORADA ================= */
    .table-card {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e9ecef;
        margin-top: 0;
        transition: all 0.3s ease;
    }

    .table-card:hover {
        box-shadow: var(--shadow-md);
    }

    .table-header {
        padding: 15px 20px;
        border-bottom: 2px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        background: linear-gradient(to right, rgba(248, 249, 250, 0.5), rgba(241, 245, 249, 0.8));
    }

    .table-title {
        font-weight: 700;
        color: var(--dark);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .table-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .search-container {
        position: relative;
        min-width: 250px;
    }

    .search-input {
        width: 100%;
        padding: 10px 16px 10px 40px;
        border: 2px solid #e2e8f0;
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(26, 95, 122, 0.1);
        background: white;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
    }

    /* Tabla Mejorada */
    .dashboard-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .dashboard-table thead {
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .dashboard-table th {
        color: #4a5568;
        font-weight: 700;
        padding: 14px 16px;
        border-bottom: 2px solid #dee2e6;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .dashboard-table th.sortable {
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .dashboard-table th.sortable:hover {
        background: rgba(26, 95, 122, 0.05);
    }

    .dashboard-table th.sortable::after {
        content: '↕';
        margin-left: 5px;
        font-size: 0.8em;
        opacity: 0.5;
    }

    .dashboard-table th.sortable.asc::after {
        content: '↑';
        opacity: 1;
    }

    .dashboard-table th.sortable.desc::after {
        content: '↓';
        opacity: 1;
    }

    .dashboard-table td {
        padding: 12px 16px;
        color: #2d3748;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }

    .dashboard-table tbody tr {
        transition: all 0.2s ease;
    }

    .dashboard-table tbody tr:hover {
        background: linear-gradient(to right, rgba(26, 95, 122, 0.03), rgba(26, 95, 122, 0.06));
        transform: translateX(2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .dashboard-table tbody tr.selected {
        background: rgba(26, 95, 122, 0.1);
        border-left: 3px solid var(--primary);
    }

    /* Badges mejorados */
    .stock-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-align: center;
        display: inline-block;
        min-width: 80px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        letter-spacing: 0.3px;
        transition: all 0.3s ease;
    }

    .stock-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .badge-critical { 
        background: linear-gradient(135deg, #dc3545, #c82333); 
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .badge-low { 
        background: linear-gradient(135deg, #ffc107, #fd7e14); 
        color: #212529;
        font-weight: 800;
    }
    .badge-ok { 
        background: linear-gradient(135deg, #28a745, #20c997); 
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .badge-diferencia { 
        background: linear-gradient(135deg, #ffc107, #fd7e14); 
        color: #212529;
        font-weight: 800;
    }
    .badge-pendiente { 
        background: linear-gradient(135deg, #6c757d, #868e96); 
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* ================= NUEVAS SECCIONES ================= */
    /* Timeline de Actividades */
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--primary), var(--info));
    }

    .timeline-item {
        position: relative;
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--primary);
        box-shadow: var(--shadow-sm);
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 15px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary);
        border: 3px solid white;
        box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.2);
    }

    .timeline-time {
        font-size: 0.75rem;
        color: var(--secondary);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Modal de Detalles */
    .modal-xl .modal-content {
        border-radius: var(--radius-md);
        border: none;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        background: var(--primary-gradient);
        color: white;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        padding: 20px;
    }

    .modal-body {
        padding: 30px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .detail-card {
        background: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
        padding: 20px;
        border-radius: var(--radius-sm);
        border-left: 4px solid var(--primary);
    }

    /* ================= RESPONSIVE MEJORADO ================= */
    @media (max-width: 1200px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            grid-template-columns: repeat(2, 1fr);
            display: grid;
        }
    }

    @media (max-width: 992px) {
        .chart-row {
            grid-template-columns: 1fr;
        }
        
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }
        
        .header-top {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .header-actions {
            width: 100%;
            justify-content: center;
        }
        
        .table-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .table-actions {
            width: 100%;
        }
        
        .search-container {
            width: 100%;
            min-width: auto;
        }
        
        .dashboard-table {
            font-size: 0.8rem;
        }
        
        .dashboard-table th,
        .dashboard-table td {
            padding: 10px 12px;
        }
    }

    @media (max-width: 576px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-body {
            height: 200px;
        }
        
        .header-stats {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            grid-template-columns: 1fr;
        }
        
        .quick-actions {
            grid-template-columns: 1fr;
        }
        
        .widget {
            margin-bottom: 15px;
        }
    }

    /* ================= ANIMACIONES MEJORADAS ================= */
    @keyframes fadeIn {
        from { 
            opacity: 0; 
            transform: translateY(20px) scale(0.95); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
        }
    }

    @keyframes slideInRight {
        from { 
            opacity: 0; 
            transform: translateX(30px); 
        }
        to { 
            opacity: 1; 
            transform: translateX(0); 
        }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    /* ================= ESTILOS PARA SELECT2 ================= */
    .select2-container {
        min-width: 180px;
    }

    .select2-container .select2-selection--single {
        height: 38px;
        border: 2px solid #e2e8f0;
        border-radius: var(--radius-sm);
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 34px;
        padding-left: 12px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }

    /* ================= ESTILOS PARA TOOLTIPS ================= */
    .tooltip-inner {
        background: var(--dark);
        color: white;
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        font-size: 0.85rem;
        box-shadow: var(--shadow-md);
    }

    .bs-tooltip-auto[data-popper-placement^=top] .tooltip-arrow::before {
        border-top-color: var(--dark);
    }

    /* ================= ESTILOS PARA SCROLLBAR ================= */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #0d4c6e;
    }

    /* ================= ESTILOS PARA BOTONES ================= */
    .btn-sm {
        padding: 6px 14px;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: var(--radius-sm);
        transition: all 0.3s ease;
    }

    .btn-outline-primary {
        border: 2px solid var(--primary);
        color: var(--primary);
        background: transparent;
    }

    .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(26, 95, 122, 0.2);
    }

    .btn-success {
        background: var(--success-gradient);
        border: none;
        color: white;
        box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
    }

    /* ================= ESTILOS PARA FILAS CRÍTICAS ================= */
    .critical-row {
        background: linear-gradient(to right, rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.02));
        border-left: 3px solid var(--danger);
    }

    .critical-row:hover {
        background: linear-gradient(to right, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
    }

    /* ================= ESTILOS PARA FILTROS ACTIVOS ================= */
    .filter-active {
        background: var(--primary) !important;
        color: white !important;
        border-color: var(--primary) !important;
    }

    /* ================= ESTILOS PARA PROGRESS BARS ================= */
    .progress {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }

    .progress-bar {
        background: var(--primary-gradient);
        transition: width 1s ease-in-out;
    }
</style>

<div class="dashboard-container">
    <!-- ================= HEADER MEJORADO ================= -->
    <div class="dashboard-header fade-in">
        <div class="header-top">
            <div class="header-title">
                <h1>
                    <i class="bi bi-clipboard-data"></i>
                    Dashboard de Conteo Físico
                    <span class="badge bg-primary ms-2">v2.0</span>
                </h1>
                <p class="text-muted mb-0 mt-1">
                    <i class="bi bi-info-circle me-1"></i>
                    Análisis completo de resultados del conteo físico vs sistema
                </p>
            </div>
            <div class="header-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="loadLatestData()" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline">Actualizar</span>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                    <i class="bi bi-clock"></i> <span class="d-none d-md-inline">Auto-Refresh</span>
                </button>
                {% if url_for('inventory.count_inventory') %}
                <a href="{{ url_for('inventory.count_inventory') }}" class="btn btn-sm btn-success">
                    <i class="bi bi-clipboard-check"></i> <span class="d-none d-md-inline">Nuevo Conteo</span>
                </a>
                {% endif %}
                <button class="btn btn-sm btn-warning" onclick="showSettings()">
                    <i class="bi bi-gear"></i> <span class="d-none d-md-inline">Configuración</span>
                </button>
            </div>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--primary-gradient);">
                    <i class="bi bi-boxes"></i>
                </div>
                <div class="stat-info">
                    <h4 id="totalItems">{{ items|length if items else 0 }}</h4>
                    <span>Total Materiales</span>
                    <div class="progress progress-ring mt-2" style="height: 4px; width: 80px;">
                        <div class="progress-bar" role="progressbar" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--success-gradient);">
                    <i class="bi bi-check-all"></i>
                </div>
                <div class="stat-info">
                    {% set ok_count = items|selectattr('estado', 'equalto', 'OK')|list|length if items else 0 %}
                    <h4 id="okItems">{{ ok_count }}</h4>
                    <span>Coinciden (OK)</span>
                    <div class="progress progress-ring mt-2" style="height: 4px; width: 80px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ (ok_count/items|length*100 if items|length > 0 else 0)|round|int }}%;"></div>
                    </div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--warning-gradient);">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    {% set dif_count = items|selectattr('estado', 'equalto', 'Diferencia')|list|length if items else 0 %}
                    <h4 id="diffItems">{{ dif_count }}</h4>
                    <span>Diferencias</span>
                    <div class="progress progress-ring mt-2" style="height: 4px; width: 80px;">
                        <div class="progress-bar bg-warning" role="progressbar" 
                             style="width: {{ (dif_count/items|length*100 if items|length > 0 else 0)|round|int }}%;"></div>
                    </div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: var(--dark-gradient);">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-info">
                    {% set pend_count = items|length - ok_count - dif_count if items else 0 %}
                    <h4 id="pendItems">{{ pend_count }}</h4>
                    <span>Pendientes</span>
                    <div class="progress progress-ring mt-2" style="height: 4px; width: 80px;">
                        <div class="progress-bar bg-secondary" role="progressbar" 
                             style="width: {{ (pend_count/items|length*100 if items|length > 0 else 0)|round|int }}%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3 pt-3 border-top">
            <div class="alert alert-info py-2 mb-0 d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-info-circle me-2"></i>
                    <small>
                        <strong>Último conteo físico</strong> - 
                        {% if last_update %}
                            Actualizado: {{ last_update.strftime('%d/%m/%Y %H:%M:%S') }}
                        {% else %}
                            Sin datos de conteo
                        {% endif %}
                    </small>
                </div>
                <div class="d-flex gap-2">
                    <small class="text-muted" id="sessionTimer">Sesión: 00:00</small>
                    <small class="text-muted" id="dataAge">Datos actualizados</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= LAYOUT PRINCIPAL MEJORADO ================= -->
    <div class="dashboard-layout fade-in">
        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-content">
            <!-- KPI CARDS MEJORADAS -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--primary-gradient);">
                        <i class="bi bi-geo-alt-fill"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalLocations">0</div>
                        <div class="kpi-label">
                            Ubicaciones
                            <span class="kpi-trend trend-up" id="locationTrend">+0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--info-gradient);">
                        <i class="bi bi-calculator-fill"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalStock">0</div>
                        <div class="kpi-label">
                            Stock Total Sistema
                            <span class="kpi-trend trend-neutral" id="stockTrend">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--success-gradient);">
                        <i class="bi bi-check-all"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalCounted">0</div>
                        <div class="kpi-label">
                            Contados
                            <span class="kpi-trend trend-up" id="countedTrend">+0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: var(--purple-gradient);">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="progressPercent">0%</div>
                        <div class="kpi-label">
                            Progreso Total
                            <span class="kpi-trend trend-up" id="progressTrend">+0%</span>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRÁFICOS MEJORADOS -->
            <div class="chart-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-pie-chart-fill"></i>
                            Distribución del Conteo
                            <button class="btn btn-sm btn-link text-primary p-0 ms-2" onclick="toggleChartView('estado')">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary active" onclick="changeChartType('estado', 'doughnut')">Dona</button>
                            <button class="btn btn-outline-secondary" onclick="changeChartType('estado', 'pie')">Circular</button>
                            <button class="btn btn-outline-secondary" onclick="changeChartType('estado', 'bar')">Barras</button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="estadoChart"></canvas>
                        <div class="chart-legend" id="estadoLegend"></div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-bar-chart-fill"></i>
                            Tendencia por Hora
                            <button class="btn btn-sm btn-link text-primary p-0 ms-2" onclick="toggleChartView('tendencia')">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="changeTimeRange('1h')">1H</button>
                            <button class="btn btn-outline-secondary active" onclick="changeTimeRange('24h')">24H</button>
                            <button class="btn btn-outline-secondary" onclick="changeTimeRange('7d')">7D</button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="tendenciaChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SEGUNDA FILA DE GRÁFICOS -->
            <div class="chart-row mt-0">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-map-fill"></i>
                            Mapa de Calor por Ubicación
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="heatmapToggle" checked>
                            <label class="form-check-label" for="heatmapToggle">Calor</label>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="heatmapChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="bi bi-people-fill"></i>
                            Rendimiento por Usuario
                        </div>
                        <select class="form-select form-select-sm w-auto" id="userFilter" onchange="updatePerformanceChart()">
                            <option value="all">Todos los usuarios</option>
                        </select>
                    </div>
                    <div class="chart-body">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TABLA DE RESULTADOS MEJORADA -->
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">
                        <i class="bi bi-table"></i>
                        Resultados Detallados: Sistema vs Conteo Físico
                        <span id="filteredCount" class="badge bg-primary">{{ items|length if items else 0 }}</span>
                        <span id="selectedCount" class="badge bg-success d-none">0 seleccionados</span>
                    </div>
                    
                    <div class="table-actions">
                        <div class="search-container">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="searchInv" class="search-input" 
                                   placeholder="Buscar código, descripción, ubicación...">
                        </div>
                        
                        <select class="form-select form-select-sm w-auto" id="statusFilter" onchange="filterByStatus(this.value)">
                            <option value="all">Todos los estados</option>
                            <option value="OK">Solo OK</option>
                            <option value="Diferencia">Solo Diferencias</option>
                            <option value="Pendiente">Solo Pendientes</option>
                        </select>
                        
                        <select class="form-select form-select-sm w-auto" id="locationFilter" onchange="filterByLocation(this.value)">
                            <option value="all">Todas las ubicaciones</option>
                        </select>
                        
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()" title="Limpiar filtros">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportDifferences()" title="Exportar diferencias">
                                <i class="bi bi-file-earmark-excel"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="showAdvancedFilters()" title="Filtros avanzados">
                                <i class="bi bi-funnel"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                    <table class="dashboard-table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable(0)">Código <i class="bi bi-arrow-down-up"></i></th>
                                <th class="sortable" onclick="sortTable(1)">Descripción</th>
                                <th class="sortable" onclick="sortTable(2)">Ubicación</th>
                                <th class="sortable" onclick="sortTable(3)">Stock Sistema</th>
                                <th class="sortable" onclick="sortTable(4)">Conteo Físico</th>
                                <th class="sortable" onclick="sortTable(5)">Diferencia</th>
                                <th class="sortable" onclick="sortTable(6)">Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            {% if items and items|length > 0 %}
                                {% for item in items %}
                                {% set stock_sistema = item.stock if item.stock is defined else 0 %}
                                {% set conteo_fisico = item.real_count if item.real_count is defined else 0 %}
                                {% set diferencia = conteo_fisico - stock_sistema %}
                                {% set diferencia_abs = diferencia|abs %}
                                {% set is_critical = diferencia_abs > (stock_sistema * 0.5) and diferencia_abs > 10 %}
                                <tr class="inventory-row {% if is_critical %}critical-row{% endif %}" 
                                    data-code="{{ item.material_code|default('', true) }}"
                                    data-desc="{{ item.material_text|default('', true) }}"
                                    data-location="{{ item.location|default('Sin ubicación', true) }}"
                                    data-stock="{{ stock_sistema }}"
                                    data-count="{{ conteo_fisico }}"
                                    data-diferencia="{{ diferencia }}"
                                    data-estado="{{ item.estado|default('Pendiente', true) }}"
                                    data-user="{{ item.usuario|default('', true) }}"
                                    data-timestamp="{{ item.timestamp|default('', true) }}"
                                    onclick="toggleRowSelection(this)"
                                    ondblclick="showItemDetails(this)">
                                    <td class="fw-bold">
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="checkbox" class="row-checkbox" onclick="event.stopPropagation()">
                                            <span>{{ item.material_code|default('N/A', true) }}</span>
                                            {% if is_critical %}
                                            <i class="bi bi-fire text-danger" title="Diferencia crítica"></i>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 220px;" 
                                             title="{{ item.material_text|default('', true) }}">
                                            {{ item.material_text|default('Sin descripción', true) }}
                                            {% if item.material_text and item.material_text|length > 50 %}
                                            <small class="text-muted">[...]</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-dark">
                                            <i class="bi bi-geo-alt me-1"></i>{{ item.location|default('Sin ubicación', true) }}
                                        </span>
                                    </td>
                                    <td class="fw-bold text-primary">
                                        {{ stock_sistema }}
                                        {% if stock_sistema == 0 %}
                                        <small class="text-muted d-block">Sin stock</small>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold {% if item.estado == 'OK' %}text-success{% elif item.estado == 'Diferencia' %}text-danger{% else %}text-muted{% endif %}">
                                        {{ conteo_fisico if conteo_fisico > 0 else '-' }}
                                        {% if item.usuario %}
                                        <small class="text-muted d-block">{{ item.usuario }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold {% if diferencia > 0 %}text-success{% elif diferencia < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {% if item.estado == 'OK' %}
                                            <span class="text-muted">0</span>
                                        {% elif item.estado == 'Diferencia' %}
                                            {% if diferencia > 0 %}
                                                <i class="bi bi-arrow-up-circle text-success"></i> +{{ diferencia_abs }}
                                            {% elif diferencia < 0 %}
                                                <i class="bi bi-arrow-down-circle text-danger"></i> -{{ diferencia_abs }}
                                            {% endif %}
                                            <div class="progress mt-1" style="height: 3px; width: 60px;">
                                                <div class="progress-bar {% if diferencia > 0 %}bg-success{% else %}bg-danger{% endif %}" 
                                                     style="width: {{ (diferencia_abs/(stock_sistema + diferencia_abs)*100)|round|int if stock_sistema + diferencia_abs > 0 else 0 }}%"></div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.estado == 'OK' %}
                                            <span class="stock-badge badge-ok">
                                                <i class="bi bi-check-circle me-1"></i>OK
                                            </span>
                                        {% elif item.estado == 'Diferencia' %}
                                            <span class="stock-badge badge-diferencia">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Diferencia
                                            </span>
                                        {% else %}
                                            <span class="stock-badge badge-pendiente">
                                                <i class="bi bi-clock me-1"></i>Pendiente
                                            </span>
                                        {% endif %}
                                        {% if item.timestamp %}
                                        <small class="text-muted d-block mt-1">{{ item.timestamp.strftime('%H:%M') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editItem(this)" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-info" onclick="showHistory(this)" title="Historial">
                                                <i class="bi bi-clock-history"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="recountItem(this)" title="Recontar">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="bi bi-inbox display-6"></i>
                                            <p class="mt-3 mb-2 fs-5">No hay datos de conteo físico disponibles</p>
                                            <p class="mb-3">Realice un conteo para ver los resultados aquí</p>
                                            {% if url_for('inventory.count_inventory') %}
                                            <a href="{{ url_for('inventory.count_inventory') }}" class="btn btn-primary">
                                                <i class="bi bi-clipboard-check me-2"></i>Iniciar Conteo Físico
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 border-top d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted" id="filterInfo">
                            Mostrando <span id="visibleCount">{{ items|length if items else 0 }}</span> de {{ items|length if items else 0 }} items
                        </small>
                        <div class="form-check form-switch d-inline-block ms-3">
                            <input class="form-check-input" type="checkbox" id="showCriticalOnly" onchange="toggleCriticalOnly()">
                            <label class="form-check-label" for="showCriticalOnly">Solo críticos</label>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-success" onclick="exportToExcel()">
                            <i class="bi bi-file-excel me-1"></i> Exportar Excel
                        </button>
                        <button class="btn btn-outline-danger" onclick="printTable()">
                            <i class="bi bi-printer me-1"></i> Imprimir
                        </button>
                        <button class="btn btn-outline-primary" onclick="showBulkActions()">
                            <i class="bi bi-tools me-1"></i> Acciones Masivas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR MEJORADO -->
        <div class="sidebar">
            <!-- WIDGET: RESUMEN DE CONTEOS MEJORADO -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-clipboard-data"></i> Resumen de Conteo</h5>
                    <button class="btn btn-sm btn-light btn-sm ms-auto" onclick="refreshSummary()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="widget-body">
                    <div class="status-list">
                        <div class="status-item ok">
                            <div class="status-label">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <div>
                                    <span>Coinciden (OK)</span>
                                    <small class="text-muted d-block">Stock exacto</small>
                                </div>
                            </div>
                            <span class="status-badge" style="background: var(--success-gradient);" id="widgetOk">0</span>
                        </div>
                        <div class="status-item diff">
                            <div class="status-label">
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                <div>
                                    <span>Diferencias</span>
                                    <small class="text-muted d-block">Faltantes/Sobrantes</small>
                                </div>
                            </div>
                            <span class="status-badge" style="background: var(--warning-gradient);" id="widgetDiff">0</span>
                        </div>
                        <div class="status-item pend">
                            <div class="status-label">
                                <i class="bi bi-hourglass-split text-secondary"></i>
                                <div>
                                    <span>Pendientes</span>
                                    <small class="text-muted d-block">Sin contar</small>
                                </div>
                            </div>
                            <span class="status-badge" style="background: var(--dark-gradient);" id="widgetPend">0</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Progreso total</small>
                            <small id="progressText">0%</small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" id="widgetProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDGET: ACCIONES RÁPIDAS MEJORADO -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-lightning-charge-fill"></i> Acciones Rápidas</h5>
                </div>
                <div class="widget-body">
                    <div class="quick-actions">
                        {% if url_for('inventory.count_inventory') %}
                        <a href="{{ url_for('inventory.count_inventory') }}" class="action-btn">
                            <i class="bi bi-clipboard-check"></i>
                            <span>Continuar Conteo</span>
                            <small>Agregar más items</small>
                        </a>
                        {% endif %}
                        <button class="action-btn" onclick="exportDifferences()">
                            <i class="bi bi-file-earmark-excel"></i>
                            <span>Exportar Diferencias</span>
                            <small>Reporte Excel</small>
                        </button>
                        <button class="action-btn" onclick="showReconciliation()">
                            <i class="bi bi-arrow-repeat"></i>
                            <span>Conciliar Stock</span>
                            <small>Ajustar sistema</small>
                        </button>
                        <button class="action-btn" onclick="generateReport()">
                            <i class="bi bi-file-earmark-pdf"></i>
                            <span>Generar Reporte</span>
                            <small>PDF detallado</small>
                        </button>
                        <button class="action-btn" onclick="showAnalytics()">
                            <i class="bi bi-graph-up"></i>
                            <span>Analítica</span>
                            <small>Estadísticas</small>
                        </button>
                        <button class="action-btn" onclick="showNotifications()">
                            <i class="bi bi-bell"></i>
                            <span>Notificaciones</span>
                            <small id="notificationCount">0 nuevas</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- WIDGET: TIMELINE DE ACTIVIDADES -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-clock-history"></i> Actividad Reciente</h5>
                </div>
                <div class="widget-body">
                    <div class="timeline" id="activityTimeline">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                            <span class="ms-2">Cargando actividad...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDGET: TOP DIFERENCIAS MEJORADO -->
            <div class="widget">
                <div class="widget-header">
                    <h5><i class="bi bi-exclamation-triangle-fill"></i> Mayores Diferencias</h5>
                    <button class="btn btn-sm btn-light btn-sm ms-auto" onclick="refreshTopDifferences()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="widget-body">
                    <div id="topDifferences">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                            <span class="ms-2">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODALES Y COMPONENTES ADICIONALES ================= -->

<!-- Modal de Detalles del Item -->
<div class="modal fade" id="itemDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-box-seam me-2"></i>
                    Detalles del Material
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="detail-grid" id="detailContent">
                    <!-- Se llena con JavaScript -->
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">Historial de Conteos</h6>
                        <div id="itemHistory">
                            <!-- Se llena con JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="editCurrentItem()">
                    <i class="bi bi-pencil me-1"></i> Editar
                </button>
                <button type="button" class="btn btn-success" onclick="validateCurrentItem()">
                    <i class="bi bi-check-circle me-1"></i> Validar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Configuración -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear me-2"></i>
                    Configuración del Dashboard
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Intervalo de Auto-Refresh</label>
                    <select class="form-select" id="refreshInterval">
                        <option value="0">Desactivado</option>
                        <option value="30">30 segundos</option>
                        <option value="60" selected>1 minuto</option>
                        <option value="300">5 minutos</option>
                        <option value="600">10 minutos</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Items por página</label>
                    <select class="form-select" id="itemsPerPage">
                        <option value="10">10 items</option>
                        <option value="25" selected>25 items</option>
                        <option value="50">50 items</option>
                        <option value="100">100 items</option>
                        <option value="0">Todos</option>
                    </select>
                </div>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableNotifications" checked>
                        <label class="form-check-label" for="enableNotifications">Notificaciones en tiempo real</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableSounds" checked>
                        <label class="form-check-label" for="enableSounds">Efectos de sonido</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showAnimations" checked>
                        <label class="form-check-label" for="showAnimations">Animaciones</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="highlightCritical" checked>
                        <label class="form-check-label" for="highlightCritical">Resaltar diferencias críticas</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tema de colores</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary" onclick="setTheme('default')">Default</button>
                        <button class="btn btn-sm btn-dark" onclick="setTheme('dark')">Oscuro</button>
                        <button class="btn btn-sm btn-light" onclick="setTheme('light')">Claro</button>
                        <button class="btn btn-sm btn-info" onclick="setTheme('blue')">Azul</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Guardar Configuración</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtros Avanzados -->
<div class="modal fade" id="advancedFiltersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-funnel-fill me-2"></i>
                    Filtros Avanzados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Rango de Stock</label>
                            <div class="row">
                                <div class="col">
                                    <input type="number" class="form-control" id="minStock" placeholder="Mínimo" min="0">
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" id="maxStock" placeholder="Máximo">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rango de Diferencia</label>
                            <div class="row">
                                <div class="col">
                                    <input type="number" class="form-control" id="minDiff" placeholder="Mínimo" min="0">
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" id="maxDiff" placeholder="Máximo">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Fecha de Conteo</label>
                            <div class="row">
                                <div class="col">
                                    <input type="date" class="form-control" id="startDate">
                                </div>
                                <div class="col">
                                    <input type="date" class="form-control" id="endDate">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Usuario</label>
                            <select class="form-select" id="filterUser">
                                <option value="all">Todos los usuarios</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="onlyCriticalFilter">
                            <label class="form-check-label" for="onlyCriticalFilter">
                                Solo diferencias críticas (más del 50% de variación)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="onlyUncountedFilter">
                            <label class="form-check-label" for="onlyUncountedFilter">
                                Solo items sin conteo físico
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetAdvancedFilters()">Limpiar</button>
                <button type="button" class="btn btn-primary" onclick="applyAdvancedFilters()">Aplicar Filtros</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Acciones Masivas -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-tools me-2"></i>
                    Acciones Masivas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Seleccione los items en la tabla para habilitar estas acciones
                </div>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action" onclick="bulkValidate()" id="bulkValidateBtn" disabled>
                        <i class="bi bi-check-circle me-2"></i> Validar seleccionados
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="bulkRecount()" id="bulkRecountBtn" disabled>
                        <i class="bi bi-arrow-repeat me-2"></i> Recontar seleccionados
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="bulkExport()" id="bulkExportBtn" disabled>
                        <i class="bi bi-file-earmark-excel me-2"></i> Exportar seleccionados
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="bulkReconcile()" id="bulkReconcileBtn" disabled>
                        <i class="bi bi-arrow-repeat me-2"></i> Conciliar seleccionados
                    </button>
                    <button class="list-group-item list-group-item-action text-danger" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
                        <i class="bi bi-trash me-2"></i> Eliminar seleccionados
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Notificaciones Flotantes -->
<div id="notificationPanel" class="position-fixed top-0 end-0 p-3" style="z-index: 9999; width: 350px; display: none;">
    <div class="toast-container">
        <!-- Las notificaciones se agregan aquí -->
    </div>
</div>

<!-- Loading Overlay Mejorado -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-none" style="z-index: 99999;">
    <div class="position-absolute top-50 start-50 translate-middle text-center text-white">
        <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;"></div>
        <h4 id="loadingMessage">Cargando datos...</h4>
        <div class="progress mt-3" style="width: 300px; margin: 0 auto;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="loadingProgress" style="width: 0%"></div>
        </div>
        <p class="mt-2" id="loadingDetail"></p>
    </div>
</div>

<!-- ================= JAVASCRIPT MEJORADO ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-hammerjs@0.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.1/dist/socket.io.min.js"></script>

<script>
// ================= CONFIGURACIÓN MEJORADA =================
const CONFIG = {
    API: {
        get_latest: "{{ url_for('inventory.get_latest_counts') if 'get_latest_counts' in url_for.__globals__ else '#' }}",
        export_diff: "{{ url_for('inventory.export_differences') if 'export_differences' in url_for.__globals__ else '#' }}",
        export_all: "{{ url_for('inventory.export_inventory') if 'export_inventory' in url_for.__globals__ else '#' }}",
        reconcile: "{{ url_for('inventory.reconcile_inventory') if 'reconcile_inventory' in url_for.__globals__ else '#' }}",
        validate: "{{ url_for('inventory.validate_item') if 'validate_item' in url_for.__globals__ else '#' }}",
        recount: "{{ url_for('inventory.recount_item') if 'recount_item' in url_for.__globals__ else '#' }}",
        bulk: "{{ url_for('inventory.bulk_actions') if 'bulk_actions' in url_for.__globals__ else '#' }}",
        history: "{{ url_for('inventory.get_item_history') if 'get_item_history' in url_for.__globals__ else '#' }}",
        activity: "{{ url_for('inventory.get_recent_activity') if 'get_recent_activity' in url_for.__globals__ else '#' }}",
        settings: "{{ url_for('inventory.save_settings') if 'save_settings' in url_for.__globals__ else '#' }}"
    },
    SETTINGS: {
        autoRefresh: false,
        refreshInterval: 60000, // 1 minuto
        itemsPerPage: 25,
        enableNotifications: true,
        enableSounds: true,
        showAnimations: true,
        highlightCritical: true,
        theme: 'default'
    },
    STATE: {
        selectedItems: new Set(),
        currentSort: { column: 0, direction: 'asc' },
        currentFilters: {},
        socket: null,
        lastUpdate: new Date(),
        sessionStart: new Date(),
        notifications: [],
        chartFullscreen: false
    }
};

// ================= VARIABLES GLOBALES =================
let charts = {};
let inventoryData = [];
let filteredData = [];
let selectedItem = null;
let autoRefreshTimer = null;
let sessionTimer = null;
let dataAgeTimer = null;

// ================= INICIALIZACIÓN MEJORADA =================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando Dashboard Avanzado v2.0...');
    
    loadSettings();
    initDashboard();
    setupEventListeners();
    startTimers();
    initWebSocket();
    loadActivityTimeline();
});

function initDashboard() {
    showLoading('Inicializando dashboard...', 0);
    
    setTimeout(() => {
        updateLoadingProgress(30, 'Recopilando datos del inventario...');
        collectInventoryData();
        
        setTimeout(() => {
            updateLoadingProgress(60, 'Calculando métricas...');
            calculateMetrics();
            updateWidgets();
            
            setTimeout(() => {
                updateLoadingProgress(80, 'Generando gráficos...');
                renderCharts();
                updateTopDifferences();
                populateFilters();
                
                setTimeout(() => {
                    updateLoadingProgress(100, '¡Dashboard listo!');
                    hideLoading();
                    showToast('Dashboard cargado exitosamente', 'success');
                }, 500);
            }, 500);
        }, 500);
    }, 500);
}

// ================= GESTIÓN DE DATOS MEJORADA =================
function collectInventoryData() {
    inventoryData = [];
    const rows = document.querySelectorAll('.inventory-row');
    
    rows.forEach((row, index) => {
        const data = {
            id: index,
            code: row.dataset.code || '',
            desc: row.dataset.desc || '',
            location: row.dataset.location || 'Sin ubicación',
            stock: parseInt(row.dataset.stock) || 0,
            count: parseInt(row.dataset.count) || 0,
            diferencia: parseInt(row.dataset.diferencia) || 0,
            estado: row.dataset.estado || 'Pendiente',
            user: row.dataset.user || '',
            timestamp: row.dataset.timestamp ? new Date(row.dataset.timestamp) : null,
            element: row,
            isCritical: Math.abs(parseInt(row.dataset.diferencia) || 0) > (parseInt(row.dataset.stock) || 0) * 0.5 && 
                       Math.abs(parseInt(row.dataset.diferencia) || 0) > 10
        };
        inventoryData.push(data);
    });
    
    filteredData = [...inventoryData];
    console.log(`📦 ${inventoryData.length} items de inventario cargados`);
}

function calculateMetrics() {
    if (inventoryData.length === 0) {
        updateEmptyState();
        return;
    }
    
    // Ubicaciones únicas
    const locations = new Set(inventoryData.map(item => item.location));
    document.getElementById('totalLocations').textContent = locations.size;
    
    // Stock total del sistema
    const totalStock = inventoryData.reduce((sum, item) => sum + item.stock, 0);
    document.getElementById('totalStock').textContent = totalStock.toLocaleString();
    
    // Items contados
    const countedItems = inventoryData.filter(item => item.count > 0).length;
    document.getElementById('totalCounted').textContent = countedItems;
    
    // Progreso porcentual
    const progressPercent = inventoryData.length > 0 ? 
        Math.round((countedItems / inventoryData.length) * 100) : 0;
    document.getElementById('progressPercent').textContent = `${progressPercent}%`;
    document.getElementById('progressBar').style.width = `${progressPercent}%`;
    document.getElementById('widgetProgress').style.width = `${progressPercent}%`;
    document.getElementById('progressText').textContent = `${progressPercent}%`;
    
    // Calcular tendencias
    calculateTrends();
    
    // Actualizar widgets
    updateWidgets();
}

function calculateTrends() {
    // Simular tendencias (en producción vendrían del backend)
    const locationTrend = Math.floor(Math.random() * 10) - 2;
    const stockTrend = Math.floor(Math.random() * 6) - 3;
    const countedTrend = Math.floor(Math.random() * 15);
    const progressTrend = Math.floor(Math.random() * 8);
    
    updateTrendElement('locationTrend', locationTrend);
    updateTrendElement('stockTrend', stockTrend);
    updateTrendElement('countedTrend', countedTrend);
    updateTrendElement('progressTrend', progressTrend);
}

function updateTrendElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.textContent = value > 0 ? `+${value}%` : `${value}%`;
    element.className = `kpi-trend ${value > 0 ? 'trend-up' : value < 0 ? 'trend-down' : 'trend-neutral'}`;
}

function updateWidgets() {
    if (inventoryData.length === 0) return;
    
    const okItems = inventoryData.filter(item => item.estado === 'OK').length;
    const diffItems = inventoryData.filter(item => item.estado === 'Diferencia').length;
    const pendItems = inventoryData.length - okItems - diffItems;
    
    document.getElementById('widgetOk').textContent = okItems;
    document.getElementById('widgetDiff').textContent = diffItems;
    document.getElementById('widgetPend').textContent = pendItems;
    
    // Actualizar contadores del header
    document.getElementById('okItems').textContent = okItems;
    document.getElementById('diffItems').textContent = diffItems;
    document.getElementById('pendItems').textContent = pendItems;
}

// ================= GRÁFICOS MEJORADOS =================
function renderCharts() {
    renderEstadoChart();
    renderTendenciaChart();
    renderHeatmapChart();
    renderPerformanceChart();
}

function renderEstadoChart() {
    const ctx = document.getElementById('estadoChart');
    if (!ctx) return;
    
    const okItems = inventoryData.filter(item => item.estado === 'OK').length;
    const diffItems = inventoryData.filter(item => item.estado === 'Diferencia').length;
    const pendItems = inventoryData.length - okItems - diffItems;
    
    if (charts.estado) {
        charts.estado.destroy();
    }
    
    // Actualizar leyenda
    updateChartLegend('estadoLegend', [
        { label: 'Coinciden', color: '#28a745', value: okItems },
        { label: 'Diferencias', color: '#ffc107', value: diffItems },
        { label: 'Pendientes', color: '#6c757d', value: pendItems }
    ]);
    
    charts.estado = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Coinciden', 'Diferencias', 'Pendientes'],
            datasets: [{
                data: [okItems, diffItems, pendItems],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.9)',
                    'rgba(255, 193, 7, 0.9)',
                    'rgba(108, 117, 125, 0.9)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(108, 117, 125, 1)'
                ],
                borderWidth: 2,
                hoverOffset: 15,
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = inventoryData.length;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 13 }
                }
            },
            cutout: '70%',
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

function renderTendenciaChart() {
    const ctx = document.getElementById('tendenciaChart');
    if (!ctx) return;
    
    // Datos simulados de tendencia
    const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
    const counts = Array.from({length: 24}, () => Math.floor(Math.random() * 100));
    const differences = Array.from({length: 24}, () => Math.floor(Math.random() * 20));
    
    if (charts.tendencia) {
        charts.tendencia.destroy();
    }
    
    charts.tendencia = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: [
                {
                    label: 'Items Contados',
                    data: counts,
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 8
                },
                {
                    label: 'Diferencias',
                    data: differences,
                    borderColor: 'rgba(255, 193, 7, 1)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { size: 11 },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                zoom: {
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'x'
                    },
                    pan: {
                        enabled: true,
                        mode: 'x'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { font: { size: 10 } }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 10 },
                        maxRotation: 45
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        },
        plugins: [{
            afterDraw: function(chart) {
                if (chart.data.datasets[0].data.length === 0) {
                    const ctx = chart.ctx;
                    const width = chart.width;
                    const height = chart.height;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#999';
                    ctx.fillText('No hay datos de tendencia', width / 2, height / 2);
                }
            }
        }]
    });
}

function renderHeatmapChart() {
    const ctx = document.getElementById('heatmapChart');
    if (!ctx) return;
    
    // Datos simulados para mapa de calor
    const locations = Array.from(new Set(inventoryData.map(item => item.location))).slice(0, 10);
    const hours = ['6:00', '8:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
    
    const data = locations.map(location => {
        return hours.map(() => Math.floor(Math.random() * 100));
    });
    
    if (charts.heatmap) {
        charts.heatmap.destroy();
    }
    
    charts.heatmap = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: hours,
            datasets: locations.map((location, index) => ({
                label: location,
                data: data[index],
                backgroundColor: data[index].map(value => 
                    `rgba(26, 95, 122, ${0.3 + (value / 100 * 0.7)})`
                ),
                borderColor: data[index].map(() => 'rgba(26, 95, 122, 1)'),
                borderWidth: 1
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return `Hora: ${tooltipItems[0].label}`;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} items`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: { display: false }
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            }
        }
    });
}

function renderPerformanceChart() {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;
    
    // Datos simulados de rendimiento por usuario
    const users = ['Usuario A', 'Usuario B', 'Usuario C', 'Usuario D', 'Usuario E'];
    const performance = users.map(() => Math.floor(Math.random() * 100));
    const accuracy = users.map(() => 80 + Math.floor(Math.random() * 20));
    
    if (charts.performance) {
        charts.performance.destroy();
    }
    
    charts.performance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: users,
            datasets: [
                {
                    label: 'Items Contados',
                    data: performance,
                    backgroundColor: 'rgba(26, 95, 122, 0.7)',
                    borderColor: 'rgba(26, 95, 122, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    order: 2
                },
                {
                    label: 'Precisión %',
                    data: accuracy,
                    type: 'line',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function updateChartLegend(legendId, items) {
    const legend = document.getElementById(legendId);
    if (!legend) return;
    
    legend.innerHTML = items.map(item => `
        <div class="legend-item">
            <div class="legend-color" style="background-color: ${item.color};"></div>
            <span>${item.label}: ${item.value}</span>
        </div>
    `).join('');
}

// ================= FUNCIONES DE TABLA MEJORADAS =================
function sortTable(columnIndex) {
    const table = document.getElementById('inventoryTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
    
    // Actualizar indicador visual
    const headers = table.querySelectorAll('th.sortable');
    headers.forEach((header, index) => {
        header.classList.remove('asc', 'desc');
        if (index === columnIndex) {
            header.classList.add(CONFIG.STATE.currentSort.direction === 'asc' ? 'desc' : 'asc');
        }
    });
    
    // Ordenar filas
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch(columnIndex) {
            case 0: // Código
                aValue = a.dataset.code || '';
                bValue = b.dataset.code || '';
                break;
            case 1: // Descripción
                aValue = a.dataset.desc || '';
                bValue = b.dataset.desc || '';
                break;
            case 2: // Ubicación
                aValue = a.dataset.location || '';
                bValue = b.dataset.location || '';
                break;
            case 3: // Stock Sistema
                aValue = parseInt(a.dataset.stock) || 0;
                bValue = parseInt(b.dataset.stock) || 0;
                break;
            case 4: // Conteo Físico
                aValue = parseInt(a.dataset.count) || 0;
                bValue = parseInt(b.dataset.count) || 0;
                break;
            case 5: // Diferencia
                aValue = parseInt(a.dataset.diferencia) || 0;
                bValue = parseInt(b.dataset.diferencia) || 0;
                break;
            case 6: // Estado
                aValue = a.dataset.estado || '';
                bValue = b.dataset.estado || '';
                break;
            default:
                return 0;
        }
        
        const direction = CONFIG.STATE.currentSort.direction === 'asc' ? 1 : -1;
        
        if (typeof aValue === 'string') {
            return direction * aValue.localeCompare(bValue);
        } else {
            return direction * (aValue - bValue);
        }
    });
    
    // Reorder DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Cambiar dirección para el próximo clic
    CONFIG.STATE.currentSort = {
        column: columnIndex,
        direction: CONFIG.STATE.currentSort.direction === 'asc' ? 'desc' : 'asc'
    };
    
    showToast(`Tabla ordenada por ${headers[columnIndex].textContent.trim()}`, 'info');
}

function toggleRowSelection(row) {
    const checkbox = row.querySelector('.row-checkbox');
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateRowSelection(row, checkbox.checked);
    }
}

function updateRowSelection(row, selected) {
    if (selected) {
        row.classList.add('selected');
        CONFIG.STATE.selectedItems.add(row.dataset.code);
    } else {
        row.classList.remove('selected');
        CONFIG.STATE.selectedItems.delete(row.dataset.code);
    }
    
    updateSelectedCount();
    updateBulkActions();
}

function updateSelectedCount() {
    const count = CONFIG.STATE.selectedItems.size;
    const badge = document.getElementById('selectedCount');
    const countSpan = badge.querySelector('span') || badge;
    
    if (count > 0) {
        badge.classList.remove('d-none');
        countSpan.textContent = `${count} seleccionados`;
    } else {
        badge.classList.add('d-none');
    }
}

function updateBulkActions() {
    const count = CONFIG.STATE.selectedItems.size;
    const buttons = ['bulkValidateBtn', 'bulkRecountBtn', 'bulkExportBtn', 'bulkReconcileBtn', 'bulkDeleteBtn'];
    
    buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.disabled = count === 0;
        }
    });
}

// ================= FUNCIONES DE FILTRO MEJORADAS =================
function populateFilters() {
    populateLocationFilter();
    populateUserFilter();
}

function populateLocationFilter() {
    const select = document.getElementById('locationFilter');
    if (!select) return;
    
    const locations = [...new Set(inventoryData.map(item => item.location))].sort();
    
    locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        select.appendChild(option);
    });
}

function populateUserFilter() {
    const select = document.getElementById('filterUser');
    if (!select) return;
    
    const users = [...new Set(inventoryData.map(item => item.user).filter(Boolean))].sort();
    
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        select.appendChild(option);
    });
}

function filterByStatus(status) {
    const searchInput = document.getElementById('searchInv');
    if (searchInput) searchInput.value = '';
    
    filteredData = [];
    let visibleCount = 0;
    
    inventoryData.forEach(item => {
        const isVisible = status === 'all' || item.estado === status;
        item.element.style.display = isVisible ? '' : 'none';
        if (isVisible) {
            visibleCount++;
            filteredData.push(item);
        }
    });
    
    updateFilteredCount();
    showToast(`Filtrado por estado: ${status === 'all' ? 'Todos' : status}`, 'info');
}

function filterByLocation(location) {
    if (location === 'all') {
        inventoryData.forEach(item => {
            if (item.element.style.display !== 'none') {
                item.element.style.display = '';
            }
        });
        return;
    }
    
    let visibleCount = 0;
    inventoryData.forEach(item => {
        const isVisible = item.location === location && item.element.style.display !== 'none';
        item.element.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
    });
    
    updateFilteredCount();
    showToast(`Filtrado por ubicación: ${location}`, 'info');
}

function showAdvancedFilters() {
    const modal = new bootstrap.Modal(document.getElementById('advancedFiltersModal'));
    modal.show();
}

function applyAdvancedFilters() {
    const minStock = parseInt(document.getElementById('minStock').value) || 0;
    const maxStock = parseInt(document.getElementById('maxStock').value) || Infinity;
    const minDiff = parseInt(document.getElementById('minDiff').value) || 0;
    const maxDiff = parseInt(document.getElementById('maxDiff').value) || Infinity;
    const onlyCritical = document.getElementById('onlyCriticalFilter').checked;
    const onlyUncounted = document.getElementById('onlyUncountedFilter').checked;
    
    filteredData = [];
    let visibleCount = 0;
    
    inventoryData.forEach(item => {
        const stockOk = item.stock >= minStock && item.stock <= maxStock;
        const diffOk = Math.abs(item.diferencia) >= minDiff && Math.abs(item.diferencia) <= maxDiff;
        const criticalOk = !onlyCritical || item.isCritical;
        const uncountedOk = !onlyUncounted || item.count === 0;
        
        const isVisible = stockOk && diffOk && criticalOk && uncountedOk;
        
        item.element.style.display = isVisible ? '' : 'none';
        if (isVisible) {
            visibleCount++;
            filteredData.push(item);
        }
    });
    
    updateFilteredCount();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('advancedFiltersModal'));
    modal.hide();
    
    showToast('Filtros avanzados aplicados', 'success');
}

function resetAdvancedFilters() {
    document.getElementById('minStock').value = '';
    document.getElementById('maxStock').value = '';
    document.getElementById('minDiff').value = '';
    document.getElementById('maxDiff').value = '';
    document.getElementById('onlyCriticalFilter').checked = false;
    document.getElementById('onlyUncountedFilter').checked = false;
}

function toggleCriticalOnly() {
    const showCritical = document.getElementById('showCriticalOnly').checked;
    
    let visibleCount = 0;
    inventoryData.forEach(item => {
        const isVisible = !showCritical || item.isCritical;
        item.element.style.display = isVisible ? '' : 'none';
        if (isVisible && item.element.style.display !== 'none') visibleCount++;
    });
    
    updateFilteredCount();
    showToast(showCritical ? 'Mostrando solo diferencias críticas' : 'Mostrando todos los items', 'info');
}

// ================= FUNCIONES DE ITEMS MEJORADAS =================
function showItemDetails(row) {
    selectedItem = {
        code: row.dataset.code,
        desc: row.dataset.desc,
        location: row.dataset.location,
        stock: parseInt(row.dataset.stock),
        count: parseInt(row.dataset.count),
        diferencia: parseInt(row.dataset.diferencia),
        estado: row.dataset.estado,
        user: row.dataset.user,
        timestamp: row.dataset.timestamp
    };
    
    // Actualizar contenido del modal
    const detailContent = document.getElementById('detailContent');
    detailContent.innerHTML = `
        <div class="detail-card">
            <h6><i class="bi bi-upc-scan me-2"></i>Código</h6>
            <p class="fs-5 fw-bold">${selectedItem.code}</p>
        </div>
        <div class="detail-card">
            <h6><i class="bi bi-text-paragraph me-2"></i>Descripción</h6>
            <p>${selectedItem.desc}</p>
        </div>
        <div class="detail-card">
            <h6><i class="bi bi-geo-alt me-2"></i>Ubicación</h6>
            <p class="badge bg-dark fs-6">${selectedItem.location}</p>
        </div>
        <div class="detail-card">
            <h6><i class="bi bi-database me-2"></i>Stock Sistema</h6>
            <p class="fs-4 fw-bold text-primary">${selectedItem.stock}</p>
        </div>
        <div class="detail-card">
            <h6><i class="bi bi-clipboard-check me-2"></i>Conteo Físico</h6>
            <p class="fs-4 fw-bold ${selectedItem.estado === 'OK' ? 'text-success' : selectedItem.estado === 'Diferencia' ? 'text-danger' : 'text-muted'}">
                ${selectedItem.count > 0 ? selectedItem.count : '-'}
            </p>
        </div>
        <div class="detail-card">
            <h6><i class="bi bi-calculator me-2"></i>Diferencia</h6>
            <p class="fs-4 fw-bold ${selectedItem.diferencia > 0 ? 'text-success' : selectedItem.diferencia < 0 ? 'text-danger' : 'text-muted'}">
                ${selectedItem.diferencia > 0 ? '+' : ''}${selectedItem.diferencia}
            </p>
        </div>
        <div class="detail-card">
            <h6><i class="bi bi-info-circle me-2"></i>Estado</h6>
            <span class="stock-badge ${selectedItem.estado === 'OK' ? 'badge-ok' : selectedItem.estado === 'Diferencia' ? 'badge-diferencia' : 'badge-pendiente'}">
                ${selectedItem.estado}
            </span>
        </div>
        <div class="detail-card">
            <h6><i class="bi bi-person me-2"></i>Último Usuario</h6>
            <p>${selectedItem.user || 'No especificado'}</p>
        </div>
    `;
    
    // Cargar historial
    loadItemHistory(selectedItem.code);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('itemDetailModal'));
    modal.show();
}

function loadItemHistory(code) {
    const historyContainer = document.getElementById('itemHistory');
    historyContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm"></div>
            <span class="ms-2">Cargando historial...</span>
        </div>
    `;
    
    // Simular carga de historial
    setTimeout(() => {
        const mockHistory = [
            { date: '2024-01-15 14:30', user: 'Usuario A', count: 100, status: 'OK' },
            { date: '2024-01-10 10:15', user: 'Usuario B', count: 95, status: 'Diferencia' },
            { date: '2024-01-05 09:00', user: 'Usuario C', count: 100, status: 'OK' },
            { date: '2023-12-20 16:45', user: 'Usuario A', count: 98, status: 'Diferencia' }
        ];
        
        historyContainer.innerHTML = mockHistory.map(item => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                    <strong>${item.date}</strong>
                    <div class="text-muted">${item.user}</div>
                </div>
                <div class="text-end">
                    <span class="badge ${item.status === 'OK' ? 'bg-success' : 'bg-warning'}">${item.count}</span>
                    <div class="text-muted small">${item.status}</div>
                </div>
            </div>
        `).join('');
    }, 1000);
}

function editItem(button) {
    const row = button.closest('tr');
    const code = row.dataset.code;
    const currentCount = parseInt(row.dataset.count) || 0;
    
    Swal.fire({
        title: `Editar Conteo: ${code}`,
        html: `
            <div class="text-start">
                <div class="mb-3">
                    <label class="form-label">Conteo Actual: <strong>${currentCount}</strong></label>
                    <input type="number" id="newCount" class="form-control" value="${currentCount}" min="0" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea id="observations" class="form-control" rows="3" placeholder="Agregar observaciones..."></textarea>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Guardar Cambios',
        cancelButtonText: 'Cancelar',
        customClass: {
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-secondary'
        },
        buttonsStyling: false,
        preConfirm: () => {
            const newCount = parseInt(document.getElementById('newCount').value);
            if (isNaN(newCount) || newCount < 0) {
                Swal.showValidationMessage('El conteo debe ser un número positivo');
                return false;
            }
            return { newCount, observations: document.getElementById('observations').value };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            updateItemCount(code, result.value.newCount, result.value.observations);
        }
    });
}

function updateItemCount(code, newCount, observations) {
    showLoading('Actualizando conteo...');
    
    // Simular actualización
    setTimeout(() => {
        hideLoading();
        
        // Actualizar fila en la tabla
        const row = document.querySelector(`tr[data-code="${code}"]`);
        if (row) {
            const oldCount = parseInt(row.dataset.count) || 0;
            const stock = parseInt(row.dataset.stock) || 0;
            const newDiferencia = newCount - stock;
            
            row.dataset.count = newCount;
            row.dataset.diferencia = newDiferencia;
            
            // Actualizar estado
            const newEstado = newCount === stock ? 'OK' : 'Diferencia';
            row.dataset.estado = newEstado;
            
            // Actualizar celdas
            row.cells[4].innerHTML = `
                <span class="fw-bold ${newEstado === 'OK' ? 'text-success' : 'text-danger'}">${newCount}</span>
                ${observations ? `<small class="text-muted d-block">${observations}</small>` : ''}
            `;
            
            row.cells[5].innerHTML = newEstado === 'OK' ? 
                '<span class="text-muted">0</span>' :
                `<span class="fw-bold ${newDiferencia > 0 ? 'text-success' : 'text-danger'}">
                    ${newDiferencia > 0 ? '<i class="bi bi-arrow-up-circle"></i> +' : '<i class="bi bi-arrow-down-circle"></i> '}${Math.abs(newDiferencia)}
                </span>`;
            
            row.cells[6].innerHTML = newEstado === 'OK' ? 
                '<span class="stock-badge badge-ok"><i class="bi bi-check-circle me-1"></i>OK</span>' :
                '<span class="stock-badge badge-diferencia"><i class="bi bi-exclamation-triangle me-1"></i>Diferencia</span>';
            
            // Recalcular métricas
            calculateMetrics();
            updateTopDifferences();
            
            showToast(`Conteo actualizado para ${code}: ${oldCount} → ${newCount}`, 'success');
            playSound('success');
        }
    }, 1500);
}

// ================= FUNCIONES DE ACCIONES MASIVAS =================
function showBulkActions() {
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function bulkValidate() {
    const selectedCodes = Array.from(CONFIG.STATE.selectedItems);
    
    if (selectedCodes.length === 0) {
        showToast('No hay items seleccionados', 'warning');
        return;
    }
    
    Swal.fire({
        title: `Validar ${selectedCodes.length} items`,
        text: '¿Desea marcar los items seleccionados como validados?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Validar Todos',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading(`Validando ${selectedCodes.length} items...`);
            
            // Simular validación
            setTimeout(() => {
                selectedCodes.forEach(code => {
                    const row = document.querySelector(`tr[data-code="${code}"]`);
                    if (row) {
                        row.dataset.estado = 'OK';
                        row.cells[6].innerHTML = '<span class="stock-badge badge-ok"><i class="bi bi-check-circle me-1"></i>OK</span>';
                    }
                });
                
                hideLoading();
                CONFIG.STATE.selectedItems.clear();
                updateSelectedCount();
                calculateMetrics();
                
                showToast(`${selectedCodes.length} items validados exitosamente`, 'success');
                playSound('success');
            }, 2000);
        }
    });
}

function bulkExport() {
    const selectedCodes = Array.from(CONFIG.STATE.selectedItems);
    
    if (selectedCodes.length === 0) {
        showToast('No hay items seleccionados', 'warning');
        return;
    }
    
    const selectedData = inventoryData.filter(item => selectedCodes.includes(item.code));
    generateExportExcel(selectedData, 'items_seleccionados');
}

// ================= FUNCIONES DE EXPORTACIÓN MEJORADAS =================
function generateExportExcel(data, fileName) {
    const wsData = [
        ['REPORTE DE CONTEO FÍSICO - ITEMS SELECCIONADOS'],
        ['Fecha:', new Date().toLocaleDateString()],
        ['Hora:', new Date().toLocaleTimeString()],
        ['Usuario:', '{{ session.get("username", "Usuario") }}'],
        ['Total items:', data.length],
        [''],
        ['Código', 'Descripción', 'Ubicación', 'Stock Sistema', 'Conteo Físico', 'Diferencia', 'Estado', 'Usuario', 'Observaciones']
    ];
    
    data.forEach(item => {
        wsData.push([
            item.code,
            item.desc,
            item.location,
            item.stock,
            item.count,
            item.diferencia > 0 ? `+${item.diferencia}` : item.diferencia,
            item.estado,
            item.user,
            ''
        ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Items Seleccionados');
    
    // Agregar hoja de resumen
    const summaryData = [
        ['RESUMEN'],
        ['Coinciden:', data.filter(item => item.estado === 'OK').length],
        ['Diferencias:', data.filter(item => item.estado === 'Diferencia').length],
        ['Pendientes:', data.filter(item => item.estado === 'Pendiente').length],
        ['Stock Total Sistema:', data.reduce((sum, item) => sum + item.stock, 0)],
        ['Conteo Total Físico:', data.reduce((sum, item) => sum + item.count, 0)],
        ['Diferencia Total:', data.reduce((sum, item) => sum + item.diferencia, 0)]
    ];
    
    const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, ws2, 'Resumen');
    
    const date = new Date().toISOString().split('T')[0];
    const fullFileName = `${fileName}_${date}.xlsx`;
    
    XLSX.writeFile(wb, fullFileName);
    
    showToast(`Exportados ${data.length} items`, 'success');
    playSound('export');
}

function generateReport() {
    showLoading('Generando reporte PDF...');
    
    html2canvas(document.querySelector('.dashboard-container')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        const date = new Date().toISOString().split('T')[0];
        pdf.save(`reporte_conteo_${date}.pdf`);
        
        hideLoading();
        showToast('Reporte PDF generado exitosamente', 'success');
        playSound('success');
    });
}

// ================= FUNCIONES DE CONFIGURACIÓN =================
function showSettings() {
    // Cargar configuración actual en el modal
    document.getElementById('refreshInterval').value = CONFIG.SETTINGS.refreshInterval / 1000;
    document.getElementById('itemsPerPage').value = CONFIG.SETTINGS.itemsPerPage;
    document.getElementById('enableNotifications').checked = CONFIG.SETTINGS.enableNotifications;
    document.getElementById('enableSounds').checked = CONFIG.SETTINGS.enableSounds;
    document.getElementById('showAnimations').checked = CONFIG.SETTINGS.showAnimations;
    document.getElementById('highlightCritical').checked = CONFIG.SETTINGS.highlightCritical;
    
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    modal.show();
}

function saveSettings() {
    CONFIG.SETTINGS.refreshInterval = parseInt(document.getElementById('refreshInterval').value) * 1000;
    CONFIG.SETTINGS.itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
    CONFIG.SETTINGS.enableNotifications = document.getElementById('enableNotifications').checked;
    CONFIG.SETTINGS.enableSounds = document.getElementById('enableSounds').checked;
    CONFIG.SETTINGS.showAnimations = document.getElementById('showAnimations').checked;
    CONFIG.SETTINGS.highlightCritical = document.getElementById('highlightCritical').checked;
    
    // Guardar en localStorage
    localStorage.setItem('dashboardSettings', JSON.stringify(CONFIG.SETTINGS));
    
    // Aplicar configuración
    applySettings();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
    modal.hide();
    
    showToast('Configuración guardada exitosamente', 'success');
    playSound('success');
}

function loadSettings() {
    const saved = localStorage.getItem('dashboardSettings');
    if (saved) {
        try {
            Object.assign(CONFIG.SETTINGS, JSON.parse(saved));
            applySettings();
        } catch (e) {
            console.error('Error cargando configuración:', e);
        }
    }
}

function applySettings() {
    // Aplicar tema
    document.body.setAttribute('data-theme', CONFIG.SETTINGS.theme);
    
    // Aplicar animaciones
    document.body.classList.toggle('no-animations', !CONFIG.SETTINGS.showAnimations);
    
    // Configurar auto-refresh
    if (CONFIG.SETTINGS.autoRefresh) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

function setTheme(theme) {
    CONFIG.SETTINGS.theme = theme;
    document.body.setAttribute('data-theme', theme);
    showToast(`Tema cambiado a ${theme}`, 'info');
}

// ================= FUNCIONES DE WEBSOCKET =================
function initWebSocket() {
    if (!CONFIG.SETTINGS.enableNotifications) return;
    
    try {
        CONFIG.STATE.socket = io('{{ request.host }}', {
            transports: ['websocket', 'polling']
        });
        
        CONFIG.STATE.socket.on('connect', () => {
            console.log('🔌 Conectado al servidor WebSocket');
            showNotification('Conectado', 'Conexión en tiempo real activa', 'success');
        });
        
        CONFIG.STATE.socket.on('count_update', (data) => {
            console.log('🔄 Actualización de conteo recibida:', data);
            showNotification('Conteo Actualizado', 
                `Item ${data.code} actualizado por ${data.user}`, 'info');
            
            if (CONFIG.SETTINGS.autoRefresh) {
                loadLatestData();
            }
        });
        
        CONFIG.STATE.socket.on('disconnect', () => {
            console.log('❌ Desconectado del servidor WebSocket');
            showNotification('Desconectado', 'Conexión perdida, reconectando...', 'warning');
        });
        
    } catch (error) {
        console.error('Error conectando WebSocket:', error);
    }
}

// ================= FUNCIONES DE NOTIFICACIONES =================
function showNotifications() {
    const panel = document.getElementById('notificationPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function showNotification(title, message, type = 'info') {
    if (!CONFIG.SETTINGS.enableNotifications) return;
    
    const panel = document.querySelector('#notificationPanel .toast-container');
    const id = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.id = id;
    toast.className = `toast show border-${type}`;
    toast.style.cssText = 'min-width: 300px; margin-bottom: 10px;';
    
    toast.innerHTML = `
        <div class="toast-header">
            <strong class="me-auto text-${type}">${title}</strong>
            <small class="text-muted">justo ahora</small>
            <button type="button" class="btn-close" onclick="document.getElementById('${id}').remove()"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    panel.appendChild(toast);
    
    // Actualizar contador
    updateNotificationCount(1);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        const toastEl = document.getElementById(id);
        if (toastEl) {
            toastEl.remove();
            updateNotificationCount(-1);
        }
    }, 5000);
    
    // Reproducir sonido
    if (CONFIG.SETTINGS.enableSounds) {
        playSound(type);
    }
}

function updateNotificationCount(change) {
    const countElement = document.getElementById('notificationCount');
    if (!countElement) return;
    
    let currentCount = parseInt(countElement.textContent) || 0;
    currentCount += change;
    
    if (currentCount <= 0) {
        countElement.textContent = '0 nuevas';
        countElement.parentElement.classList.remove('pulse');
    } else {
        countElement.textContent = `${currentCount} nuevas`;
        countElement.parentElement.classList.add('pulse');
    }
}

// ================= FUNCIONES DE UTILIDAD MEJORADAS =================
function playSound(type) {
    if (!CONFIG.SETTINGS.enableSounds) return;
    
    const sounds = {
        success: 'https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3',
                error: 'https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-957.wav',
        info: 'https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.wav',
        warning: 'https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-957.wav',
        export: 'https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.wav'
    };
    
    if (sounds[type]) {
        const audio = new Audio(sounds[type]);
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Error reproduciendo sonido:', e));
    }
}

function updateLoadingProgress(percent, detail = '') {
    const progressBar = document.getElementById('loadingProgress');
    const loadingDetail = document.getElementById('loadingDetail');
    const loadingMessage = document.getElementById('loadingMessage');
    
    if (progressBar) {
        progressBar.style.width = `${percent}%`;
    }
    if (loadingDetail && detail) {
        loadingDetail.textContent = detail;
    }
    if (loadingMessage && percent === 100) {
        loadingMessage.textContent = '¡Completado!';
    }
}

function showLoading(message = 'Cargando...', percent = 0) {
    const overlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    const loadingDetail = document.getElementById('loadingDetail');
    
    if (overlay) {
        overlay.classList.remove('d-none');
        if (loadingMessage) loadingMessage.textContent = message;
        if (loadingDetail) loadingDetail.textContent = '';
        updateLoadingProgress(percent);
    }
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.add('d-none');
    }
}

function showToast(message, type = 'info', duration = 3000) {
    // Crear contenedor si no existe
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        `;
        document.body.appendChild(container);
    }
    
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = `
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
    `;
    
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="document.getElementById('${toastId}').remove()"></button>
    `;
    
    container.appendChild(toast);
    
    // Auto-remover
    setTimeout(() => {
        const toastEl = document.getElementById(toastId);
        if (toastEl) {
            toastEl.remove();
        }
    }, duration);
}

// ================= FUNCIONES DE TIMERS =================
function startTimers() {
    // Timer de sesión
    sessionTimer = setInterval(() => {
        const now = new Date();
        const diff = Math.floor((now - CONFIG.STATE.sessionStart) / 1000);
        const minutes = Math.floor(diff / 60);
        const seconds = diff % 60;
        document.getElementById('sessionTimer').textContent = 
            `Sesión: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
    
    // Timer de antigüedad de datos
    dataAgeTimer = setInterval(() => {
        const now = new Date();
        const diff = Math.floor((now - CONFIG.STATE.lastUpdate) / 1000);
        
        if (diff < 60) {
            document.getElementById('dataAge').textContent = `Hace ${diff} segundos`;
        } else if (diff < 3600) {
            const minutes = Math.floor(diff / 60);
            document.getElementById('dataAge').textContent = `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
        } else {
            const hours = Math.floor(diff / 3600);
            document.getElementById('dataAge').textContent = `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
        }
    }, 30000); // Actualizar cada 30 segundos
}

// ================= FUNCIONES DE AUTO-REFRESH =================
function toggleAutoRefresh() {
    CONFIG.SETTINGS.autoRefresh = !CONFIG.SETTINGS.autoRefresh;
    const button = document.getElementById('autoRefreshBtn');
    
    if (CONFIG.SETTINGS.autoRefresh) {
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-info');
        startAutoRefresh();
        showToast('Auto-refresh activado', 'success');
    } else {
        button.classList.remove('btn-info');
        button.classList.add('btn-outline-info');
        stopAutoRefresh();
        showToast('Auto-refresh desactivado', 'info');
    }
}

function startAutoRefresh() {
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    
    autoRefreshTimer = setInterval(() => {
        loadLatestData();
    }, CONFIG.SETTINGS.refreshInterval);
}

function stopAutoRefresh() {
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
}

// ================= FUNCIONES DE ACTUALIZACIÓN DE DATOS =================
async function loadLatestData() {
    showLoading('Actualizando datos...', 0);
    
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizando...';
    }
    
    // Si la API no está disponible, simular actualización
    if (CONFIG.API.get_latest === '#') {
        setTimeout(() => {
            updateLoadingProgress(50, 'Simulando actualización...');
            
            setTimeout(() => {
                // Simular nuevos datos
                simulateDataUpdate();
                
                updateLoadingProgress(100, '¡Datos actualizados!');
                
                setTimeout(() => {
                    hideLoading();
                    CONFIG.STATE.lastUpdate = new Date();
                    
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline">Actualizar</span>';
                    }
                    
                    showToast('Datos actualizados exitosamente', 'success');
                    playSound('success');
                }, 500);
            }, 1000);
        }, 500);
        return;
    }
    
    try {
        updateLoadingProgress(30, 'Conectando con el servidor...');
        
        const response = await fetch(CONFIG.API.get_latest);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        updateLoadingProgress(70, 'Procesando datos...');
        
        const data = await response.json();
        
        if (data.success) {
            // Actualizar la interfaz con los nuevos datos
            updateUIWithNewData(data);
            
            updateLoadingProgress(100, '¡Datos actualizados!');
            
            setTimeout(() => {
                hideLoading();
                CONFIG.STATE.lastUpdate = new Date();
                
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline">Actualizar</span>';
                }
                
                showToast('Datos actualizados exitosamente', 'success');
                playSound('success');
            }, 500);
            
        } else {
            throw new Error(data.error || 'Error en los datos recibidos');
        }
        
    } catch (error) {
        console.error('Error actualizando datos:', error);
        
        hideLoading();
        CONFIG.STATE.lastUpdate = new Date();
        
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline">Actualizar</span>';
        }
        
        showToast('Error al actualizar datos: ' + error.message, 'danger');
        playSound('error');
    }
}

function simulateDataUpdate() {
    // Simular algunos cambios en los datos
    const changes = [];
    
    // Cambiar aleatoriamente algunos estados
    inventoryData.forEach(item => {
        if (Math.random() < 0.1) { // 10% de probabilidad de cambio
            const oldEstado = item.estado;
            const newEstado = Math.random() < 0.5 ? 'OK' : 'Diferencia';
            
            if (oldEstado !== newEstado) {
                item.estado = newEstado;
                item.element.dataset.estado = newEstado;
                
                // Actualizar la celda de estado
                const estadoCell = item.element.cells[6];
                if (estadoCell) {
                    estadoCell.innerHTML = newEstado === 'OK' ? 
                        '<span class="stock-badge badge-ok"><i class="bi bi-check-circle me-1"></i>OK</span>' :
                        '<span class="stock-badge badge-diferencia"><i class="bi bi-exclamation-triangle me-1"></i>Diferencia</span>';
                }
                
                changes.push(`${item.code}: ${oldEstado} → ${newEstado}`);
            }
        }
    });
    
    // Recalcular métricas
    calculateMetrics();
    updateTopDifferences();
    
    if (changes.length > 0) {
        console.log('Cambios simulados:', changes);
    }
}

function updateUIWithNewData(data) {
    // Esta función actualizaría la UI con datos reales del backend
    // Por ahora solo recalculamos métricas
    calculateMetrics();
    updateTopDifferences();
}

// ================= FUNCIONES ADICIONALES =================
function updateTopDifferences() {
    if (inventoryData.length === 0) {
        document.getElementById('topDifferences').innerHTML = 
            '<p class="text-muted text-center">No hay datos</p>';
        return;
    }
    
    // Filtrar solo items con diferencias
    const differences = inventoryData
        .filter(item => item.estado === 'Diferencia' && item.diferencia !== 0)
        .map(item => ({
            ...item,
            diferenciaAbs: Math.abs(item.diferencia),
            porcentajeDiff: item.stock > 0 ? 
                Math.abs((item.diferencia / item.stock) * 100) : 100
        }))
        .sort((a, b) => b.diferenciaAbs - a.diferenciaAbs)
        .slice(0, 5);
    
    if (differences.length === 0) {
        // Mostrar items pendientes
        const pendientes = inventoryData
            .filter(item => item.estado === 'Pendiente')
            .slice(0, 5);
        
        const html = pendientes.map((item, index) => `
            <div class="d-flex align-items-center justify-content-between mb-2 pb-2 ${index < pendientes.length - 1 ? 'border-bottom' : ''}">
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2">${index + 1}</span>
                    <div>
                        <div class="fw-semibold small text-truncate" style="max-width: 150px;">${item.code}</div>
                        <div class="text-muted extra-small">${item.location}</div>
                    </div>
                </div>
                <span class="badge bg-light text-dark border">Pendiente</span>
            </div>
        `).join('');
        
        document.getElementById('topDifferences').innerHTML = html || 
            '<p class="text-muted text-center">No hay diferencias</p>';
        return;
    }
    
    const html = differences.map((item, index) => `
        <div class="d-flex align-items-center justify-content-between mb-2 pb-2 ${index < differences.length - 1 ? 'border-bottom' : ''}">
            <div class="d-flex align-items-center">
                <span class="badge ${item.porcentajeDiff > 50 ? 'bg-danger' : 'bg-warning'} me-2">${index + 1}</span>
                <div>
                    <div class="fw-semibold small text-truncate" style="max-width: 150px;">${item.code}</div>
                    <div class="text-muted extra-small">${item.location}</div>
                </div>
            </div>
            <div class="text-end">
                <span class="fw-bold ${item.diferencia > 0 ? 'text-success' : 'text-danger'}">
                    ${item.diferencia > 0 ? '+' : ''}${item.diferencia}
                </span>
                <div class="text-muted extra-small">${item.porcentajeDiff.toFixed(1)}%</div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('topDifferences').innerHTML = html;
}

function loadActivityTimeline() {
    const timeline = document.getElementById('activityTimeline');
    if (!timeline) return;
    
    // Simular carga de actividad
    setTimeout(() => {
        const activities = [
            {
                time: 'Hace 5 minutos',
                user: '{{ session.get("username", "Usuario") }}',
                action: 'Actualizó conteo de AB-1234',
                type: 'update'
            },
            {
                time: 'Hace 15 minutos',
                user: 'Operador 2',
                action: 'Validó 10 items',
                type: 'validate'
            },
            {
                time: 'Hace 30 minutos',
                user: 'Sistema',
                action: 'Auto-refresh completado',
                type: 'system'
            },
            {
                time: 'Hace 1 hora',
                user: '{{ session.get("username", "Usuario") }}',
                action: 'Exportó reporte de diferencias',
                type: 'export'
            },
            {
                time: 'Hace 2 horas',
                user: 'Operador 1',
                action: 'Inició nuevo conteo físico',
                type: 'start'
            }
        ];
        
        timeline.innerHTML = activities.map(activity => `
            <div class="timeline-item">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <strong>${activity.action}</strong>
                    <small class="timeline-time">
                        <i class="bi bi-clock"></i> ${activity.time}
                    </small>
                </div>
                <div class="text-muted">
                    <i class="bi bi-person me-1"></i> ${activity.user}
                </div>
            </div>
        `).join('');
    }, 1500);
}

function changeChartType(chartId, type) {
    if (charts[chartId]) {
        charts[chartId].config.type = type;
        charts[chartId].update();
        
        // Actualizar botones activos
        const buttons = document.querySelectorAll(`[onclick*="changeChartType('${chartId}'"]`);
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase().includes(type)) {
                btn.classList.add('active');
            }
        });
        
        showToast(`Gráfico cambiado a ${type}`, 'info');
    }
}

function changeTimeRange(range) {
    // Actualizar botones activos
    const buttons = document.querySelectorAll('[onclick*="changeTimeRange"]');
    buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === range.toUpperCase()) {
            btn.classList.add('active');
        }
    });
    
    showToast(`Rango de tiempo cambiado a ${range}`, 'info');
    // Aquí actualizarías los datos del gráfico según el rango seleccionado
}

function toggleChartView(chartId) {
    CONFIG.STATE.chartFullscreen = !CONFIG.STATE.chartFullscreen;
    const chartCard = document.querySelector(`#${chartId}Chart`).closest('.chart-card');
    
    if (CONFIG.STATE.chartFullscreen) {
        chartCard.style.position = 'fixed';
        chartCard.style.top = '0';
        chartCard.style.left = '0';
        chartCard.style.width = '100vw';
        chartCard.style.height = '100vh';
        chartCard.style.zIndex = '99999';
        chartCard.style.margin = '0';
        chartCard.style.borderRadius = '0';
    } else {
        chartCard.style.position = '';
        chartCard.style.top = '';
        chartCard.style.left = '';
        chartCard.style.width = '';
        chartCard.style.height = '';
        chartCard.style.zIndex = '';
        chartCard.style.margin = '';
        chartCard.style.borderRadius = '';
    }
    
    // Actualizar gráfico
    if (charts[chartId]) {
        charts[chartId].resize();
    }
}

function updateFilteredCount() {
    const visibleCount = filteredData.length;
    document.getElementById('filteredCount').textContent = visibleCount;
    document.getElementById('visibleCount').textContent = visibleCount;
    document.getElementById('filterInfo').innerHTML = 
        `Mostrando <strong>${visibleCount}</strong> de ${inventoryData.length} items`;
}

function clearFilters() {
    // Limpiar inputs
    const searchInput = document.getElementById('searchInv');
    if (searchInput) searchInput.value = '';
    
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) statusFilter.value = 'all';
    
    const locationFilter = document.getElementById('locationFilter');
    if (locationFilter) locationFilter.value = 'all';
    
    // Mostrar todas las filas
    inventoryData.forEach(item => {
        item.element.style.display = '';
    });
    
    filteredData = [...inventoryData];
    updateFilteredCount();
    
    showToast('Filtros limpiados', 'info');
}

// ================= FUNCIONES DE EVENT LISTENERS =================
function setupEventListeners() {
    // Búsqueda en tiempo real
    const searchInput = document.getElementById('searchInv');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    filteredData = [...inventoryData];
                    inventoryData.forEach(item => item.element.style.display = '');
                    updateFilteredCount();
                    return;
                }
                
                filteredData = [];
                let visibleCount = 0;
                
                inventoryData.forEach(item => {
                    const matches = item.code.toLowerCase().includes(searchTerm) ||
                                   item.desc.toLowerCase().includes(searchTerm) ||
                                   item.location.toLowerCase().includes(searchTerm) ||
                                   item.stock.toString().includes(searchTerm) ||
                                   item.count.toString().includes(searchTerm) ||
                                   item.user.toLowerCase().includes(searchTerm);
                    
                    item.element.style.display = matches ? '' : 'none';
                    if (matches) {
                        visibleCount++;
                        filteredData.push(item);
                    }
                });
                
                updateFilteredCount();
            }, 300);
        });
    }
    
    // Teclas rápidas
    document.addEventListener('keydown', function(e) {
        // Ctrl + F para buscar
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            const searchInput = document.getElementById('searchInv');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }
        
        // Ctrl + R para actualizar
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            loadLatestData();
        }
        
        // Escape para limpiar filtros
        if (e.key === 'Escape') {
            clearFilters();
        }
    });
    
    // Prevenir recarga accidental con F5
    window.addEventListener('beforeunload', function(e) {
        if (CONFIG.STATE.selectedItems.size > 0) {
            e.preventDefault();
            e.returnValue = 'Tienes items seleccionados. ¿Seguro que quieres salir?';
        }
    });
    
    // Cerrar modales con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
        }
    });
}

// ================= FUNCIONES FALTANTES =================
function showAnalytics() {
    Swal.fire({
        title: 'Analítica Avanzada',
        html: `
            <div class="text-start">
                <h5>Estadísticas del Conteo</h5>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary">${inventoryData.length}</h3>
                                <p class="text-muted mb-0">Total Items</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-success">${inventoryData.filter(item => item.estado === 'OK').length}</h3>
                                <p class="text-muted mb-0">Precisión</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Distribución por Ubicación</h6>
                    <canvas id="analyticsChart" height="200"></canvas>
                </div>
            </div>
        `,
        width: 600,
        showConfirmButton: false,
        showCloseButton: true
    });
    
    // Renderizar gráfico de analítica
    setTimeout(() => {
        const ctx = document.getElementById('analyticsChart');
        if (ctx) {
            const locations = [...new Set(inventoryData.map(item => item.location))];
            const counts = locations.map(location => 
                inventoryData.filter(item => item.location === location).length
            );
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: locations,
                    datasets: [{
                        label: 'Items por Ubicación',
                        data: counts,
                        backgroundColor: 'rgba(26, 95, 122, 0.7)',
                        borderColor: 'rgba(26, 95, 122, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }, 100);
}

function refreshSummary() {
    calculateMetrics();
    showToast('Resumen actualizado', 'info');
}

function refreshTopDifferences() {
    updateTopDifferences();
    showToast('Diferencias actualizadas', 'info');
}

function editCurrentItem() {
    if (selectedItem) {
        editItem(document.querySelector(`tr[data-code="${selectedItem.code}"]`));
    }
}

function validateCurrentItem() {
    if (selectedItem) {
        const row = document.querySelector(`tr[data-code="${selectedItem.code}"]`);
        if (row) {
            row.dataset.estado = 'OK';
            row.cells[6].innerHTML = '<span class="stock-badge badge-ok"><i class="bi bi-check-circle me-1"></i>OK</span>';
            calculateMetrics();
            showToast(`Item ${selectedItem.code} validado`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('itemDetailModal'));
            if (modal) modal.hide();
        }
    }
}

function showHistory(button) {
    const row = button.closest('tr');
    showItemDetails(row);
}

function recountItem(button) {
    const row = button.closest('tr');
    const code = row.dataset.code;
    
    Swal.fire({
        title: `Recontar: ${code}`,
        text: '¿Desea marcar este item para reconteo?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, recontar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            row.dataset.count = '0';
            row.dataset.estado = 'Pendiente';
            row.cells[4].innerHTML = '<span class="fw-bold text-muted">-</span>';
            row.cells[5].innerHTML = '<span class="text-muted">-</span>';
            row.cells[6].innerHTML = '<span class="stock-badge badge-pendiente"><i class="bi bi-clock me-1"></i>Pendiente</span>';
            
            calculateMetrics();
            showToast(`Item ${code} marcado para reconteo`, 'info');
        }
    });
}

function showReconciliation() {
    const differences = inventoryData.filter(item => item.estado === 'Diferencia');
    
    if (differences.length === 0) {
        showToast('No hay diferencias para conciliar', 'info');
        return;
    }
    
    Swal.fire({
        title: 'Conciliar Stock',
        html: `
            <div class="text-start">
                <p>Se encontraron <strong>${differences.length}</strong> diferencias.</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Esta acción actualizará el sistema SAP con los conteos físicos.
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmReconciliation">
                    <label class="form-check-label" for="confirmReconciliation">
                        Confirmo que los conteos han sido verificados por supervisor
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="createJournal">
                    <label class="form-check-label" for="createJournal">
                        Crear asiento de ajuste contable
                    </label>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Conciliar Ahora',
        cancelButtonText: 'Cancelar',
        customClass: {
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-secondary'
        },
        buttonsStyling: false,
        preConfirm: () => {
            if (!document.getElementById('confirmReconciliation').checked) {
                Swal.showValidationMessage('Debe confirmar la verificación');
                return false;
            }
            return true;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            performReconciliation(differences);
        }
    });
}

function performReconciliation(differences) {
    showLoading(`Conciliando ${differences.length} diferencias...`);
    
    setTimeout(() => {
        hideLoading();
        
        Swal.fire({
            title: '¡Conciliación Exitosa!',
            html: `
                <div class="text-center">
                    <i class="bi bi-check-circle-fill text-success display-4 mb-3"></i>
                    <p>Se conciliaron ${differences.length} diferencias exitosamente.</p>
                    <p class="text-muted">El sistema SAP ha sido actualizado.</p>
                </div>
            `,
            icon: 'success',
            confirmButtonText: 'Aceptar'
        }).then(() => {
            // Marcar todos como OK después de la conciliación
            differences.forEach(item => {
                item.estado = 'OK';
                item.element.dataset.estado = 'OK';
                item.element.cells[6].innerHTML = 
                    '<span class="stock-badge badge-ok"><i class="bi bi-check-circle me-1"></i>OK</span>';
            });
            
            calculateMetrics();
            showToast('Stock conciliado exitosamente', 'success');
            playSound('success');
        });
    }, 2000);
}

function exportDifferences() {
    const differences = filteredData.filter(item => item.estado === 'Diferencia');
    
    if (differences.length === 0) {
        showToast('No hay diferencias para exportar', 'warning');
        return;
    }
    
    generateExportExcel(differences, 'diferencias_conteo');
}

function exportToExcel() {
    if (filteredData.length === 0) {
        showToast('No hay datos para exportar', 'warning');
        return;
    }
    
    generateExportExcel(filteredData, 'resultados_conteo_completo');
}

function printTable() {
    const printContent = document.querySelector('.table-card').outerHTML;
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <html>
            <head>
                <title>Reporte de Conteo Físico - ${new Date().toLocaleDateString()}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        body { margin: 0; font-size: 12px; }
                        .table { font-size: 11px; }
                        .badge { padding: 3px 8px; font-size: 10px; }
                        h4 { font-size: 16px; }
                    }
                    .no-print { display: none !important; }
                    .print-only { display: block !important; }
                </style>
            </head>
            <body>
                <div class="container mt-4">
                    <h4 class="mb-4 text-center">Reporte de Conteo Físico</h4>
                    <div class="mb-3">
                        <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
                        <p><strong>Usuario:</strong> {{ session.get('username', 'Usuario') }}</p>
                        <p><strong>Total items:</strong> ${filteredData.length}</p>
                    </div>
                    ${printContent}
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(() => window.close(), 500);
                    }
                </script>
            </body>
        </html>
    `);
    
    printWindow.document.close();
    showToast('Preparando para imprimir...', 'info');
}

function bulkRecount() {
    const selectedCodes = Array.from(CONFIG.STATE.selectedItems);
    
    if (selectedCodes.length === 0) {
        showToast('No hay items seleccionados', 'warning');
        return;
    }
    
    Swal.fire({
        title: `Recontar ${selectedCodes.length} items`,
        text: '¿Desea marcar los items seleccionados para reconteo?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, recontar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            selectedCodes.forEach(code => {
                const row = document.querySelector(`tr[data-code="${code}"]`);
                if (row) {
                    row.dataset.count = '0';
                    row.dataset.estado = 'Pendiente';
                    row.cells[4].innerHTML = '<span class="fw-bold text-muted">-</span>';
                    row.cells[5].innerHTML = '<span class="text-muted">-</span>';
                    row.cells[6].innerHTML = 
                        '<span class="stock-badge badge-pendiente"><i class="bi bi-clock me-1"></i>Pendiente</span>';
                }
            });
            
            CONFIG.STATE.selectedItems.clear();
            updateSelectedCount();
            calculateMetrics();
            
            showToast(`${selectedCodes.length} items marcados para reconteo`, 'success');
            playSound('success');
        }
    });
}

function bulkReconcile() {
    const selectedCodes = Array.from(CONFIG.STATE.selectedItems);
    
    if (selectedCodes.length === 0) {
        showToast('No hay items seleccionados', 'warning');
        return;
    }
    
    const selectedData = inventoryData.filter(item => selectedCodes.includes(item.code));
    const differences = selectedData.filter(item => item.estado === 'Diferencia');
    
    if (differences.length === 0) {
        showToast('No hay diferencias en los items seleccionados', 'warning');
        return;
    }
    
    Swal.fire({
        title: `Conciliar ${differences.length} diferencias`,
        html: `
            <div class="text-start">
                <p>Se conciliarán <strong>${differences.length}</strong> items seleccionados.</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Esta acción actualizará el stock en el sistema.
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Conciliar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading(`Conciliando ${differences.length} items...`);
            
            setTimeout(() => {
                differences.forEach(item => {
                    item.estado = 'OK';
                    item.element.dataset.estado = 'OK';
                    item.element.cells[6].innerHTML = 
                        '<span class="stock-badge badge-ok"><i class="bi bi-check-circle me-1"></i>OK</span>';
                });
                
                CONFIG.STATE.selectedItems.clear();
                updateSelectedCount();
                calculateMetrics();
                hideLoading();
                
                showToast(`${differences.length} items conciliados exitosamente`, 'success');
                playSound('success');
            }, 1500);
        }
    });
}

function bulkDelete() {
    const selectedCodes = Array.from(CONFIG.STATE.selectedItems);
    
    if (selectedCodes.length === 0) {
        showToast('No hay items seleccionados', 'warning');
        return;
    }
    
    Swal.fire({
        title: `¿Eliminar ${selectedCodes.length} items?`,
        html: `
            <div class="text-start">
                <p>Esta acción eliminará permanentemente <strong>${selectedCodes.length}</strong> items del conteo.</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Esta acción no se puede deshacer.
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmDelete">
                    <label class="form-check-label" for="confirmDelete">
                        Confirmo que deseo eliminar estos items
                    </label>
                </div>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#dc3545',
        customClass: {
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-secondary'
        },
        preConfirm: () => {
            if (!document.getElementById('confirmDelete').checked) {
                Swal.showValidationMessage('Debe confirmar la eliminación');
                return false;
            }
            return true;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading(`Eliminando ${selectedCodes.length} items...`);
            
            setTimeout(() => {
                selectedCodes.forEach(code => {
                    const row = document.querySelector(`tr[data-code="${code}"]`);
                    if (row) {
                        row.remove();
                        // Eliminar de los arrays de datos
                        const index = inventoryData.findIndex(item => item.code === code);
                        if (index > -1) {
                            inventoryData.splice(index, 1);
                        }
                    }
                });
                
                CONFIG.STATE.selectedItems.clear();
                updateSelectedCount();
                calculateMetrics();
                updateFilteredCount();
                hideLoading();
                
                showToast(`${selectedCodes.length} items eliminados exitosamente`, 'success');
                playSound('success');
            }, 1500);
        }
    });
}

function updateEmptyState() {
    // Actualizar todos los contadores a 0
    document.getElementById('totalItems').textContent = '0';
    document.getElementById('okItems').textContent = '0';
    document.getElementById('diffItems').textContent = '0';
    document.getElementById('pendItems').textContent = '0';
    document.getElementById('totalLocations').textContent = '0';
    document.getElementById('totalStock').textContent = '0';
    document.getElementById('totalCounted').textContent = '0';
    document.getElementById('progressPercent').textContent = '0%';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('widgetProgress').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
    
    // Actualizar widgets
    document.getElementById('widgetOk').textContent = '0';
    document.getElementById('widgetDiff').textContent = '0';
    document.getElementById('widgetPend').textContent = '0';
}

// ================= INICIALIZACIÓN FINAL =================
// Exportar funciones globales necesarias
window.loadLatestData = loadLatestData;
window.clearFilters = clearFilters;
window.filterByStatus = filterByStatus;
window.exportDifferences = exportDifferences;
window.exportToExcel = exportToExcel;
window.printTable = printTable;
window.showReconciliation = showReconciliation;
window.showSettings = showSettings;
window.showAnalytics = showAnalytics;
window.showNotifications = showNotifications;
window.toggleAutoRefresh = toggleAutoRefresh;
window.showBulkActions = showBulkActions;
window.showAdvancedFilters = showAdvancedFilters;
window.applyAdvancedFilters = applyAdvancedFilters;
window.resetAdvancedFilters = resetAdvancedFilters;
window.toggleCriticalOnly = toggleCriticalOnly;
window.editItem = editItem;
window.showHistory = showHistory;
window.recountItem = recountItem;
window.showItemDetails = showItemDetails;
window.toggleRowSelection = toggleRowSelection;
window.sortTable = sortTable;
window.changeChartType = changeChartType;
window.changeTimeRange = changeTimeRange;
window.toggleChartView = toggleChartView;
window.filterByLocation = filterByLocation;
window.bulkValidate = bulkValidate;
window.bulkRecount = bulkRecount;
window.bulkExport = bulkExport;
window.bulkReconcile = bulkReconcile;
window.bulkDelete = bulkDelete;
window.generateReport = generateReport;
window.setTheme = setTheme;
window.saveSettings = saveSettings;
window.refreshSummary = refreshSummary;
window.refreshTopDifferences = refreshTopDifferences;
window.editCurrentItem = editCurrentItem;
window.validateCurrentItem = validateCurrentItem;

console.log('✅ Dashboard completamente inicializado y listo para usar!');
</script>

{% endblock %}
