{% extends "base.html" %}
{% block content %}

<style>
  .gloves * { font-size: 1.15rem !important; }
  .gloves .btn { padding: 0.9rem 1.1rem !important; }
  .gloves input.form-control { height: 52px; font-size: 1.2rem !important; }
  .sticky-tools { position: sticky; top: 10px; z-index: 10; }
  .row-saving { outline: 2px dashed rgba(25,135,84,.35); border-radius: 10px; }
</style>

<div id="pageRoot" class="container">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center">
      <i class="bi bi-clipboard-check fs-2 me-3 text-success"></i>
      <div>
        <h2 class="fw-bold mb-0">Conteo</h2>
        <div class="text-muted small">Dictado por voz + guardado autom谩tico</div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button id="btnGloves" class="btn btn-outline-dark">
        <i class="bi bi-hand-index-thumb me-2"></i> Guantes
      </button>
      <button id="btnVoice" class="btn btn-outline-primary">
        <i class="bi bi-mic me-2"></i> Dictado
      </button>
    </div>
  </div>

  <div class="card shadow-sm mb-3 sticky-tools">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleContinuous" checked>
        <label class="form-check-label fw-semibold">Dictado continuo</label>
      </div>

      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleSpeak" checked>
        <label class="form-check-label fw-semibold">Confirmaci贸n por voz</label>
      </div>

      <div class="ms-auto text-muted small" id="voiceStatus">
        <i class="bi bi-info-circle me-1"></i> Micr贸fono: listo
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>C贸digo</th>
            <th>Descripci贸n</th>
            <th>UM</th>
            <th>Ubicaci贸n</th>
            <th>Stock</th>
            <th style="width:160px;">Conteo</th>
            <th style="width:120px;">Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for i in items %}
          <tr>
            <td class="fw-semibold">{{ i.material_code }}</td>

            <td class="text-muted small">
              {{ i.material_text }}
            </td>

            <td class="text-center fw-semibold">
              {{ i.base_unit }}
            </td>

            <td class="text-center fw-semibold">
              {{ i.location }}
            </td>

            <!--  STOCK + UNIDAD (CLARO PARA DICTADO) -->
            <td class="text-center fw-semibold">
              {{ i.stock }}
              <span class="text-muted">{{ i.base_unit }}</span>
            </td>

            <td>
              <input class="form-control text-center count-input"
                     inputmode="numeric"
                     pattern="[0-9]*"
                     placeholder="0"
                     value="{{ i.real_count }}"
                     data-code="{{ i.material_code }}"
                     data-loc="{{ i.location }}">
            </td>

            <td class="text-center">
              <span class="badge
                {% if i.estado == 'OK' %}bg-success
                {% elif i.estado == 'Diferencia' %}bg-warning
                {% else %}bg-secondary{% endif %}">
                {{ i.estado }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(() => {

  let recognition = null;
  let listening = false;
  let manualStop = false;

  const btnVoice = document.getElementById("btnVoice");
  const voiceStatus = document.getElementById("voiceStatus");
  const toggleContinuous = document.getElementById("toggleContinuous");
  const toggleSpeak = document.getElementById("toggleSpeak");

  /* ==========================
     UTILIDADES
  ========================== */
  const speak = (txt) => {
    if (!toggleSpeak.checked) return;
    try {
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = "es-PE";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch {}
  };

  const setStatus = (msg, ok=true) => {
    voiceStatus.innerHTML = ok
      ? `<i class="bi bi-mic me-1"></i> ${msg}`
      : `<i class="bi bi-exclamation-triangle me-1"></i> ${msg}`;
  };

  const findInputByCode = (code) => {
    return document.querySelector(
      `.count-input[data-code="${code}"]`
    );
  };

  /* ==========================
     GUARDAR FILA
  ========================== */
  const saveRow = async (inputEl) => {
    const code = inputEl.dataset.code;
    const loc = inputEl.dataset.loc;
    const val = parseInt(inputEl.value || "0", 10) || 0;

    const tr = inputEl.closest("tr");
    tr.classList.add("row-saving");

    try {
      const res = await fetch("{{ url_for('inventory.save_count_row') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          material_code: code,
          location: loc,
          real_count: val
        })
      });
      const j = await res.json();
      if (j && j.success) {
        speak("registrado");
        setStatus(`C贸digo ${code}, cantidad ${val}`);
      }
    } catch {
      setStatus("Error al guardar", false);
    } finally {
      tr.classList.remove("row-saving");
    }
  };

  /* ==========================
     SPEECH RECOGNITION
  ========================== */
  const getRecognition = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = "es-PE";
    r.continuous = true;
    r.interimResults = false;
    return r;
  };

  const startRecognition = () => {
    if (listening) return;

    recognition = getRecognition();
    if (!recognition) {
      setStatus("Dictado no soportado", false);
      return;
    }

    manualStop = false;

    recognition.onresult = (e) => {
      const text = e.results[e.results.length - 1][0]
        .transcript.toLowerCase();

      // Extraer n煤meros
      const nums = text.match(/\d+/g) || [];

      const code = nums.find(n => n.length >= 8);
      const qty  = nums.find(n => n.length >= 1 && n.length <= 3);

      if (!code || !qty) {
        setStatus("Diga: c贸digo + cantidad", false);
        return;
      }

      const input = findInputByCode(code);

      if (!input) {
        setStatus(`C贸digo ${code} no encontrado`, false);
        speak("c贸digo no encontrado");
        return;
      }

      input.focus();
      input.value = qty;
      input.dispatchEvent(new Event("input", { bubbles: true }));

      saveRow(input);
    };

    recognition.onerror = () => {
      setStatus("Error de micr贸fono", false);
    };

    recognition.onend = () => {
      listening = false;
      if (!manualStop && toggleContinuous.checked) {
        setTimeout(() => {
          try {
            recognition.start();
            listening = true;
            setStatus("Escuchando...");
          } catch {}
        }, 300);
      } else {
        setStatus("Dictado detenido");
        btnVoice.classList.remove("btn-primary");
        btnVoice.classList.add("btn-outline-primary");
        btnVoice.innerHTML = '<i class="bi bi-mic me-2"></i> Dictado';
      }
    };

    try {
      recognition.start();
      listening = true;
      btnVoice.classList.add("btn-primary");
      btnVoice.innerHTML =
        '<i class="bi bi-mic-fill me-2"></i> Dictando...';
      setStatus("Habla: c贸digo + cantidad");
    } catch {
      setStatus("No se pudo iniciar micr贸fono", false);
    }
  };

  const stopRecognition = () => {
    manualStop = true;
    try { recognition && recognition.stop(); } catch {}
    listening = false;
    setStatus("Dictado detenido");
  };

  btnVoice.addEventListener("click", () => {
    listening ? stopRecognition() : startRecognition();
  });

})();
</script>
{% endblock %}



