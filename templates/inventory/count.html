{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-3">
  <i class="bi bi-clipboard-data me-2"></i> Conteo de Inventario
</h2>

<style>
  /* Modo guantes */
  .glove-input {
    font-size: 1.1rem;
    padding: 14px 12px;
    border-radius: 12px;
  }
  .btn-mobile {
    border-radius: 14px;
    padding: 12px 14px;
  }
  .row-highlight {
    background: #f7fff0 !important;
    transition: background 0.2s ease;
  }
  .sticky-tools {
    position: sticky;
    top: 12px;
    z-index: 9;
    background: transparent;
  }
</style>

<div class="card shadow-sm p-3">

  <!-- TOOLBAR RESPONSIVE -->
  <div class="sticky-tools mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-12 col-lg-6">
        <input id="searchCount" type="text" class="form-control glove-input shadow-sm"
               placeholder="üîç Buscar material, texto o ubicaci√≥n‚Ä¶">
      </div>

      <div class="col-12 col-lg-6">
        <div class="d-grid d-lg-flex gap-2 justify-content-lg-end">
          <button id="exportBtn" class="btn btn-primary btn-mobile shadow-sm">
            <i class="bi bi-file-earmark-excel me-2"></i>Exportar
          </button>

          <button id="saveCountBtn" class="btn btn-success btn-mobile shadow-sm">
            <i class="bi bi-cloud-check me-2"></i>Guardar
          </button>

          <button id="voiceBtn" class="btn btn-danger btn-mobile shadow-sm">
            <i class="bi bi-mic-fill me-2"></i>Dictar
          </button>
        </div>

        <div class="mt-2">
          <small id="voiceStatus" class="text-muted">Listo.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA -->
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="countTable">
      <thead class="table-dark text-center">
        <tr>
          <th style="min-width:140px;">C√≥digo</th>
          <th style="min-width:420px;">Descripci√≥n</th>
          <th style="min-width:120px;">Ubicaci√≥n</th>
          <th style="min-width:140px;">Stock Sistema</th>
          <th style="min-width:170px;">Conteo Real</th>
        </tr>
      </thead>
      <tbody>
        {% for i in items %}
        <tr data-code="{{ i.material_code }}" data-loc="{{ i.location }}">
          <td><strong>{{ i.material_code }}</strong></td>
          <td>{{ i.material_text }}</td>
          <td class="text-primary fw-bold">{{ i.location }}</td>
          <td class="text-center">{{ i.libre_utilizacion }}</td>
          <td class="text-center">
            <input type="number"
                   inputmode="numeric"
                   min="0"
                   class="form-control glove-input count-input shadow-sm text-center"
                   placeholder="0">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script>
/* ==========================
   B√öSQUEDA
========================== */
document.getElementById("searchCount").addEventListener("input", function () {
  const filter = this.value.toLowerCase();
  document.querySelectorAll("#countTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});

/* ==========================
   INPUT UX
========================== */
function paintInput(input) {
  const v = (input.value || "").trim();
  input.style.backgroundColor = v === "" ? "#ffe5e5" : "#e6ffe6";
}

document.querySelectorAll(".count-input").forEach((input) => {
  input.addEventListener("input", () => {
    paintInput(input);
    const tr = input.closest("tr");
    tr.classList.add("row-highlight");
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const inputs = [...document.querySelectorAll(".count-input")];
      const idx = inputs.indexOf(input);
      if (inputs[idx + 1]) inputs[idx + 1].focus();
    }
  });

  paintInput(input);
});

/* ==========================
   GUARDAR CONTEO
========================== */
document.getElementById("saveCountBtn").addEventListener("click", async () => {
  const conteos = [];
  document.querySelectorAll("#countTable tbody tr").forEach(row => {
    const material_code = row.dataset.code;
    const location = row.dataset.loc;
    const input = row.querySelector(".count-input").value.trim();
    if (input !== "") {
      conteos.push({ material_code, location, real_count: Number(input) });
    }
  });

  if (conteos.length === 0) return alert("‚ö† Debe ingresar al menos un valor de conteo.");

  try {
    const res = await fetch("/inventory/save-count", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(conteos)
    });
    const data = await res.json();

    if (data.success) {
      alert("‚úÖ Conteo guardado correctamente.");
      document.querySelectorAll(".count-input").forEach(i => i.style.backgroundColor = "white");
    } else {
      alert("‚ùå Error guardando conteo: " + (data.msg || ""));
    }
  } catch (e) {
    alert("‚ùå Error conectando con el servidor.");
  }
});

/* ==========================
   EXPORTAR DISCREPANCIAS
========================== */
document.getElementById("exportBtn").addEventListener("click", async () => {
  const conteos = [];
  document.querySelectorAll("#countTable tbody tr").forEach(row => {
    const material_code = row.dataset.code;
    const location = row.dataset.loc;
    const input = row.querySelector(".count-input").value.trim();
    if (input !== "") conteos.push({ material_code, location, real_count: Number(input) });
  });

  if (conteos.length === 0) return alert("‚ö† Debe ingresar m√≠nimo un conteo para generar discrepancias.");

  const r = await fetch("/inventory/export-discrepancies", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(conteos)
  });

  const blob = await r.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "discrepancias.xlsx";
  a.click();
  window.URL.revokeObjectURL(url);
});

/* ==========================
   DICTADO ANDROID (Web Speech)
========================== */
let recognition = null;
let listening = false;
let lastRow = null;

const btn = document.getElementById("voiceBtn");
const status = document.getElementById("voiceStatus");

function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("‚ùå Dictado no compatible. Usa Chrome en Android.");
    return null;
  }

  const rec = new SR();
  rec.lang = "es-PE";
  rec.continuous = true;     // continuo (Android puede cortarlo igual)
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  return rec;
}

function setCellValue(row, cantidad) {
  const input = row.querySelector(".count-input");
  input.value = String(cantidad);
  input.setAttribute("value", String(cantidad));
  input.dispatchEvent(new Event("input", { bubbles: true }));
  input.dispatchEvent(new Event("change", { bubbles: true }));

  row.classList.add("row-highlight");
  row.scrollIntoView({ behavior: "smooth", block: "center" });
  input.focus({ preventScroll: true });

  lastRow = row;
}

function findRowByCode(code) {
  const rows = document.querySelectorAll("#countTable tbody tr");
  for (const row of rows) {
    if (String(row.dataset.code).trim() === String(code).trim()) return row;
  }
  return null;
}

/**
 * Reglas:
 * - Si el dictado trae varios n√∫meros:
 *    - √∫ltimo n√∫mero = cantidad
 *    - resto concatenado = c√≥digo (para casos tipo "100 40 568 12" => 10040568 / 12)
 * - Si trae 2 n√∫meros: "codigo cantidad"
 * - Si trae 1 n√∫mero: cantidad para lastRow
 */
function procesarTexto(texto) {
  const nums = (texto.match(/\d+/g) || []).map(x => String(x));
  if (nums.length === 0) return;

  if (nums.length === 1) {
    if (lastRow) setCellValue(lastRow, nums[0]);
    return;
  }

  const cantidad = nums[nums.length - 1];
  const codigo = nums.slice(0, -1).join(""); // concat

  const row = findRowByCode(codigo) || findRowByCode(nums[0]); // fallback
  if (row) {
    setCellValue(row, cantidad);
  } else {
    status.innerText = `‚ö†Ô∏è No encontr√© c√≥digo ${codigo}`;
  }
}

btn.addEventListener("click", () => {
  if (!recognition) recognition = initRecognition();
  if (!recognition) return;

  if (!listening) {
    recognition.onstart = () => {
      listening = true;
      status.innerText = "üéôÔ∏è Escuchando‚Ä¶ (di: 100 40 568 12)";
      btn.classList.remove("btn-danger");
      btn.classList.add("btn-dark");
    };

    recognition.onresult = (event) => {
      const text = (event.results?.[event.results.length - 1]?.[0]?.transcript || "").toLowerCase().trim();
      if (text) procesarTexto(text);
    };

    recognition.onerror = (e) => {
      // en Android suele salir "network" si no hay servicio/permiso
      status.innerText = `‚ö†Ô∏è Dictado error: ${e.error}`;
      listening = false;
      btn.classList.add("btn-danger");
      btn.classList.remove("btn-dark");
      try { recognition.stop(); } catch {}
    };

    recognition.onend = () => {
      // si estaba en modo ‚Äúcontinuo‚Äù, reintenta (cuando Android lo corta)
      if (listening) {
        try { recognition.start(); } catch {}
      } else {
        status.innerText = "‚èπÔ∏è Detenido.";
      }
    };

    recognition.start();

  } else {
    listening = false;
    try { recognition.stop(); } catch {}
    btn.classList.add("btn-danger");
    btn.classList.remove("btn-dark");
    status.innerText = "‚èπÔ∏è Detenido.";
  }
});
</script>

{% endblock %}
