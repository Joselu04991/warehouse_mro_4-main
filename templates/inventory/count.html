{% extends "base.html" %}
{% block content %}

<style>
  .count-toolbar { gap: .5rem; flex-wrap: wrap; }
  .count-toolbar .btn { white-space: nowrap; }
  .glove-mode .count-input{
    font-size: 1.35rem !important;
    height: 56px !important;
    border-radius: 14px !important;
  }
  .glove-mode #searchCount{
    font-size: 1.15rem !important;
    height: 52px !important;
    border-radius: 14px !important;
  }
  .glove-mode .btn{
    font-size: 1.05rem !important;
    padding: .85rem 1rem !important;
    border-radius: 14px !important;
  }
  .row-active{
    outline: 3px solid rgba(13,110,253,.35);
    box-shadow: 0 0 0 4px rgba(13,110,253,.08);
  }
  .sticky-actions{
    position: sticky;
    bottom: 0;
    z-index: 10;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(6px);
    border-top: 1px solid rgba(0,0,0,.08);
    padding: .75rem;
    margin: 0 -1rem -1rem -1rem;
  }
  .mini-status{
    font-size: .95rem;
  }
</style>

<h2 class="fw-bold mb-3">
  <i class="bi bi-clipboard-data me-2"></i> Conteo de Inventario
</h2>

<div class="card shadow-sm p-3 p-md-4">

  <div class="d-flex justify-content-between align-items-center mb-3 count-toolbar">
    <input
      type="text"
      id="searchCount"
      class="form-control shadow-sm flex-grow-1"
      placeholder="üîç Buscar material, texto o ubicaci√≥n‚Ä¶"
      style="min-width: 240px;"
    >

    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" id="gloveToggle">
        <label class="form-check-label" for="gloveToggle">üß§ Modo guantes</label>
      </div>

      <button id="pwaInstallBtn" class="btn btn-outline-dark btn-lg shadow-sm d-none">
        <i class="bi bi-download me-2"></i>Instalar app
      </button>

      <button id="voiceBtn" class="btn btn-danger btn-lg shadow-sm">
        <i class="bi bi-mic-fill me-2"></i>Dictado
      </button>

      <button id="exportBtn" class="btn btn-primary btn-lg shadow-sm">
        <i class="bi bi-file-earmark-excel me-2"></i>Exportar
      </button>

      <button id="saveCountBtn" class="btn btn-success btn-lg shadow-sm">
        <i class="bi bi-cloud-check me-2"></i>Guardar
      </button>
    </div>
  </div>

  <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
    <span id="voiceStatus" class="text-muted mini-status"></span>
    <span id="saveStatus" class="text-muted mini-status"></span>
    <span id="hintStatus" class="text-muted mini-status"></span>
  </div>

  <div class="table-responsive" style="max-height: 70vh;">
    <table class="table table-hover align-middle" id="countTable">
      <thead class="table-dark text-center" style="position: sticky; top: 0; z-index: 2;">
        <tr>
          <th style="min-width:120px;">C√≥digo</th>
          <th style="min-width:220px;">Descripci√≥n</th>
          <th style="min-width:120px;">Ubicaci√≥n</th>
          <th style="min-width:120px;">Stock Sistema</th>
          <th style="min-width:180px;">Conteo Real</th>
        </tr>
      </thead>

      <tbody>
        {% for i in items %}
        <tr class="count-row" data-code="{{ i.material_code }}" data-loc="{{ i.location }}">
          <td><strong>{{ i.material_code }}</strong></td>
          <td>{{ i.material_text }}</td>
          <td class="text-primary fw-bold">{{ i.location }}</td>
          <td class="text-center">{{ i.libre_utilizacion }}</td>
          <td class="text-center" style="width: 220px;">
            <input
              type="number"
              min="0"
              class="form-control count-input shadow-sm text-center"
              placeholder="0"
              inputmode="numeric"
              autocomplete="off"
            >
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>

  <div class="sticky-actions d-md-none">
    <div class="d-grid gap-2">
      <button id="voiceBtnMobile" class="btn btn-danger btn-lg shadow-sm">
        <i class="bi bi-mic-fill me-2"></i>Dictado
      </button>
      <div class="d-flex gap-2">
        <button id="exportBtnMobile" class="btn btn-primary btn-lg shadow-sm w-50">
          <i class="bi bi-file-earmark-excel me-2"></i>Exportar
        </button>
        <button id="saveCountBtnMobile" class="btn btn-success btn-lg shadow-sm w-50">
          <i class="bi bi-cloud-check me-2"></i>Guardar
        </button>
      </div>
    </div>
  </div>

</div>

<script>
  // ===== Helpers UI =====
  const bodyEl = document.body;
  const gloveToggle = document.getElementById("gloveToggle");
  const voiceStatus = document.getElementById("voiceStatus");
  const saveStatus = document.getElementById("saveStatus");
  const hintStatus = document.getElementById("hintStatus");

  gloveToggle?.addEventListener("change", () => {
    bodyEl.classList.toggle("glove-mode", gloveToggle.checked);
    localStorage.setItem("glove_mode", gloveToggle.checked ? "1" : "0");
  });
  if (localStorage.getItem("glove_mode") === "1") {
    gloveToggle.checked = true;
    bodyEl.classList.add("glove-mode");
  }

  function speak(text) {
    try {
      if (!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-PE";
      u.rate = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    } catch {}
  }

  function normalizeDigits(x) {
    const s = String(x ?? "").trim();
    const digits = (s.match(/\d+/g) || []).join("");
    return digits.replace(/^0+/, "") || digits;
  }

  // ===== Buscar =====
  document.getElementById("searchCount").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("#countTable tbody tr").forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
  });

  // ===== Selecci√≥n de fila (tap) =====
  let activeRow = null;
  let lastRow = null;

  function setActiveRow(row) {
    document.querySelectorAll(".count-row").forEach(r => r.classList.remove("row-active"));
    activeRow = row;
    if (activeRow) activeRow.classList.add("row-active");
  }

  document.querySelectorAll(".count-row").forEach(row => {
    row.addEventListener("click", (e) => {
      if (e.target && e.target.classList && e.target.classList.contains("count-input")) return;
      setActiveRow(row);
      const input = row.querySelector(".count-input");
      input?.focus();
      lastRow = row;
      hintStatus.innerText = `‚úÖ Fila seleccionada: ${row.dataset.code}`;
      setTimeout(() => (hintStatus.innerText = ""), 2500);
    });
  });

  // ===== Efectos + autosave debounce =====
  let autosaveTimer = null;
  let autosaveInFlight = false;

  function collectConteos() {
    const conteos = [];
    document.querySelectorAll("#countTable tbody tr").forEach(row => {
      const material_code = row.dataset.code;
      const location = row.dataset.loc;
      const input = row.querySelector(".count-input")?.value?.trim();

      if (input !== "") {
        conteos.push({
          material_code,
          location,
          real_count: Number(input)
        });
      }
    });
    return conteos;
  }

  function scheduleAutosave() {
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(async () => {
      const conteos = collectConteos();
      if (conteos.length === 0) return;

      autosaveInFlight = true;
      saveStatus.innerText = "üíæ Guardando‚Ä¶";

      try {
        const res = await fetch("/inventory/save-count", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(conteos),
          keepalive: true
        });

        const data = await res.json().catch(() => null);

        if (res.ok && data && data.success) {
          saveStatus.innerText = "‚úÖ Guardado autom√°tico";
          setTimeout(() => (saveStatus.innerText = ""), 1800);
        } else {
          saveStatus.innerText = "‚ö†Ô∏è No se pudo guardar";
        }
      } catch (e) {
        saveStatus.innerText = "‚ö†Ô∏è Error de red guardando";
      } finally {
        autosaveInFlight = false;
      }
    }, 700);
  }

  document.querySelectorAll(".count-input").forEach(input => {
    input.addEventListener("input", () => {
      input.style.backgroundColor = input.value.trim() === "" ? "#ffe5e5" : "#e6ffe6";
      const row = input.closest("tr");
      row.style.backgroundColor = "#f7fff0";
      lastRow = row;
      scheduleAutosave();
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const inputs = [...document.querySelectorAll(".count-input")];
        const idx = inputs.indexOf(input);
        if (inputs[idx + 1]) inputs[idx + 1].focus();
      }
    });
  });

  // ===== Guardar manual =====
  async function saveManual() {
    const conteos = collectConteos();
    if (conteos.length === 0) return alert("‚ö† Debe ingresar al menos un valor de conteo.");

    saveStatus.innerText = "üíæ Guardando‚Ä¶";
    try {
      const res = await fetch("/inventory/save-count", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(conteos)
      });
      const data = await res.json();

      if (data.success) {
        alert("‚úÖ Conteo guardado correctamente.");
        saveStatus.innerText = "‚úÖ Guardado";
        setTimeout(() => (saveStatus.innerText = ""), 2000);
      } else {
        alert("‚ùå Error guardando conteo.");
        saveStatus.innerText = "‚ö†Ô∏è No se pudo guardar";
      }
    } catch {
      alert("‚ùå Error conectando con el servidor.");
      saveStatus.innerText = "‚ö†Ô∏è Error de red";
    }
  }

  document.getElementById("saveCountBtn").addEventListener("click", saveManual);
  document.getElementById("saveCountBtnMobile")?.addEventListener("click", saveManual);

  // ===== Exportar =====
  async function exportExcel() {
    const conteos = collectConteos();
    if (conteos.length === 0) return alert("‚ö† Debe ingresar m√≠nimo un conteo para generar discrepancias.");

    try {
      const r = await fetch("/inventory/export-discrepancies", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(conteos)
      });

      const blob = await r.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "discrepancias.xlsx";
      a.click();

      window.URL.revokeObjectURL(url);
    } catch {
      alert("‚ùå Error exportando.");
    }
  }

  document.getElementById("exportBtn").addEventListener("click", exportExcel);
  document.getElementById("exportBtnMobile")?.addEventListener("click", exportExcel);

  // ===== Dictado continuo =====
  let recognition = null;
  let listening = false;
  let pendingCode = null;

  function initRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("‚ùå Dictado no compatible. Usa Chrome en Android.");
      return null;
    }

    const rec = new SpeechRecognition();
    rec.lang = "es-PE";
    rec.continuous = true;
    rec.interimResults = true;
    rec.maxAlternatives = 1;
    return rec;
  }

  function buildCodeMap() {
    const map = new Map();
    document.querySelectorAll("#countTable tbody tr").forEach(row => {
      const raw = row.dataset.code;
      const key = normalizeDigits(raw);
      if (key) map.set(key, row);
    });
    return map;
  }

  const codeMap = buildCodeMap();

  function setRowValue(row, cantidad) {
    if (!row) return false;
    const input = row.querySelector(".count-input");
    if (!input) return false;

    setActiveRow(row);
    input.value = String(cantidad);
    input.dispatchEvent(new Event("input", { bubbles: true }));
    lastRow = row;

    speak("registrado");
    return true;
  }

  function parseNumbers(texto) {
    const nums = (texto.match(/\d+/g) || []).map(n => n.trim()).filter(Boolean);
    return nums;
  }

  function procesarTexto(texto) {
    const nums = parseNumbers(texto);
    if (nums.length === 0) return;

    // Si qued√≥ un c√≥digo pendiente, el primer n√∫mero es la cantidad
    if (pendingCode) {
      const row = codeMap.get(normalizeDigits(pendingCode));
      const ok = setRowValue(row, nums[0]);
      if (ok) {
        voiceStatus.innerText = `‚úÖ ${pendingCode} ‚Üí ${nums[0]} (registrado)`;
        scheduleAutosave();
      } else {
        voiceStatus.innerText = `‚ö†Ô∏è C√≥digo no encontrado: ${pendingCode}`;
      }
      pendingCode = null;
      nums.shift();
      if (nums.length === 0) return;
    }

    // Si solo dictan 1 n√∫mero y hay fila activa, lo ponemos ah√≠
    if (nums.length === 1) {
      const target = activeRow || lastRow;
      if (target) {
        setRowValue(target, nums[0]);
        voiceStatus.innerText = `‚úÖ ${target.dataset.code} ‚Üí ${nums[0]} (registrado)`;
        scheduleAutosave();
      } else {
        voiceStatus.innerText = "‚ÑπÔ∏è Toca una fila o dicta: C√ìDIGO + CANTIDAD";
      }
      return;
    }

    // M√∫ltiples n√∫meros: interpretamos como pares (c√≥digo,cantidad)
    // Si hay impar: el √∫ltimo queda como pendingCode
    for (let i = 0; i < nums.length; i += 2) {
      const code = nums[i];
      const qty = nums[i + 1];

      if (qty === undefined) {
        pendingCode = code;
        voiceStatus.innerText = `‚åõ C√≥digo ${code} listo‚Ä¶ di la cantidad`;
        break;
      }

      const row = codeMap.get(normalizeDigits(code));
      if (row) {
        setRowValue(row, qty);
        voiceStatus.innerText = `‚úÖ ${code} ‚Üí ${qty} (registrado)`;
      } else {
        voiceStatus.innerText = `‚ö†Ô∏è No encuentro el c√≥digo: ${code}`;
      }
    }

    scheduleAutosave();
  }

  function startDictation() {
    if (listening) return;
    if (!recognition) recognition = initRecognition();
    if (!recognition) return;

    recognition.onstart = () => {
      listening = true;
      voiceStatus.innerText = "üéôÔ∏è Dictado activo (continuo)‚Ä¶";
    };

    recognition.onend = () => {
      listening = false;
      if (dictationWanted) {
        try { recognition.start(); } catch {}
      } else {
        voiceStatus.innerText = "‚èπÔ∏è Dictado detenido";
      }
    };

    recognition.onerror = (e) => {
      const msg =
        e.error === "not-allowed" ? "‚ö†Ô∏è Permiso de micr√≥fono bloqueado" :
        e.error === "network" ? "‚ö†Ô∏è Error network: revisa internet/HTTPS" :
        "‚ö†Ô∏è Error de dictado: " + e.error;

      voiceStatus.innerText = msg;
      listening = false;
    };

    recognition.onresult = (event) => {
      let finalText = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        if (res.isFinal) finalText += (res[0]?.transcript || "") + " ";
      }
      finalText = finalText.trim().toLowerCase();
      if (finalText) procesarTexto(finalText);
    };

    try { recognition.start(); } catch {}
  }

  function stopDictation() {
    dictationWanted = false;
    try { recognition?.stop(); } catch {}
    listening = false;
    voiceStatus.innerText = "‚èπÔ∏è Dictado detenido";
  }

  let dictationWanted = false;

  function toggleDictation() {
    dictationWanted = !dictationWanted;
    if (dictationWanted) {
      startDictation();
      btnText("Detener dictado", true);
    } else {
      stopDictation();
      btnText("Dictado", false);
    }
  }

  function btnText(label, active) {
    const main = document.getElementById("voiceBtn");
    const mob = document.getElementById("voiceBtnMobile");
    if (main) {
      main.classList.toggle("btn-danger", !active);
      main.classList.toggle("btn-outline-danger", active);
      main.innerHTML = active
        ? `<i class="bi bi-mic-mute-fill me-2"></i>${label}`
        : `<i class="bi bi-mic-fill me-2"></i>${label}`;
    }
    if (mob) {
      mob.classList.toggle("btn-danger", !active);
      mob.classList.toggle("btn-outline-danger", active);
      mob.innerHTML = active
        ? `<i class="bi bi-mic-mute-fill me-2"></i>${label}`
        : `<i class="bi bi-mic-fill me-2"></i>${label}`;
    }
  }

  document.getElementById("voiceBtn").addEventListener("click", toggleDictation);
  document.getElementById("voiceBtnMobile")?.addEventListener("click", toggleDictation);

  // ===== PWA install prompt =====
  let deferredPrompt = null;
  const pwaBtn = document.getElementById("pwaInstallBtn");

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    pwaBtn.classList.remove("d-none");
  });

  pwaBtn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice.catch(() => null);
    deferredPrompt = null;
    pwaBtn.classList.add("d-none");
  });

  // Service worker (si existe en tu proyecto)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(() => {});
    });
  }

</script>

{% endblock %}




