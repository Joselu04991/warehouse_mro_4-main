{% extends "base.html" %}
{% block content %}

<style>
  .gloves * {
    font-size: 1.2rem !important;
  }
  .gloves input.form-control {
    height: 56px;
    font-size: 1.3rem !important;
  }
  .gloves .btn {
    padding: 0.9rem 1.2rem !important;
  }
  .row-saving {
    outline: 2px dashed rgba(25,135,84,.35);
    border-radius: 10px;
  }
</style>

<div id="pageRoot" class="container">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="fw-bold mb-0">Conteo</h2>
      <div class="text-muted small">Dictado por voz + guardado autom√°tico</div>
    </div>

    <div class="d-flex gap-2">
      <button id="btnGloves" class="btn btn-outline-dark">
        <i class="bi bi-hand-index-thumb me-2"></i> Guantes
      </button>
      <button id="btnVoice" class="btn btn-outline-primary">
        <i class="bi bi-mic me-2"></i> Dictado
      </button>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body d-flex gap-4 align-items-center">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleContinuous" checked>
        <label class="form-check-label fw-semibold">Dictado continuo</label>
      </div>

      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleSpeak" checked>
        <label class="form-check-label fw-semibold">Confirmaci√≥n por voz</label>
      </div>

      <div class="ms-auto text-muted small" id="voiceStatus">
        <i class="bi bi-mic me-1"></i> Micr√≥fono listo
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>C√≥digo</th>
            <th>Descripci√≥n</th>
            <th>UM</th>
            <th>Ubicaci√≥n</th>
            <th>Stock sistema</th>
            <th style="width:160px;">Conteo</th>
          </tr>
        </thead>

        <tbody>
          {% for i in items %}
          <tr data-code="{{ i.material_code }}">
            <td class="fw-semibold">{{ i.material_code }}</td>
            <td class="text-muted small">{{ i.material_text or "‚Äî" }}</td>
            <td class="text-center fw-semibold">{{ i.base_unit or "‚Äî" }}</td>
            <td class="text-center fw-semibold">{{ i.location }}</td>
            <td class="text-center fw-semibold">{{ i.stock_sistema }}</td>

            <td>
              <input class="form-control text-center count-input"
                     type="number"
                     min="0"
                     value="{{ i.real_count }}"
                     data-code="{{ i.material_code }}"
                     data-loc="{{ i.location }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
(() => {

  const root = document.getElementById("pageRoot");
  const btnGloves = document.getElementById("btnGloves");
  const btnVoice = document.getElementById("btnVoice");
  const toggleContinuous = document.getElementById("toggleContinuous");
  const toggleSpeak = document.getElementById("toggleSpeak");
  const voiceStatus = document.getElementById("voiceStatus");

  /* ======================
     MODO GUANTES
  ====================== */
  const glovesKey = "mro_gloves";
  const setGloves = (on) => {
    root.classList.toggle("gloves", on);
    localStorage.setItem(glovesKey, on ? "1" : "0");
  };
  setGloves(localStorage.getItem(glovesKey) === "1");
  btnGloves.onclick = () =>
    setGloves(!root.classList.contains("gloves"));

  /* ======================
     GUARDAR FILA
  ====================== */
  const saveRow = async (input) => {
    const tr = input.closest("tr");
    tr.classList.add("row-saving");

    await fetch("{{ url_for('inventory.save_count_row') }}", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        material_code: input.dataset.code,
        location: input.dataset.loc,
        real_count: parseFloat(input.value || 0)
      })
    });

    tr.classList.remove("row-saving");
    if (toggleSpeak.checked) speak("registrado");
  };

  document.querySelectorAll(".count-input").forEach(inp => {
    let t;
    inp.oninput = () => {
      clearTimeout(t);
      t = setTimeout(() => saveRow(inp), 400);
    };
  });

  /* ======================
     VOZ
  ====================== */
  const speak = (txt) => {
    try {
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = "es-PE";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch {}
  };

  let recognition = null;
  let listening = false;
  let manualStop = false;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  const findInput = (code) =>
    document.querySelector(`.count-input[data-code="${code}"]`);

  const startVoice = () => {
    if (!SR) {
      alert("Navegador no soporta dictado");
      return;
    }

    recognition = new SR();
    recognition.lang = "es-PE";
    recognition.continuous = true;

    manualStop = false;

    recognition.onresult = (e) => {
      const text = e.results[e.results.length - 1][0].transcript;
      const nums = text.match(/\d+/g) || [];

      const code = nums.find(n => n.length >= 8);
      const qty  = nums.find(n => n.length <= 3);

      if (!code || !qty) return;

      const input = findInput(code);
      if (!input) return;

      input.value = qty;
      saveRow(input);
    };

    recognition.onend = () => {
      listening = false;
      if (!manualStop && toggleContinuous.checked) {
        setTimeout(() => recognition.start(), 300);
        listening = true;
      }
    };

    recognition.start();
    listening = true;
    btnVoice.classList.add("btn-primary");
    voiceStatus.innerHTML = "üéôÔ∏è Escuchando...";
  };

  const stopVoice = () => {
    manualStop = true;
    recognition && recognition.stop();
    listening = false;
    btnVoice.classList.remove("btn-primary");
    voiceStatus.innerHTML = "üé§ Dictado detenido";
  };

  btnVoice.onclick = () => {
    listening ? stopVoice() : startVoice();
  };

})();
</script>

{% endblock %}
