{% extends "base.html" %}
{% block content %}

<style>
  .count-wrap { max-width: 1200px; margin: 0 auto; }
  .btn-big { padding: 14px 18px; font-size: 1.05rem; border-radius: 14px; }
  .gloves .count-input { height: 58px; font-size: 1.35rem; border-radius: 14px; }
  .gloves td, .gloves th { padding-top: 18px !important; padding-bottom: 18px !important; }
  .sticky-head thead th { position: sticky; top: 0; z-index: 5; }
  .row-hit { outline: 3px solid rgba(13,110,253,.35); border-radius: 10px; }
  .mini { font-size:.92rem; }
  @media (max-width: 768px){
    .toolbar { flex-direction: column; gap: 10px; align-items: stretch !important; }
    .toolbar .form-control { width: 100% !important; }
    .toolbar .btns { display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; }
    .btn-big { width: 100%; }
  }
</style>

<div class="count-wrap">

  <h2 class="fw-bold mb-3">
    <i class="bi bi-clipboard-data me-2"></i> Conteo de Inventario
  </h2>

  <div class="card shadow-sm p-3 p-md-4">

    <div class="d-flex justify-content-between align-items-center mb-3 toolbar">
      <input type="text" id="searchCount"
             class="form-control w-50 shadow-sm"
             placeholder="üîç Buscar material, texto o ubicaci√≥n‚Ä¶">

      <div class="btns">
        <button id="exportBtn" class="btn btn-primary btn-big shadow-sm">
          <i class="bi bi-file-earmark-excel me-2"></i>Exportar Discrepancias
        </button>

        <button id="saveCountBtn" class="btn btn-success btn-big shadow-sm">
          <i class="bi bi-cloud-check me-2"></i>Guardar Conteo
        </button>

        <button id="voiceBtn" class="btn btn-danger btn-big shadow-sm">
          <i class="bi bi-mic-fill me-2"></i>Dictado (Android)
        </button>

        <button id="glovesBtn" class="btn btn-dark btn-big shadow-sm">
          <i class="bi bi-hand-index-thumb me-2"></i>Modo guantes
        </button>
      </div>
    </div>

    <div class="d-flex align-items-center gap-2 mb-3">
      <span class="badge text-bg-secondary">Estado</span>
      <span id="voiceStatus" class="text-muted mini">Listo</span>
      <span class="text-muted mini">Tip: di ‚Äú100 40 568 cantidad 12‚Äù o ‚Äú100 40 568 12‚Äù.</span>
    </div>

    <div class="table-responsive sticky-head" id="tableContainer">
      <table class="table table-hover align-middle" id="countTable">
        <thead class="table-dark text-center">
          <tr>
            <th>C√≥digo</th>
            <th>Descripci√≥n</th>
            <th>Ubicaci√≥n</th>
            <th>Stock Sistema</th>
            <th>Conteo Real</th>
          </tr>
        </thead>

        <tbody>
          {% for i in items %}
          <tr data-code="{{ i.material_code }}" data-loc="{{ i.location }}">
            <td><strong>{{ i.material_code }}</strong></td>
            <td>{{ i.material_text }}</td>
            <td class="text-primary fw-bold">{{ i.location }}</td>
            <td class="text-center">{{ i.libre_utilizacion }}</td>

            <td class="text-center" style="width: 190px;">
              <input type="number" min="0"
                     class="form-control count-input shadow-sm text-center"
                     placeholder="0"
                     inputmode="numeric">
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

  </div>
</div>

<script>
/* ===================== BUSCADOR ===================== */
document.getElementById("searchCount").addEventListener("input", function () {
  const filter = this.value.toLowerCase();
  document.querySelectorAll("#countTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});

/* ===================== UI INPUTS ===================== */
function paintInput(input){
  input.style.backgroundColor = input.value.trim() === "" ? "#ffe5e5" : "#e6ffe6";
  input.closest("tr").style.backgroundColor = "#f7fff0";
}

document.querySelectorAll(".count-input").forEach(input => {
  input.addEventListener("input", () => paintInput(input));
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const inputs = [...document.querySelectorAll(".count-input")];
      const idx = inputs.indexOf(input);
      if (inputs[idx + 1]) inputs[idx + 1].focus();
    }
  });
});

/* ===================== GUARDAR ===================== */
document.getElementById("saveCountBtn").addEventListener("click", () => {
  const conteos = [];
  document.querySelectorAll("#countTable tbody tr").forEach(row => {
    const material_code = row.dataset.code;
    const location = row.dataset.loc;
    const input = row.querySelector(".count-input").value.trim();
    if (input !== "") conteos.push({ material_code, location, real_count: Number(input) });
  });

  if (!conteos.length) return alert("‚ö† Debe ingresar al menos un valor de conteo.");

  fetch("/inventory/save-count", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(conteos)
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) alert("‚úÖ Conteo guardado correctamente.");
    else alert("‚ùå Error guardando conteo.");
  })
  .catch(() => alert("‚ùå Error conectando con el servidor."));
});

/* ===================== EXPORTAR ===================== */
document.getElementById("exportBtn").addEventListener("click", () => {
  const conteos = [];
  document.querySelectorAll("#countTable tbody tr").forEach(row => {
    const material_code = row.dataset.code;
    const location = row.dataset.loc;
    const input = row.querySelector(".count-input").value.trim();
    if (input !== "") conteos.push({ material_code, location, real_count: Number(input) });
  });

  if (!conteos.length) return alert("‚ö† Debe ingresar m√≠nimo un conteo para generar discrepancias.");

  fetch("/inventory/export-discrepancies", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(conteos)
  })
  .then(r => r.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "discrepancias.xlsx";
    a.click();
    window.URL.revokeObjectURL(url);
  });
});

/* ===================== MODO GUANTES ===================== */
const glovesBtn = document.getElementById("glovesBtn");
const container = document.querySelector(".count-wrap");
let glovesOn = false;

glovesBtn.addEventListener("click", () => {
  glovesOn = !glovesOn;
  document.body.classList.toggle("gloves", glovesOn);
});

/* ===================== VOZ ANDROID (FIX) ===================== */
let recognition = null;
let listening = false;
let lastRow = null;

const voiceBtn = document.getElementById("voiceBtn");
const voiceStatus = document.getElementById("voiceStatus");

const CODE_SET = new Set([...document.querySelectorAll("#countTable tbody tr")].map(r => String(r.dataset.code)));
const CODE_TO_ROW = new Map([...document.querySelectorAll("#countTable tbody tr")].map(r => [String(r.dataset.code), r]));

function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-PE";
    window.speechSynthesis.speak(u);
  } catch(e){}
}

function getSpeechRecognition(){
  return window.SpeechRecognition || window.webkitSpeechRecognition || null;
}

function parseNums(text){
  const m = text.match(/\d+/g);
  return m ? m.map(x => String(x)) : [];
}

function findBestCode(nums){
  // intenta armar c√≥digo juntando 2..6 grupos (para casos 100 40 568 => 10040568)
  // y deja el √∫ltimo como cantidad si sobra
  for (let k = Math.min(6, nums.length); k >= 2; k--){
    const code = nums.slice(0, k).join("");
    if (CODE_SET.has(code)){
      const rest = nums.slice(k);
      const qty = rest.length ? rest[rest.length - 1] : null;
      return { code, qty };
    }
  }
  // fallback: primer num como c√≥digo exacto
  if (CODE_SET.has(nums[0])) {
    const qty = nums.length >= 2 ? nums[1] : null;
    return { code: nums[0], qty };
  }
  return { code: null, qty: null };
}

function applyCount(code, qty){
  if (!code) return false;
  const row = CODE_TO_ROW.get(code);
  if (!row) return false;

  const input = row.querySelector(".count-input");
  if (!input) return false;

  if (qty != null){
    input.value = qty;
    input.dispatchEvent(new Event("input"));
    lastRow = row;

    row.classList.add("row-hit");
    setTimeout(() => row.classList.remove("row-hit"), 900);

    input.focus({preventScroll:false});
    input.scrollIntoView({behavior:"smooth", block:"center"});

    speak("registrado");
    return true;
  }

  // si no vino qty, solo selecciona fila como "√∫ltima"
  lastRow = row;
  row.classList.add("row-hit");
  setTimeout(() => row.classList.remove("row-hit"), 900);
  speak("c√≥digo detectado");
  return true;
}

function applyQtyOnly(qty){
  if (!lastRow) return false;
  const input = lastRow.querySelector(".count-input");
  if (!input) return false;
  input.value = qty;
  input.dispatchEvent(new Event("input"));
  speak("registrado");
  return true;
}

function startListening(){
  const SR = getSpeechRecognition();
  if (!SR){
    alert("‚ùå Dictado no compatible. Usa Chrome en Android y en HTTPS.");
    return;
  }

  recognition = new SR();
  recognition.lang = "es-PE";
  recognition.interimResults = false;

  // Android suele ignorar continuous=true, entonces reiniciamos en onend
  recognition.continuous = true;

  recognition.onstart = () => {
    listening = true;
    voiceStatus.innerText = "üéôÔ∏è Escuchando...";
    voiceBtn.classList.add("disabled");
  };

  recognition.onerror = (e) => {
    // "network" pasa cuando Google Speech no responde o no hay permisos / conexi√≥n
    voiceStatus.innerText = (e.error === "network")
      ? "‚ö†Ô∏è error network (conexi√≥n/servicio). Intenta con datos o reintenta."
      : `‚ö†Ô∏è error: ${e.error}`;
    listening = false;
    voiceBtn.classList.remove("disabled");
  };

  recognition.onresult = (event) => {
    const text = event.results?.[0]?.[0]?.transcript ? event.results[0][0].transcript.toLowerCase().trim() : "";
    if (!text) return;

    const nums = parseNums(text);
    if (!nums.length) return;

    // caso: "cantidad 12" / "doce" -> solo n√∫meros (si vino 1 num, qty-only)
    if (nums.length === 1) {
      if (!applyQtyOnly(nums[0])) {
        voiceStatus.innerText = "‚ö†Ô∏è No hay c√≥digo previo para asignar cantidad.";
      }
      return;
    }

    const best = findBestCode(nums);
    if (best.code){
      // si qty viene null, intenta usar el √∫ltimo como qty
      const qty = best.qty ?? nums[nums.length - 1];
      const ok = applyCount(best.code, qty);
      if (!ok) voiceStatus.innerText = "‚ö†Ô∏è C√≥digo no encontrado en la tabla.";
      return;
    }

    voiceStatus.innerText = "‚ö†Ô∏è No pude reconocer el c√≥digo. Di el c√≥digo m√°s claro.";
  };

  recognition.onend = () => {
    // reinicio autom√°tico si seguimos ‚Äúen modo dictado‚Äù
    if (listening){
      try { recognition.start(); } catch(e){}
      return;
    }
    voiceStatus.innerText = "‚èπÔ∏è Detenido";
    voiceBtn.classList.remove("disabled");
  };

  try{
    recognition.start();
  } catch(e){
    voiceStatus.innerText = "‚ö†Ô∏è No pude iniciar micr√≥fono. Revisa permisos.";
    listening = false;
    voiceBtn.classList.remove("disabled");
  }
}

function stopListening(){
  listening = false;
  try{ recognition && recognition.stop(); } catch(e){}
  voiceBtn.classList.remove("disabled");
}

voiceBtn.addEventListener("click", () => {
  if (!listening) startListening();
  else stopListening();
});
</script>

{% endblock %}
