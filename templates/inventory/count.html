{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-4">
    <i class="bi bi-clipboard-data me-2"></i> Conteo de Inventario
</h2>

<div class="card shadow-sm p-4">

    <!-- ========================== BUSCADOR + BOTONES ========================== -->
    <div class="d-flex justify-content-between align-items-center mb-3">

        <input type="text" id="searchCount"
               class="form-control w-50 shadow-sm"
               placeholder="üîç Buscar material, texto o ubicaci√≥n‚Ä¶">

        <div>
            <!-- üìå Exportar discrepancias autom√°ticamente -->
            <button id="exportBtn" class="btn btn-primary btn-lg shadow-sm me-2">
                <i class="bi bi-file-earmark-excel me-2"></i>
                Exportar Discrepancias
            </button>

            <!-- üìå Guardar conteo -->
            <button id="saveCountBtn" class="btn btn-success btn-lg shadow-sm">
                <i class="bi bi-cloud-check me-2"></i>
                Guardar Conteo
            </button>

            <button id="voiceBtn" class="btn btn-danger btn-lg shadow-sm">
                üéôÔ∏è Dictar conteo
            </button>
            <span id="voiceStatus" class="ms-3 text-muted"></span>
        </div>

    </div>
    <!-- ========================== TABLA ========================== -->
    <div class="table-responsive">
        <table class="table table-hover align-middle" id="countTable">
            <thead class="table-dark text-center">
                <tr>
                    <th>C√≥digo</th>
                    <th>Descripci√≥n</th>
                    <th>Ubicaci√≥n</th>
                    <th>Stock Sistema</th>
                    <th>Conteo Real</th>
                </tr>
            </thead>

            <tbody>
                {% for i in items %}
                <tr data-code="{{ i.material_code }}" data-loc="{{ i.location }}">
                    <td><strong>{{ i.material_code }}</strong></td>
                    <td>{{ i.material_text }}</td>
                    <td class="text-primary fw-bold">{{ i.location }}</td>
                    <td class="text-center">{{ i.libre_utilizacion }}</td>

                    <td class="text-center" style="width: 180px;">
                        <input type="number"
                               min="0"
                               class="form-control count-input shadow-sm text-center"
                               placeholder="0">
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

</div>

<!-- ========================== SCRIPTS ========================== -->
<script>
/* ==================================================
   üîç B√öSQUEDA EN TIEMPO REAL
   ================================================== */
document.getElementById("searchCount").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
});


/* ==================================================
   üé® EFECTOS EN INPUTS (colores y navegaci√≥n)
   ================================================== */
document.querySelectorAll(".count-input").forEach(input => {

    // Fondo seg√∫n si est√° vac√≠o o lleno
    input.addEventListener("input", () => {
        input.style.backgroundColor = input.value.trim() === ""
            ? "#ffe5e5"
            : "#e6ffe6";

        // Resaltar fila modificada
        input.closest("tr").style.backgroundColor = "#f7fff0";
    });

    // ENTER ‚Üí ir al siguiente input
    input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            const inputs = [...document.querySelectorAll(".count-input")];
            const idx = inputs.indexOf(input);
            if (inputs[idx + 1]) inputs[idx + 1].focus();
        }
    });

});


/* ==================================================
   üìù GUARDAR CONTEO (YA FUNCIONA CON TU BACKEND)
   ================================================== */
document.getElementById("saveCountBtn").addEventListener("click", () => {

    const conteos = [];

    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        const material_code = row.dataset.code;
        const location = row.dataset.loc;
        const input = row.querySelector(".count-input").value.trim();

        if (input !== "") {
            conteos.push({
                material_code,
                location,
                real_count: Number(input)
            });
        }
    });

    if (conteos.length === 0) {
        return alert("‚ö† Debe ingresar al menos un valor de conteo.");
    }

    fetch("/inventory/save-count", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(conteos)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {

            alert("‚úÖ Conteo guardado correctamente.");

            document.querySelectorAll(".count-input").forEach(i => {
                i.style.backgroundColor = "white";
            });

        } else {
            alert("‚ùå Error guardando conteo.");
        }
    })
    .catch(err => {
        alert("‚ùå Error conectando con el servidor.");
    });
});


/* ==================================================
   üìå EXPORTAR DISCREPANCIAS DIRECTO A EXCEL (sin archivo)
   ================================================== */
document.getElementById("exportBtn").addEventListener("click", () => {

    const conteos = [];

    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        const material_code = row.dataset.code;
        const location = row.dataset.loc;
        const input = row.querySelector(".count-input").value.trim();

        if (input !== "") {
            conteos.push({
                material_code,
                location,
                real_count: Number(input)
            });
        }
    });

    if (conteos.length === 0) {
        return alert("‚ö† Debe ingresar m√≠nimo un conteo para generar discrepancias.");
    }

    fetch("/inventory/export-discrepancies", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(conteos)
    })
    .then(r => r.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "discrepancias.xlsx";
        a.click();

        window.URL.revokeObjectURL(url);
    });
});
</script>
<script>
let recognition = null;
let lastRow = null;
let listening = false;

const btn = document.getElementById("voiceBtn");
const status = document.getElementById("voiceStatus");

function initRecognition() {
    const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
        alert("‚ùå Dictado no compatible con este navegador. Usa Chrome en Android.");
        return null;
    }

    const rec = new SpeechRecognition();
    rec.lang = "es-PE";
    rec.continuous = false;
    rec.interimResults = false;
    return rec;
}

btn.addEventListener("click", () => {

    if (listening) return;

    recognition = initRecognition();
    if (!recognition) return;

    recognition.onstart = () => {
        listening = true;
        status.innerText = "üéôÔ∏è Hablando‚Ä¶";
        btn.disabled = true;
    };

    recognition.onend = () => {
        listening = false;
        status.innerText = "‚èπÔ∏è Listo";
        btn.disabled = false;
    };

    recognition.onerror = (e) => {
        console.warn("Speech error:", e.error);
        status.innerText = "‚ö†Ô∏è Error de micr√≥fono";
        listening = false;
        btn.disabled = false;
    };

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript.toLowerCase().trim();
        console.log("Dictado:", text);
        procesarTexto(text);
    };

    recognition.start();
});

function procesarTexto(texto) {

    const numeros = texto.match(/\d+/g);
    if (!numeros) return;

    const rows = document.querySelectorAll("#countTable tbody tr");

    // Caso: "codigo cantidad" ‚Üí 123 40
    if (numeros.length >= 2) {
        const codigo = numeros[0];
        const cantidad = numeros[1];

        rows.forEach(row => {
            if (row.dataset.code === codigo) {
                const input = row.querySelector(".count-input");
                input.value = cantidad;
                input.dispatchEvent(new Event("input"));
                lastRow = row;
            }
        });
        return;
    }

    // Caso: solo cantidad ‚Üí 40
    if (numeros.length === 1 && lastRow) {
        const input = lastRow.querySelector(".count-input");
        input.value = numeros[0];
        input.dispatchEvent(new Event("input"));
    }
}
</script>
{% endblock %}



