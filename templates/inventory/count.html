{% extends "base.html" %}
{% block content %}

<style>
  .gloves * { font-size: 1.15rem !important; }
  .gloves .btn { padding: 0.9rem 1.1rem !important; }
  .gloves input.form-control { height: 52px; font-size: 1.2rem !important; }
  .sticky-tools { position: sticky; top: 10px; z-index: 10; }
  .row-saving { outline: 2px dashed rgba(25,135,84,.35); border-radius: 10px; }
</style>

<div id="pageRoot" class="container">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center">
      <i class="bi bi-clipboard-check fs-2 me-3 text-success"></i>
      <div>
        <h2 class="fw-bold mb-0">Conteo</h2>
        <div class="text-muted small">Dictado + guardado autom√°tico por fila</div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button id="btnGloves" class="btn btn-outline-dark">
        <i class="bi bi-hand-index-thumb me-2"></i> Guantes
      </button>
      <button id="btnVoice" class="btn btn-outline-primary">
        <i class="bi bi-mic me-2"></i> Dictado
      </button>
    </div>
  </div>

  <div class="card shadow-sm mb-3 sticky-tools">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleContinuous" checked>
        <label class="form-check-label fw-semibold" for="toggleContinuous">Dictado continuo</label>
      </div>

      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleSpeak" checked>
        <label class="form-check-label fw-semibold" for="toggleSpeak">Confirmaci√≥n por voz (‚Äúregistrado‚Äù)</label>
      </div>

      <div class="ms-auto text-muted small" id="voiceStatus">
        <i class="bi bi-info-circle me-1"></i> Micr√≥fono: listo
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>C√≥digo</th>
            <th>Descripci√≥n</th>
            <th>UM</th>
            <th>Ubicaci√≥n</th>
            <th>Stock</th>
            <th style="width: 170px;">Conteo</th>
            <th style="width: 130px;">Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for i in items %}
          <tr data-code="{{ i.material_code }}" data-loc="{{ i.location }}">
            <td class="fw-semibold">{{ i.material_code }}</td>
            <td class="text-muted small">{{ i.material_text }}</td>
            <td class="text-center">{{ i.base_unit }}</td>
            <td class="text-center fw-semibold">{{ i.location }}</td>
            <td class="text-center fw-semibold">{{ i.stock }}</td>

            <td>
              <input class="form-control text-center count-input"
                     inputmode="numeric"
                     pattern="[0-9]*"
                     placeholder="0"
                     value="{{ i.real_count }}"
                     data-code="{{ i.material_code }}"
                     data-loc="{{ i.location }}">
            </td>

            <td class="text-center">
              <span class="badge
              {% if i.estado == 'OK' %}bg-success
              {% elif i.estado == 'Diferencia' %}bg-warning
              {% else %}bg-secondary{% endif %}
            ">
              {{ i.estado }}
            </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button id="btnSaveAll" class="btn btn-success">
          <i class="bi bi-cloud-check me-2"></i> Guardar todo
        </button>
        <a href="{{ url_for('inventory.download_discrepancies_excel') }}"
           class="btn btn-outline-danger">
          <i class="bi bi-file-earmark-excel me-2"></i>
          Descargar discrepancias
        </a>
      </div>
    </div>
  </div>

</div>

<script>
(() => {

  const root = document.getElementById("pageRoot");
  const btnGloves = document.getElementById("btnGloves");
  const btnVoice = document.getElementById("btnVoice");
  const toggleContinuous = document.getElementById("toggleContinuous");
  const toggleSpeak = document.getElementById("toggleSpeak");
  const voiceStatus = document.getElementById("voiceStatus");
  const btnSaveAll = document.getElementById("btnSaveAll");

  /* ======================
     MODO GUANTES
  ====================== */
  const glovesKey = "mro_gloves_mode";
  const setGloves = (on) => {
    root.classList.toggle("gloves", on);
    localStorage.setItem(glovesKey, on ? "1" : "0");
  };
  setGloves(localStorage.getItem(glovesKey) === "1");
  btnGloves.addEventListener("click", () =>
    setGloves(!root.classList.contains("gloves"))
  );

  /* ======================
     VOZ (SPEAK)
  ====================== */
  const speak = (text) => {
    if (!toggleSpeak.checked) return;
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-PE";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch (e) {}
  };

  /* ======================
     GUARDAR FILA
  ====================== */
  const saveRow = async (inputEl) => {
    const code = inputEl.dataset.code;
    const loc = inputEl.dataset.loc;
    const val = parseInt(inputEl.value || "0", 10) || 0;

    const tr = inputEl.closest("tr");
    tr.classList.add("row-saving");

    try {
      const res = await fetch("{{ url_for('inventory.save_count_row') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          material_code: code,
          location: loc,
          real_count: val
        })
      });
      const j = await res.json();
      if (j && j.success) {
        speak("registrado");
      }
    } catch (e) {
      console.error(e);
    } finally {
      tr.classList.remove("row-saving");
    }
  };

  /* ======================
     AUTOSAVE (DEBOUNCE)
  ====================== */
  const timers = new Map();
  document.querySelectorAll(".count-input").forEach(inp => {
    inp.addEventListener("input", () => {
      const key = inp.dataset.code + "|" + inp.dataset.loc;
      clearTimeout(timers.get(key));
      timers.set(key, setTimeout(() => saveRow(inp), 450));
    });
  });

  /* ======================
     BOT√ìN GUARDAR TODO
  ====================== */
  btnSaveAll.addEventListener("click", async () => {
    const data = [];
    document.querySelectorAll(".count-input").forEach(inp => {
      data.push({
        material_code: inp.dataset.code,
        location: inp.dataset.loc,
        real_count: parseInt(inp.value || "0", 10) || 0
      });
    });

    btnSaveAll.disabled = true;

    try {
      const res = await fetch("{{ url_for('inventory.save_count') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      const j = await res.json();
      if (j && j.success) speak("registrado");
    } catch (e) {} finally {
      btnSaveAll.disabled = false;
    }
  });

  /* ======================
     DICTADO POR VOZ (REGLA: C√ìDIGO + CANTIDAD)
  ====================== */
  let rec = null;
  let listening = false;

  const getRecognition = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = "es-PE";
    r.continuous = true;
    r.interimResults = false;
    return r;
  };

  const activeInput = () =>
    document.activeElement &&
    document.activeElement.classList.contains("count-input")
      ? document.activeElement
      : null;

  const setVoiceStatus = (txt, ok = true) => {
    voiceStatus.innerHTML = ok
      ? `<i class="bi bi-mic me-1"></i> ${txt}`
      : `<i class="bi bi-exclamation-triangle me-1"></i> ${txt}`;
  };

  const startVoice = () => {
    if (listening) return;
    rec = getRecognition();
    if (!rec) {
      setVoiceStatus("Tu navegador no soporta dictado", false);
      return;
    }

    rec.onresult = (ev) => {
      const text = ev.results[ev.results.length - 1][0].transcript.toLowerCase();

      // üîë EXTRAER N√öMEROS
      const matches = text.match(/\d+/g) || [];

      // C√≥digo: 8+ d√≠gitos | Cantidad: 1‚Äì3 d√≠gitos
      const codes = matches.filter(n => n.length >= 8);
      const quantities = matches.filter(n => n.length >= 1 && n.length <= 3);

      // OBLIGATORIO: c√≥digo + cantidad
      if (codes.length === 0 || quantities.length === 0) {
        setVoiceStatus("Diga c√≥digo y cantidad", false);
        return;
      }

      // Usar la √öLTIMA cantidad
      const number = quantities[quantities.length - 1];

      const inp = activeInput();
      if (!inp) {
        setVoiceStatus("Toca un campo de conteo", false);
        return;
      }

      inp.value = number;
      inp.dispatchEvent(new Event("input", { bubbles: true }));
      setVoiceStatus(`Registrando: ${number}`);
    };

    rec.onerror = () => {
      setVoiceStatus("Error micr√≥fono", false);
    };

    rec.onend = () => {
      listening = false;
      btnVoice.classList.remove("btn-primary");
      btnVoice.classList.add("btn-outline-primary");
      btnVoice.innerHTML = '<i class="bi bi-mic me-2"></i> Dictado';
      if (toggleContinuous.checked) {
        try { rec.start(); listening = true; } catch(e) {}
      }
    };

    try {
      rec.start();
      listening = true;
      btnVoice.classList.add("btn-primary");
      btnVoice.innerHTML = '<i class="bi bi-mic-fill me-2"></i> Dictando...';
      setVoiceStatus("Dictado activo (c√≥digo + cantidad)");
    } catch (e) {
      setVoiceStatus("No se pudo iniciar micr√≥fono", false);
    }
  };

  const stopVoice = () => {
    try { if (rec) rec.stop(); } catch(e) {}
    listening = false;
    setVoiceStatus("Dictado detenido");
  };

  btnVoice.addEventListener("click", () =>
    listening ? stopVoice() : startVoice()
  );

})();
</script>

{% endblock %}
