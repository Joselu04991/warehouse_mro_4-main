{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-4">
    <i class="bi bi-clipboard-data me-2"></i> Conteo de Inventario
</h2>

<div class="card shadow-sm p-4">

    <!-- ========================== BUSCADOR + BOTONES ========================== -->
    <div class="d-flex justify-content-between align-items-center mb-3">

        <input type="text" id="searchCount"
               class="form-control w-50 shadow-sm"
               placeholder="ðŸ” Buscar material, texto o ubicaciÃ³nâ€¦">

        <div>
            <!-- ðŸ“Œ Exportar discrepancias automÃ¡ticamente -->
            <button id="exportBtn" class="btn btn-primary btn-lg shadow-sm me-2">
                <i class="bi bi-file-earmark-excel me-2"></i>
                Exportar Discrepancias
            </button>

            <!-- ðŸ“Œ Guardar conteo -->
            <button id="saveCountBtn" class="btn btn-success btn-lg shadow-sm">
                <i class="bi bi-cloud-check me-2"></i>
                Guardar Conteo
            </button>

            <button id="voiceBtn" class="btn btn-dark btn-lg shadow-sm">
                <i class="bi bi-mic-fill me-2"></i> Dictar conteo
            </button>
        </div>

    </div>

    <!-- ========================== TABLA ========================== -->
    <div class="table-responsive">
        <table class="table table-hover align-middle" id="countTable">
            <thead class="table-dark text-center">
                <tr>
                    <th>CÃ³digo</th>
                    <th>DescripciÃ³n</th>
                    <th>UbicaciÃ³n</th>
                    <th>Stock Sistema</th>
                    <th>Conteo Real</th>
                </tr>
            </thead>

            <tbody>
                {% for i in items %}
                <tr data-code="{{ i.material_code }}" data-loc="{{ i.location }}">
                    <td><strong>{{ i.material_code }}</strong></td>
                    <td>{{ i.material_text }}</td>
                    <td class="text-primary fw-bold">{{ i.location }}</td>
                    <td class="text-center">{{ i.libre_utilizacion }}</td>

                    <td class="text-center" style="width: 180px;">
                        <input type="number"
                               min="0"
                               class="form-control count-input shadow-sm text-center"
                               placeholder="0">
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

</div>

<!-- ========================== SCRIPTS ========================== -->
<script>
/* ==================================================
   ðŸ” BÃšSQUEDA EN TIEMPO REAL
   ================================================== */
document.getElementById("searchCount").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
});


/* ==================================================
   ðŸŽ¨ EFECTOS EN INPUTS (colores y navegaciÃ³n)
   ================================================== */
document.querySelectorAll(".count-input").forEach(input => {

    // Fondo segÃºn si estÃ¡ vacÃ­o o lleno
    input.addEventListener("input", () => {
        input.style.backgroundColor = input.value.trim() === ""
            ? "#ffe5e5"
            : "#e6ffe6";

        // Resaltar fila modificada
        input.closest("tr").style.backgroundColor = "#f7fff0";
    });

    // ENTER â†’ ir al siguiente input
    input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            const inputs = [...document.querySelectorAll(".count-input")];
            const idx = inputs.indexOf(input);
            if (inputs[idx + 1]) inputs[idx + 1].focus();
        }
    });

});


/* ==================================================
   ðŸ“ GUARDAR CONTEO (YA FUNCIONA CON TU BACKEND)
   ================================================== */
document.getElementById("saveCountBtn").addEventListener("click", () => {

    const conteos = [];

    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        const material_code = row.dataset.code;
        const location = row.dataset.loc;
        const input = row.querySelector(".count-input").value.trim();

        if (input !== "") {
            conteos.push({
                material_code,
                location,
                real_count: Number(input)
            });
        }
    });

    if (conteos.length === 0) {
        return alert("âš  Debe ingresar al menos un valor de conteo.");
    }

    fetch("/inventory/save-count", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(conteos)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {

            alert("âœ… Conteo guardado correctamente.");

            document.querySelectorAll(".count-input").forEach(i => {
                i.style.backgroundColor = "white";
            });

        } else {
            alert("âŒ Error guardando conteo.");
        }
    })
    .catch(err => {
        alert("âŒ Error conectando con el servidor.");
    });
});


/* ==================================================
   ðŸ“Œ EXPORTAR DISCREPANCIAS DIRECTO A EXCEL (sin archivo)
   ================================================== */
document.getElementById("exportBtn").addEventListener("click", () => {

    const conteos = [];

    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        const material_code = row.dataset.code;
        const location = row.dataset.loc;
        const input = row.querySelector(".count-input").value.trim();

        if (input !== "") {
            conteos.push({
                material_code,
                location,
                real_count: Number(input)
            });
        }
    });

    if (conteos.length === 0) {
        return alert("âš  Debe ingresar mÃ­nimo un conteo para generar discrepancias.");
    }

    fetch("/inventory/export-discrepancies", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(conteos)
    })
    .then(r => r.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "discrepancias.xlsx";
        a.click();

        window.URL.revokeObjectURL(url);
    });
});
</script>
<script>
let recognition;
let listening = false;

if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "es-PE";
    recognition.continuous = true;
    recognition.interimResults = false;
} else {
    alert("Tu navegador no soporta dictado por voz");
}

document.getElementById("voiceBtn").addEventListener("click", () => {
    if (!recognition) return;

    if (!listening) {
        recognition.start();
        listening = true;
        document.getElementById("voiceBtn").classList.add("btn-danger");
    } else {
        recognition.stop();
        listening = false;
        document.getElementById("voiceBtn").classList.remove("btn-danger");
    }
});

recognition.onresult = function(event) {
    const texto = event.results[event.results.length - 1][0].transcript.toLowerCase();
    console.log("ðŸŽ¤ Voz:", texto);

    // Ejemplo esperado: "codigo a123 cantidad 15"
    const match = texto.match(/codigo\s+([a-z0-9]+).*?(\d+)/i);

    if (!match) return;

    const codigo = match[1].toUpperCase();
    const cantidad = parseInt(match[2]);

    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        if (row.dataset.code === codigo) {
            const input = row.querySelector(".count-input");
            input.value = cantidad;
            input.style.backgroundColor = "#e6ffe6";
            row.style.backgroundColor = "#f7fff0";
        }
    });
};

recognition.onerror = e => console.error("ðŸŽ¤ Error voz:", e);
</script>
{% endblock %}
