{% extends "base.html" %}
{% block content %}

<style>
  .row-saving { outline: 2px dashed rgba(25,135,84,.35); border-radius: 10px; }
</style>

<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="fw-bold mb-0">Conteo</h2>
      <div class="text-muted small">Dictado por voz + guardado automático</div>
    </div>
    <button id="btnVoice" class="btn btn-outline-primary">
      <i class="bi bi-mic me-2"></i> Dictado
    </button>
  </div>

  <div class="card shadow-sm">
    <div class="card-body table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>Código</th>
            <th>Descripción</th>
            <th>UM</th>
            <th>Ubicación</th>
            <th>Stock sistema</th>
            <th style="width:150px;">Conteo</th>
          </tr>
        </thead>

        <tbody>
          {% for i in items %}
          <tr>
            <td class="fw-semibold">{{ i.material_code }}</td>

            <td class="text-muted small">
              {{ i.material_text or "—" }}
            </td>

            <!-- UNIDAD DE MEDIDA -->
            <td class="text-center fw-semibold">
              {{ i.base_unit or "—" }}
            </td>

            <td class="text-center fw-semibold">
              {{ i.location }}
            </td>

            <!-- STOCK DEL SISTEMA -->
            <td class="text-center fw-semibold">
              {{ i.stock_sistema }}
            </td>

            <!-- CONTEO FÍSICO -->
            <td>
              <input class="form-control text-center count-input"
                     type="number"
                     min="0"
                     value="{{ i.real_count }}"
                     data-code="{{ i.material_code }}"
                     data-loc="{{ i.location }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>
</div>

<script>
(() => {

  const btnVoice = document.getElementById("btnVoice");
  let recognition = null;
  let listening = false;

  const findInputByCode = (code) =>
    document.querySelector(`.count-input[data-code="${code}"]`);

  const saveRow = async (input) => {
    await fetch("{{ url_for('inventory.save_count_row') }}", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        material_code: input.dataset.code,
        location: input.dataset.loc,
        real_count: parseFloat(input.value || 0)
      })
    });
  };

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  btnVoice.onclick = () => {
    if (!SR) {
      alert("Tu navegador no soporta dictado");
      return;
    }

    if (listening) {
      recognition.stop();
      listening = false;
      btnVoice.classList.remove("btn-primary");
      return;
    }

    recognition = new SR();
    recognition.lang = "es-PE";
    recognition.continuous = true;

    recognition.onresult = (e) => {
      const text = e.results[e.results.length - 1][0].transcript;
      const nums = text.match(/\d+/g) || [];

      const code = nums.find(n => n.length >= 8);
      const qty  = nums.find(n => n.length <= 3);

      if (!code || !qty) return;

      const input = findInputByCode(code);
      if (!input) return;

      input.value = qty;
      saveRow(input);
    };

    recognition.start();
    listening = true;
    btnVoice.classList.add("btn-primary");
  };

})();
</script>

{% endblock %}
