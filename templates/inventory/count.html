{% extends "base.html" %}
{% block content %}

<style>
  /* ================= MODE STYLES ================= */
  .gloves-mode * { 
    font-size: 1.1rem !important; 
  }
  .gloves-mode input { 
    height: 50px; 
    font-size: 1.2rem !important;
    min-width: 90px;
    border-width: 2px;
  }
  .gloves-mode .btn { 
    padding: 0.8rem 1rem !important;
    min-height: 50px;
    font-size: 1.1rem !important;
  }
  .gloves-mode .table td, .gloves-mode .table th {
    padding: 0.8rem 0.5rem;
  }
  .gloves-mode .badge {
    font-size: 0.9rem !important;
    padding: 0.5rem 0.7rem !important;
  }

  /* ================= LAYOUT STYLES ================= */
  .page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 10px;
  }
  
  .header-section {
    background: linear-gradient(135deg, #1a5f7a 0%, #0d4c6e 100%);
    color: white;
    padding: 1rem 0;
    margin-bottom: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .user-info {
    background-color: rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    border-left: 3px solid #4cd964;
  }
  
  .control-panel {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .status-badge {
    font-weight: 600;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  .status-badge.pendiente {
    background-color: #6c757d;
    color: white;
  }
  
  .status-badge.ok {
    background-color: #198754;
    color: white;
  }
  
  .status-badge.diferencia {
    background-color: #ffc107;
    color: #212529;
  }
  
  .table-container {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
  }
  
  .table-header {
    background-color: #343a40;
    color: white;
    padding: 0.8rem 1rem;
  }
  
  .table thead th {
    background-color: #495057;
    color: white;
    border-bottom: none;
    font-weight: 600;
    padding: 0.8rem 0.5rem;
    text-align: center;
    vertical-align: middle;
  }
  
  .table tbody tr {
    transition: background-color 0.2s ease;
  }
  
  .table tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
  }
  
  /* ================= INPUT STYLES ================= */
  .count-input {
    text-align: center;
    font-weight: 600;
    font-size: 1rem;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    transition: all 0.2s ease;
    width: 100%;
    max-width: 120px;
    margin: 0 auto;
    display: block;
    background-color: white;
  }
  
  .count-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13,110,253,0.15);
    background-color: #f8f9ff;
  }
  
  .count-input:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
  }
  
  /* ================= VOICE CONTROL STYLES ================= */
  .voice-controls {
    position: sticky;
    bottom: 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid #dee2e6;
    padding: 0.8rem 0;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }
  
  .voice-status {
    background-color: #e7f1ff;
    border: 1px solid #b6d4fe;
    border-radius: 6px;
    padding: 0.6rem 1rem;
    font-size: 0.9rem;
    margin-top: 0.5rem;
  }
  
  .voice-active {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
  
  /* ================= SAVE FEEDBACK ================= */
  .saving-indicator {
    display: none;
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
  }
  
  .row-saving .saving-indicator {
    display: block;
  }
  
  .row-saving {
    position: relative;
    background-color: rgba(25,135,84,0.05) !important;
    border-left: 4px solid #198754 !important;
  }
  
  .row-saved {
    animation: savedFlash 1.5s ease-out;
  }
  
  @keyframes savedFlash {
    0% { background-color: rgba(25,135,84,0.15); }
    100% { background-color: transparent; }
  }
  
  /* ================= RESPONSIVE STYLES ================= */
  @media (max-width: 768px) {
    .page-container {
      padding: 0 5px;
    }
    
    .header-section {
      padding: 0.8rem 0;
      margin-bottom: 1rem;
    }
    
    .control-panel {
      padding: 0.8rem;
    }
    
    .table-responsive {
      font-size: 0.85rem;
    }
    
    .count-input {
      font-size: 0.9rem;
      height: 42px;
      max-width: 100px;
    }
    
    .table thead th,
    .table tbody td {
      padding: 0.5rem 0.3rem;
    }
    
    .voice-controls {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 0.6rem;
    }
    
    .main-content {
      margin-bottom: 120px;
    }
  }
  
  @media (max-width: 576px) {
    .btn span:not(.bi) {
      display: none;
    }
    
    .btn .bi {
      margin-right: 0 !important;
    }
    
    .table th:nth-child(2), /* Hide description on very small screens */
    .table td:nth-child(2) {
      display: none;
    }
  }
  
  /* ================= FOOTER LEGEND ================= */
  .legend {
    font-size: 0.85rem;
    color: #6c757d;
    border-top: 1px solid #dee2e6;
    padding-top: 0.8rem;
    margin-top: 1rem;
  }
  
  .legend-item {
    display: inline-flex;
    align-items: center;
    margin-right: 1rem;
  }
  
  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.3rem;
  }
  
  .legend-ok { background-color: #198754; }
  .legend-diferencia { background-color: #ffc107; }
  .legend-pendiente { background-color: #6c757d; }
</style>

<div class="page-container">
  <!-- ================= HEADER SECTION ================= -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="h2 mb-1 fw-bold">
            <i class="bi bi-clipboard-check me-2"></i>Conteo Físico de Inventario
          </h1>
          <p class="mb-0 opacity-75">
            Dictado por voz • Guardado automático • Modo guantes
          </p>
        </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= CONTROL PANEL ================= -->
  <div class="control-panel">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="toggleContinuous" checked
                   style="width: 3em; height: 1.5em;">
            <label class="form-check-label fw-medium" for="toggleContinuous">
              <i class="bi bi-arrow-repeat me-1"></i>Dictado continuo
            </label>
          </div>
          
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="toggleSpeak" checked
                   style="width: 3em; height: 1.5em;">
            <label class="form-check-label fw-medium" for="toggleSpeak">
              <i class="bi bi-speaker me-1"></i>Confirmación por voz
            </label>
          </div>
        </div>
      </div>
      
      <div class="col-md-6 text-md-end mt-2 mt-md-0">
        <div class="d-flex gap-2 justify-content-md-end">
          <button id="btnGloves" class="btn btn-outline-secondary">
            <i class="bi bi-hand-index-thumb me-1"></i><span>Modo Guantes</span>
          </button>
          <button id="btnVoice" class="btn btn-primary">
            <i class="bi bi-mic me-1"></i><span>Dictado por Voz</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= MAIN CONTENT ================= -->
  <div class="main-content">
    <!-- Table Header -->
    <div class="table-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-bold">Items para Conteo</h5>
      <div class="text-light small">
        <span class="badge bg-info me-2">Total: {{ items|length }}</span>
        <span class="opacity-75">Stock: Sistema | Conteo: Físico</span>
      </div>
    </div>

    <!-- Inventory Table -->
    <div class="table-container">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th class="text-center" style="width: 12%">Código</th>
              <th class="text-start" style="width: 25%">Descripción</th>
              <th class="text-center" style="width: 8%">UM</th>
              <th class="text-center" style="width: 10%">Ubicación</th>
              <th class="text-center" style="width: 10%">Stock</th>
              <th class="text-center" style="width: 12%">Conteo</th>
              <th class="text-center" style="width: 12%">Estado</th>
            </tr>
          </thead>
          <tbody>
          {% for i in items %}
            <tr id="row-{{ i.material_code }}-{{ i.location }}"
                class="{% if i.estado == 'OK' %}table-success{% elif i.estado == 'Diferencia' %}table-warning{% endif %}">
              <!-- Código -->
              <td class="text-center fw-bold">
                <code class="bg-light px-2 py-1 rounded">{{ i.material_code }}</code>
              </td>
              
              <!-- Descripción -->
              <td class="text-start">
                <div class="small text-muted" title="{{ i.material_text }}">
                  {{ i.material_text|truncate(50, true, '...') }}
                </div>
              </td>
              
              <!-- Unidad de Medida -->
              <td class="text-center fw-semibold">
                <span class="badge bg-secondary">{{ i.base_unit }}</span>
              </td>
              
              <!-- Ubicación -->
              <td class="text-center fw-bold">
                <span class="badge bg-dark">{{ i.location }}</span>
              </td>
              
              <!-- Stock del Sistema -->
              <td class="text-center fw-bold text-primary">
                {{ i.stock }}
              </td>
              
              <!-- Conteo Físico -->
              <td class="text-center position-relative">
                <input type="text"
                       class="form-control count-input"
                       value="{% if i.real_count and i.real_count > 0 %}{{ i.real_count }}{% endif %}"
                       inputmode="numeric"
                       pattern="[0-9]*"
                       autocomplete="off"
                       data-code="{{ i.material_code }}"
                       data-loc="{{ i.location }}"
                       data-stock="{{ i.stock }}"
                       placeholder="0"
                       aria-label="Conteo para {{ i.material_code }}">
                <div class="saving-indicator">
                  <div class="spinner-border spinner-border-sm text-success" role="status">
                    <span class="visually-hidden">Guardando...</span>
                  </div>
                </div>
              </td>
              
              <!-- Estado -->
              <td class="text-center">
                {% if i.estado == 'OK' %}
                  <span class="status-badge ok">
                    <i class="bi bi-check-circle me-1"></i>OK
                  </span>
                {% elif i.estado == 'Diferencia' %}
                  <span class="status-badge diferencia">
                    <i class="bi bi-exclamation-triangle me-1"></i>Diferencia
                  </span>
                {% else %}
                  <span class="status-badge pendiente">
                    <i class="bi bi-clock me-1"></i>Pendiente
                  </span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color legend-ok"></div>
        <span>OK: Coincide con stock</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-diferencia"></div>
        <span>Diferencia: Revisar</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-pendiente"></div>
        <span>Pendiente: Sin conteo</span>
      </div>
    </div>
  </div>

  <!-- ================= VOICE CONTROLS FOOTER ================= -->
  <div class="voice-controls">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div id="voiceStatus" class="voice-status">
            <i class="bi bi-info-circle me-2"></i>
            <span id="statusText">Preparado para dictado</span>
            <div id="voiceInstructions" class="small mt-1">
              Di "código" seguido de números y "cantidad" seguido de números
            </div>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-2 mt-md-0">
          <div class="d-flex gap-2 justify-content-md-end">
            <span class="badge bg-light text-dark border d-none" id="lastCommand">
              <i class="bi bi-soundwave me-1"></i><span id="commandText"></span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================= OPTIMIZED SCRIPT ================= -->
<script>
/**
 * Sistema de Conteo Físico - Optimizado para Producción Industrial
 * Compatible con Android Chrome y dispositivos móviles
 */

(function() {
  'use strict';
  
  // ================= CONFIGURATION =================
  const CONFIG = {
    DEBOUNCE_DELAY: 800,
    VOICE_RESTART_DELAY: 300,
    MAX_RESTART_ATTEMPTS: 3,
    SPEECH_LANG: 'es-PE',  // Cambiado a es-PE para Perú
    COMMAND_TIMEOUT: 5000
  };
  
  // ================= STATE MANAGEMENT =================
  const State = {
    voice: {
      recognition: null,
      isListening: false,
      isAvailable: false,
      continuous: true,
      feedback: true,
      errorCount: 0,
      restartCount: 0
    },
    ui: {
      glovesMode: false,
      savingRows: new Set(),
      lastCommand: null
    },
    debug: false
  };
  
  // ================= DOM REFERENCES =================
  const DOM = {
    btnVoice: document.getElementById('btnVoice'),
    btnGloves: document.getElementById('btnGloves'),
    voiceStatus: document.getElementById('voiceStatus'),
    statusText: document.getElementById('statusText'),
    voiceInstructions: document.getElementById('voiceInstructions'),
    toggleContinuous: document.getElementById('toggleContinuous'),
    toggleSpeak: document.getElementById('toggleSpeak'),
    lastCommandBadge: document.getElementById('lastCommand'),
    commandText: document.getElementById('commandText'),
    pageContainer: document.querySelector('.page-container')
  };
  
  // ================= UTILITY FUNCTIONS =================
  
  /**
   * Actualiza la UI del estado de voz
   */
  function updateVoiceUI(state, message = '') {
    const states = {
      idle: {
        icon: 'bi-mic',
        btnClass: 'btn-primary',
        statusClass: '',
        defaultMsg: 'Preparado para dictado',
        instructions: 'Di "código" seguido de números y "cantidad" seguido de números'
      },
      listening: {
        icon: 'bi-mic-fill',
        btnClass: 'btn-danger voice-active',
        statusClass: 'bg-warning bg-opacity-10 border-warning',
        defaultMsg: 'Escuchando... Habla ahora',
        instructions: 'Habla claramente cerca del micrófono'
      },
      processing: {
        icon: 'bi-soundwave',
        btnClass: 'btn-primary',
        statusClass: 'bg-info bg-opacity-10 border-info',
        defaultMsg: 'Procesando comando...',
        instructions: 'Procesando tu voz...'
      },
      error: {
        icon: 'bi-exclamation-triangle',
        btnClass: 'btn-outline-danger',
        statusClass: 'bg-danger bg-opacity-10 border-danger text-danger',
        defaultMsg: 'Error de micrófono',
        instructions: 'Verifica los permisos del micrófono'
      }
    };
    
    const config = states[state] || states.idle;
    
    // Actualizar botón de voz
    DOM.btnVoice.innerHTML = `<i class="bi ${config.icon} me-1"></i><span>Dictado por Voz</span>`;
    DOM.btnVoice.className = DOM.btnVoice.className.replace(/btn-(primary|danger|outline-danger)/g, '');
    DOM.btnVoice.classList.add(config.btnClass);
    
    // Actualizar estado
    DOM.statusText.textContent = message || config.defaultMsg;
    DOM.voiceInstructions.textContent = config.instructions;
    DOM.voiceStatus.className = `voice-status ${config.statusClass}`;
    
    // Instrucciones específicas para móvil
    if (/Mobi|Android/i.test(navigator.userAgent) && state === 'idle') {
      DOM.voiceInstructions.textContent = 'Toca el botón de dictado y habla claramente';
    }
  }
  
  /**
   * Muestra el último comando reconocido
   */
  function showLastCommand(command, success = true) {
    if (!DOM.lastCommandBadge) return;
    
    DOM.commandText.textContent = command.substring(0, 30);
    DOM.lastCommandBadge.className = `badge ${success ? 'bg-success text-white' : 'bg-danger text-white'} border d-inline-flex align-items-center`;
    DOM.lastCommandBadge.classList.remove('d-none');
    
    // Ocultar después de 3 segundos
    setTimeout(() => {
      DOM.lastCommandBadge.classList.add('d-none');
    }, 3000);
  }
  
  /**
   * Feedback de voz sintetizado
   */
  function speak(text) {
    if (!State.voice.feedback || !window.speechSynthesis) return;
    
    try {
      speechSynthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = CONFIG.SPEECH_LANG;
      utterance.rate = 1.0;
      utterance.volume = 0.9;
      
      // Optimizar para móvil
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        utterance.rate = 1.1;
        utterance.pitch = 1.0;
      }
      
      utterance.onerror = () => {
        console.warn('Error en síntesis de voz');
      };
      
      setTimeout(() => {
        speechSynthesis.speak(utterance);
      }, 50);
    } catch (error) {
      console.warn('Síntesis de voz no disponible:', error);
    }
  }
  
  /**
   * Encuentra input por código de material
   */
  function findInputByCode(code) {
    return document.querySelector(`.count-input[data-code="${code}"]`);
  }
  
  /**
   * Muestra feedback visual de guardado
   */
  function showSaveFeedback(input, success = true) {
    const code = input.dataset.code;
    const loc = input.dataset.loc;
    const row = document.getElementById(`row-${code}-${loc}`);
    
    if (!row) return;
    
    // Remover estados anteriores
    row.classList.remove('row-saving', 'row-saved', 'table-warning', 'table-success');
    
    const count = parseInt(input.value) || 0;
    const stock = parseInt(input.dataset.stock) || 0;
    
    if (success) {
      // Estado de guardado
      row.classList.add('row-saving');
      
      setTimeout(() => {
        row.classList.remove('row-saving');
        row.classList.add('row-saved');
        
        // Actualizar estado basado en conteo vs stock
        if (count === 0) {
          row.classList.remove('table-success', 'table-warning');
        } else if (count === stock) {
          row.classList.add('table-success');
          row.classList.remove('table-warning');
        } else {
          row.classList.add('table-warning');
          row.classList.remove('table-success');
        }
        
        // Actualizar badge de estado
        const badge = row.querySelector('.status-badge');
        if (badge) {
          if (count === 0) {
            badge.className = 'status-badge pendiente';
            badge.innerHTML = '<i class="bi bi-clock me-1"></i>Pendiente';
          } else if (count === stock) {
            badge.className = 'status-badge ok';
            badge.innerHTML = '<i class="bi bi-check-circle me-1"></i>OK';
          } else {
            badge.className = 'status-badge diferencia';
            badge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Diferencia';
          }
        }
      }, 600);
      
      // Limpiar animación
      setTimeout(() => row.classList.remove('row-saved'), 2000);
    }
  }
  
  /**
   * Guarda una fila en el servidor
   */
  async function saveRow(input) {
    const value = parseInt(input.value || "0", 10) || 0;
    const code = input.dataset.code;
    
    // Prevenir guardados duplicados
    if (State.ui.savingRows.has(code)) {
      return;
    }
    
    State.ui.savingRows.add(code);
    
    try {
      const response = await fetch("{{ url_for('inventory.save_count_row') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({
          material_code: input.dataset.code,
          location: input.dataset.loc,
          real_count: value
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      
      // Feedback visual
      showSaveFeedback(input, true);
      
      // Feedback de voz si es diferente de 0
      if (value > 0) {
        speak(`Registrado ${value} para ${code}`);
      }
      
    } catch (error) {
      console.error('Error guardando fila:', error);
      showSaveFeedback(input, false);
      speak('Error al guardar, reintentando');
      
      // Reintentar una vez
      if (!input.hasAttribute('data-retry')) {
        input.setAttribute('data-retry', '1');
        setTimeout(() => {
          input.removeAttribute('data-retry');
          saveRow(input);
        }, 2000);
      }
    } finally {
      setTimeout(() => {
        State.ui.savingRows.delete(code);
      }, 1000);
    }
  }
  
  // ================= VOICE RECOGNITION =================
  
  /**
   * Inicializa el reconocimiento de voz
   */
  function initVoiceRecognition() {
    // Verificar compatibilidad del navegador
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
      State.voice.isAvailable = false;
      updateVoiceUI('error', 'Navegador no compatible con dictado por voz');
      DOM.btnVoice.disabled = true;
      DOM.btnVoice.innerHTML = '<i class="bi bi-mic-mute me-1"></i><span>No compatible</span>';
      return false;
    }
    
    try {
      State.voice.recognition = new SpeechRecognition();
      State.voice.recognition.lang = CONFIG.SPEECH_LANG;
      State.voice.recognition.interimResults = false;
      State.voice.recognition.continuous = false;  // Importante para móviles
      State.voice.recognition.maxAlternatives = 1;
      
      setupVoiceEvents();
      State.voice.isAvailable = true;
      return true;
      
    } catch (error) {
      console.error('Error inicializando reconocimiento:', error);
      State.voice.isAvailable = false;
      updateVoiceUI('error', 'No se pudo acceder al micrófono');
      return false;
    }
  }
  
  /**
   * Configura eventos del reconocimiento de voz
   */
  function setupVoiceEvents() {
    const rec = State.voice.recognition;
    
    rec.onstart = () => {
      State.voice.isListening = true;
      State.voice.errorCount = 0;
      State.voice.restartCount = 0;
      updateVoiceUI('listening');
    };
    
    rec.onresult = (event) => {
      updateVoiceUI('processing');
      
      const result = event.results[0];
      const transcript = result[0].transcript.toLowerCase().trim();
      
      console.log('Texto reconocido:', transcript);
      showLastCommand(transcript, true);
      
      // Parsear comando de voz
      const parsed = parseVoiceCommand(transcript);
      
      if (parsed.success && parsed.code && parsed.quantity !== null) {
        processVoiceCommand(parsed.code, parsed.quantity);
      } else {
        updateVoiceUI('error', 'No se entendió el comando');
        speak('No entendí, por favor repite código y cantidad');
      }
    };
    
    rec.onerror = (event) => {
      console.error('Error en reconocimiento:', event.error);
      State.voice.errorCount++;
      
      switch (event.error) {
        case 'not-allowed':
        case 'permission-denied':
          updateVoiceUI('error', 'Permiso de micrófono denegado');
          speak('Por favor, permite el acceso al micrófono en ajustes');
          stopVoiceRecognition();
          break;
          
        case 'no-speech':
          if (State.voice.continuous) {
            updateVoiceUI('idle', 'No se detectó voz. Reintentando...');
            setTimeout(restartVoiceRecognition, 1000);
          }
          break;
          
        case 'audio-capture':
          updateVoiceUI('error', 'No se detectó micrófono');
          speak('No se encontró micrófono');
          break;
          
        case 'network':
          updateVoiceUI('error', 'Error de red en reconocimiento');
          break;
          
        case 'aborted':
          // Ignorar, usualmente ocurre cuando se detiene manualmente
          break;
          
        default:
          console.warn('Error de reconocimiento no manejado:', event.error);
          if (State.voice.errorCount < 3) {
            updateVoiceUI('error', `Error ${event.error}. Reintentando...`);
            setTimeout(restartVoiceRecognition, 1000);
          } else {
            updateVoiceUI('error', 'Demasiados errores. Reinicia el dictado');
            stopVoiceRecognition();
          }
      }
    };
    
    rec.onend = () => {
      State.voice.isListening = false;
      
      // Reinicio automático en modo continuo
      if (State.voice.continuous && State.voice.restartCount < CONFIG.MAX_RESTART_ATTEMPTS) {
        State.voice.restartCount++;
        console.log(`Reinicio automático ${State.voice.restartCount}/${CONFIG.MAX_RESTART_ATTEMPTS}`);
        
        setTimeout(() => {
          if (!State.voice.isListening && State.voice.continuous) {
            startVoiceRecognition();
          }
        }, CONFIG.VOICE_RESTART_DELAY);
      } else {
        updateVoiceUI('idle');
        State.voice.restartCount = 0;
      }
    };
  }
  
  /**
   * Parsea comandos de voz - MEJORADO PARA ANDROID
   */
  function parseVoiceCommand(transcript) {
    console.log('Procesando comando:', transcript);
    
    // Limpiar y normalizar texto
    const cleanTranscript = transcript
      .toLowerCase()
      .replace(/[.,]/g, ' ')  // Reemplazar puntuación por espacios
      .replace(/\s+/g, ' ')   // Normalizar espacios múltiples
      .trim();
    
    // Patrones de reconocimiento mejorados para español
    const patterns = [
      // "código 12345678 cantidad 10"
      /c[óo]digo\s+(\d{4,})\s+cantidad\s+(\d+)/i,
      // "12345678 cantidad 10"
      /(\d{6,})\s+cantidad\s+(\d+)/i,
      // "código 12345678 10 unidades"
      /c[óo]digo\s+(\d+)\s+(\d+)\s+unidades/i,
      // "para el código 12345678 10"
      /para el c[óo]digo\s+(\d+)\s+(\d+)/i,
      // "12345678 10"
      /(\d{6,})\s+(\d{1,4})/,
      // "poner 10 en 12345678"
      /poner\s+(\d+)\s+en\s+(\d{4,})/i,
      // "material 12345678 10"
      /material\s+(\d+)\s+(\d+)/i,
      // "10 para 12345678"
      /(\d+)\s+para\s+(\d+)/i
    ];
    
    for (const pattern of patterns) {
      const match = cleanTranscript.match(pattern);
      if (match) {
        console.log('Patrón encontrado:', pattern, match);
        
        // Determinar qué grupo es código (normalmente el más largo)
        const group1 = match[1];
        const group2 = match[2];
        
        let code, quantity;
        
        if (group1.length >= 6 && group2.length <= 4) {
          // group1 es código, group2 es cantidad
          code = group1;
          quantity = parseInt(group2, 10);
        } else if (group2.length >= 6 && group1.length <= 4) {
          // group2 es código, group1 es cantidad
          code = group2;
          quantity = parseInt(group1, 10);
        } else {
          // Por defecto, el primero es código
          code = group1;
          quantity = parseInt(group2, 10);
        }
        
        return {
          success: true,
          code: code,
          quantity: quantity
        };
      }
    }
    
    // Fallback: extraer todos los números
    const numbers = cleanTranscript.match(/\d+/g) || [];
    console.log('Números encontrados:', numbers);
    
    if (numbers.length >= 2) {
      // El número más largo es probablemente el código
      const code = numbers.reduce((a, b) => a.length >= b.length ? a : b);
      const quantity = parseInt(numbers.find(n => n !== code) || numbers[1], 10);
      
      return {
        success: true,
        code: code,
        quantity: quantity
      };
    }
    
    return { success: false };
  }
  
  /**
   * Procesa un comando de voz válido
   */
  function processVoiceCommand(code, quantity) {
    console.log('Procesando comando:', code, quantity);
    
    const input = findInputByCode(code);
    
    if (!input) {
      updateVoiceUI('error', `Código ${code} no encontrado`);
      speak(`Código ${code} no existe en la lista`);
      return;
    }
    
    // Actualizar valor
    input.value = quantity;
    
    // Disparar eventos
    const inputEvent = new Event('input', { bubbles: true });
    const changeEvent = new Event('change', { bubbles: true });
    input.dispatchEvent(inputEvent);
    input.dispatchEvent(changeEvent);
    
    // Guardar automáticamente
    saveRow(input);
    
    // Feedback
    const stock = parseInt(input.dataset.stock) || 0;
    let feedback = `Registrado ${quantity} para ${code}`;
    
    if (quantity === stock) {
      feedback += ', coincide con stock';
    } else if (quantity > stock) {
      feedback += `, mayor que stock de ${stock}`;
    } else {
      feedback += `, menor que stock de ${stock}`;
    }
    
    updateVoiceUI('listening', feedback);
  }
  
  /**
   * Inicia el reconocimiento de voz con manejo de permisos
   */
  async function startVoiceRecognition() {
    if (State.voice.isListening || !State.voice.isAvailable) return;
    
    // Para Android/Chrome Mobile, verificar permisos primero
    if (/Mobi|Android/i.test(navigator.userAgent) && navigator.mediaDevices) {
      try {
        // Verificar permisos de micrófono
        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
        
        if (permissionStatus.state === 'denied') {
          updateVoiceUI('error', 'Permiso de micrófono denegado');
          speak('Por favor, activa el micrófono en ajustes del navegador');
          return;
        }
        
        // Solicitar acceso al micrófono
        await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Iniciar reconocimiento
        State.voice.recognition.start();
        
      } catch (error) {
        console.error('Error de permisos de micrófono:', error);
        updateVoiceUI('error', 'No se pudo acceder al micrófono');
        
        if (error.name === 'NotAllowedError') {
          speak('Permiso de micrófono denegado. Actívalo en ajustes');
        } else if (error.name === 'NotFoundError') {
          speak('No se encontró micrófono');
        } else {
          speak('Error al acceder al micrófono');
        }
        return;
      }
    } else {
      // Para desktop u otros navegadores
      try {
        State.voice.recognition.start();
      } catch (error) {
        console.error('Error iniciando reconocimiento:', error);
        updateVoiceUI('error', 'No se pudo iniciar el dictado');
      }
    }
  }
  
  /**
   * Detiene el reconocimiento de voz
   */
  function stopVoiceRecognition() {
    if (State.voice.recognition && State.voice.isListening) {
      try {
        State.voice.recognition.stop();
      } catch (error) {
        // Ignorar errores al detener
        console.warn('Error deteniendo reconocimiento:', error);
      }
    }
    State.voice.isListening = false;
    updateVoiceUI('idle');
  }
  
  /**
   * Reinicia el reconocimiento de voz
   */
  function restartVoiceRecognition() {
    if (State.voice.isListening) {
      stopVoiceRecognition();
    }
    setTimeout(startVoiceRecognition, CONFIG.VOICE_RESTART_DELAY);
  }
  
  /**
   * Alterna el reconocimiento de voz
   */
  function toggleVoiceRecognition() {
    if (State.voice.isListening) {
      stopVoiceRecognition();
    } else {
      startVoiceRecognition();
    }
  }
  
  // ================= GLOVES MODE =================
  
  /**
   * Alterna el modo guantes
   */
  function toggleGlovesMode() {
    State.ui.glovesMode = !State.ui.glovesMode;
    
    if (State.ui.glovesMode) {
      DOM.pageContainer.classList.add('gloves-mode');
      DOM.btnGloves.classList.remove('btn-outline-secondary');
      DOM.btnGloves.classList.add('btn-secondary');
      DOM.btnGloves.innerHTML = '<i class="bi bi-hand-index-thumb-fill me-1"></i><span>Guantes ON</span>';
      speak('Modo guantes activado');
    } else {
      DOM.pageContainer.classList.remove('gloves-mode');
      DOM.btnGloves.classList.remove('btn-secondary');
      DOM.btnGloves.classList.add('btn-outline-secondary');
      DOM.btnGloves.innerHTML = '<i class="bi bi-hand-index-thumb me-1"></i><span>Modo Guantes</span>';
    }
  }
  
  // ================= INPUT HANDLING =================
  
  /**
   * Configura handlers para inputs
   */
  function setupInputHandlers() {
    let saveTimer;
    
    document.querySelectorAll('.count-input').forEach(input => {
      // Validar entrada
      input.addEventListener('input', function() {
        clearTimeout(saveTimer);
        
        // Solo permitir números
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Mostrar feedback visual
        const row = this.closest('tr');
        if (row) {
          row.classList.add('row-saving');
        }
        
        // Programar guardado (si hay valor)
        if (this.value && this.value !== '0') {
          saveTimer = setTimeout(() => {
            saveRow(this);
          }, CONFIG.DEBOUNCE_DELAY);
        }
      });
      
      // Limpiar feedback al perder foco
      input.addEventListener('blur', function() {
        const row = this.closest('tr');
        if (row) {
          setTimeout(() => {
            row.classList.remove('row-saving');
          }, 300);
        }
      });
    });
  }
  
  // ================= INITIALIZATION =================
  
  /**
   * Inicializa la aplicación
   */
  function initApp() {
    console.log('Inicializando sistema de conteo...');
    
    // Inicializar reconocimiento de voz
    if (initVoiceRecognition()) {
      updateVoiceUI('idle');
    }
    
    // Configurar controles de voz
    DOM.btnVoice.addEventListener('click', toggleVoiceRecognition);
    DOM.toggleContinuous.addEventListener('change', function() {
      State.voice.continuous = this.checked;
      console.log('Modo continuo:', this.checked);
    });
    DOM.toggleSpeak.addEventListener('change', function() {
      State.voice.feedback = this.checked;
      console.log('Confirmación por voz:', this.checked);
    });
    
    // Configurar modo guantes
    DOM.btnGloves.addEventListener('click', toggleGlovesMode);
    
    // Configurar handlers de inputs
    setupInputHandlers();
    
    // Manejar visibilidad de la página
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && State.voice.isListening) {
        console.log('Página oculta, deteniendo dictado');
        stopVoiceRecognition();
      }
    });
    
    // Optimizaciones para móvil
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      console.log('Dispositivo móvil detectado, aplicando optimizaciones');
      
      // Prevenir zoom en inputs en iOS
      document.addEventListener('touchstart', function(e) {
        if (e.target.matches('.count-input')) {
          e.target.style.fontSize = '16px';
        }
      }, { passive: true });
      
      // Ajustar altura para evitar teclado
      window.addEventListener('resize', () => {
        if (document.activeElement.matches('.count-input')) {
          document.activeElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
      });
      
      // Mejorar rendimiento táctil
      document.documentElement.style.touchAction = 'manipulation';
    }
    
    console.log('Sistema de conteo inicializado correctamente');
  }
  
  // Iniciar aplicación
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    initApp();
  }
  
  // Exportar para debugging
  window.CountSystem = {
    toggleVoice: toggleVoiceRecognition,
    toggleGloves: toggleGlovesMode,
    startVoice: startVoiceRecognition,
    stopVoice: stopVoiceRecognition,
    getState: () => State
  };
  
})();
</script>
{% endblock %}

