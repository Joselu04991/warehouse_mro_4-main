{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="bi bi-clipboard-plus me-2"></i> Crear Nueva Reclamaci√≥n</h3>
                        <span class="badge bg-dark">√öltimo ID: {{ last_id }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Descripci√≥n:</strong> Use este formulario para reportar problemas, fallas o inconvenientes en el sistema MRO. 
                        Las reclamaciones ser√°n asignadas autom√°ticamente al departamento correspondiente para su resoluci√≥n.
                    </div>
                    
                    <form method="POST" action="{{ url_for('simulator_mro.create_claims') }}" id="claimForm" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i> Informaci√≥n de la Reclamaci√≥n</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="claimType" class="form-label">Tipo de Reclamaci√≥n *</label>
                                            <select class="form-select" id="claimType" name="claim_type" required onchange="updatePriority()">
                                                <option value="">Seleccionar tipo de problema...</option>
                                                {% for type in claim_types %}
                                                <option value="{{ type.id }}" data-priority="{{ type.priority }}">
                                                    {{ type.name }} ({{ type.code }}) - {{ type.priority }}
                                                </option>
                                                {% endfor %}
                                                <option value="other">Otro tipo de problema</option>
                                            </select>
                                            <div class="form-text">Seleccione la categor√≠a que mejor describa el problema</div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="priority" class="form-label">Nivel de Prioridad *</label>
                                                <select class="form-select" id="priority" name="priority" required>
                                                    <option value="baja">Baja (Resoluci√≥n en 72 horas)</option>
                                                    <option value="media" selected>Media (Resoluci√≥n en 48 horas)</option>
                                                    <option value="alta">Alta (Resoluci√≥n en 24 horas)</option>
                                                    <option value="critica">Cr√≠tica (Resoluci√≥n en 4 horas)</option>
                                                </select>
                                                <div class="form-text">Determine la urgencia del problema</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="department" class="form-label">Departamento Responsable *</label>
                                                <select class="form-select" id="department" name="department" required>
                                                    <option value="">Seleccionar departamento...</option>
                                                    <option value="almacen">Almac√©n</option>
                                                    <option value="mantenimiento">Mantenimiento</option>
                                                    <option value="produccion">Producci√≥n</option>
                                                    <option value="calidad">Control de Calidad</option>
                                                    <option value="logistica">Log√≠stica</option>
                                                    <option value="compras">Compras</option>
                                                    <option value="it">Sistemas (IT)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="claimTitle" class="form-label">T√≠tulo de la Reclamaci√≥n *</label>
                                            <input type="text" class="form-control" id="claimTitle" name="claim_title" 
                                                   placeholder="Ej: Falta de rodamientos SKF-6205 en zona A" required>
                                            <div class="form-text">Describa brevemente el problema</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="description" class="form-label">Descripci√≥n Detallada *</label>
                                            <textarea class="form-control" id="description" name="description" rows="6" 
                                                      placeholder="Describa el problema en detalle. Incluya:\n‚Ä¢ Ubicaci√≥n exacta\n‚Ä¢ Materiales/equipos afectados\n‚Ä¢ S√≠ntomas observados\n‚Ä¢ Impacto en operaciones\n‚Ä¢ Cualquier informaci√≥n adicional relevante..." 
                                                      required></textarea>
                                            <div class="form-text">Mientras m√°s detallada sea la descripci√≥n, m√°s r√°pida ser√° la resoluci√≥n</div>
                                            <div class="mt-1">
                                                <small id="charCount" class="text-muted">0/1000 caracteres</small>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="location" class="form-label">Ubicaci√≥n F√≠sica</label>
                                                <input type="text" class="form-control" id="location" name="location" 
                                                       placeholder="Ej: Zona A, Estante 12, Nivel 3, Almac√©n Principal">
                                                <div class="form-text">Si aplica, indique la ubicaci√≥n exacta</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="material_code" class="form-label">C√≥digo de Material/Equipo</label>
                                                <input type="text" class="form-control" id="material_code" name="material_code" 
                                                       placeholder="Ej: MAT-7892-SKF o EQ-456-CNC">
                                                <div class="form-text">C√≥digo interno del material o equipo afectado</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i> Informaci√≥n Adicional</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="evidence" class="form-label">Adjuntar Evidencia</label>
                                            <input type="file" class="form-control" id="evidence" name="evidence" 
                                                   accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx">
                                            <div class="form-text">
                                                Formatos aceptados: im√°genes (JPG, PNG), documentos (PDF, DOC, XLS)
                                                <br>Tama√±o m√°ximo: 10MB
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="contact_phone" class="form-label">Tel√©fono de Contacto</label>
                                            <input type="tel" class="form-control" id="contact_phone" name="contact_phone" 
                                                   placeholder="+34 600 123 456">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="preferred_time" class="form-label">Horario Preferido para Contacto</label>
                                            <select class="form-select" id="preferred_time" name="preferred_time">
                                                <option value="">Cualquier horario</option>
                                                <option value="morning">Ma√±ana (8:00 - 12:00)</option>
                                                <option value="afternoon">Tarde (13:00 - 17:00)</option>
                                                <option value="evening">Noche (17:00 - 20:00)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="urgent" name="urgent">
                                            <label class="form-check-label" for="urgent">
                                                <strong class="text-danger">Reclamaci√≥n Urgente</strong>
                                            </label>
                                            <div class="form-text">
                                                Marque esta opci√≥n si el problema est√° afectando operaciones cr√≠ticas
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="safety_issue" name="safety_issue">
                                            <label class="form-check-label" for="safety_issue">
                                                <strong class="text-warning">Problema de Seguridad</strong>
                                            </label>
                                            <div class="form-text">
                                                Marque si existe riesgo para personas o instalaciones
                                            </div>
                                        </div>
                                        
                                        <div class="card bg-light mt-3">
                                            <div class="card-body">
                                                <h6><i class="bi bi-clock-history me-2"></i> Tiempos de Respuesta</h6>
                                                <ul class="small mb-0">
                                                    <li><span class="badge bg-danger">Cr√≠tica</span>: 4 horas m√°ximo</li>
                                                    <li><span class="badge bg-warning">Alta</span>: 24 horas m√°ximo</li>
                                                    <li><span class="badge bg-info">Media</span>: 48 horas m√°ximo</li>
                                                    <li><span class="badge bg-success">Baja</span>: 72 horas m√°ximo</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i> Tipos Comunes de Reclamaciones</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group">
                                            {% for type in claim_types %}
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <strong>{{ type.name }}</strong>
                                                    <small class="text-muted">{{ type.code }}</small>
                                                </div>
                                                <small>Prioridad: {{ type.priority }} | Resoluci√≥n: {{ type.avg_resolution }}</small>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button type="button" class="btn btn-outline-secondary me-md-2" onclick="clearForm()">
                                                <i class="bi bi-x-circle me-2"></i> Limpiar Formulario
                                            </button>
                                            <button type="button" class="btn btn-info me-md-2" onclick="previewClaim()">
                                                <i class="bi bi-eye me-2"></i> Vista Previa
                                            </button>
                                            <button type="submit" class="btn btn-warning btn-lg">
                                                <i class="bi bi-send me-2"></i> Enviar Reclamaci√≥n
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i> ¬øC√≥mo Reportar Correctamente?</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="bi bi-check-circle text-success me-2"></i> Lo que S√ç debes hacer:</h6>
                            <ul>
                                <li>Describe el problema con detalle</li>
                                <li>Incluye ubicaci√≥n exacta</li>
                                <li>Adjunta fotos si es posible</li>
                                <li>Especifica el impacto en operaciones</li>
                                <li>Proporciona datos de contacto</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="bi bi-x-circle text-danger me-2"></i> Lo que NO debes hacer:</h6>
                            <ul>
                                <li>No uses descripciones vagas</li>
                                <li>No olvides la ubicaci√≥n</li>
                                <li>No adjuntes archivos muy grandes</li>
                                <li>No reportes m√∫ltiples veces el mismo problema</li>
                                <li>No uses lenguaje informal</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="bi bi-clock-history text-primary me-2"></i> Proceso de Resoluci√≥n:</h6>
                            <ol>
                                <li>Recepci√≥n de reclamaci√≥n</li>
                                <li>Asignaci√≥n a departamento</li>
                                <li>Evaluaci√≥n y diagn√≥stico</li>
                                <li>Plan de acci√≥n</li>
                                <li>Resoluci√≥n y seguimiento</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Actualizar prioridad seg√∫n tipo seleccionado
function updatePriority() {
    const select = document.getElementById('claimType');
    const selectedOption = select.options[select.selectedIndex];
    const priority = selectedOption.getAttribute('data-priority');
    
    if (priority) {
        document.getElementById('priority').value = priority.toLowerCase();
    }
}

// Contador de caracteres
const description = document.getElementById('description');
const charCount = document.getElementById('charCount');

description.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length}/1000 caracteres`;
    
    if (length < 20) {
        charCount.className = 'text-danger';
    } else if (length < 100) {
        charCount.className = 'text-warning';
    } else {
        charCount.className = 'text-success';
    }
});

// Vista previa de la reclamaci√≥n
function previewClaim() {
    const title = document.getElementById('claimTitle').value;
    const typeSelect = document.getElementById('claimType');
    const type = typeSelect.options[typeSelect.selectedIndex].text;
    const priority = document.getElementById('priority').options[document.getElementById('priority').selectedIndex].text;
    const descriptionText = document.getElementById('description').value;
    
    if (!title || !type || !descriptionText) {
        alert('Por favor complete los campos obligatorios antes de ver la vista previa');
        return;
    }
    
    const preview = `
        üìã VISTA PREVIA DE RECLAMACI√ìN
        ================================
        
        üè∑Ô∏è T√çTULO: ${title}
        üìÇ TIPO: ${type}
        ‚ö° PRIORIDAD: ${priority}
        üìÖ FECHA: ${new Date().toLocaleDateString()}
        üë§ REPORTADO POR: {{ current_user.username }}
        
        üìù DESCRIPCI√ìN:
        ${descriptionText.substring(0, 300)}${descriptionText.length > 300 ? '...' : ''}
        
        ‚è±Ô∏è TIEMPO ESTIMADO DE RESPUESTA: 
        ${priority.includes('Cr√≠tica') ? '4 horas' : 
          priority.includes('Alta') ? '24 horas' : 
          priority.includes('Media') ? '48 horas' : '72 horas'}
    `;
    
    alert(preview);
}

// Limpiar formulario
function clearForm() {
    if (confirm('¬øEst√° seguro que desea limpiar todo el formulario?\n\nSe perder√°n todos los datos ingresados.')) {
        document.getElementById('claimForm').reset();
        charCount.textContent = '0/1000 caracteres';
        charCount.className = 'text-muted';
    }
}

// Validaci√≥n antes de enviar
document.getElementById('claimForm').addEventListener('submit', function(e) {
    const title = document.getElementById('claimTitle').value;
    const type = document.getElementById('claimType').value;
    const descriptionText = document.getElementById('description').value;
    
    if (!title || !type || !descriptionText) {
        e.preventDefault();
        alert('‚ùå Por favor complete todos los campos obligatorios marcados con *');
        return false;
    }
    
    if (descriptionText.length < 20) {
        e.preventDefault();
        alert('‚ùå La descripci√≥n debe tener al menos 20 caracteres');
        return false;
    }
    
    if (descriptionText.length > 1000) {
        e.preventDefault();
        alert('‚ùå La descripci√≥n no puede exceder los 1000 caracteres');
        return false;
    }
    
    // Validar archivo adjunto
    const fileInput = document.getElementById('evidence');
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (file.size > maxSize) {
            e.preventDefault();
            alert('‚ùå El archivo adjunto es demasiado grande. M√°ximo 10MB.');
            return false;
        }
    }
    
    const newClaimId = 'CLM-' + new Date().getFullYear() + '-' + 
                      String(Math.floor(Math.random() * 1000)).padStart(3, '0');
    
    if (confirm(`¬øConfirmar env√≠o de reclamaci√≥n?\n\nID: ${newClaimId}`)) {
        // Continuar con el env√≠o
        return true;
    } else {
        e.preventDefault();
        return false;
    }
});
</script>

<style>
.form-control:focus, .form-select:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
}

.card {
    transition: all 0.3s;
}

.list-group-item {
    transition: background-color 0.2s;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

#description {
    resize: vertical;
    min-height: 150px;
}
</style>
{% endblock %}
