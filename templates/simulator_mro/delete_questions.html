{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="bi bi-question-circle me-2"></i> Eliminación de Preguntas</h3>
                        <span class="badge bg-light text-dark">Total: {{ questions|length }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>¡Atención!</strong> La eliminación de preguntas afectará evaluaciones existentes y reportes históricos. Revise cuidadosamente antes de proceder.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-filter me-2"></i> Filtros Avanzados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="filterSection" class="form-label">Sección</label>
                                        <select class="form-select" id="filterSection" onchange="filterQuestions()">
                                            <option value="">Todas las secciones</option>
                                            <option value="1">Procedimientos Operativos Estándar</option>
                                            <option value="2">Normas de Seguridad Industrial</option>
                                            <option value="3">Control de Calidad - ISO 9001</option>
                                            <option value="4">Procedimientos Administrativos</option>
                                            <option value="5">Mantenimiento Técnico Preventivo</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filterType" class="form-label">Tipo de Pregunta</label>
                                        <select class="form-select" id="filterType" onchange="filterQuestions()">
                                            <option value="">Todos los tipos</option>
                                            <option value="multiple">Selección múltiple</option>
                                            <option value="truefalse">Verdadero/Falso</option>
                                            <option value="open">Respuesta abierta</option>
                                            <option value="practical">Práctica/Demostración</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filterDifficulty" class="form-label">Dificultad</label>
                                        <select class="form-select" id="filterDifficulty" onchange="filterQuestions()">
                                            <option value="">Todas</option>
                                            <option value="easy">Baja</option>
                                            <option value="medium">Media</option>
                                            <option value="hard">Alta</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filterStatus" class="form-label">Estado</label>
                                        <select class="form-select" id="filterStatus" onchange="filterQuestions()">
                                            <option value="">Todos</option>
                                            <option value="active">Activas</option>
                                            <option value="inactive">Inactivas</option>
                                            <option value="draft">Borrador</option>
                                            <option value="review">En revisión</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filterDate" class="form-label">Creadas después de</label>
                                        <input type="date" class="form-control" id="filterDate" onchange="filterQuestions()">
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="filterQuestions()">
                                            <i class="bi bi-funnel me-2"></i> Aplicar Filtros
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                            <i class="bi bi-arrow-clockwise me-2"></i> Restablecer
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i> Estadísticas</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6 mb-3">
                                            <div class="stat-box bg-primary text-white p-3 rounded">
                                                <h4 id="totalFiltered">0</h4>
                                                <small>Preguntas visibles</small>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="stat-box bg-danger text-white p-3 rounded">
                                                <h4 id="totalSelected">0</h4>
                                                <small>Seleccionadas</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="stat-box bg-warning text-white p-3 rounded">
                                                <h4 id="avgDifficulty">0.0</h4>
                                                <small>Dificultad promedio</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="stat-box bg-info text-white p-3 rounded">
                                                <h4 id="totalUsage">0</h4>
                                                <small>Usos totales</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="bi bi-list-task me-2"></i> Lista de Preguntas</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllQuestions()">
                                                <i class="bi bi-check-all me-1"></i> Seleccionar Todo
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="invertSelection()">
                                                <i class="bi bi-arrow-left-right me-1"></i> Invertir
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="clearQuestionSelection()">
                                                <i class="bi bi-x-circle me-1"></i> Limpiar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                        <table class="table table-hover" id="questionsTable">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th width="50">
                                                        <input type="checkbox" id="selectAllQuestions" onclick="toggleAllQuestions()">
                                                    </th>
                                                    <th>Pregunta</th>
                                                    <th>Sección</th>
                                                    <th>Tipo</th>
                                                    <th>Dificultad</th>
                                                    <th>Usos</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr data-section="1" data-type="multiple" data-difficulty="medium" data-status="active" data-created="2024-01-15">
                                                    <td>
                                                        <input type="checkbox" class="question-checkbox" value="101">
                                                    </td>
                                                    <td>
                                                        <div class="question-text">
                                                            <strong>¿Cuál es el primer paso en el procedimiento de arranque de la máquina XYZ?</strong>
                                                            <div class="text-muted small">ID: Q-2024-001</div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info">Operativos</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">Múltiple</span>
                                                    </td>
                                                    <td>
                                                        <div class="difficulty-stars" data-rating="3">
                                                            ★★★☆☆
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">24 veces</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-info" onclick="viewQuestion(101)" title="Ver detalles">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning" onclick="editQuestion(101)" title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" onclick="deleteSingleQuestion(101)" title="Eliminar individual">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr data-section="2" data-type="truefalse" data-difficulty="easy" data-status="active" data-created="2023-12-22">
                                                    <td>
                                                        <input type="checkbox" class="question-checkbox" value="102">
                                                    </td>
                                                    <td>
                                                        <div class="question-text">
                                                            <strong>El uso de gafas de seguridad es obligatorio en todas las áreas de producción.</strong>
                                                            <div class="text-muted small">ID: Q-2023-045</div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-danger">Seguridad</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success">V/F</span>
                                                    </td>
                                                    <td>
                                                        <div class="difficulty-stars" data-rating="1">
                                                            ★☆☆☆☆
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">42 veces</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-info" onclick="viewQuestion(102)" title="Ver detalles">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning" onclick="editQuestion(102)" title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" onclick="deleteSingleQuestion(102)" title="Eliminar individual">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr data-section="3" data-type="open" data-difficulty="hard" data-status="active" data-created="2024-01-10">
                                                    <td>
                                                        <input type="checkbox" class="question-checkbox" value="103">
                                                    </td>
                                                    <td>
                                                        <div class="question-text">
                                                            <strong>Describa el proceso de calibración del instrumento de medición ABC según ISO 9001.</strong>
                                                            <div class="text-muted small">ID: Q-2024-003</div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-warning">Calidad</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info">Abierta</span>
                                                    </td>
                                                    <td>
                                                        <div class="difficulty-stars" data-rating="5">
                                                            ★★★★★
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">18 veces</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-info" onclick="viewQuestion(103)" title="Ver detalles">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning" onclick="editQuestion(103)" title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" onclick="deleteSingleQuestion(103)" title="Eliminar individual">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr data-section="4" data-type="multiple" data-difficulty="medium" data-status="inactive" data-created="2023-11-05">
                                                    <td>
                                                        <input type="checkbox" class="question-checkbox" value="104">
                                                    </td>
                                                    <td>
                                                        <div class="question-text">
                                                            <strong>¿Cuál es el plazo máximo para procesar una factura de proveedor?</strong>
                                                            <div class="text-muted small">ID: Q-2023-028</div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">Administrativa</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">Múltiple</span>
                                                    </td>
                                                    <td>
                                                        <div class="difficulty-stars" data-rating="2">
                                                            ★★☆☆☆
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">8 veces</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-info" onclick="viewQuestion(104)" title="Ver detalles">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning" onclick="editQuestion(104)" title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" onclick="deleteSingleQuestion(104)" title="Eliminar individual">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr data-section="5" data-type="practical" data-difficulty="hard" data-status="active" data-created="2024-01-08">
                                                    <td>
                                                        <input type="checkbox" class="question-checkbox" value="105">
                                                    </td>
                                                    <td>
                                                        <div class="question-text">
                                                            <strong>Demuestre el procedimiento de bloqueo y etiquetado (LOTO) para mantenimiento.</strong>
                                                            <div class="text-muted small">ID: Q-2024-002</div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success">Técnica</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-warning">Práctica</span>
                                                    </td>
                                                    <td>
                                                        <div class="difficulty-stars" data-rating="4">
                                                            ★★★★☆
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">15 veces</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-info" onclick="viewQuestion(105)" title="Ver detalles">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning" onclick="editQuestion(105)" title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" onclick="deleteSingleQuestion(105)" title="Eliminar individual">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr data-section="2" data-type="multiple" data-difficulty="easy" data-status="active" data-created="2023-09-15">
                                                    <td>
                                                        <input type="checkbox" class="question-checkbox" value="106">
                                                    </td>
                                                    <td>
                                                        <div class="question-text">
                                                            <strong>¿Cuál de los siguientes es un Equipo de Protección Personal (EPP) básico?</strong>
                                                            <div class="text-muted small">ID: Q-2023-019</div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-danger">Seguridad</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">Múltiple</span>
                                                    </td>
                                                    <td>
                                                        <div class="difficulty-stars" data-rating="1">
                                                            ★☆☆☆☆
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">36 veces</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-info" onclick="viewQuestion(106)" title="Ver detalles">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning" onclick="editQuestion(106)" title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" onclick="deleteSingleQuestion(106)" title="Eliminar individual">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6><i class="bi bi-clipboard-check me-2"></i> Resumen de Selección</h6>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <ul class="list-unstyled" id="selectionSummary">
                                                            <li>Preguntas seleccionadas: <strong>0</strong></li>
                                                            <li>Secciones afectadas: <strong>0</strong></li>
                                                            <li>Tipos variados: <strong>0</strong></li>
                                                        </ul>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="d-grid">
                                                            <button class="btn btn-danger btn-lg" onclick="deleteSelectedQuestions()" id="deleteQuestionsBtn" disabled>
                                                                <i class="bi bi-trash3 me-2"></i> Eliminar Preguntas Seleccionadas
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmación de eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i> Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <!-- Contenido dinámico se insertará aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-2"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash me-2"></i> Confirmar Eliminación
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar eventos
    const checkboxes = document.querySelectorAll('.question-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateQuestionStats);
    });
    
    // Inicializar estadísticas
    filterQuestions();
    updateQuestionStats();
    
    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function filterQuestions() {
    const sectionFilter = document.getElementById('filterSection').value;
    const typeFilter = document.getElementById('filterType').value;
    const difficultyFilter = document.getElementById('filterDifficulty').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const dateFilter = document.getElementById('filterDate').value;
    
    const rows = document.querySelectorAll('#questionsTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const section = row.getAttribute('data-section');
        const type = row.getAttribute('data-type');
        const difficulty = row.getAttribute('data-difficulty');
        const status = row.getAttribute('data-status');
        const created = row.getAttribute('data-created');
        
        const matchesSection = !sectionFilter || section === sectionFilter;
        const matchesType = !typeFilter || type === typeFilter;
        const matchesDifficulty = !difficultyFilter || difficulty === difficultyFilter;
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesDate = !dateFilter || created >= dateFilter;
        
        const shouldShow = matchesSection && matchesType && matchesDifficulty && matchesStatus && matchesDate;
        
        row.style.display = shouldShow ? '' : 'none';
        
        if (shouldShow) {
            visibleCount++;
        }
    });
    
    // Actualizar estadísticas
    document.getElementById('totalFiltered').textContent = visibleCount;
    updateQuestionStats();
}

function resetFilters() {
    document.getElementById('filterSection').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterDifficulty').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterDate').value = '';
    
    filterQuestions();
}

function toggleAllQuestions() {
    const selectAll = document.getElementById('selectAllQuestions');
    const checkboxes = document.querySelectorAll('.question-checkbox');
    const visibleRows = document.querySelectorAll('#questionsTable tbody tr:not([style*="display: none"])');
    
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (row.style.display !== 'none') {
            checkbox.checked = selectAll.checked;
        }
    });
    
    updateQuestionStats();
}

function selectAllQuestions() {
    const checkboxes = document.querySelectorAll('.question-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('selectAllQuestions').checked = true;
    updateQuestionStats();
}

function invertSelection() {
    const checkboxes = document.querySelectorAll('.question-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = !checkbox.checked;
    });
    updateQuestionStats();
}

function clearQuestionSelection() {
    const checkboxes = document.querySelectorAll('.question-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllQuestions').checked = false;
    updateQuestionStats();
}

function updateQuestionStats() {
    const checkboxes = document.querySelectorAll('.question-checkbox');
    const checked = document.querySelectorAll('.question-checkbox:checked');
    const visibleRows = document.querySelectorAll('#questionsTable tbody tr:not([style*="display: none"])');
    
    // Contadores
    const selectedCount = checked.length;
    const visibleCount = visibleRows.length;
    
    // Actualizar estadísticas básicas
    document.getElementById('totalSelected').textContent = selectedCount;
    document.getElementById('deleteQuestionsBtn').disabled = selectedCount === 0;
    
    // Actualizar resumen de selección
    const sections = new Set();
    const types = new Set();
    let totalDifficulty = 0;
    let totalUsage = 0;
    
    checked.forEach(checkbox => {
        const row = checkbox.closest('tr');
        sections.add(row.getAttribute('data-section'));
        types.add(row.getAttribute('data-type'));
        
        const difficulty = parseInt(row.querySelector('.difficulty-stars').getAttribute('data-rating'));
        totalDifficulty += difficulty;
        
        const usageText = row.cells[5].querySelector('.badge').textContent;
        const usage = parseInt(usageText) || 0;
        totalUsage += usage;
    });
    
    // Actualizar resumen
    document.getElementById('selectionSummary').innerHTML = `
        <li>Preguntas seleccionadas: <strong>${selectedCount}</strong></li>
        <li>Secciones afectadas: <strong>${sections.size}</strong></li>
        <li>Tipos variados: <strong>${types.size}</strong></li>
        <li>Usos totales: <strong>${totalUsage}</strong></li>
    `;
    
    // Calcular estadísticas avanzadas
    const avgDifficulty = selectedCount > 0 ? (totalDifficulty / selectedCount).toFixed(1) : '0.0';
    
    document.getElementById('avgDifficulty').textContent = avgDifficulty;
    document.getElementById('totalUsage').textContent = totalUsage;
    
    // Actualizar checkbox "seleccionar todos"
    const visibleCheckboxes = document.querySelectorAll('#questionsTable tbody tr:not([style*="display: none"]) .question-checkbox');
    const checkedVisible = document.querySelectorAll('#questionsTable tbody tr:not([style*="display: none"]) .question-checkbox:checked');
    
    const selectAllCheckbox = document.getElementById('selectAllQuestions');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = visibleCheckboxes.length > 0 && checkedVisible.length === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedVisible.length > 0 && checkedVisible.length < visibleCheckboxes.length;
    }
}

function viewQuestion(questionId) {
    // Simular modal de visualización
    alert(`Vista previa de pregunta ID: ${questionId}\n\nEsta funcionalidad mostraría un modal con todos los detalles de la pregunta, opciones de respuesta, retroalimentación, etc.`);
}

function editQuestion(questionId) {
    // Simular edición
    alert(`Editar pregunta ID: ${questionId}\n\nEsta funcionalidad redirigiría al formulario de edición de pregunta.`);
}

function deleteSingleQuestion(questionId) {
    // Obtener detalles de la pregunta
    const checkbox = document.querySelector(`.question-checkbox[value="${questionId}"]`);
    const row = checkbox.closest('tr');
    const questionText = row.cells[1].querySelector('strong').textContent;
    const section = row.cells[2].textContent;
    
    // Mostrar modal de confirmación
    const modalContent = `
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Está a punto de eliminar una pregunta individual.
        </div>
        
        <h6>Detalles de la pregunta:</h6>
        <ul>
            <li><strong>ID:</strong> ${questionId}</li>
            <li><strong>Pregunta:</strong> ${questionText.substring(0, 100)}...</li>
            <li><strong>Sección:</strong> ${section}</li>
        </ul>
        
        <div class="mb-3">
            <label for="singleDeleteReason" class="form-label">Razón de eliminación:</label>
            <textarea class="form-control" id="singleDeleteReason" rows="2" 
                      placeholder="Explique por qué está eliminando esta pregunta..."></textarea>
        </div>
        
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="singleDeleteReplace">
            <label class="form-check-label" for="singleDeleteReplace">
                Reemplazar con pregunta alternativa
            </label>
        </div>
    `;
    
    document.getElementById('modalContent').innerHTML = modalContent;
    
    // Configurar botón de confirmación
    document.getElementById('confirmDeleteBtn').onclick = function() {
        const reason = document.getElementById('singleDeleteReason').value;
        const replace = document.getElementById('singleDeleteReplace').checked;
        
        if (!reason.trim()) {
            alert('Por favor, proporcione una razón para la eliminación.');
            return;
        }
        
        // Simular eliminación
        showQuestionLoading();
        
        setTimeout(() => {
            hideQuestionLoading();
            
            // Eliminar la fila de la tabla
            row.remove();
            
            // Actualizar estadísticas
            updateQuestionStats();
            filterQuestions();
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            
            // Mostrar notificación de éxito
            showNotification(`Pregunta ID: ${questionId} eliminada exitosamente`, 'success');
            
        }, 1500);
    };
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function deleteSelectedQuestions() {
    const checkboxes = document.querySelectorAll('.question-checkbox:checked');
    const selectedCount = checkboxes.length;
    
    if (selectedCount === 0) {
        alert('Por favor, seleccione al menos una pregunta para eliminar.');
        return;
    }
    
    // Obtener detalles de las preguntas seleccionadas
    const selectedQuestions = [];
    const sections = new Set();
    
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const questionId = checkbox.value;
        const questionText = row.cells[1].querySelector('strong').textContent;
        const section = row.cells[2].textContent;
        
        selectedQuestions.push({
            id: questionId,
            text: questionText,
            section: section
        });
        
        sections.add(section);
    });
    
    // Preparar contenido del modal
    let modalContent = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-octagon me-2"></i>
            <strong>¡ATENCIÓN!</strong> Está a punto de eliminar <strong>${selectedCount}</strong> preguntas.
        </div>
        
        <h6>Resumen de la operación:</h6>
        <ul>
            <li><strong>Total de preguntas:</strong> ${selectedCount}</li>
            <li><strong>Secciones afectadas:</strong> ${sections.size}</li>
            <li><strong>Acción:</strong> Eliminación masiva</li>
        </ul>
        
        <div class="mb-3">
            <label for="bulkDeleteReason" class="form-label">Razón de eliminación *</label>
            <textarea class="form-control" id="bulkDeleteReason" rows="3" 
                      placeholder="Explique detalladamente por qué está eliminando estas preguntas..."
                      required></textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="bulkDeleteBackup" checked>
                    <label class="form-check-label" for="bulkDeleteBackup">
                        Crear copia de seguridad
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="bulkDeleteArchive">
                    <label class="form-check-label" for="bulkDeleteArchive">
                        Mover a archivo histórico
                    </label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="bulkDeleteNotify" checked>
                    <label class="form-check-label" for="bulkDeleteNotify">
                        Notificar a administradores
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="bulkDeleteReport">
                    <label class="form-check-label" for="bulkDeleteReport">
                        Generar reporte detallado
                    </label>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <details>
                <summary>Ver lista de preguntas seleccionadas (${selectedCount})</summary>
                <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                    <ul class="small">
    `;
    
    selectedQuestions.forEach((q, index) => {
        modalContent += `<li>${index + 1}. [ID: ${q.id}] ${q.text.substring(0, 80)}...</li>`;
    });
    
    modalContent += `
                    </ul>
                </div>
            </details>
        </div>
    `;
    
    document.getElementById('modalContent').innerHTML = modalContent;
    
    // Configurar botón de confirmación
    document.getElementById('confirmDeleteBtn').onclick = function() {
        const reason = document.getElementById('bulkDeleteReason').value;
        
        if (!reason.trim()) {
            alert('Por favor, proporcione una razón para la eliminación.');
            return;
        }
        
        // Simular eliminación masiva
        showQuestionLoading();
        
        setTimeout(() => {
            hideQuestionLoading();
            
            // Eliminar todas las filas seleccionadas
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                row.remove();
            });
            
            // Actualizar estadísticas
            updateQuestionStats();
            filterQuestions();
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            
            // Mostrar notificación de éxito
            showNotification(`${selectedCount} preguntas eliminadas exitosamente`, 'success');
            
            // Limpiar selección
            clearQuestionSelection();
            
        }, 2000);
    };
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function showQuestionLoading() {
    const button = document.getElementById('confirmDeleteBtn');
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Procesando...';
    button.disabled = true;
    button.setAttribute('data-original-text', originalText);
}

function hideQuestionLoading() {
    const button = document.getElementById('confirmDeleteBtn');
    const originalText = button.getAttribute('data-original-text');
    if (originalText) {
        button.innerHTML = originalText;
    }
    button.disabled = false;
}

function showNotification(message, type = 'info') {
    // Crear notificación
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Función para exportar preguntas seleccionadas
function exportQuestions() {
    const checkboxes = document.querySelectorAll('.question-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Por favor, seleccione al menos una pregunta para exportar.');
        return;
    }
    
    let exportData = "PREGUNTAS SELECCIONADAS PARA REVISIÓN/ELIMINACIÓN\n";
    exportData += "=".repeat(60) + "\n";
    exportData += "Fecha de exportación: " + new Date().toLocaleString() + "\n";
    exportData += "Total de preguntas: " + checkboxes.length + "\n\n";
    
    checkboxes.forEach((checkbox, index) => {
        const row = checkbox.closest('tr');
        const cells = row.cells;
        
        exportData += `[PREGUNTA ${index + 1}]\n`;
        exportData += `ID: ${checkbox.value}\n`;
        exportData += `Texto: ${cells[1].querySelector('strong').textContent}\n`;
        exportData += `Sección: ${cells[2].textContent}\n`;
        exportData += `Tipo: ${cells[3].textContent}\n`;
        exportData += `Dificultad: ${cells[4].querySelector('.difficulty-stars').getAttribute('data-rating')}/5\n`;
        exportData += `Usos: ${cells[5].textContent}\n`;
        exportData += "-".repeat(40) + "\n\n";
    });
    
    // Crear y descargar archivo
    const blob = new Blob([exportData], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `preguntas-seleccionadas-${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification(`Archivo exportado con ${checkboxes.length} preguntas`, 'info');
}
</script>

<style>
.stat-box {
    transition: transform 0.2s;
}

.stat-box:hover {
    transform: translateY(-2px);
}

.difficulty-stars {
    color: #ffc107;
    font-size: 0.9rem;
}

.question-text {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.table-hover tbody tr:hover {
    background-color: rgba(220, 53, 69, 0.05) !important;
}

.sticky-top {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 1;
}

#questionsTable tbody tr td:first-child {
    border-left: 3px solid transparent;
}

#questionsTable tbody tr input[type="checkbox"]:checked ~ td {
    border-left-color: #dc3545;
}

.modal-backdrop {
    z-index: 1040;
}

.modal {
    z-index: 1050;
}

details summary {
    cursor: pointer;
    padding: 5px;
    background-color: #f8f9fa;
    border-radius: 3px;
}

details[open] summary {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 10px;
}
</style>
{% endblock %}
