{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="bi bi-folder me-2"></i> Permisos de Directorios del Sistema</h3>
                        <span class="badge bg-light text-dark">Versi√≥n 2.1.4</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-4">
                        <i class="bi bi-shield-lock me-2"></i>
                        <strong>Descripci√≥n:</strong> Este m√≥dulo permite gestionar los permisos de acceso a los directorios del sistema MRO. 
                        Solo usuarios con rol de administrador, supervisor o planificador pueden modificar estos permisos.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-folder2-open me-2"></i> Directorios del Sistema</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Directorio</th>
                                                    <th>Archivos</th>
                                                    <th>Tama√±o</th>
                                                    <th>Propietario</th>
                                                    <th>Permisos Actuales</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for dir in directories %}
                                                <tr>
                                                    <td>
                                                        <code>{{ dir.name }}</code>
                                                        <br>
                                                        <small class="text-muted">Modificado: {{ dir.last_modified }}</small>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary rounded-pill">{{ dir.files }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">{{ dir.size }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-dark">{{ dir.owner|title }}</span>
                                                    </td>
                                                    <td>
                                                        <code class="bg-light p-1 rounded">{{ dir.permissions }}</code>
                                                        <br>
                                                        <small class="text-muted">
                                                            {% if dir.permissions == 'rwxr-xr-x' %}
                                                            Usuario: RWX, Grupo: R-X, Otros: R-X
                                                            {% elif dir.permissions == 'rwxrwxr-x' %}
                                                            Usuario: RWX, Grupo: RWX, Otros: R-X
                                                            {% elif dir.permissions == 'rw-r--r--' %}
                                                            Usuario: RW, Grupo: R, Otros: R
                                                            {% else %}
                                                            Personalizado
                                                            {% endif %}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary mb-1" onclick="showDirectoryInfo({{ dir.id }})">
                                                            <i class="bi bi-info-circle"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning mb-1" data-bs-toggle="modal" data-bs-target="#editModal{{ dir.id }}">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                
                                                <!-- Modal para editar permisos -->
                                                <div class="modal fade" id="editModal{{ dir.id }}" tabindex="-1">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">Editar Permisos: {{ dir.name }}</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                            </div>
                                                            <form method="POST" action="{{ url_for('simulator_mro.access_directories') }}">
                                                                <div class="modal-body">
                                                                    <input type="hidden" name="directory_id" value="{{ dir.id }}">
                                                                    
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Nuevos Permisos</label>
                                                                        <input type="text" class="form-control" name="permissions" 
                                                                               value="{{ dir.permissions }}" pattern="[r-][w-][x-][r-][w-][x-][r-][w-][x-]"
                                                                               title="Formato: rwxr-xr-x (lectura/escritura/ejecuci√≥n para usuario/grupo/otros)">
                                                                        <small class="text-muted">Ejemplo: rwxr-xr-x = Usuario(RWX), Grupo(R-X), Otros(R-X)</small>
                                                                    </div>
                                                                    
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Explicaci√≥n de Permisos</label>
                                                                        <div class="form-text">
                                                                            <strong>r</strong> = Lectura, 
                                                                            <strong>w</strong> = Escritura, 
                                                                            <strong>x</strong> = Ejecuci√≥n<br>
                                                                            <strong>-</strong> = Sin permiso
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                                    <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i> Estad√≠sticas del Sistema</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Directorios Totales
                                            <span class="badge bg-primary rounded-pill">{{ directories|length }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Archivos Totales
                                            <span class="badge bg-success rounded-pill">{{ directories|sum(attribute='files') }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Espacio Total Usado
                                            <span class="badge bg-warning rounded-pill">
                                                {% set total_mb = directories|sum(attribute='size')|replace(' MB','')|replace(' GB','000')|int %}
                                                {% if total_mb > 1000 %}
                                                    {{ (total_mb / 1000)|round(1) }} GB
                                                {% else %}
                                                    {{ total_mb }} MB
                                                {% endif %}
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            √öltimo Backup
                                            <span class="badge bg-info rounded-pill">Hoy 02:00</span>
                                        </li>
                                    </ul>
                                    
                                    <div class="mt-4">
                                        <h6><i class="bi bi-shield-check me-2"></i> Niveles de Permiso Recomendados</h6>
                                        <div class="list-group mt-2">
                                            <div class="list-group-item">
                                                <strong>rwxr-xr-x</strong>
                                                <small class="d-block">Configuraci√≥n p√∫blica (solo admin escribe)</small>
                                            </div>
                                            <div class="list-group-item">
                                                <strong>rwxrwxr-x</strong>
                                                <small class="d-block">Colaborativo (equipo puede modificar)</small>
                                            </div>
                                            <div class="list-group-item">
                                                <strong>rwx------</strong>
                                                <small class="d-block">Privado (solo propietario)</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <button class="btn btn-outline-success w-100 mb-2" onclick="createBackup()">
                                            <i class="bi bi-download me-2"></i>Crear Backup
                                        </button>
                                        <button class="btn btn-outline-info w-100" onclick="scanPermissions()">
                                            <i class="bi bi-search me-2"></i>Escanear Permisos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i> Gu√≠a R√°pida de Permisos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>¬øQu√© significan los permisos?</h6>
                                            <ul>
                                                <li><strong>Primer grupo (rwx)</strong>: Permisos del usuario propietario</li>
                                                <li><strong>Segundo grupo (r-x)</strong>: Permisos del grupo asignado</li>
                                                <li><strong>Tercer grupo (r--)</strong>: Permisos para otros usuarios</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Recomendaciones de Seguridad:</h6>
                                            <ul>
                                                <li>Nunca dar permisos de escritura a "otros" (tercer grupo)</li>
                                                <li>Directorios de configuraci√≥n: rwxr-xr-x</li>
                                                <li>Logs y backups: rwx------ (solo administrador)</li>
                                                <li>Datos de usuario: rwxrwx--- (equipo colaborativo)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showDirectoryInfo(dirId) {
    fetch(`/mro-simulator/api/get-directory-info/${dirId}`)
        .then(response => response.json())
        .then(data => {
            alert(`üìÅ Informaci√≥n del Directorio:\n\n` +
                  `ID: ${data.id}\n` +
                  `Nombre: ${data.name}\n` +
                  `Tama√±o: ${data.size}\n` +
                  `Archivos: ${data.files}\n` +
                  `√öltima modificaci√≥n: ${data.last_modified}`);
        })
        .catch(error => {
            alert('Error al obtener informaci√≥n del directorio');
        });
}

function createBackup() {
    if (confirm('¬øCrear backup completo de todos los directorios?\n\nEsto puede tomar varios minutos.')) {
        alert('üîÑ Creando backup...\n\nEl archivo se guardar√° en /mro/backups/backup_' + 
              new Date().toISOString().slice(0,10) + '.zip');
        
        // Simular proceso
        setTimeout(() => {
            alert('‚úÖ Backup completado exitosamente!');
        }, 2000);
    }
}

function scanPermissions() {
    alert('üîç Escaneando permisos del sistema...\n\nBuscando configuraciones inseguras.');
    
    setTimeout(() => {
        alert('üìä Resultados del escaneo:\n\n' +
              '‚Ä¢ 6 directorios analizados\n' +
              '‚Ä¢ 0 configuraciones inseguras encontradas\n' +
              '‚Ä¢ Sistema seguro ‚úì');
    }, 1500);
}

// Validar formulario de permisos
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const permissions = this.querySelector('input[name="permissions"]').value;
        const regex = /^[r-][w-][x-][r-][w-][x-][r-][w-][x-]$/;
        
        if (!regex.test(permissions)) {
            e.preventDefault();
            alert('‚ùå Formato de permisos inv√°lido.\n\nUse formato: rwxr-xr-x\n(r=lectura, w=escritura, x=ejecuci√≥n, -=sin permiso)');
            return false;
        }
        
        return true;
    });
});
</script>

<style>
code {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.modal-backdrop {
    z-index: 1040;
}

.modal {
    z-index: 1050;
}
</style>
{% endblock %}
