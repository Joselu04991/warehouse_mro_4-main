{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="bi bi-person-x me-2"></i> Gestión de Ausencias del Personal</h3>
                        <span class="badge bg-light text-dark">Activas: {{ absences|selectattr('status', 'equalto', 'Aprobada')|list|length + absences|selectattr('status', 'equalto', 'Pendiente')|list|length }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Descripción:</strong> Gestione solicitudes de ausencia del personal. Aprobaciones, rechazos y seguimiento. 
                        Solo supervisores, administradores y owners pueden gestionar aprobaciones.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i> Nueva Solicitud de Ausencia</h5>
                                </div>
                                <div class="card-body">
                                    <form id="absenceForm" onsubmit="return submitAbsenceForm()">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="employeeSelect" class="form-label">Empleado *</label>
                                                <select class="form-select" id="employeeSelect" required>
                                                    <option value="">Seleccionar empleado...</option>
                                                    <option value="{{ current_user.id }}">{{ current_user.username }} (Yo)</option>
                                                    <option value="1">Juan Pérez - Técnico Senior</option>
                                                    <option value="2">María González - Planificador</option>
                                                    <option value="3">Carlos Rodríguez - Supervisor</option>
                                                    <option value="4">Ana Martínez - Operadora</option>
                                                    <option value="5">Luis Fernández - Almacenista</option>
                                                    <option value="6">Sofía Ramírez - Control Calidad</option>
                                                    <option value="7">Pedro Gómez - Mantenimiento</option>
                                                </select>
                                                <div class="form-text">Seleccione el empleado que solicita ausencia</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="absenceType" class="form-label">Tipo de Ausencia *</label>
                                                <select class="form-select" id="absenceType" required onchange="updateRequirements()">
                                                    <option value="">Seleccionar tipo...</option>
                                                    <option value="vacation">Vacaciones Programadas</option>
                                                    <option value="sick">Enfermedad / Consulta Médica</option>
                                                    <option value="personal">Asuntos Personales</option>
                                                    <option value="training">Capacitación / Curso Externo</option>
                                                    <option value="emergency">Emergencia Familiar</option>
                                                    <option value="maternity">Licencia por Maternidad/Paternidad</option>
                                                    <option value="bereavement">Duelo por Fallecimiento</option>
                                                    <option value="other">Otro</option>
                                                </select>
                                                <div class="form-text">Categoría principal de la ausencia</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="startDate" class="form-label">Fecha de Inicio *</label>
                                                <input type="date" class="form-control" id="startDate" 
                                                       value="{{ today_date }}" min="{{ today_date }}" required onchange="calculateDays()">
                                                <div class="form-text">Primer día de ausencia</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="endDate" class="form-label">Fecha de Fin *</label>
                                                <input type="date" class="form-control" id="endDate" 
                                                       value="{{ today_date }}" required onchange="calculateDays()">
                                                <div class="form-text">Último día de ausencia</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <div class="card bg-light">
                                                    <div class="card-body py-2">
                                                        <div class="row text-center">
                                                            <div class="col-4">
                                                                <h5 id="totalDays">0</h5>
                                                                <small>Días Totales</small>
                                                            </div>
                                                            <div class="col-4">
                                                                <h5 id="workingDays">0</h5>
                                                                <small>Días Laborables</small>
                                                            </div>
                                                            <div class="col-4">
                                                                <h5 id="weekendDays">0</h5>
                                                                <small>Fines de Semana</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="reason" class="form-label">Motivo Detallado *</label>
                                            <textarea class="form-control" id="reason" rows="3" 
                                                      placeholder="Describa el motivo de la ausencia con detalle. Para enfermedades, incluya síntomas y tratamiento. Para vacaciones, indique destino." 
                                                      required></textarea>
                                            <div class="form-text">Proporcione información suficiente para la aprobación</div>
                                            <div class="mt-1">
                                                <small id="reasonCharCount" class="text-muted">0/1000 caracteres</small>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="contactDuring" class="form-label">Contacto durante ausencia</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                                    <input type="tel" class="form-control" id="contactDuring" 
                                                           placeholder="+34 600 123 456">
                                                </div>
                                                <div class="form-text">Teléfono para emergencias</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="backupPerson" class="form-label">Persona de Respaldo</label>
                                                <select class="form-select" id="backupPerson">
                                                    <option value="">Sin respaldo asignado</option>
                                                    <option value="1">Juan Pérez</option>
                                                    <option value="2">María González</option>
                                                    <option value="3">Carlos Rodríguez</option>
                                                    <option value="4">Ana Martínez</option>
                                                </select>
                                                <div class="form-text">Quién cubrirá sus responsabilidades</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3" id="documentationSection" style="display: none;">
                                            <label for="documentation" class="form-label">Documentación de Soporte</label>
                                            <input type="file" class="form-control" id="documentation" 
                                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                            <div class="form-text" id="docRequirements"></div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Notificaciones</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="notifyTeam">
                                                <label class="form-check-label" for="notifyTeam">
                                                    Notificar a todo el equipo
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="outOfOffice">
                                                <label class="form-check-label" for="outOfOffice">
                                                    Activar respuesta automática de correo
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-danger">
                                                <i class="bi bi-send me-2"></i> Enviar Solicitud de Ausencia
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i> Acciones Rápidas</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <a href="#" class="btn btn-outline-primary">
                                            <i class="bi bi-calendar-check me-2"></i> Ver Calendario de Ausencias
                                        </a>
                                        <a href="#" class="btn btn-outline-success">
                                            <i class="bi bi-file-earmark-text me-2"></i> Generar Reporte Mensual
                                        </a>
                                        <a href="#" class="btn btn-outline-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i> Ausencias Urgentes
                                        </a>
                                        <a href="#" class="btn btn-outline-info">
                                            <i class="bi bi-graph-up me-2"></i> Estadísticas por Departamento
                                        </a>
                                    </div>
                                    
                                    <hr>
                                    
                                    <h6 class="mt-3"><i class="bi bi-info-square me-2"></i> Información Importante</h6>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Vacaciones aprobadas
                                            <span class="badge bg-success rounded-pill">12</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Pendientes de revisión
                                            <span class="badge bg-warning rounded-pill">3</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Ausencias médicas activas
                                            <span class="badge bg-info rounded-pill">2</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Solicitudes rechazadas este mes
                                            <span class="badge bg-danger rounded-pill">1</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i> Solicitudes Recientes</h5>
                                        <div>
                                            <select class="form-select form-select-sm" style="width: auto;">
                                                <option selected>Todas las solicitudes</option>
                                                <option>Pendientes</option>
                                                <option>Aprobadas</option>
                                                <option>Rechazadas</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Empleado</th>
                                                    <th>Tipo</th>
                                                    <th>Período</th>
                                                    <th>Días</th>
                                                    <th>Estado</th>
                                                    <th>Solicitado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                                <span class="text-white">JP</span>
                                                            </div>
                                                            <div>
                                                                <strong>Juan Pérez</strong><br>
                                                                <small class="text-muted">Técnico Senior</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info">Vacaciones</span>
                                                    </td>
                                                    <td>
                                                        <small>15 - 22 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <strong>7</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success">Aprobada</span>
                                                    </td>
                                                    <td>
                                                        <small>10 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm bg-warning rounded-circle d-flex align-items-center justify-content-center me-2">
                                                                <span class="text-white">AG</span>
                                                            </div>
                                                            <div>
                                                                <strong>Ana Gómez</strong><br>
                                                                <small class="text-muted">Operadora</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-danger">Enfermedad</span>
                                                    </td>
                                                    <td>
                                                        <small>18 - 20 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <strong>3</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-warning">Pendiente</span>
                                                    </td>
                                                    <td>
                                                        <small>17 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm bg-success rounded-circle d-flex align-items-center justify-content-center me-2">
                                                                <span class="text-white">MG</span>
                                                            </div>
                                                            <div>
                                                                <strong>María González</strong><br>
                                                                <small class="text-muted">Planificador</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">Capacitación</span>
                                                    </td>
                                                    <td>
                                                        <small>25 - 26 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <strong>2</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success">Aprobada</span>
                                                    </td>
                                                    <td>
                                                        <small>12 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm bg-info rounded-circle d-flex align-items-center justify-content-center me-2">
                                                                <span class="text-white">CR</span>
                                                            </div>
                                                            <div>
                                                                <strong>Carlos Rodríguez</strong><br>
                                                                <small class="text-muted">Supervisor</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-dark">Asuntos Personales</span>
                                                    </td>
                                                    <td>
                                                        <small>30 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <strong>1</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-danger">Rechazada</span>
                                                    </td>
                                                    <td>
                                                        <small>14 Ene 2024</small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar contador de caracteres
    const reasonTextarea = document.getElementById('reason');
    const charCount = document.getElementById('reasonCharCount');
    
    if (reasonTextarea) {
        reasonTextarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = `${length}/1000 caracteres`;
            
            if (length > 1000) {
                charCount.classList.remove('text-muted');
                charCount.classList.add('text-danger');
            } else {
                charCount.classList.remove('text-danger');
                charCount.classList.add('text-muted');
            }
        });
        
        // Calcular días iniciales
        calculateDays();
    }
});

function calculateDays() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) return;
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        document.getElementById('endDate').value = startDate;
        alert('La fecha de fin no puede ser anterior a la fecha de inicio');
        return;
    }
    
    // Calcular días totales
    const diffTime = Math.abs(end - start);
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    
    // Calcular días laborables y fines de semana
    let workingDays = 0;
    let weekendDays = 0;
    
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const day = d.getDay();
        if (day === 0 || day === 6) {
            weekendDays++;
        } else {
            workingDays++;
        }
    }
    
    document.getElementById('totalDays').textContent = totalDays;
    document.getElementById('workingDays').textContent = workingDays;
    document.getElementById('weekendDays').textContent = weekendDays;
}

function updateRequirements() {
    const type = document.getElementById('absenceType').value;
    const docSection = document.getElementById('documentationSection');
    const docRequirements = document.getElementById('docRequirements');
    
    if (type === 'sick') {
        docSection.style.display = 'block';
        docRequirements.textContent = 'Requiere justificante médico (obligatorio para ausencias > 3 días)';
        docRequirements.classList.remove('text-muted');
        docRequirements.classList.add('text-danger');
        document.getElementById('documentation').required = true;
    } else if (type === 'maternity' || type === 'training') {
        docSection.style.display = 'block';
        docRequirements.textContent = 'Documentación de soporte recomendada';
        docRequirements.classList.remove('text-danger');
        docRequirements.classList.add('text-info');
        document.getElementById('documentation').required = false;
    } else {
        docSection.style.display = 'none';
        document.getElementById('documentation').required = false;
    }
}

function submitAbsenceForm() {
    // Validación básica
    const employee = document.getElementById('employeeSelect').value;
    const type = document.getElementById('absenceType').value;
    const reason = document.getElementById('reason').value;
    
    if (!employee || !type || !reason) {
        alert('Por favor, complete todos los campos obligatorios (*)');
        return false;
    }
    
    if (reason.length < 20) {
        alert('El motivo debe tener al menos 20 caracteres');
        return false;
    }
    
    // Mostrar confirmación
    if (confirm('¿Está seguro de enviar esta solicitud de ausencia?')) {
        // Simular envío
        alert('Solicitud enviada correctamente. Será revisada por el supervisor.');
        // Aquí iría la lógica real de envío
        // document.getElementById('absenceForm').submit();
    }
    
    return false; // Prevenir envío real para este ejemplo
}
</script>

<style>
.avatar-sm {
    width: 36px;
    height: 36px;
    font-size: 0.875rem;
    font-weight: bold;
}

.table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}
