{% extends "simulator_mro/base.html" %}

{% block title %}Clasificaci√≥n - Simulador MRO{% endblock %}

{% block extra_css %}
<style>
    .leaderboard-table {
        background: #1e293b;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .leaderboard-header {
        background: linear-gradient(135deg, #0f172a, #1e293b);
        padding: 20px;
        border-bottom: 2px solid #2d3748;
    }
    
    .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
    .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e0e0e0); }
    .rank-3 { background: linear-gradient(135deg, #cd7f32, #e69542); }
    
    .rank-badge {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .user-row {
        transition: all 0.3s ease;
        border-bottom: 1px solid #2d3748;
    }
    
    .user-row:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateX(5px);
    }
    
    .user-row.current-user {
        background: rgba(13, 110, 253, 0.15);
        border-left: 4px solid #0d6efd;
    }
    
    .stats-badge {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 4px 12px;
        font-size: 0.85rem;
    }
    
    .filter-btn.active {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="leaderboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-2">
                    <i class="fas fa-trophy me-2 text-warning"></i> Tabla de Clasificaci√≥n
                </h1>
                <p class="text-muted mb-0">
                    Compite con otros usuarios y mejora tus habilidades en gesti√≥n de almac√©n MRO
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="h2 mb-0">{{ current_user.mro_score }}</div>
                <small class="text-muted">Tu puntuaci√≥n</small>
                <div class="mt-2">
                    <span class="badge level-{{ current_user.role }}">{{ current_user.role_display }}</span>
                    <span class="badge bg-info">{{ current_user.mro_level }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="mro-card p-3 mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-0">Filtrar por rol:</h6>
            </div>
            <div class="col-md-6">
                <div class="btn-group btn-group-sm w-100" role="group">
                    <button type="button" class="btn btn-outline-light filter-btn active" data-role="all">
                        Todos
                    </button>
                    <button type="button" class="btn btn-outline-light filter-btn" data-role="aprendiz">
                        Aprendices
                    </button>
                    <button type="button" class="btn btn-outline-light filter-btn" data-role="tecnico_almacen">
                        T√©cnicos
                    </button>
                    <button type="button" class="btn btn-outline-light filter-btn" data-role="planificador">
                        Planificadores
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabla de clasificaci√≥n -->
    <div class="leaderboard-table">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 80px;" class="text-center">Posici√≥n</th>
                        <th>Usuario</th>
                        <th class="text-center">Rol</th>
                        <th class="text-center">Nivel</th>
                        <th class="text-center">Puntuaci√≥n</th>
                        <th class="text-center">Escenarios</th>
                        <th class="text-center">Efectividad</th>
                        <th class="text-center">XP</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Loading -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando clasificaci√≥n...</p>
    </div>
    
    <!-- Tu posici√≥n -->
    <div id="user-position" class="mro-card p-4 mt-4 d-none">
        <h6 class="mb-3">
            <i class="fas fa-user me-2"></i> Tu posici√≥n en la clasificaci√≥n
        </h6>
        <div id="current-user-row">
            <!-- Se llenar√° din√°micamente -->
        </div>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="row mt-4">
        <div class="col-md-4 mb-3">
            <div class="mro-card p-3 h-100">
                <div class="text-center">
                    <div class="display-6" id="total-players">0</div>
                    <small class="text-muted">Jugadores activos</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="mro-card p-3 h-100">
                <div class="text-center">
                    <div class="display-6" id="avg-score">0</div>
                    <small class="text-muted">Puntuaci√≥n promedio</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="mro-card p-3 h-100">
                <div class="text-center">
                    <div class="display-6" id="total-scenarios">0</div>
                    <small class="text-muted">Escenarios jugados</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentFilter = 'all';
    
    // Cargar leaderboard inicial
    loadLeaderboard(currentFilter);
    
    // Filtros
    $('.filter-btn').click(function() {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        currentFilter = $(this).data('role');
        loadLeaderboard(currentFilter);
    });
    
    // Funci√≥n para cargar leaderboard
    function loadLeaderboard(role) {
        $('#loading').show();
        $('#leaderboard-body').empty();
        $('#user-position').hide();
        
        $.getJSON('{{ url_for("simulator_mro.get_leaderboard") }}?role=' + role)
            .done(function(data) {
                $('#loading').hide();
                renderLeaderboard(data.leaderboard);
                updateStats(data.leaderboard);
            })
            .fail(function() {
                $('#loading').html('<div class="alert alert-danger">Error al cargar la clasificaci√≥n</div>');
            });
    }
    
    // Renderizar tabla
    function renderLeaderboard(players) {
        let html = '';
        let currentUserFound = false;
        
        players.forEach(function(player, index) {
            const isCurrentUser = player.username === '{{ current_user.username }}';
            const rowClass = isCurrentUser ? 'current-user' : '';
            
            // Iconos seg√∫n rol
            let roleIcon = 'üë∑';
            if (player.role.includes('T√©cnico')) roleIcon = 'üîß';
            if (player.role.includes('Planificador')) roleIcon = 'üìä';
            if (player.role.includes('Supervisor')) roleIcon = 'üë®‚Äçüíº';
            
            html += `
            <tr class="user-row ${rowClass}" data-rank="${index + 1}">
                <td class="text-center align-middle">
                    ${getRankBadge(index + 1)}
                </td>
                <td class="align-middle">
                    <div class="d-flex align-items-center">
                        <div class="me-3 fs-5">${roleIcon}</div>
                        <div>
                            <div class="fw-bold">${player.username}</div>
                            <div class="small text-muted">${player.department || 'Almac√©n MRO'}</div>
                        </div>
                        ${isCurrentUser ? '<span class="badge bg-info ms-2">T√ö</span>' : ''}
                    </div>
                </td>
                <td class="text-center align-middle">
                    <span class="badge level-${player.role.toLowerCase().split(' ')[0]}">
                        ${player.role}
                    </span>
                </td>
                <td class="text-center align-middle">
                    <span class="stats-badge">${player.level}</span>
                </td>
                <td class="text-center align-middle">
                    <div class="h5 mb-0">${player.score}</div>
                </td>
                <td class="text-center align-middle">
                    <div class="small">${player.scenarios_completed}</div>
                </td>
                <td class="text-center align-middle">
                    <div class="progress progress-mro" style="width: 80px; margin: 0 auto;">
                        <div class="progress-bar bg-success" style="width: ${player.accuracy}%"></div>
                    </div>
                    <small>${player.accuracy}%</small>
                </td>
                <td class="text-center align-middle">
                    <span class="stats-badge">${player.xp}</span>
                </td>
            </tr>`;
            
            if (isCurrentUser) {
                currentUserFound = true;
                renderCurrentUserRow(player, index + 1);
            }
        });
        
        $('#leaderboard-body').html(html);
        
        if (currentUserFound) {
            $('#user-position').show();
        }
    }
    
    // Badge seg√∫n posici√≥n
    function getRankBadge(rank) {
        if (rank === 1) {
            return '<div class="rank-badge rank-1 text-dark mx-auto">ü•á</div>';
        } else if (rank === 2) {
            return '<div class="rank-badge rank-2 text-dark mx-auto">ü•à</div>';
        } else if (rank === 3) {
            return '<div class="rank-badge rank-3 text-dark mx-auto">ü•â</div>';
        } else {
            return `<div class="rank-badge bg-dark text-light mx-auto">${rank}</div>`;
        }
    }
    
    // Fila del usuario actual
    function renderCurrentUserRow(player, rank) {
        const html = `
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                ${getRankBadge(rank)}
                <div class="ms-3">
                    <div class="fw-bold">{{ current_user.username }}</div>
                    <div class="small text-muted">{{ current_user.role_display }}</div>
                </div>
            </div>
            <div class="text-end">
                <div class="h4 mb-0">${player.score}</div>
                <div class="small text-muted">
                    ${player.scenarios_completed} escenarios | ${player.accuracy}% efectividad
                </div>
            </div>
        </div>`;
        
        $('#current-user-row').html(html);
    }
    
    // Actualizar estad√≠sticas
    function updateStats(players) {
        if (players.length === 0) return;
        
        const totalPlayers = players.length;
        const totalScore = players.reduce((sum, player) => sum + player.score, 0);
        const avgScore = Math.round(totalScore / totalPlayers);
        const totalScenarios = players.reduce((sum, player) => sum + player.scenarios_completed, 0);
        
        $('#total-players').text(totalPlayers);
        $('#avg-score').text(avgScore);
        $('#total-scenarios').text(totalScenarios);
    }
    
    // Auto-refresh cada 30 segundos
    setInterval(function() {
        loadLeaderboard(currentFilter);
    }, 30000);
});
</script>
{% endblock %}
{% endblock %}
