{% extends "base.html" %}
{% block title %}Mapa 2D Inteligente del Almacén - Sistema de Gestión{% endblock %}

{% block content %}
<style>
    /* Estilos CSS (mantén los que ya tienes) */
    .warehouse-container { padding: 20px; }
    .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; border-radius: 10px; margin-bottom: 20px; }
    .title-main { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
    .subtitle { font-size: 1.1rem; opacity: 0.9; }
    .upload-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: transform 0.2s; }
    .upload-btn:hover { transform: translateY(-2px); color: white; }
    .control-panel { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .filter-buttons { display: flex; gap: 10px; margin: 15px 0; }
    .filter-btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .filter-btn.active { transform: scale(1.05); }
    .btn-todos { background: #6c757d; color: white; }
    .btn-normal { background: #28a745; color: white; }
    .btn-bajo { background: #ffc107; color: white; }
    .btn-critico { background: #dc3545; color: white; }
    .btn-vacio { background: #adb5bd; color: white; }
    .legend { display: flex; gap: 20px; margin-top: 15px; }
    .legend-item { display: flex; align-items: center; gap: 8px; }
    .legend-color { width: 20px; height: 20px; border-radius: 4px; }
    .map-container-wrapper { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .map-title { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
    .map-stats { display: flex; gap: 30px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.8rem; font-weight: bold; display: block; }
    .stat-label { font-size: 0.9rem; color: #6c757d; }
    .map-grid-container { overflow: auto; max-height: 600px; padding: 20px; background: #f8f9fa; border-radius: 8px; position: relative; }
    .map-grid { display: grid; gap: 3px; margin: 0 auto; transition: transform 0.3s; }
    .location-cell { border-radius: 6px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; font-size: 0.7rem; color: white; min-width: 45px; min-height: 45px; }
    .location-cell:hover { transform: scale(1.05); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    .location-cell.normal { background-color: #28a745; }
    .location-cell.bajo { background-color: #ffc107; }
    .location-cell.critico { background-color: #dc3545; }
    .location-cell.vacio { background-color: #6c757d; opacity: 0.5; }
    .location-cell.empty { background-color: #f8f9fa; border: 1px dashed #dee2e6; }
    .location-cell.highlighted { box-shadow: 0 0 0 3px #007bff; z-index: 10; }
    .location-code { font-weight: bold; font-size: 0.6rem; }
    .location-percent { font-size: 0.8rem; font-weight: bold; }
    .sidebar-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .card-header-custom { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .kpi-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .kpi-item:last-child { border-bottom: none; }
    .kpi-label { font-weight: 500; }
    .kpi-subtext { font-size: 0.8rem; color: #6c757d; }
    .kpi-value { font-size: 1.3rem; font-weight: bold; }
    .counter-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
    .counter-item:hover { background: #f8f9fa; }
    .counter-item.active { background: #e7f1ff; }
    .counter-color { width: 20px; height: 20px; border-radius: 4px; }
    .color-normal { background-color: #28a745; }
    .color-bajo { background-color: #ffc107; }
    .color-critico { background-color: #dc3545; }
    .color-vacio { background-color: #6c757d; }
    .counter-label { flex-grow: 1; }
    .counter-value { font-weight: bold; }
    .counter-percent { font-size: 0.8rem; color: #6c757d; margin-left: 5px; }
    .filter-section { margin-top: 10px; }
    .filter-group { margin-bottom: 15px; }
    .filter-label { font-weight: 500; margin-bottom: 5px; display: block; }
    .btn-apply-filters { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: 500; cursor: pointer; }
    .modal-custom .modal-content { border-radius: 15px; border: none; }
    .modal-custom .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0; }
    .location-badge { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; margin-left: 10px; }
    .modal-section { margin-bottom: 25px; }
    .modal-section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .info-card { background: #f8f9fa; border-radius: 8px; padding: 15px; }
    .info-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .info-label { font-weight: 500; color: #6c757d; }
    .info-value { font-weight: bold; }
    .progress-custom { height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; }
    .progress-bar { height: 100%; transition: width 0.3s; }
    .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
    .bg-normal { background-color: #28a745; color: white; }
    .bg-bajo { background-color: #ffc107; color: white; }
    .bg-critico { background-color: #dc3545; color: white; }
    .bg-vacio { background-color: #6c757d; color: white; }
    .materials-table { font-size: 0.9rem; }
    .materials-table th { background: #f8f9fa; }
    .tooltip-custom { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 6px; font-size: 0.9rem; z-index: 9999; pointer-events: none; transition: opacity 0.3s; max-width: 250px; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; }
    .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { color: white; font-size: 1.2rem; }
    .no-results { text-align: center; padding: 50px; color: #6c757d; }
    .search-container { position: relative; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; }
    .search-input { padding-left: 40px; }
    .zoom-controls { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 5px 10px; border-radius: 6px; }
    .zoom-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
    .zoom-level { font-weight: bold; min-width: 50px; text-align: center; }
    .view-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
    .view-options { display: flex; gap: 10px; }
    .view-btn { padding: 8px 15px; border: 1px solid #dee2e6; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .view-btn.active { background: #007bff; color: white; border-color: #007bff; }
</style>

<div class="warehouse-container">
    <!-- ================= HEADER PRINCIPAL ================= -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8 col-md-7">
                    <h1 class="title-main fade-in">
                        <i class="bi bi-grid-3x3-gap-fill"></i> Mapa 2D Inteligente del Almacén
                    </h1>
                    <p class="subtitle slide-in" id="warehouse-info">
                        {% if has_data %}
                        {{ total_locations }} ubicaciones • {{ total_materials }} materiales • Última actualización: {{ last_update }}
                        {% else %}
                        Visualización avanzada del inventario • Carga un archivo Excel para comenzar
                        {% endif %}
                    </p>
                </div>
                <div class="col-lg-4 col-md-5">
                    <div class="d-flex flex-column flex-md-row gap-2">
                        <a href="{{ url_for('warehouse2d.upload_view') }}" class="upload-btn scale-in">
                            <i class="bi bi-cloud-upload-fill"></i> 
                            <span>
                                {% if has_data %}
                                Actualizar Excel
                                {% else %}
                                Cargar Excel 2D
                                {% endif %}
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        {% if not has_data %}
        <!-- ================= ESTADO SIN DATOS ================= -->
        <div class="row justify-content-center mt-5">
            <div class="col-md-8">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-inbox"></i> No hay datos cargados</h4>
                    </div>
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-cloud-upload" style="font-size: 4rem; color: #6c757d;"></i>
                        </div>
                        <h3 class="text-muted mb-3">Comienza cargando un archivo Excel</h3>
                        <p class="text-muted mb-4">
                            Para visualizar el mapa 2D de tu almacén, primero necesitas cargar un archivo Excel 
                            con la estructura de ubicaciones y materiales.
                        </p>
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5><i class="bi bi-info-circle text-info"></i> Formato requerido:</h5>
                                        <ul class="text-start">
                                            <li><strong>Ubicación:</strong> Código único (ej: A-01-01)</li>
                                            <li><strong>Código del Material:</strong> Identificador del material</li>
                                            <li><strong>Stock máximo:</strong> Capacidad máxima</li>
                                            <li><strong>Libre utilización:</strong> Stock actual</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="{{ url_for('warehouse2d.upload_view') }}" class="btn btn-primary btn-lg">
                            <i class="bi bi-cloud-upload-fill"></i> Cargar Archivo Excel
                        </a>
                        <div class="mt-3">
                            <a href="{{ url_for('warehouse2d.download_template') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-download"></i> Descargar Plantilla
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- ================= CONTENIDO CON DATOS ================= -->
        <div class="row">
            <!-- ================= PANEL PRINCIPAL (MAPA) ================= -->
            <div class="col-xl-9 col-lg-8">
                <!-- Panel de Control Avanzado -->
                <div class="control-panel scale-in">
                    <div class="row align-items-center g-3">
                        <!-- Información del Archivo -->
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-file-earmark-excel-fill text-success" style="font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Archivo cargado:</div>
                                    <div class="fw-bold">{{ file_name }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Buscador Avanzado -->
                        <div class="col-md-5">
                            <div class="search-container">
                                <i class="bi bi-search search-icon"></i>
                                <input type="text" 
                                       class="form-control search-input" 
                                       id="searchBox" 
                                       placeholder="Buscar ubicación, material o código..."
                                       aria-label="Buscar en el almacén"
                                       autocomplete="off">
                            </div>
                        </div>
                        
                        <!-- Controles Avanzados -->
                        <div class="col-md-3">
                            <div class="d-flex justify-content-end align-items-center gap-2">
                                <div class="zoom-controls">
                                    <button class="zoom-btn" onclick="zoomOut()" title="Alejar (Ctrl -)" aria-label="Alejar vista">
                                        <i class="bi bi-dash-lg"></i>
                                    </button>
                                    <span class="zoom-level" id="zoomLevel">100%</span>
                                    <button class="zoom-btn" onclick="zoomIn()" title="Acercar (Ctrl +)" aria-label="Acercar vista">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros por Estado -->
                    <div class="filter-buttons">
                        <button class="filter-btn btn-todos active" onclick="filterStatus('todos')" data-status="todos">
                            <i class="bi bi-grid-fill"></i> Todas
                        </button>
                        <button class="filter-btn btn-normal" onclick="filterStatus('normal')" data-status="normal">
                            <i class="bi bi-check-circle-fill"></i> Normal
                        </button>
                        <button class="filter-btn btn-bajo" onclick="filterStatus('bajo')" data-status="bajo">
                            <i class="bi bi-exclamation-triangle-fill"></i> Bajo
                        </button>
                        <button class="filter-btn btn-critico" onclick="filterStatus('critico')" data-status="critico">
                            <i class="bi bi-x-circle-fill"></i> Crítico
                        </button>
                        <button class="filter-btn btn-vacio" onclick="filterStatus('vacio')" data-status="vacio">
                            <i class="bi bi-dash-circle-fill"></i> Vacío
                        </button>
                    </div>

                    <!-- Controles de Vista -->
                    <div class="view-controls">
                        <div class="view-options">
                            <button class="view-btn active" onclick="setViewMode('grid')" data-view="grid">
                                <i class="bi bi-grid-3x3"></i> Vista Grid
                            </button>
                            <button class="view-btn" onclick="setViewMode('list')" data-view="list">
                                <i class="bi bi-list-ul"></i> Vista Lista
                            </button>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                                <i class="bi bi-arrow-repeat"></i> Actualizar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearData()" title="Borrar todos los datos">
                                <i class="bi bi-trash"></i> Limpiar
                            </button>
                        </div>
                    </div>

                    <!-- Leyenda Avanzada -->
                    <div class="legend fade-in">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #28a745;"></div>
                            <div class="legend-text">
                                <span>Normal</span>
                                <span class="legend-range">≥ 50% ocupación</span>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffc107;"></div>
                            <div class="legend-text">
                                <span>Stock Bajo</span>
                                <span class="legend-range">20% - 49%</span>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #dc3545;"></div>
                            <div class="legend-text">
                                <span>Crítico</span>
                                <span class="legend-range">1% - 19%</span>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #6c757d;"></div>
                            <div class="legend-text">
                                <span>Vacío</span>
                                <span class="legend-range">0% ocupación</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor del Mapa -->
                <div class="map-container-wrapper scale-in">
                    <div class="map-header">
                        <div class="map-title">
                            <i class="bi bi-map"></i> Distribución 2D del Almacén
                            <span class="badge bg-secondary ms-2" id="currentView">Vista Grid</span>
                        </div>
                        <div class="map-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="total-locations">{{ total_locations }}</span>
                                <span class="stat-label">Ubicaciones</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="visible-locations">0</span>
                                <span class="stat-label">Visibles</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="occupied-locations">0</span>
                                <span class="stat-label">Ocupadas</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="ocupation-rate">0%</span>
                                <span class="stat-label">Ocupación</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="map-grid-container" id="map-container">
                        <div id="map-grid" class="map-grid"></div>
                        <div id="no-results" class="no-results d-none">
                            <i class="bi bi-inboxes"></i>
                            <h4>No se encontraron ubicaciones</h4>
                            <p>Intenta cambiar los filtros o ajustar la búsqueda para ver los resultados.</p>
                            <button class="btn btn-primary mt-3" onclick="resetAllFilters()">
                                <i class="bi bi-filter-circle"></i> Restablecer filtros
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showLabels" checked onchange="toggleLabels()">
                                <label class="form-check-label" for="showLabels">
                                    Mostrar etiquetas
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showGrid" checked onchange="toggleGrid()">
                                <label class="form-check-label" for="showGrid">
                                    Mostrar grid
                                </label>
                            </div>
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-info-circle"></i> Haz clic en una celda para ver detalles
                        </div>
                    </div>
                </div>
                
                <!-- Vista Lista (oculta por defecto) -->
                <div id="list-view" class="d-none">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Ubicaciones</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Ubicación</th>
                                            <th>Zona</th>
                                            <th>Fila</th>
                                            <th>Columna</th>
                                            <th>Materiales</th>
                                            <th>Stock</th>
                                            <th>Capacidad</th>
                                            <th>Ocupación</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="locations-table">
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= PANEL LATERAL (KPIs) ================= -->
            <div class="col-xl-3 col-lg-4">
                <!-- Información del Archivo -->
                <div class="sidebar-card fade-in">
                    <div class="card-header-custom">
                        <i class="bi bi-file-earmark-text-fill"></i> Información del Archivo
                    </div>
                    <div class="card-body p-0">
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Nombre Archivo</div>
                                <div class="kpi-subtext" id="file-name">{{ file_name }}</div>
                            </div>
                            <div class="kpi-value">
                                <i class="bi bi-filetype-xlsx text-success"></i>
                            </div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Total Ubicaciones</div>
                                <div class="kpi-subtext">Únicas en el sistema</div>
                            </div>
                            <div class="kpi-value" id="total-locations-side">{{ total_locations }}</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Total Materiales</div>
                                <div class="kpi-subtext">Diferentes SKUs</div>
                            </div>
                            <div class="kpi-value" id="total-materials">{{ total_materials }}</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Última Carga</div>
                                <div class="kpi-subtext">Fecha y hora</div>
                            </div>
                            <div class="kpi-value" style="font-size: 0.9rem;">{{ last_update }}</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Tamaño del Almacén</div>
                                <div class="kpi-subtext">Filas x Columnas</div>
                            </div>
                            <div class="kpi-value" id="warehouse-size">0x0</div>
                        </div>
                    </div>
                </div>

                <!-- Panel de KPIs Avanzados -->
                <div class="sidebar-card fade-in">
                    <div class="card-header-custom">
                        <i class="bi bi-graph-up-arrow"></i> KPIs del Almacén
                    </div>
                    <div class="card-body p-0">
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Ocupación Total</div>
                                <div class="kpi-subtext">Capacidad utilizada</div>
                            </div>
                            <div class="kpi-value" id="kpi-ocupacion">0%</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Ubicaciones Críticas</div>
                                <div class="kpi-subtext">Requieren atención</div>
                            </div>
                            <div class="kpi-value" id="kpi-criticas">0</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Espacio Disponible</div>
                                <div class="kpi-subtext">Capacidad libre</div>
                            </div>
                            <div class="kpi-value" id="kpi-espacio">0</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-info">
                                <div class="kpi-label">Eficiencia Almacén</div>
                                <div class="kpi-subtext">Score general</div>
                            </div>
                            <div class="kpi-value" id="kpi-eficiencia">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Contadores por Estado -->
                <div class="sidebar-card fade-in">
                    <div class="card-header-custom">
                        <i class="bi bi-pie-chart-fill"></i> Distribución por Estado
                    </div>
                    <div class="card-body p-0">
                        <div class="counter-item" data-status="normal" onclick="filterStatus('normal')">
                            <div class="counter-color color-normal"></div>
                            <div class="counter-label">Normal</div>
                            <div class="counter-value">
                                <span id="count-normal">0</span>
                                <span class="counter-percent" id="percent-normal">0%</span>
                            </div>
                        </div>
                        <div class="counter-item" data-status="bajo" onclick="filterStatus('bajo')">
                            <div class="counter-color color-bajo"></div>
                            <div class="counter-label">Stock Bajo</div>
                            <div class="counter-value">
                                <span id="count-bajo">0</span>
                                <span class="counter-percent" id="percent-bajo">0%</span>
                            </div>
                        </div>
                        <div class="counter-item" data-status="critico" onclick="filterStatus('critico')">
                            <div class="counter-color color-critico"></div>
                            <div class="counter-label">Crítico</div>
                            <div class="counter-value">
                                <span id="count-critico">0</span>
                                <span class="counter-percent" id="percent-critico">0%</span>
                            </div>
                        </div>
                        <div class="counter-item" data-status="vacio" onclick="filterStatus('vacio')">
                            <div class="counter-color color-vacio"></div>
                            <div class="counter-label">Vacío</div>
                            <div class="counter-value">
                                <span id="count-vacio">0</span>
                                <span class="counter-percent" id="percent-vacio">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros Avanzados -->
                <div class="sidebar-card fade-in">
                    <div class="card-header-custom">
                        <i class="bi bi-funnel-fill"></i> Filtros Avanzados
                    </div>
                    <div class="filter-section">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-compass"></i> Zona del Almacén
                            </label>
                            <select class="form-select" id="filter-zone">
                                <option value="all">Todas las zonas</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-thermometer-half"></i> Nivel de Stock
                            </label>
                            <select class="form-select" id="filter-stock-level">
                                <option value="all">Todos los niveles</option>
                                <option value="very-high">Muy Alto (>90%)</option>
                                <option value="high">Alto (75-90%)</option>
                                <option value="medium">Medio (25-75%)</option>
                                <option value="low">Bajo (10-25%)</option>
                                <option value="very-low">Muy Bajo (<10%)</option>
                                <option value="empty">Vacío (0%)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-box-seam"></i> Material Específico
                            </label>
                            <select class="form-select" id="filter-material">
                                <option value="all">Todos los materiales</option>
                            </select>
                        </div>
                        
                        <button class="btn-apply-filters mt-3" onclick="applyAdvancedFilters()">
                            <i class="bi bi-filter-circle"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="resetAdvancedFilters()">
                            <i class="bi bi-x-circle"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if has_data %}
<!-- ================= MODAL AVANZADO DE DETALLES ================= -->
<div class="modal fade modal-custom" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalLabel">
                    <i class="bi bi-info-circle-fill"></i> Detalles de Ubicación
                    <span class="location-badge" id="modal-location-code">A-01-01</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            
            <div class="modal-body">
                <!-- Información General -->
                <div class="modal-section">
                    <h6 class="modal-section-title">
                        <i class="bi bi-geo-alt-fill"></i> Información General
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-item">
                                    <span class="info-label">Código Ubicación:</span>
                                    <span class="info-value" id="modal-location">A-01-01</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Zona:</span>
                                    <span class="info-value" id="modal-zone">A</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fila:</span>
                                    <span class="info-value" id="modal-row">01</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Columna:</span>
                                    <span class="info-value" id="modal-col">01</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-item">
                                    <span class="info-label">Capacidad Total:</span>
                                    <span class="info-value" id="modal-capacity">0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Stock Actual:</span>
                                    <span class="info-value" id="modal-stock">0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ocupación:</span>
                                    <span class="info-value" id="modal-ocupation">0%</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Estado:</span>
                                    <span class="info-value">
                                        <span class="status-badge" id="modal-status">Normal</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Barra de Progreso -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Ocupación de la Ubicación</span>
                            <span id="modal-ocupation-text">0 / 0 (0%)</span>
                        </div>
                        <div class="progress-custom">
                            <div id="modal-ocupation-bar" class="progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Materiales en la Ubicación -->
                <div class="modal-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="modal-section-title mb-0">
                            <i class="bi bi-box-seam-fill"></i> Materiales en esta Ubicación
                        </h6>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportLocationCSV()">
                                <i class="bi bi-download"></i> Exportar CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table materials-table">
                            <thead>
                                <tr>
                                    <th>Código Material</th>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Unidad</th>
                                </tr>
                            </thead>
                            <tbody id="location-materials">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg"></i> Cerrar
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary" onclick="editLocation()">
                            <i class="bi bi-pencil-square"></i> Editar Ubicación
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= TOOLTIP DINÁMICO ================= -->
<div id="dynamic-tooltip" class="tooltip-custom" style="display: none;"></div>

<!-- ================= OVERLAY DE CARGA ================= -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Procesando datos del almacén...</div>
</div>
{% endif %}

<!-- ================= SCRIPT AVANZADO ================= -->
<script>
/**
 * SISTEMA DE MAPA 2D INTELIGENTE PARA ALMACÉN
 * Versión Corregida
 */

// ================= CONFIGURACIÓN GLOBAL =================
const WarehouseConfig = {
    ZOOM_LEVELS: [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0],
    DEFAULT_ZOOM_INDEX: 2,
    GRID_SIZE: 45,
    GRID_GAP: 3,
    STATUS_COLORS: {
        normal: '#28a745',
        bajo: '#ffc107',
        critico: '#dc3545',
        vacio: '#6c757d'
    },
    OCCUPATION_THRESHOLDS: {
        critico: 20,
        bajo: 50,
        normal: 100
    },
    API_ENDPOINTS: {
        get_data: "{{ url_for('warehouse2d.get_warehouse_data') }}",
        map_data: "{{ url_for('warehouse2d.map_data') }}",
        clear_data: "{{ url_for('warehouse2d.clear_data') }}",
        export_excel: "{{ url_for('warehouse2d.export_excel') }}"
    }
};

// ================= ESTADO GLOBAL =================
const WarehouseState = {
    rawData: [],
    locations: [],
    materials: new Set(),
    filteredLocations: [],
    currentFilter: 'todos',
    searchQuery: '',
    advancedFilters: {
        zone: 'all',
        stockLevel: 'all',
        material: 'all'
    },
    viewMode: 'grid',
    zoomIndex: WarehouseConfig.DEFAULT_ZOOM_INDEX,
    showLabels: true,
    showGrid: true,
    selectedLocation: null,
    stats: {
        totalLocations: 0,
        totalMaterials: 0,
        occupiedLocations: 0,
        emptyLocations: 0,
        totalCapacity: 0,
        usedCapacity: 0,
        byStatus: {
            normal: 0,
            bajo: 0,
            critico: 0,
            vacio: 0
        }
    },
    dimensions: {
        maxRow: 0,
        maxCol: 0,
        zones: new Set()
    }
};

// ================= ELEMENTOS DOM =================
const DOMElements = {
    mapGrid: document.getElementById('map-grid'),
    mapContainer: document.getElementById('map-container'),
    noResults: document.getElementById('no-results'),
    listView: document.getElementById('list-view'),
    locationsTable: document.getElementById('locations-table'),
    searchBox: document.getElementById('searchBox'),
    zoomLevel: document.getElementById('zoomLevel'),
    currentView: document.getElementById('currentView'),
    totalLocationsSide: document.getElementById('total-locations-side'),
    visibleLocations: document.getElementById('visible-locations'),
    occupiedLocations: document.getElementById('occupied-locations'),
    ocupationRate: document.getElementById('ocupation-rate'),
    warehouseSize: document.getElementById('warehouse-size'),
    kpiOcupacion: document.getElementById('kpi-ocupacion'),
    kpiCriticas: document.getElementById('kpi-criticas'),
    kpiEspacio: document.getElementById('kpi-espacio'),
    kpiEficiencia: document.getElementById('kpi-eficiencia'),
    countNormal: document.getElementById('count-normal'),
    countBajo: document.getElementById('count-bajo'),
    countCritico: document.getElementById('count-critico'),
    countVacio: document.getElementById('count-vacio'),
    percentNormal: document.getElementById('percent-normal'),
    percentBajo: document.getElementById('percent-bajo'),
    percentCritico: document.getElementById('percent-critico'),
    percentVacio: document.getElementById('percent-vacio'),
    filterZone: document.getElementById('filter-zone'),
    filterStockLevel: document.getElementById('filter-stock-level'),
    filterMaterial: document.getElementById('filter-material'),
    modal: null,
    modalLocationCode: document.getElementById('modal-location-code'),
    modalLocation: document.getElementById('modal-location'),
    modalZone: document.getElementById('modal-zone'),
    modalRow: document.getElementById('modal-row'),
    modalCol: document.getElementById('modal-col'),
    modalStatus: document.getElementById('modal-status'),
    modalCapacity: document.getElementById('modal-capacity'),
    modalStock: document.getElementById('modal-stock'),
    modalOcupation: document.getElementById('modal-ocupation'),
    modalOcupationBar: document.getElementById('modal-ocupation-bar'),
    modalOcupationText: document.getElementById('modal-ocupation-text'),
    locationMaterials: document.getElementById('location-materials'),
    showLabels: document.getElementById('showLabels'),
    showGrid: document.getElementById('showGrid'),
    loadingOverlay: document.getElementById('loading-overlay')
};

// ================= INICIALIZACIÓN =================
document.addEventListener('DOMContentLoaded', async function() {
    {% if has_data %}
    console.log('Inicializando Mapa 2D del Almacén...');
    
    // Inicializar modal
    DOMElements.modal = new bootstrap.Modal(document.getElementById('locationModal'));
    
    // Cargar datos del servidor
    await loadDataFromServer();
    
    // Configurar eventos
    setupEventListeners();
    
    // Configurar atajos de teclado
    setupKeyboardShortcuts();
    
    // Inicializar vista
    renderGrid();
    
    console.log('Sistema inicializado correctamente');
    {% endif %}
});

// ================= CARGA DE DATOS =================
async function loadDataFromServer() {
    showLoading(true);
    
    try {
        const response = await fetch(WarehouseConfig.API_ENDPOINTS.map_data);
        const data = await response.json();
        
        if (data.success) {
            WarehouseState.locations = data.locations;
            WarehouseState.dimensions.maxRow = data.stats.max_row;
            WarehouseState.dimensions.maxCol = data.stats.max_col;
            WarehouseState.dimensions.zones = new Set(data.stats.zones);
            
            // Extraer materiales
            WarehouseState.materials = new Set();
            WarehouseState.locations.forEach(location => {
                if (location.material) {
                    WarehouseState.materials.add(location.material);
                }
            });
            
            updateStatistics();
            populateFilters();
            applyFilters();
            showNotification('Datos cargados correctamente', 'success');
        } else {
            throw new Error(data.message || 'Error al cargar datos');
        }
    } catch (error) {
        console.error('Error cargando datos:', error);
        showNotification('Error al cargar los datos: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function updateStatistics() {
    const stats = {
        totalLocations: WarehouseState.locations.length,
        totalMaterials: WarehouseState.materials.size,
        occupiedLocations: 0,
        emptyLocations: 0,
        totalCapacity: 0,
        usedCapacity: 0,
        byStatus: {
            normal: 0,
            bajo: 0,
            critico: 0,
            vacio: 0
        }
    };
    
    WarehouseState.locations.forEach(location => {
        // Calcular ocupación
        const ocupationPercent = location.capacity > 0 ? 
            Math.round((location.quantity / location.capacity) * 100) : 0;
        
        // Determinar estado
        let status = 'vacio';
        if (location.quantity > 0) {
            if (ocupationPercent < WarehouseConfig.OCCUPATION_THRESHOLDS.critico) {
                status = 'critico';
            } else if (ocupationPercent < WarehouseConfig.OCCUPATION_THRESHOLDS.bajo) {
                status = 'bajo';
            } else {
                status = 'normal';
            }
        }
        
        location.ocupationPercent = ocupationPercent;
        location.status = status;
        location.usedCapacity = location.quantity;
        location.freeCapacity = location.capacity - location.quantity;
        
        // Actualizar estadísticas
        stats.totalCapacity += location.capacity;
        stats.usedCapacity += location.quantity;
        
        if (location.quantity > 0) {
            stats.occupiedLocations++;
        } else {
            stats.emptyLocations++;
        }
        
        stats.byStatus[status]++;
    });
    
    const avgOcupation = stats.totalCapacity > 0 ? 
        Math.round((stats.usedCapacity / stats.totalCapacity) * 100) : 0;
    
    // Actualizar UI
    DOMElements.warehouseSize.textContent = `${WarehouseState.dimensions.maxRow}x${WarehouseState.dimensions.maxCol}`;
    DOMElements.kpiOcupacion.textContent = `${avgOcupation}%`;
    DOMElements.kpiCriticas.textContent = stats.byStatus.critico;
    DOMElements.kpiEspacio.textContent = formatNumber(stats.totalCapacity - stats.usedCapacity);
    DOMElements.kpiEficiencia.textContent = `${Math.min(100, Math.round((stats.occupiedLocations / stats.totalLocations) * 100))}%`;
    
    // Actualizar contadores
    DOMElements.countNormal.textContent = stats.byStatus.normal;
    DOMElements.countBajo.textContent = stats.byStatus.bajo;
    DOMElements.countCritico.textContent = stats.byStatus.critico;
    DOMElements.countVacio.textContent = stats.byStatus.vacio;
    
    DOMElements.percentNormal.textContent = `(${Math.round((stats.byStatus.normal / stats.totalLocations) * 100)}%)`;
    DOMElements.percentBajo.textContent = `(${Math.round((stats.byStatus.bajo / stats.totalLocations) * 100)}%)`;
    DOMElements.percentCritico.textContent = `(${Math.round((stats.byStatus.critico / stats.totalLocations) * 100)}%)`;
    DOMElements.percentVacio.textContent = `(${Math.round((stats.byStatus.vacio / stats.totalLocations) * 100)}%)`;
    
    WarehouseState.stats = stats;
}

function populateFilters() {
    // Limpiar filtros
    DOMElements.filterZone.innerHTML = '<option value="all">Todas las zonas</option>';
    DOMElements.filterMaterial.innerHTML = '<option value="all">Todos los materiales</option>';
    
    // Agregar zonas
    WarehouseState.dimensions.zones.forEach(zone => {
        const option = document.createElement('option');
        option.value = zone;
        option.textContent = `Zona ${zone}`;
        DOMElements.filterZone.appendChild(option);
    });
    
    // Agregar materiales
    Array.from(WarehouseState.materials).slice(0, 50).forEach(material => {
        const option = document.createElement('option');
        option.value = material;
        option.textContent = material;
        DOMElements.filterMaterial.appendChild(option);
    });
}

// ================= RENDERIZADO DEL GRID =================
function renderGrid() {
    if (WarehouseState.viewMode !== 'grid') return;
    
    const grid = DOMElements.mapGrid;
    grid.innerHTML = '';
    
    // Calcular dimensiones
    const rows = WarehouseState.dimensions.maxRow;
    const cols = WarehouseState.dimensions.maxCol;
    
    if (rows === 0 || cols === 0) {
        showNoResults();
        return;
    }
    
    // Configurar grid
    grid.style.gridTemplateColumns = `repeat(${cols}, ${WarehouseConfig.GRID_SIZE}px)`;
    grid.style.gridTemplateRows = `repeat(${rows}, ${WarehouseConfig.GRID_SIZE}px)`;
    grid.style.gap = `${WarehouseConfig.GRID_GAP}px`;
    grid.style.width = `${cols * (WarehouseConfig.GRID_SIZE + WarehouseConfig.GRID_GAP) - WarehouseConfig.GRID_GAP}px`;
    grid.style.height = `${rows * (WarehouseConfig.GRID_SIZE + WarehouseConfig.GRID_GAP) - WarehouseConfig.GRID_GAP}px`;
    
    // Aplicar zoom
    const zoom = WarehouseConfig.ZOOM_LEVELS[WarehouseState.zoomIndex];
    grid.style.transform = `scale(${zoom})`;
    DOMElements.zoomLevel.textContent = `${Math.round(zoom * 100)}%`;
    
    // Crear celdas
    for (let row = 1; row <= rows; row++) {
        for (let col = 1; col <= cols; col++) {
            const location = findLocationAt(row, col);
            const cell = createGridCell(row, col, location);
            grid.appendChild(cell);
        }
    }
    
    // Actualizar estadísticas visibles
    updateVisibleStats();
    
    // Mostrar/ocultar grid
    toggleGridLines();
}

function findLocationAt(row, col) {
    return WarehouseState.filteredLocations.find(loc => 
        loc.row === row && loc.col === col
    );
}

function createGridCell(row, col, location) {
    const cell = document.createElement('div');
    cell.className = 'location-cell';
    
    if (location) {
        cell.classList.add(location.status);
        cell.dataset.locationCode = location.code;
        cell.dataset.row = row;
        cell.dataset.col = col;
        
        if (WarehouseState.showLabels) {
            cell.innerHTML = `
                <div class="location-code">${location.code}</div>
                <div class="location-percent">${location.ocupationPercent}%</div>
            `;
        } else {
            cell.innerHTML = `<div class="location-percent">${location.ocupationPercent}%</div>`;
        }
        
        cell.title = `${location.code}\nZona: ${location.zone}\nEstado: ${location.status}\nOcupación: ${location.ocupationPercent}%\nMaterial: ${location.material || 'Ninguno'}`;
        
        cell.addEventListener('click', (e) => handleCellClick(e, location));
        cell.addEventListener('mouseenter', (e) => handleCellMouseEnter(e, location));
        cell.addEventListener('mouseleave', handleCellMouseLeave);
        
        if (WarehouseState.selectedLocation && 
            WarehouseState.selectedLocation.code === location.code) {
            cell.classList.add('highlighted');
        }
    } else {
        cell.classList.add('empty');
        cell.style.backgroundColor = '#f8f9fa';
        cell.style.border = '1px dashed #dee2e6';
        cell.style.opacity = '0.5';
        
        if (WarehouseState.showLabels) {
            cell.innerHTML = `<div class="location-code text-muted">${row}-${col}</div>`;
        }
        
        cell.title = `Espacio no definido: Fila ${row}, Columna ${col}`;
    }
    
    return cell;
}

function handleCellClick(event, location) {
    WarehouseState.selectedLocation = location;
    showLocationDetails(location);
    
    document.querySelectorAll('.location-cell').forEach(cell => {
        cell.classList.remove('highlighted');
    });
    event.currentTarget.classList.add('highlighted');
}

function handleCellMouseEnter(event, location) {
    const tooltip = document.getElementById('dynamic-tooltip');
    if (!tooltip) return;
    
    tooltip.innerHTML = `
        <strong>${location.code}</strong><br>
        <small>Zona: ${location.zone}</small><br>
        <small>Estado: <span class="text-${location.status}">${location.status.toUpperCase()}</span></small><br>
        <small>Ocupación: ${location.ocupationPercent}%</small><br>
        <small>Material: ${location.material || 'Ninguno'}</small>
    `;
    
    tooltip.style.left = `${event.pageX + 15}px`;
    tooltip.style.top = `${event.pageY - 15}px`;
    tooltip.style.opacity = '1';
    tooltip.style.display = 'block';
}

function handleCellMouseLeave() {
    const tooltip = document.getElementById('dynamic-tooltip');
    if (!tooltip) return;
    
    tooltip.style.opacity = '0';
    setTimeout(() => {
        tooltip.style.display = 'none';
    }, 300);
}

// ================= VISTA DE LISTA =================
function renderListView() {
    const tableBody = DOMElements.locationsTable;
    tableBody.innerHTML = '';
    
    WarehouseState.filteredLocations.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'location-row';
        row.dataset.locationCode = location.code;
        
        row.innerHTML = `
            <td><strong>${location.code}</strong></td>
            <td>${location.zone}</td>
            <td>${location.row}</td>
            <td>${location.col}</td>
            <td>${location.material || 'Ninguno'}</td>
            <td>${formatNumber(location.quantity)}</td>
            <td>${formatNumber(location.capacity)}</td>
            <td>${location.ocupationPercent}%</td>
            <td>
                <span class="status-badge bg-${location.status}">
                    ${location.status.toUpperCase()}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showLocationDetailsByCode('${location.code}')">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

// ================= FILTRADO Y BÚSQUEDA =================
function filterStatus(status) {
    WarehouseState.currentFilter = status;
    applyFilters();
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.status === status);
    });
    
    document.querySelectorAll('.counter-item').forEach(item => {
        item.classList.toggle('active', item.dataset.status === status);
    });
}

function applyFilters() {
    let filtered = [...WarehouseState.locations];
    
    if (WarehouseState.currentFilter !== 'todos') {
        filtered = filtered.filter(loc => loc.status === WarehouseState.currentFilter);
    }
    
    if (WarehouseState.advancedFilters.zone !== 'all') {
        filtered = filtered.filter(loc => loc.zone === WarehouseState.advancedFilters.zone);
    }
    
    if (WarehouseState.advancedFilters.stockLevel !== 'all') {
        filtered = filtered.filter(loc => {
            switch(WarehouseState.advancedFilters.stockLevel) {
                case 'very-high': return loc.ocupationPercent > 90;
                case 'high': return loc.ocupationPercent >= 75 && loc.ocupationPercent <= 90;
                case 'medium': return loc.ocupationPercent >= 25 && loc.ocupationPercent < 75;
                case 'low': return loc.ocupationPercent >= 10 && loc.ocupationPercent < 25;
                case 'very-low': return loc.ocupationPercent < 10 && loc.ocupationPercent > 0;
                case 'empty': return loc.ocupationPercent === 0;
                default: return true;
            }
        });
    }
    
    if (WarehouseState.advancedFilters.material !== 'all') {
        filtered = filtered.filter(loc => loc.material === WarehouseState.advancedFilters.material);
    }
    
    if (WarehouseState.searchQuery) {
        const query = WarehouseState.searchQuery.toLowerCase();
        filtered = filtered.filter(loc => 
            loc.code.toLowerCase().includes(query) ||
            loc.zone.toLowerCase().includes(query) ||
            (loc.material && loc.material.toLowerCase().includes(query))
        );
    }
    
    WarehouseState.filteredLocations = filtered;
    updateFilterUI();
    
    if (WarehouseState.viewMode === 'grid') {
        renderGrid();
    } else if (WarehouseState.viewMode === 'list') {
        renderListView();
    }
}

function applyAdvancedFilters() {
    WarehouseState.advancedFilters = {
        zone: DOMElements.filterZone.value,
        stockLevel: DOMElements.filterStockLevel.value,
        material: DOMElements.filterMaterial.value
    };
    applyFilters();
}

function resetAdvancedFilters() {
    DOMElements.filterZone.value = 'all';
    DOMElements.filterStockLevel.value = 'all';
    DOMElements.filterMaterial.value = 'all';
    WarehouseState.advancedFilters = {
        zone: 'all',
        stockLevel: 'all',
        material: 'all'
    };
    applyFilters();
}

function resetAllFilters() {
    WarehouseState.currentFilter = 'todos';
    WarehouseState.searchQuery = '';
    DOMElements.searchBox.value = '';
    resetAdvancedFilters();
    showNotification('Filtros restablecidos', 'info');
}

function updateFilterUI() {
    updateVisibleStats();
    
    if (WarehouseState.filteredLocations.length === 0) {
        DOMElements.noResults.classList.remove('d-none');
    } else {
        DOMElements.noResults.classList.add('d-none');
    }
}

function updateVisibleStats() {
    const visible = WarehouseState.filteredLocations.length;
    const occupied = WarehouseState.filteredLocations.filter(loc => loc.quantity > 0).length;
    const totalCapacity = WarehouseState.filteredLocations.reduce((sum, loc) => sum + loc.capacity, 0);
    const usedCapacity = WarehouseState.filteredLocations.reduce((sum, loc) => sum + loc.quantity, 0);
    const ocupationRate = totalCapacity > 0 ? Math.round((usedCapacity / totalCapacity) * 100) : 0;
    
    DOMElements.visibleLocations.textContent = formatNumber(visible);
    DOMElements.occupiedLocations.textContent = formatNumber(occupied);
    DOMElements.ocupationRate.textContent = `${ocupationRate}%`;
}

// ================= DETALLES DE UBICACIÓN =================
function showLocationDetails(location) {
    DOMElements.modalLocationCode.textContent = location.code;
    DOMElements.modalLocation.textContent = location.code;
    DOMElements.modalZone.textContent = location.zone;
    DOMElements.modalRow.textContent = location.row.toString().padStart(2, '0');
    DOMElements.modalCol.textContent = location.col.toString().padStart(2, '0');
    DOMElements.modalStatus.textContent = location.status;
    DOMElements.modalStatus.className = `status-badge bg-${location.status}`;
    DOMElements.modalCapacity.textContent = formatNumber(location.capacity);
    DOMElements.modalStock.textContent = formatNumber(location.quantity);
    DOMElements.modalOcupation.textContent = `${location.ocupationPercent}%`;
    
    DOMElements.modalOcupationBar.style.width = `${location.ocupationPercent}%`;
    DOMElements.modalOcupationBar.style.backgroundColor = WarehouseConfig.STATUS_COLORS[location.status];
    DOMElements.modalOcupationText.textContent = 
        `${formatNumber(location.quantity)} / ${formatNumber(location.capacity)} (${location.ocupationPercent}%)`;
    
    renderLocationMaterials(location);
    DOMElements.modal.show();
}

function showLocationDetailsByCode(locationCode) {
    const location = WarehouseState.locations.find(loc => loc.code === locationCode);
    if (location) {
        showLocationDetails(location);
    }
}

function renderLocationMaterials(location) {
    const tbody = DOMElements.locationMaterials;
    tbody.innerHTML = '';
    
    if (!location.material) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-inbox me-2"></i> No hay materiales en esta ubicación
                </td>
            </tr>
        `;
        return;
    }
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><code>${location.material}</code></td>
        <td>${location.description || location.material}</td>
        <td class="fw-bold">${formatNumber(location.quantity)}</td>
        <td>${location.unit || 'UN'}</td>
    `;
    tbody.appendChild(row);
}

// ================= CONTROLES DE VISTA =================
function setViewMode(mode) {
    WarehouseState.viewMode = mode;
    DOMElements.currentView.textContent = 
        mode === 'grid' ? 'Vista Grid' : 'Vista Lista';
    
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === mode);
    });
    
    if (mode === 'grid') {
        DOMElements.mapContainer.parentElement.classList.remove('d-none');
        DOMElements.listView.classList.add('d-none');
        renderGrid();
    } else if (mode === 'list') {
        DOMElements.mapContainer.parentElement.classList.add('d-none');
        DOMElements.listView.classList.remove('d-none');
        renderListView();
    }
}

function zoomIn() {
    if (WarehouseState.zoomIndex < WarehouseConfig.ZOOM_LEVELS.length - 1) {
        WarehouseState.zoomIndex++;
        renderGrid();
    }
}

function zoomOut() {
    if (WarehouseState.zoomIndex > 0) {
        WarehouseState.zoomIndex--;
        renderGrid();
    }
}

function toggleLabels() {
    WarehouseState.showLabels = DOMElements.showLabels.checked;
    renderGrid();
}

function toggleGrid() {
    WarehouseState.showGrid = DOMElements.showGrid.checked;
    toggleGridLines();
}

function toggleGridLines() {
    const gridContainer = DOMElements.mapContainer;
    if (WarehouseState.showGrid) {
        gridContainer.style.backgroundImage = `
            linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
            linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
            linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
            linear-gradient(-45deg, transparent 75%, #f8f9fa 75%)
        `;
        gridContainer.style.backgroundSize = '20px 20px';
    } else {
        gridContainer.style.backgroundImage = 'none';
    }
}

// ================= UTILIDADES =================
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(2) + 'M';
    }
    if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function showLoading(show) {
    if (DOMElements.loadingOverlay) {
        DOMElements.loadingOverlay.style.display = show ? 'flex' : 'none';
    }
}

function showNotification(message, type = 'info') {
    // Implementación simple de notificación
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

function showNoResults() {
    DOMElements.noResults.classList.remove('d-none');
    DOMElements.mapGrid.style.display = 'none';
}

// ================= EXPORTACIÓN =================
function exportToPDF() {
    showNotification('Generando PDF del almacén...', 'info');
    
    // Simulación
    setTimeout(() => {
        showNotification('PDF generado correctamente', 'success');
    }, 1500);
}

async function exportToExcel() {
    showLoading(true);
    
    try {
        const response = await fetch(WarehouseConfig.API_ENDPOINTS.export_excel);
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `almacen2d_export_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Excel exportado correctamente', 'success');
    } catch (error) {
        console.error('Error exportando Excel:', error);
        showNotification('Error al exportar Excel', 'error');
    } finally {
        showLoading(false);
    }
}

function exportLocationCSV() {
    if (!WarehouseState.selectedLocation) return;
    
    const location = WarehouseState.selectedLocation;
    let csv = 'Material,Descripción,Cantidad,Unidad\n';
    csv += `"${location.material || ''}","${location.description || ''}",${location.quantity},"${location.unit || 'UN'}"`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `material_${location.code}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('CSV exportado correctamente', 'success');
}

// ================= GESTIÓN DE DATOS =================
async function refreshData() {
    await loadDataFromServer();
}

async function clearData() {
    if (!confirm('¿Estás seguro de que deseas borrar todos los datos del almacén? Esta acción no se puede deshacer.')) {
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch(WarehouseConfig.API_ENDPOINTS.clear_data, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Datos borrados correctamente', 'success');
            setTimeout(() => {
                window.location.href = "{{ url_for('warehouse2d.index') }}";
            }, 1500);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error borrando datos:', error);
        showNotification('Error al borrar datos: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// ================= CONFIGURACIÓN DE EVENTOS =================
function setupEventListeners() {
    // Buscador
    DOMElements.searchBox.addEventListener('input', debounce((e) => {
        WarehouseState.searchQuery = e.target.value;
        applyFilters();
    }, 300));
    
    // Zoom con rueda del mouse
    DOMElements.mapContainer.addEventListener('wheel', (e) => {
        if (e.ctrlKey) {
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        }
    });
    
    // Redimensionar ventana
    window.addEventListener('resize', throttle(() => {
        if (WarehouseState.viewMode === 'grid') {
            renderGrid();
        }
    }, 250));
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        if (e.ctrlKey) {
            switch(e.key) {
                case '+':
                case '=':
                    e.preventDefault();
                    zoomIn();
                    break;
                case '-':
                case '_':
                    e.preventDefault();
                    zoomOut();
                    break;
                case 'f':
                    e.preventDefault();
                    DOMElements.searchBox.focus();
                    break;
                case 'r':
                    e.preventDefault();
                    refreshData();
                    break;
            }
        }
        
        if (e.key === 'Escape') {
            if (DOMElements.searchBox.value) {
                DOMElements.searchBox.value = '';
                WarehouseState.searchQuery = '';
                applyFilters();
            }
        }
    });
}

// ================= FUNCIONES DE DEBOUNCE Y THROTTLE =================
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// ================= FUNCIONES PARA EL MODAL =================
function editLocation() {
    if (!WarehouseState.selectedLocation) return;
    showNotification('Función de edición en desarrollo', 'info');
}

// ================= MÉTODOS PARA DEPURACIÓN =================
window.warehouseDebug = {
    getState: () => ({ ...WarehouseState }),
    getStats: () => ({ ...WarehouseState.stats }),
    reloadData: () => loadDataFromServer()
};
</script>
{% endblock %}

