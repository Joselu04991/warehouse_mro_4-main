{% extends "base.html" %}
{% block title %}Errores T√©cnicos - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-4 mt-4">

    <!-- Header con t√≠tulo y acciones -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div>
            <h1 class="fw-bold mb-1">üìä Panel de Errores T√©cnicos</h1>
            <p class="text-muted mb-0">Monitoreo y an√°lisis de incidentes t√©cnicos</p>
        </div>
        <div class="d-flex gap-2 mt-3 mt-md-0">
            <a href="{{ url_for('technician_errors.new_error') }}" class="btn btn-primary d-flex align-items-center gap-2">
                <i class="bi bi-plus-circle"></i>
                <span>Nuevo Error</span>
            </a>
            <a href="{{ url_for('technician_errors.reporte_pdf') }}" class="btn btn-danger d-flex align-items-center gap-2">
                <i class="bi bi-file-earmark-pdf"></i>
                <span>Exportar PDF</span>
            </a>
        </div>
    </div>

    <!-- Cards de resumen -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-primary border-3 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                Total Errores
                            </div>
                            <div class="h5 mb-0 fw-bold">{{ errores|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-exclamation-triangle text-primary fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-warning border-3 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                P√©rdida Total
                            </div>
                            <div class="h5 mb-0 fw-bold">S/ {{ errores|sum(attribute='dinero')|round(2) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-currency-dollar text-warning fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-info border-3 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                T√©cnicos con Errores
                            </div>
                            <div class="h5 mb-0 fw-bold">{{ (errores|map(attribute='tecnico')|unique|list)|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people text-info fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start-danger border-3 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-danger text-uppercase mb-1">
                                Gravedad Promedio
                            </div>
                            <div class="h5 mb-0 fw-bold">{{ (errores|sum(attribute='impacto')/errores|length if errores else 0)|round(1) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-speedometer2 text-danger fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="row mb-4">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 fw-bold text-primary">üìà P√©rdida Econ√≥mica por D√≠a</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical text-gray-400"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow animated--fade-in" 
                            aria-labelledby="dropdownMenuLink">
                            <li><a class="dropdown-item" href="#">Ver detalles</a></li>
                            <li><a class="dropdown-item" href="#">Exportar datos</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="graf_dias"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">üë®‚Äçüîß Errores por T√©cnico</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4">
                        <canvas id="graf_tecnico"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        {% for label in graf_por_tecnico.keys() %}
                        <span class="me-3">
                            <i class="bi bi-circle-fill" style="color: {{ ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1', '#fd7e14', '#20c9a6']|random }}"></i>
                            {{ label }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de errores -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-primary">üìã Registro de Errores</h6>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Todos</a></li>
                    <li><a class="dropdown-item" href="#">Cr√≠ticos</a></li>
                    <li><a class="dropdown-item" href="#">Este mes</a></li>
                </ul>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="dataTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>T√©cnico</th>
                            <th>Tipo</th>
                            <th>Gravedad</th>
                            <th>Puntaje</th>
                            <th>P√©rdida (S/.)</th>
                            <th>Fecha</th>
                            <th>Observaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for e in errores %}
                        <tr>
                            <td class="fw-bold">#{{ e.id }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-2">
                                        <div class="avatar-title bg-light text-primary rounded-circle">
                                            {{ e.tecnico[0]|upper }}
                                        </div>
                                    </div>
                                    {{ e.tecnico }}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info bg-opacity-10 text-info">
                                    {{ e.tipo_error }}
                                </span>
                            </td>
                            <td>
                                {% if e.gravedad == 'Bajo' %}
                                    <span class="badge bg-success">{{ e.gravedad }}</span>
                                {% elif e.gravedad == 'Medio' %}
                                    <span class="badge bg-warning">{{ e.gravedad }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ e.gravedad }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar 
                                        {% if e.impacto <= 3 %}bg-success
                                        {% elif e.impacto <= 7 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                        role="progressbar" 
                                        style="width: {{ e.impacto * 10 }}%"
                                        aria-valuenow="{{ e.impacto }}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="10">
                                    </div>
                                </div>
                                <small class="fw-bold">{{ e.impacto }}/10</small>
                            </td>
                            <td class="fw-bold text-danger">S/ {{ e.dinero }}</td>
                            <td>
                                <div>{{ e.fecha_hora.strftime("%d-%m-%Y") }}</div>
                                <small class="text-muted">{{ e.fecha_hora.strftime("%H:%M") }}</small>
                            </td>
                            <td>
                                <div class="truncate-text" style="max-width: 200px;">
                                    {{ e.observacion }}
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        data-bs-toggle="tooltip" 
                                        title="Ver detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" 
                                        data-bs-toggle="tooltip" 
                                        title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginaci√≥n -->
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1">Anterior</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">Siguiente</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Tooltip activation
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
});

// Gr√°fico de errores por t√©cnico (Pie Chart)
new Chart(document.getElementById('graf_tecnico'), {
    type: 'doughnut',
    data: {
        labels: {{ graf_por_tecnico.keys() | list | safe }},
        datasets: [{
            data: {{ graf_por_tecnico.values() | list | safe }},
            backgroundColor: [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
                '#e74a3b', '#6f42c1', '#fd7e14', '#20c9a6'
            ],
            borderWidth: 2,
            hoverOffset: 15
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Gr√°fico de p√©rdidas por d√≠a (Line Chart)
new Chart(document.getElementById('graf_dias'), {
    type: 'line',
    data: {
        labels: {{ graf_por_dia.keys() | list | safe }},
        datasets: [{
            label: 'P√©rdidas (S/.)',
            data: {{ graf_por_dia.values() | list | safe }},
            fill: true,
            backgroundColor: 'rgba(78, 115, 223, 0.05)',
            borderColor: '#4e73df',
            borderWidth: 3,
            pointBackgroundColor: '#4e73df',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            tension: 0.3
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    drawBorder: false
                },
                ticks: {
                    callback: function(value) {
                        return 'S/ ' + value;
                    }
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'P√©rdida: S/ ' + context.parsed.y;
                    }
                }
            }
        }
    }
});
</script>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.truncate-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.card {
    border: none;
    border-radius: 0.75rem;
}

.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    color: #6c757d;
}

.progress {
    border-radius: 10px;
}

.chart-area, .chart-pie {
    position: relative;
    height: 300px;
}

.border-start-primary { border-left-color: #4e73df !important; }
.border-start-warning { border-left-color: #f6c23e !important; }
.border-start-info { border-left-color: #36b9cc !important; }
.border-start-danger { border-left-color: #e74a3b !important; }
</style>

{% endblock %}
